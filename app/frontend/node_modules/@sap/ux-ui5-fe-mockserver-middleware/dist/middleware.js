"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createMockMiddleware = void 0;
var router_1 = __importDefault(require("router"));
var logger_1 = require("@ui5/logger");
var odata_1 = require("./router/odata");
var catalog_1 = require("./router/catalog");
var fs = __importStar(require("fs"));
var path_1 = __importDefault(require("path"));
var url_1 = __importDefault(require("url"));
var fileLoader_1 = require("./router/utils/fileLoader");
function disableCache(req, res, next) {
    res.header('Cache-Control', 'private, no-cache, no-store, must-revalidate');
    res.header('Expires', '-1');
    res.header('Pragma', 'no-cache');
    next();
}
function encode(str) {
    return str.replace(/'/g, '%27');
}
function isFolderBasedConfig(serverConfig) {
    return serverConfig.mockFolder !== undefined;
}
function createMockMiddleware(config) {
    return __awaiter(this, void 0, void 0, function () {
        var app, log, mockConfig, serverInit_1, nise, fakeServer, escapePath, mockServer, serverhook_1;
        var _this = this;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    app = router_1.default();
                    log = logger_1.getLogger('server:ux-fe-mockserver');
                    app.use(function (req, res, next) {
                        next();
                    });
                    app.use(disableCache);
                    if (!isFolderBasedConfig(config)) return [3 /*break*/, 2];
                    mockConfig = void 0;
                    if (fs.existsSync(path_1.default.join(config.mockFolder, 'config.js'))) {
                        mockConfig = require(path_1.default.join(config.mockFolder, 'config.js'));
                    }
                    else {
                        mockConfig = JSON.parse(fs.readFileSync(path_1.default.join(config.mockFolder, 'config.json')).toString('utf-8'));
                    }
                    return [4 /*yield*/, Promise.all(mockConfig.map(function (mockConfig) { return __awaiter(_this, void 0, void 0, function () {
                            var subConfig, oDataHandlerInstance, subRouter, e_1;
                            return __generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        subConfig = {
                                            service: mockConfig
                                        };
                                        if (subConfig.service.metadataXmlPath) {
                                            subConfig.service.metadataXmlPath = path_1.default.resolve(config.mockFolder, subConfig.service.metadataXmlPath);
                                        }
                                        if (subConfig.service.metadataCdsPath) {
                                            subConfig.service.metadataCdsPath = path_1.default.resolve(config.mockFolder, subConfig.service.metadataCdsPath);
                                        }
                                        subConfig.service.mockdataRootPath = path_1.default.resolve(config.mockFolder, subConfig.service.mockdataRootPath);
                                        if (!subConfig.service.urlBasePath) {
                                            subConfig.service.urlBasePath = '';
                                        }
                                        _a.label = 1;
                                    case 1:
                                        _a.trys.push([1, 3, , 4]);
                                        return [4 /*yield*/, odata_1.oDataHandler(subConfig)];
                                    case 2:
                                        oDataHandlerInstance = _a.sent();
                                        if (config.contextBasedIsolation) {
                                            subRouter = router_1.default();
                                            subRouter.use(subConfig.service.urlBasePath + "/" + subConfig.service.name, oDataHandlerInstance);
                                            subRouter.use(subConfig.service.urlBasePath + "/" + encode(subConfig.service.name), oDataHandlerInstance);
                                            app.use(/^\/tenant-(\d{1,3})/, subRouter);
                                        }
                                        if (config.debug) {
                                            log.info("Mockdata location: " + subConfig.service.mockdataRootPath);
                                            log.info("Service path: " + subConfig.service.urlBasePath + "/" + subConfig.service.name);
                                        }
                                        app.use(subConfig.service.urlBasePath + "/" + subConfig.service.name, oDataHandlerInstance);
                                        app.use(subConfig.service.urlBasePath + "/" + encode(subConfig.service.name), oDataHandlerInstance);
                                        app.use('/sap/opu/odata/IWFND/CATALOGSERVICE;v=2', catalog_1.catalogService(subConfig));
                                        return [3 /*break*/, 4];
                                    case 3:
                                        e_1 = _a.sent();
                                        if (config.debug) {
                                            console.error(e_1);
                                        }
                                        console.log('Failed to start ' + subConfig.service.urlBasePath + '/' + subConfig.service.name);
                                        return [3 /*break*/, 4];
                                    case 4: return [2 /*return*/];
                                }
                            });
                        }); }))];
                case 1:
                    _a.sent();
                    return [3 /*break*/, 3];
                case 2:
                    if (!config.service.urlBasePath) {
                        config.service.urlBasePath = '';
                    }
                    log.info("Mockdata location: " + config.service.mockdataRootPath);
                    log.info("Service path: " + config.service.urlBasePath + "/" + config.service.name);
                    if (fileLoader_1.isInBrowser()) {
                        nise = require('nise');
                        fakeServer = nise.fakeServer;
                        escapePath = function (sPath) {
                            // eslint-disable-next-line
                            return sPath.replace(/[\\\/\[\]\{\}\(\)\-\*\+\?\.\^\$\|]/g, '\\$&');
                        };
                        nise.fakeXhr.FakeXMLHttpRequest.useFilters = true;
                        mockServer = fakeServer.create();
                        mockServer.autoRespond = true;
                        serverhook_1 = new RegExp(escapePath(config.service.urlBasePath) + '.*');
                        nise.fakeXhr.FakeXMLHttpRequest.addFilter(function (method, url, async, username, password) {
                            return !serverhook_1.test(url);
                        });
                        mockServer.respondWith(serverhook_1, function (xhr, id) {
                            return __awaiter(this, void 0, void 0, function () {
                                var parsedUrl, req, oBoundaryRegex, sBoundary, responseHeaders, responseStatusCode, responseContentType, responseBuffer, res;
                                return __generator(this, function (_a) {
                                    switch (_a.label) {
                                        case 0:
                                            parsedUrl = url_1.default.parse(xhr.url);
                                            req = {
                                                url: parsedUrl.href,
                                                method: xhr.method,
                                                body: xhr.requestBody,
                                                headers: xhr.requestHeaders
                                            };
                                            if (req.headers['Content-Type'] === 'multipart/mixed;charset=utf-8') {
                                                oBoundaryRegex = new RegExp('batch_[a-z0-9-]*');
                                                sBoundary = oBoundaryRegex.exec(req.body)[0];
                                                req.headers['Content-Type'] = 'multipart/mixed; boundary=' + sBoundary;
                                            }
                                            Object.keys(req.headers).forEach(function (headerText) {
                                                req.headers[headerText.toLowerCase()] = req.headers[headerText];
                                            });
                                            responseHeaders = {};
                                            responseStatusCode = 200;
                                            responseBuffer = '';
                                            res = {
                                                header: function (headerName, headerValue) {
                                                    //responseHeaders[headerName] = headerValue;
                                                    responseHeaders[headerName.toLowerCase()] = headerValue;
                                                },
                                                getHeader: function (headerName) {
                                                    return responseHeaders[headerName];
                                                },
                                                setHeader: function (headerName, headerValue) {
                                                    res.header(headerName, headerValue);
                                                },
                                                status: function (statusCode) {
                                                    responseStatusCode = statusCode;
                                                },
                                                type: function (contentType) {
                                                    responseContentType = contentType;
                                                    return res;
                                                },
                                                contentType: function (contentType) {
                                                    responseContentType = contentType;
                                                    res.header('Content-Type', responseContentType);
                                                    return res;
                                                },
                                                write: function (data) {
                                                    responseBuffer += data;
                                                },
                                                end: function () {
                                                    res.send(responseBuffer);
                                                },
                                                send: function (data) {
                                                    xhr.readyState = 1;
                                                    if (typeof data === 'object') {
                                                        data = JSON.stringify(data);
                                                    }
                                                    xhr.respond(responseStatusCode, responseHeaders, data);
                                                }
                                            };
                                            xhr.readyState = 4;
                                            return [4 /*yield*/, serverInit_1];
                                        case 1:
                                            _a.sent();
                                            app(req, res, function (arg1, arg2, arg3) {
                                                console.error(arg1);
                                            });
                                            return [2 /*return*/];
                                    }
                                });
                            });
                        });
                        app.mockServer = mockServer;
                    }
                    serverInit_1 = odata_1.oDataHandler(config).then(function (oDataHandlerInstance) {
                        app.use(config.service.urlBasePath + "/" + config.service.name, oDataHandlerInstance);
                        app.use(config.service.urlBasePath + "/" + encode(config.service.name), oDataHandlerInstance);
                        app.use('/sap/opu/odata/IWFND/CATALOGSERVICE;v=2', catalog_1.catalogService(config));
                        return true;
                    });
                    app.readyPromise = serverInit_1;
                    _a.label = 3;
                case 3: return [2 /*return*/, app];
            }
        });
    });
}
exports.createMockMiddleware = createMockMiddleware;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWlkZGxld2FyZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9taWRkbGV3YXJlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSxrREFBNEI7QUFDNUIsc0NBQXdDO0FBQ3hDLHdDQUE4QztBQUU5Qyw0Q0FBa0Q7QUFDbEQscUNBQXlCO0FBQ3pCLDhDQUF3QjtBQUN4Qiw0Q0FBc0I7QUFFdEIsd0RBQXdEO0FBRXhELFNBQVMsWUFBWSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSTtJQUNoQyxHQUFHLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBRSw4Q0FBOEMsQ0FBQyxDQUFDO0lBQzVFLEdBQUcsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzVCLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQ2pDLElBQUksRUFBRSxDQUFDO0FBQ1gsQ0FBQztBQUVELFNBQVMsTUFBTSxDQUFDLEdBQUc7SUFDZixPQUFPLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ3BDLENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLFlBQTBCO0lBQ25ELE9BQVEsWUFBd0MsQ0FBQyxVQUFVLEtBQUssU0FBUyxDQUFDO0FBQzlFLENBQUM7QUFFRCxTQUFzQixvQkFBb0IsQ0FBQyxNQUFvQjs7Ozs7OztvQkFDckQsR0FBRyxHQUFXLGdCQUFNLEVBQUUsQ0FBQztvQkFDdkIsR0FBRyxHQUFHLGtCQUFTLENBQUMseUJBQXlCLENBQUMsQ0FBQztvQkFDakQsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBSTt3QkFDdEMsSUFBSSxFQUFFLENBQUM7b0JBQ1gsQ0FBQyxDQUFDLENBQUM7b0JBRUgsR0FB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QUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVyxTQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBRyxFQUFFLG9CQUFvQixDQUFDLENBQUM7d0JBRTlGLEdBQUcsQ0FBQyxHQUFHLENBQUMseUNBQXlDLEVBQUUsd0JBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO3dCQUMzRSxPQUFPLElBQUksQ0FBQztvQkFDaEIsQ0FBQyxDQUFDLENBQUM7b0JBQ0gsR0FBRyxDQUFDLFlBQVksR0FBRyxZQUFVLENBQUM7O3dCQUdsQyxzQkFBTyxHQUFHLEVBQUM7Ozs7Q0FDZDtBQTlLRCxvREE4S0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IFJvdXRlciBmcm9tICdyb3V0ZXInO1xuaW1wb3J0IHsgZ2V0TG9nZ2VyIH0gZnJvbSAnQHVpNS9sb2dnZXInO1xuaW1wb3J0IHsgb0RhdGFIYW5kbGVyIH0gZnJvbSAnLi9yb3V0ZXIvb2RhdGEnO1xuaW1wb3J0IHsgRm9sZGVyQmFzZWRTZXJ2ZXJDb25maWcsIFNlcnZlckNvbmZpZyB9IGZyb20gJy4vYXBpJztcbmltcG9ydCB7IGNhdGFsb2dTZXJ2aWNlIH0gZnJvbSAnLi9yb3V0ZXIvY2F0YWxvZyc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcblxuaW1wb3J0IHsgaXNJbkJyb3dzZXIgfSBmcm9tICcuL3JvdXRlci91dGlscy9maWxlTG9hZGVyJztcblxuZnVuY3Rpb24gZGlzYWJsZUNhY2hlKHJlcSwgcmVzLCBuZXh0KTogdm9pZCB7XG4gICAgcmVzLmhlYWRlcignQ2FjaGUtQ29udHJvbCcsICdwcml2YXRlLCBuby1jYWNoZSwgbm8tc3RvcmUsIG11c3QtcmV2YWxpZGF0ZScpO1xuICAgIHJlcy5oZWFkZXIoJ0V4cGlyZXMnLCAnLTEnKTtcbiAgICByZXMuaGVhZGVyKCdQcmFnbWEnLCAnbm8tY2FjaGUnKTtcbiAgICBuZXh0KCk7XG59XG5cbmZ1bmN0aW9uIGVuY29kZShzdHIpIHtcbiAgICByZXR1cm4gc3RyLnJlcGxhY2UoLycvZywgJyUyNycpO1xufVxuXG5mdW5jdGlvbiBpc0ZvbGRlckJhc2VkQ29uZmlnKHNlcnZlckNvbmZpZzogU2VydmVyQ29uZmlnKTogc2VydmVyQ29uZmlnIGlzIEZvbGRlckJhc2VkU2VydmVyQ29uZmlnIHtcbiAgICByZXR1cm4gKHNlcnZlckNvbmZpZyBhcyBGb2xkZXJCYXNlZFNlcnZlckNvbmZpZykubW9ja0ZvbGRlciAhPT0gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlTW9ja01pZGRsZXdhcmUoY29uZmlnOiBTZXJ2ZXJDb25maWcpOiBQcm9taXNlPFJvdXRlcj4ge1xuICAgIGNvbnN0IGFwcDogUm91dGVyID0gUm91dGVyKCk7XG4gICAgY29uc3QgbG9nID0gZ2V0TG9nZ2VyKCdzZXJ2ZXI6dXgtZmUtbW9ja3NlcnZlcicpO1xuICAgIGFwcC51c2UoKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dCkgPT4ge1xuICAgICAgICBuZXh0KCk7XG4gICAgfSk7XG5cbiAgICBhcHAudXNlKGRpc2FibGVDYWNoZSk7XG4gICAgaWYgKGlzRm9sZGVyQmFzZWRDb25maWcoY29uZmlnKSkge1xuICAgICAgICBsZXQgbW9ja0NvbmZpZztcbiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMocGF0aC5qb2luKGNvbmZpZy5tb2NrRm9sZGVyLCAnY29uZmlnLmpzJykpKSB7XG4gICAgICAgICAgICBtb2NrQ29uZmlnID0gcmVxdWlyZShwYXRoLmpvaW4oY29uZmlnLm1vY2tGb2xkZXIsICdjb25maWcuanMnKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtb2NrQ29uZmlnID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKGNvbmZpZy5tb2NrRm9sZGVyLCAnY29uZmlnLmpzb24nKSkudG9TdHJpbmcoJ3V0Zi04JykpO1xuICAgICAgICB9XG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICAgICAgbW9ja0NvbmZpZy5tYXAoYXN5bmMgKG1vY2tDb25maWcpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdWJDb25maWc6IFNlcnZlckNvbmZpZyA9IHtcbiAgICAgICAgICAgICAgICAgICAgc2VydmljZTogbW9ja0NvbmZpZ1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgaWYgKHN1YkNvbmZpZy5zZXJ2aWNlLm1ldGFkYXRhWG1sUGF0aCkge1xuICAgICAgICAgICAgICAgICAgICBzdWJDb25maWcuc2VydmljZS5tZXRhZGF0YVhtbFBhdGggPSBwYXRoLnJlc29sdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25maWcubW9ja0ZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1YkNvbmZpZy5zZXJ2aWNlLm1ldGFkYXRhWG1sUGF0aFxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoc3ViQ29uZmlnLnNlcnZpY2UubWV0YWRhdGFDZHNQYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIHN1YkNvbmZpZy5zZXJ2aWNlLm1ldGFkYXRhQ2RzUGF0aCA9IHBhdGgucmVzb2x2ZShcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5tb2NrRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3ViQ29uZmlnLnNlcnZpY2UubWV0YWRhdGFDZHNQYXRoXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgc3ViQ29uZmlnLnNlcnZpY2UubW9ja2RhdGFSb290UGF0aCA9IHBhdGgucmVzb2x2ZShcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLm1vY2tGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgIHN1YkNvbmZpZy5zZXJ2aWNlLm1vY2tkYXRhUm9vdFBhdGhcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGlmICghc3ViQ29uZmlnLnNlcnZpY2UudXJsQmFzZVBhdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgc3ViQ29uZmlnLnNlcnZpY2UudXJsQmFzZVBhdGggPSAnJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb0RhdGFIYW5kbGVySW5zdGFuY2UgPSBhd2FpdCBvRGF0YUhhbmRsZXIoc3ViQ29uZmlnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5jb250ZXh0QmFzZWRJc29sYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1YlJvdXRlcjogUm91dGVyID0gUm91dGVyKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJSb3V0ZXIudXNlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAke3N1YkNvbmZpZy5zZXJ2aWNlLnVybEJhc2VQYXRofS8ke3N1YkNvbmZpZy5zZXJ2aWNlLm5hbWV9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvRGF0YUhhbmRsZXJJbnN0YW5jZVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1YlJvdXRlci51c2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7c3ViQ29uZmlnLnNlcnZpY2UudXJsQmFzZVBhdGh9LyR7ZW5jb2RlKHN1YkNvbmZpZy5zZXJ2aWNlLm5hbWUpfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb0RhdGFIYW5kbGVySW5zdGFuY2VcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAudXNlKC9eXFwvdGVuYW50LShcXGR7MSwzfSkvLCBzdWJSb3V0ZXIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcuZGVidWcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5pbmZvKGBNb2NrZGF0YSBsb2NhdGlvbjogJHtzdWJDb25maWcuc2VydmljZS5tb2NrZGF0YVJvb3RQYXRofWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmluZm8oYFNlcnZpY2UgcGF0aDogJHtzdWJDb25maWcuc2VydmljZS51cmxCYXNlUGF0aH0vJHtzdWJDb25maWcuc2VydmljZS5uYW1lfWApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGFwcC51c2UoYCR7c3ViQ29uZmlnLnNlcnZpY2UudXJsQmFzZVBhdGh9LyR7c3ViQ29uZmlnLnNlcnZpY2UubmFtZX1gLCBvRGF0YUhhbmRsZXJJbnN0YW5jZSk7XG4gICAgICAgICAgICAgICAgICAgIGFwcC51c2UoYCR7c3ViQ29uZmlnLnNlcnZpY2UudXJsQmFzZVBhdGh9LyR7ZW5jb2RlKHN1YkNvbmZpZy5zZXJ2aWNlLm5hbWUpfWAsIG9EYXRhSGFuZGxlckluc3RhbmNlKTtcblxuICAgICAgICAgICAgICAgICAgICBhcHAudXNlKCcvc2FwL29wdS9vZGF0YS9JV0ZORC9DQVRBTE9HU0VSVklDRTt2PTInLCBjYXRhbG9nU2VydmljZShzdWJDb25maWcpKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcuZGVidWcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0ZhaWxlZCB0byBzdGFydCAnICsgc3ViQ29uZmlnLnNlcnZpY2UudXJsQmFzZVBhdGggKyAnLycgKyBzdWJDb25maWcuc2VydmljZS5uYW1lKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICghY29uZmlnLnNlcnZpY2UudXJsQmFzZVBhdGgpIHtcbiAgICAgICAgICAgIGNvbmZpZy5zZXJ2aWNlLnVybEJhc2VQYXRoID0gJyc7XG4gICAgICAgIH1cbiAgICAgICAgbG9nLmluZm8oYE1vY2tkYXRhIGxvY2F0aW9uOiAke2NvbmZpZy5zZXJ2aWNlLm1vY2tkYXRhUm9vdFBhdGh9YCk7XG4gICAgICAgIGxvZy5pbmZvKGBTZXJ2aWNlIHBhdGg6ICR7Y29uZmlnLnNlcnZpY2UudXJsQmFzZVBhdGh9LyR7Y29uZmlnLnNlcnZpY2UubmFtZX1gKTtcblxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLWNvbnN0XG4gICAgICAgIGxldCBzZXJ2ZXJJbml0O1xuICAgICAgICBpZiAoaXNJbkJyb3dzZXIoKSkge1xuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby12YXItcmVxdWlyZXNcbiAgICAgICAgICAgIGNvbnN0IG5pc2UgPSByZXF1aXJlKCduaXNlJyk7XG4gICAgICAgICAgICBjb25zdCBmYWtlU2VydmVyID0gbmlzZS5mYWtlU2VydmVyO1xuICAgICAgICAgICAgY29uc3QgZXNjYXBlUGF0aCA9IGZ1bmN0aW9uKHNQYXRoKSB7XG4gICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lXG4gICAgICAgICAgICAgICAgcmV0dXJuIHNQYXRoLnJlcGxhY2UoL1tcXFxcXFwvXFxbXFxdXFx7XFx9XFwoXFwpXFwtXFwqXFwrXFw/XFwuXFxeXFwkXFx8XS9nLCAnXFxcXCQmJyk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBuaXNlLmZha2VYaHIuRmFrZVhNTEh0dHBSZXF1ZXN0LnVzZUZpbHRlcnMgPSB0cnVlO1xuXG4gICAgICAgICAgICBjb25zdCBtb2NrU2VydmVyID0gZmFrZVNlcnZlci5jcmVhdGUoKTtcbiAgICAgICAgICAgIG1vY2tTZXJ2ZXIuYXV0b1Jlc3BvbmQgPSB0cnVlO1xuICAgICAgICAgICAgY29uc3Qgc2VydmVyaG9vayA9IG5ldyBSZWdFeHAoZXNjYXBlUGF0aChjb25maWcuc2VydmljZS51cmxCYXNlUGF0aCkgKyAnLionKTtcbiAgICAgICAgICAgIG5pc2UuZmFrZVhoci5GYWtlWE1MSHR0cFJlcXVlc3QuYWRkRmlsdGVyKChtZXRob2QsIHVybCwgYXN5bmMsIHVzZXJuYW1lLCBwYXNzd29yZCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiAhc2VydmVyaG9vay50ZXN0KHVybCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbW9ja1NlcnZlci5yZXNwb25kV2l0aChzZXJ2ZXJob29rLCBhc3luYyBmdW5jdGlvbih4aHIsIGlkKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFyc2VkVXJsID0gdXJsLnBhcnNlKHhoci51cmwpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlcSA9IHtcbiAgICAgICAgICAgICAgICAgICAgdXJsOiBwYXJzZWRVcmwuaHJlZixcbiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiB4aHIubWV0aG9kLFxuICAgICAgICAgICAgICAgICAgICBib2R5OiB4aHIucmVxdWVzdEJvZHksXG4gICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHhoci5yZXF1ZXN0SGVhZGVyc1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgaWYgKHJlcS5oZWFkZXJzWydDb250ZW50LVR5cGUnXSA9PT0gJ211bHRpcGFydC9taXhlZDtjaGFyc2V0PXV0Zi04Jykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvQm91bmRhcnlSZWdleCA9IG5ldyBSZWdFeHAoJ2JhdGNoX1thLXowLTktXSonKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc0JvdW5kYXJ5ID0gb0JvdW5kYXJ5UmVnZXguZXhlYyhyZXEuYm9keSlbMF07XG4gICAgICAgICAgICAgICAgICAgIHJlcS5oZWFkZXJzWydDb250ZW50LVR5cGUnXSA9ICdtdWx0aXBhcnQvbWl4ZWQ7IGJvdW5kYXJ5PScgKyBzQm91bmRhcnk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKHJlcS5oZWFkZXJzKS5mb3JFYWNoKChoZWFkZXJUZXh0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlcS5oZWFkZXJzW2hlYWRlclRleHQudG9Mb3dlckNhc2UoKV0gPSByZXEuaGVhZGVyc1toZWFkZXJUZXh0XTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZUhlYWRlcnMgPSB7fTtcbiAgICAgICAgICAgICAgICBsZXQgcmVzcG9uc2VTdGF0dXNDb2RlID0gMjAwO1xuICAgICAgICAgICAgICAgIGxldCByZXNwb25zZUNvbnRlbnRUeXBlO1xuICAgICAgICAgICAgICAgIGxldCByZXNwb25zZUJ1ZmZlciA9ICcnO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IHtcbiAgICAgICAgICAgICAgICAgICAgaGVhZGVyOiAoaGVhZGVyTmFtZSwgaGVhZGVyVmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vcmVzcG9uc2VIZWFkZXJzW2hlYWRlck5hbWVdID0gaGVhZGVyVmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnNbaGVhZGVyTmFtZS50b0xvd2VyQ2FzZSgpXSA9IGhlYWRlclZhbHVlO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBnZXRIZWFkZXI6IChoZWFkZXJOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VIZWFkZXJzW2hlYWRlck5hbWVdO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBzZXRIZWFkZXI6IChoZWFkZXJOYW1lLCBoZWFkZXJWYWx1ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzLmhlYWRlcihoZWFkZXJOYW1lLCBoZWFkZXJWYWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHN0YXR1czogKHN0YXR1c0NvZGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlU3RhdHVzQ29kZSA9IHN0YXR1c0NvZGU7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IChjb250ZW50VHlwZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VDb250ZW50VHlwZSA9IGNvbnRlbnRUeXBlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgY29udGVudFR5cGU6IChjb250ZW50VHlwZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VDb250ZW50VHlwZSA9IGNvbnRlbnRUeXBlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzLmhlYWRlcignQ29udGVudC1UeXBlJywgcmVzcG9uc2VDb250ZW50VHlwZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB3cml0ZTogKGRhdGE6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VCdWZmZXIgKz0gZGF0YTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgZW5kOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXMuc2VuZChyZXNwb25zZUJ1ZmZlcik7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHNlbmQ6IChkYXRhOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHhoci5yZWFkeVN0YXRlID0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gSlNPTi5zdHJpbmdpZnkoZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB4aHIucmVzcG9uZChyZXNwb25zZVN0YXR1c0NvZGUsIHJlc3BvbnNlSGVhZGVycywgZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHhoci5yZWFkeVN0YXRlID0gNDtcbiAgICAgICAgICAgICAgICBhd2FpdCBzZXJ2ZXJJbml0O1xuICAgICAgICAgICAgICAgIGFwcChyZXEsIHJlcywgZnVuY3Rpb24oYXJnMSwgYXJnMiwgYXJnMykge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGFyZzEpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBhcHAubW9ja1NlcnZlciA9IG1vY2tTZXJ2ZXI7XG4gICAgICAgIH1cblxuICAgICAgICBzZXJ2ZXJJbml0ID0gb0RhdGFIYW5kbGVyKGNvbmZpZykudGhlbigob0RhdGFIYW5kbGVySW5zdGFuY2UpID0+IHtcbiAgICAgICAgICAgIGFwcC51c2UoYCR7Y29uZmlnLnNlcnZpY2UudXJsQmFzZVBhdGh9LyR7Y29uZmlnLnNlcnZpY2UubmFtZX1gLCBvRGF0YUhhbmRsZXJJbnN0YW5jZSk7XG4gICAgICAgICAgICBhcHAudXNlKGAke2NvbmZpZy5zZXJ2aWNlLnVybEJhc2VQYXRofS8ke2VuY29kZShjb25maWcuc2VydmljZS5uYW1lKX1gLCBvRGF0YUhhbmRsZXJJbnN0YW5jZSk7XG5cbiAgICAgICAgICAgIGFwcC51c2UoJy9zYXAvb3B1L29kYXRhL0lXRk5EL0NBVEFMT0dTRVJWSUNFO3Y9MicsIGNhdGFsb2dTZXJ2aWNlKGNvbmZpZykpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pO1xuICAgICAgICBhcHAucmVhZHlQcm9taXNlID0gc2VydmVySW5pdDtcbiAgICB9XG5cbiAgICByZXR1cm4gYXBwO1xufVxuIl19