"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.convertBatch = exports.getBoundary = void 0;
var batchContent_1 = require("./batchContent");
var batch_1 = require("./batch");
var appHttp_1 = require("./appHttp");
function getBoundary(headerValue) {
    var l = headerValue.split(';');
    for (var i = 0; i < l.length; i++) {
        var ll = l[i].split('=');
        if (ll[0].trim() === 'boundary') {
            return ll[1];
        }
    }
}
exports.getBoundary = getBoundary;
function readHeader(line) {
    var colPos = line.indexOf(':');
    if (colPos === -1) {
        throw new Error('Invalid header "content-type" in batch part');
    }
    var s0 = line.substr(0, colPos);
    var s1 = line.substr(colPos + 1);
    return {
        name: s0.toLowerCase(),
        value: s1.trim()
    };
}
function readAppHttp(batchContent, boundary) {
    var headers = {};
    var payload = [];
    var state = 0; //read url
    var url = batchContent.readLine();
    state = 1; //read header
    var line = batchContent.lookLine();
    while (line !== null && line !== undefined && line.indexOf(boundary) !== 0) {
        if (state === 1) {
            if (line.length === 0) {
                state = 2; //read body
                batchContent.inc();
            }
            else {
                var h = readHeader(line);
                headers[h.name] = h.value;
                batchContent.inc();
            }
        }
        else if (state === 2) {
            payload.push(line);
            batchContent.inc();
        }
        line = batchContent.lookLine();
    }
    if (line === undefined) {
        throw new Error('Invalid boundary while parsing batch request. Expect boundary ' + boundary);
    }
    return new appHttp_1.AppHttp(url, headers, payload);
}
function parsePart(batchContent, boundary) {
    var boundaryNext = boundary;
    var boundaryEnd = boundary + '--';
    var headers = {};
    var content;
    var state = 1; //read header
    var line = batchContent.lookLine();
    while (line !== null && line !== undefined && line !== boundaryNext && line !== boundaryEnd) {
        if (state === 1) {
            if (line.length === 0) {
                state = 2; //read body
                batchContent.inc();
            }
            else {
                var h = readHeader(line);
                headers[h.name] = h.value;
                batchContent.inc();
            }
        }
        else if (state === 2) {
            if (!headers['content-type']) {
                throw new Error('Missing header "content-type" in batch part');
            }
            else if (headers['content-type'] === 'application/http') {
                content = readAppHttp(batchContent, boundary);
                if (headers['content-id']) {
                    content.contentId = { id: headers['content-id'] };
                }
            }
            else if (headers['content-type'].indexOf('multipart/mixed;') > -1) {
                var changeSetBoundary = exports.getBoundary(headers['content-type']);
                content = parseBatch(batchContent, changeSetBoundary, 'changeset');
            }
            else {
                //TODO not supported
            }
        }
        line = batchContent.lookLine();
    }
    if (line === undefined) {
        throw new Error('Invalid boundary while parsing batch request. Expect boundary ' + boundary);
    }
    return content;
}
function parseBatch(content, boundary, type) {
    var boundaryNext = '--' + boundary;
    var boundaryEnd = '--' + boundary + '--';
    var batch = new batch_1.Batch(type);
    var part;
    var line = content.readLine();
    while (line !== null && line !== undefined && line !== boundaryNext) {
        //read lines before first boundary
        line = content.readLine();
    }
    if (line === undefined) {
        throw new Error('Invalid boundary while parsing batch request');
    }
    //line is now read boundary
    line = content.lookLine(); //read line behind
    while (line !== null && line !== undefined && line !== boundaryEnd) {
        part = parsePart(content, boundaryNext);
        batch.parts.push(part);
        line = content.lookLine(); //now on boundary
        if (line === boundaryNext) {
            line = content.readLine(); //consume boundaryNext
        }
    }
    content.readLine(); //consume boundaryEnd
    line = content.lookLine(); //read line behind
    while (line !== null && line !== undefined && line.length === 0) {
        //read empty lines after first boundaryend
        content.readLine();
        line = content.lookLine();
    }
    return batch;
}
function convertBatch(payload, boundary) {
    return parseBatch(new batchContent_1.BatchContent(payload), boundary, 'batch');
}
exports.convertBatch = convertBatch;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmF0Y2hQYXJzZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvcm91dGVyL2JhdGNoL2NvbnRlbnQvYmF0Y2hQYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0NBQThDO0FBQzlDLGlDQUFnQztBQUNoQyxxQ0FBb0M7QUFFcEMsU0FBZ0IsV0FBVyxDQUFDLFdBQVc7SUFDbkMsSUFBTSxDQUFDLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUVqQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMvQixJQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzNCLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLFVBQVUsRUFBRTtZQUM3QixPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNoQjtLQUNKO0FBQ0wsQ0FBQztBQVRELGtDQVNDO0FBRUQsU0FBUyxVQUFVLENBQUMsSUFBSTtJQUNwQixJQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2pDLElBQUksTUFBTSxLQUFLLENBQUMsQ0FBQyxFQUFFO1FBQ2YsTUFBTSxJQUFJLEtBQUssQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0tBQ2xFO0lBRUQsSUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDbEMsSUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDbkMsT0FBTztRQUNILElBQUksRUFBRSxFQUFFLENBQUMsV0FBVyxFQUFFO1FBQ3RCLEtBQUss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QUFFLFFBQVE7SUFDMUMsT0FBTyxVQUFVLENBQUMsSUFBSSwyQkFBWSxDQUFDLE9BQU8sQ0FBQyxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUNwRSxDQUFDO0FBRkQsb0NBRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYXRjaENvbnRlbnQgfSBmcm9tICcuL2JhdGNoQ29udGVudCc7XG5pbXBvcnQgeyBCYXRjaCB9IGZyb20gJy4vYmF0Y2gnO1xuaW1wb3J0IHsgQXBwSHR0cCB9IGZyb20gJy4vYXBwSHR0cCc7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRCb3VuZGFyeShoZWFkZXJWYWx1ZSkge1xuICAgIGNvbnN0IGwgPSBoZWFkZXJWYWx1ZS5zcGxpdCgnOycpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGxsID0gbFtpXS5zcGxpdCgnPScpO1xuICAgICAgICBpZiAobGxbMF0udHJpbSgpID09PSAnYm91bmRhcnknKSB7XG4gICAgICAgICAgICByZXR1cm4gbGxbMV07XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmZ1bmN0aW9uIHJlYWRIZWFkZXIobGluZSkge1xuICAgIGNvbnN0IGNvbFBvcyA9IGxpbmUuaW5kZXhPZignOicpO1xuICAgIGlmIChjb2xQb3MgPT09IC0xKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBoZWFkZXIgXCJjb250ZW50LXR5cGVcIiBpbiBiYXRjaCBwYXJ0Jyk7XG4gICAgfVxuXG4gICAgY29uc3QgczAgPSBsaW5lLnN1YnN0cigwLCBjb2xQb3MpO1xuICAgIGNvbnN0IHMxID0gbGluZS5zdWJzdHIoY29sUG9zICsgMSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZTogczAudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgdmFsdWU6IHMxLnRyaW0oKVxuICAgIH07XG59XG5cbmZ1bmN0aW9uIHJlYWRBcHBIdHRwKGJhdGNoQ29udGVudCwgYm91bmRhcnkpIHtcbiAgICBjb25zdCBoZWFkZXJzID0ge307XG4gICAgY29uc3QgcGF5bG9hZCA9IFtdO1xuXG4gICAgbGV0IHN0YXRlID0gMDsgLy9yZWFkIHVybFxuICAgIGNvbnN0IHVybCA9IGJhdGNoQ29udGVudC5yZWFkTGluZSgpO1xuXG4gICAgc3RhdGUgPSAxOyAvL3JlYWQgaGVhZGVyXG4gICAgbGV0IGxpbmUgPSBiYXRjaENvbnRlbnQubG9va0xpbmUoKTtcblxuICAgIHdoaWxlIChsaW5lICE9PSBudWxsICYmIGxpbmUgIT09IHVuZGVmaW5lZCAmJiBsaW5lLmluZGV4T2YoYm91bmRhcnkpICE9PSAwKSB7XG4gICAgICAgIGlmIChzdGF0ZSA9PT0gMSkge1xuICAgICAgICAgICAgaWYgKGxpbmUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUgPSAyOyAvL3JlYWQgYm9keVxuICAgICAgICAgICAgICAgIGJhdGNoQ29udGVudC5pbmMoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaCA9IHJlYWRIZWFkZXIobGluZSk7XG4gICAgICAgICAgICAgICAgaGVhZGVyc1toLm5hbWVdID0gaC52YWx1ZTtcbiAgICAgICAgICAgICAgICBiYXRjaENvbnRlbnQuaW5jKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09IDIpIHtcbiAgICAgICAgICAgIHBheWxvYWQucHVzaChsaW5lKTtcbiAgICAgICAgICAgIGJhdGNoQ29udGVudC5pbmMoKTtcbiAgICAgICAgfVxuICAgICAgICBsaW5lID0gYmF0Y2hDb250ZW50Lmxvb2tMaW5lKCk7XG4gICAgfVxuICAgIGlmIChsaW5lID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGJvdW5kYXJ5IHdoaWxlIHBhcnNpbmcgYmF0Y2ggcmVxdWVzdC4gRXhwZWN0IGJvdW5kYXJ5ICcgKyBib3VuZGFyeSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBBcHBIdHRwKHVybCwgaGVhZGVycywgcGF5bG9hZCk7XG59XG5cbmZ1bmN0aW9uIHBhcnNlUGFydChiYXRjaENvbnRlbnQsIGJvdW5kYXJ5KSB7XG4gICAgY29uc3QgYm91bmRhcnlOZXh0ID0gYm91bmRhcnk7XG4gICAgY29uc3QgYm91bmRhcnlFbmQgPSBib3VuZGFyeSArICctLSc7XG4gICAgY29uc3QgaGVhZGVycyA9IHt9O1xuICAgIGxldCBjb250ZW50O1xuXG4gICAgbGV0IHN0YXRlID0gMTsgLy9yZWFkIGhlYWRlclxuICAgIGxldCBsaW5lID0gYmF0Y2hDb250ZW50Lmxvb2tMaW5lKCk7XG5cbiAgICB3aGlsZSAobGluZSAhPT0gbnVsbCAmJiBsaW5lICE9PSB1bmRlZmluZWQgJiYgbGluZSAhPT0gYm91bmRhcnlOZXh0ICYmIGxpbmUgIT09IGJvdW5kYXJ5RW5kKSB7XG4gICAgICAgIGlmIChzdGF0ZSA9PT0gMSkge1xuICAgICAgICAgICAgaWYgKGxpbmUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUgPSAyOyAvL3JlYWQgYm9keVxuICAgICAgICAgICAgICAgIGJhdGNoQ29udGVudC5pbmMoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaCA9IHJlYWRIZWFkZXIobGluZSk7XG4gICAgICAgICAgICAgICAgaGVhZGVyc1toLm5hbWVdID0gaC52YWx1ZTtcbiAgICAgICAgICAgICAgICBiYXRjaENvbnRlbnQuaW5jKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09IDIpIHtcbiAgICAgICAgICAgIGlmICghaGVhZGVyc1snY29udGVudC10eXBlJ10pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgaGVhZGVyIFwiY29udGVudC10eXBlXCIgaW4gYmF0Y2ggcGFydCcpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChoZWFkZXJzWydjb250ZW50LXR5cGUnXSA9PT0gJ2FwcGxpY2F0aW9uL2h0dHAnKSB7XG4gICAgICAgICAgICAgICAgY29udGVudCA9IHJlYWRBcHBIdHRwKGJhdGNoQ29udGVudCwgYm91bmRhcnkpO1xuICAgICAgICAgICAgICAgIGlmIChoZWFkZXJzWydjb250ZW50LWlkJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudC5jb250ZW50SWQgPSB7IGlkOiBoZWFkZXJzWydjb250ZW50LWlkJ10gfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddLmluZGV4T2YoJ211bHRpcGFydC9taXhlZDsnKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2hhbmdlU2V0Qm91bmRhcnkgPSBleHBvcnRzLmdldEJvdW5kYXJ5KGhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddKTtcbiAgICAgICAgICAgICAgICBjb250ZW50ID0gcGFyc2VCYXRjaChiYXRjaENvbnRlbnQsIGNoYW5nZVNldEJvdW5kYXJ5LCAnY2hhbmdlc2V0Jyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vVE9ETyBub3Qgc3VwcG9ydGVkXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbGluZSA9IGJhdGNoQ29udGVudC5sb29rTGluZSgpO1xuICAgIH1cbiAgICBpZiAobGluZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBib3VuZGFyeSB3aGlsZSBwYXJzaW5nIGJhdGNoIHJlcXVlc3QuIEV4cGVjdCBib3VuZGFyeSAnICsgYm91bmRhcnkpO1xuICAgIH1cblxuICAgIHJldHVybiBjb250ZW50O1xufVxuXG5mdW5jdGlvbiBwYXJzZUJhdGNoKGNvbnRlbnQsIGJvdW5kYXJ5LCB0eXBlKSB7XG4gICAgY29uc3QgYm91bmRhcnlOZXh0ID0gJy0tJyArIGJvdW5kYXJ5O1xuICAgIGNvbnN0IGJvdW5kYXJ5RW5kID0gJy0tJyArIGJvdW5kYXJ5ICsgJy0tJztcblxuICAgIGNvbnN0IGJhdGNoID0gbmV3IEJhdGNoKHR5cGUpO1xuXG4gICAgbGV0IHBhcnQ7XG5cbiAgICBsZXQgbGluZSA9IGNvbnRlbnQucmVhZExpbmUoKTtcbiAgICB3aGlsZSAobGluZSAhPT0gbnVsbCAmJiBsaW5lICE9PSB1bmRlZmluZWQgJiYgbGluZSAhPT0gYm91bmRhcnlOZXh0KSB7XG4gICAgICAgIC8vcmVhZCBsaW5lcyBiZWZvcmUgZmlyc3QgYm91bmRhcnlcbiAgICAgICAgbGluZSA9IGNvbnRlbnQucmVhZExpbmUoKTtcbiAgICB9XG4gICAgaWYgKGxpbmUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgYm91bmRhcnkgd2hpbGUgcGFyc2luZyBiYXRjaCByZXF1ZXN0Jyk7XG4gICAgfVxuICAgIC8vbGluZSBpcyBub3cgcmVhZCBib3VuZGFyeVxuICAgIGxpbmUgPSBjb250ZW50Lmxvb2tMaW5lKCk7IC8vcmVhZCBsaW5lIGJlaGluZFxuXG4gICAgd2hpbGUgKGxpbmUgIT09IG51bGwgJiYgbGluZSAhPT0gdW5kZWZpbmVkICYmIGxpbmUgIT09IGJvdW5kYXJ5RW5kKSB7XG4gICAgICAgIHBhcnQgPSBwYXJzZVBhcnQoY29udGVudCwgYm91bmRhcnlOZXh0KTtcbiAgICAgICAgYmF0Y2gucGFydHMucHVzaChwYXJ0KTtcbiAgICAgICAgbGluZSA9IGNvbnRlbnQubG9va0xpbmUoKTsgLy9ub3cgb24gYm91bmRhcnlcbiAgICAgICAgaWYgKGxpbmUgPT09IGJvdW5kYXJ5TmV4dCkge1xuICAgICAgICAgICAgbGluZSA9IGNvbnRlbnQucmVhZExpbmUoKTsgLy9jb25zdW1lIGJvdW5kYXJ5TmV4dFxuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29udGVudC5yZWFkTGluZSgpOyAvL2NvbnN1bWUgYm91bmRhcnlFbmRcbiAgICBsaW5lID0gY29udGVudC5sb29rTGluZSgpOyAvL3JlYWQgbGluZSBiZWhpbmRcbiAgICB3aGlsZSAobGluZSAhPT0gbnVsbCAmJiBsaW5lICE9PSB1bmRlZmluZWQgJiYgbGluZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgLy9yZWFkIGVtcHR5IGxpbmVzIGFmdGVyIGZpcnN0IGJvdW5kYXJ5ZW5kXG4gICAgICAgIGNvbnRlbnQucmVhZExpbmUoKTtcbiAgICAgICAgbGluZSA9IGNvbnRlbnQubG9va0xpbmUoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYmF0Y2g7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0QmF0Y2gocGF5bG9hZCwgYm91bmRhcnkpIHtcbiAgICByZXR1cm4gcGFyc2VCYXRjaChuZXcgQmF0Y2hDb250ZW50KHBheWxvYWQpLCBib3VuZGFyeSwgJ2JhdGNoJyk7XG59XG4iXX0=