"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.batchRequestHandler = void 0;
var keyGenerator_1 = require("./keyGenerator");
var simpleHttpRequest_1 = require("./http/simpleHttpRequest");
var batchParser_1 = require("./content/batchParser");
var odataV2Request_1 = require("../request/odataV2Request");
var odataV4Request_1 = require("../request/odataV4Request");
/**
 * Simplified/mocked implementation of a batch context required by the
 * xs2/xsodata lib
 */
var index = 0;
var mockContext = {
    getNextKeyCounter: function () {
        return index++;
    }
};
/**
 * Write batch content to the response. The method has been copied from the
 * xs2/xsodata project and modified because FE expects status code 202.
 * @param batch
 * @param context
 * @param response
 */
function writeBatch(batch, context, response) {
    response.statusCode = 200;
    var boundary = 'batch_' + keyGenerator_1.createBoundary(context);
    response.setHeader('Content-Type', 'multipart/mixed; boundary=' + boundary);
    response.write('--' + boundary + '\r\n');
    for (var i = 0; i < batch.parts.length; i++) {
        if (i !== 0) {
            response.write('\r\n--' + boundary + '\r\n');
        }
        batch.parts[i].write(context, response);
    }
    response.write('\r\n--' + boundary + '--\r\n');
}
function batchRequestHandler(metadata, dataAccess, config) {
    var _this = this;
    return function (req, res) {
        var request = simpleHttpRequest_1.createRequest(req, '/');
        if (metadata.getVersion() === '2.0') {
            res.setHeader('dataserviceversion', metadata.getVersion());
        }
        else {
            res.setHeader('odata-version', metadata.getVersion());
        }
        res.status(200);
        var boundary = batchParser_1.getBoundary(req.headers['content-type']);
        /**
         * Process the current part and prepare the return part
         * @param part
         */
        function handlePart(part) {
            return __awaiter(this, void 0, void 0, function () {
                var baseUrl, _a, method, url, odataReq, _b, patchData, updatedData, postData, actionResponse, createdData, data, e_1;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            baseUrl = req.baseUrl.replace('/$batch', '');
                            if (config.debug) {
                                console.log(part.rawData.url);
                            }
                            _a = part.rawData.url.split(' '), method = _a[0], url = _a[1];
                            odataReq = metadata.getVersion() === '2.0'
                                ? new odataV2Request_1.ODataV2Request(baseUrl, url, metadata)
                                : new odataV4Request_1.ODataV4Request(baseUrl, url, metadata);
                            _c.label = 1;
                        case 1:
                            _c.trys.push([1, 14, 15, 16]);
                            _b = method;
                            switch (_b) {
                                case 'PATCH': return [3 /*break*/, 2];
                                case 'MERGE': return [3 /*break*/, 2];
                                case 'DELETE': return [3 /*break*/, 4];
                                case 'POST': return [3 /*break*/, 6];
                                case 'GET': return [3 /*break*/, 11];
                            }
                            return [3 /*break*/, 11];
                        case 2:
                            patchData = part.rawData.payload[0].length ? JSON.parse(part.rawData.payload[0]) : {};
                            return [4 /*yield*/, dataAccess.updateData(odataReq, patchData)];
                        case 3:
                            updatedData = _c.sent();
                            part.response = odataReq.createResponse(updatedData);
                            return [3 /*break*/, 13];
                        case 4: return [4 /*yield*/, dataAccess.deleteData(odataReq)];
                        case 5:
                            _c.sent();
                            part.response = odataReq.createResponse(null);
                            return [3 /*break*/, 13];
                        case 6:
                            postData = part.rawData.payload[0].length ? JSON.parse(part.rawData.payload[0]) : {};
                            return [4 /*yield*/, dataAccess.performAction(odataReq, postData)];
                        case 7:
                            actionResponse = _c.sent();
                            if (!(actionResponse === null)) return [3 /*break*/, 9];
                            return [4 /*yield*/, dataAccess.createData(odataReq, postData)];
                        case 8:
                            createdData = _c.sent();
                            part.response = odataReq.createResponse(createdData, true, createdData);
                            return [3 /*break*/, 10];
                        case 9:
                            part.response = odataReq.createResponse(actionResponse);
                            _c.label = 10;
                        case 10: return [3 /*break*/, 13];
                        case 11: return [4 /*yield*/, dataAccess.getData(odataReq)];
                        case 12:
                            data = _c.sent();
                            part.response = odataReq.createResponse(data);
                            return [3 /*break*/, 13];
                        case 13: return [3 /*break*/, 16];
                        case 14:
                            e_1 = _c.sent();
                            part.response = odataReq.createErrorResponse(e_1);
                            return [3 /*break*/, 16];
                        case 15:
                            odataReq.applyResponseHeaders(res);
                            return [7 /*endfinally*/];
                        case 16: return [2 /*return*/];
                    }
                });
            });
        }
        request.getBodyAsString(function (body) { return __awaiter(_this, void 0, void 0, function () {
            var batch;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        batch = batchParser_1.convertBatch(body, boundary);
                        return [4 /*yield*/, Promise.all(batch.parts.map(function (part) { return __awaiter(_this, void 0, void 0, function () {
                                var _this = this;
                                return __generator(this, function (_a) {
                                    switch (_a.label) {
                                        case 0:
                                            if (!part.isChangeSet) return [3 /*break*/, 2];
                                            return [4 /*yield*/, Promise.all(part.parts.map(function (subPart) { return __awaiter(_this, void 0, void 0, function () { return __generator(this, function (_a) {
                                                    switch (_a.label) {
                                                        case 0: return [4 /*yield*/, handlePart(subPart)];
                                                        case 1: return [2 /*return*/, _a.sent()];
                                                    }
                                                }); }); }))];
                                        case 1: return [2 /*return*/, _a.sent()];
                                        case 2: return [4 /*yield*/, handlePart(part)];
                                        case 3: return [2 /*return*/, _a.sent()];
                                    }
                                });
                            }); }))];
                    case 1:
                        _a.sent();
                        writeBatch(batch, mockContext, res);
                        res.end();
                        return [2 /*return*/];
                }
            });
        }); });
    };
}
exports.batchRequestHandler = batchRequestHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcm91dGVyL2JhdGNoL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBLCtDQUFnRDtBQUNoRCw4REFBeUQ7QUFDekQscURBQWtFO0FBSWxFLDREQUEyRDtBQUMzRCw0REFBMkQ7QUFHM0Q7OztHQUdHO0FBQ0gsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0FBQ2QsSUFBTSxXQUFXLEdBQUc7SUFDaEIsaUJBQWlCLEVBQWpCO1FBQ0ksT0FBTyxLQUFLLEVBQUUsQ0FBQztJQUNuQixDQUFDO0NBQ0osQ0FBQztBQUVGOzs7Ozs7R0FNRztBQUNILFNBQVMsVUFBVSxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsUUFBa0I7SUFDbEQsUUFBUSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUM7SUFDMUIsSUFBTSxRQUFRLEdBQUcsUUFBUSxHQUFHLDZCQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDcEQsUUFBUSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsNEJBQTRCLEdBQUcsUUFBUSxDQUFDLENBQUM7SUFDNUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsUUFBUSxHQUFHLE1BQU0sQ0FBQyxDQUFDO0lBQ3pDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUN6QyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDVCxRQUFRLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxRQUFRLEdBQUcsTUFBTSxDQUFDLENBQUM7U0FDaEQ7UUFDRCxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7S0FDM0M7SUFD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QUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBTyxPQUFPOztnRUFBSyxxQkFBTSxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUE7Z0VBQXpCLHNCQUFBLFNBQXlCLEVBQUE7O3lEQUFBLENBQUMsQ0FBQyxFQUFBO2dEQUF0RixzQkFBTyxTQUErRSxFQUFDO2dEQUVoRixxQkFBTSxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUE7Z0RBQTdCLHNCQUFPLFNBQXNCLEVBQUM7OztpQ0FFckMsQ0FBQyxDQUNMLEVBQUE7O3dCQVJELFNBUUMsQ0FBQzt3QkFDRixVQUFVLENBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRSxHQUFHLENBQUMsQ0FBQzt3QkFDcEMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDOzs7O2FBQ2IsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDO0FBQ04sQ0FBQztBQWxGRCxrREFrRkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgUmVxdWVzdEhhbmRsZXIgfSBmcm9tICdleHByZXNzLXNlcnZlLXN0YXRpYy1jb3JlJztcbmltcG9ydCB7IGNyZWF0ZUJvdW5kYXJ5IH0gZnJvbSAnLi9rZXlHZW5lcmF0b3InO1xuaW1wb3J0IHsgY3JlYXRlUmVxdWVzdCB9IGZyb20gJy4vaHR0cC9zaW1wbGVIdHRwUmVxdWVzdCc7XG5pbXBvcnQgeyBnZXRCb3VuZGFyeSwgY29udmVydEJhdGNoIH0gZnJvbSAnLi9jb250ZW50L2JhdGNoUGFyc2VyJztcbmltcG9ydCB7IE9EYXRhTWV0YWRhdGEgfSBmcm9tICcuLi9kYXRhL21ldGFkYXRhJztcbmltcG9ydCB7IERhdGFBY2Nlc3MgfSBmcm9tICcuLi9kYXRhL2RhdGFBY2Nlc3MnO1xuaW1wb3J0IHsgT0RhdGFSZXF1ZXN0IH0gZnJvbSAnLi4vcmVxdWVzdC9vZGF0YVJlcXVlc3QnO1xuaW1wb3J0IHsgT0RhdGFWMlJlcXVlc3QgfSBmcm9tICcuLi9yZXF1ZXN0L29kYXRhVjJSZXF1ZXN0JztcbmltcG9ydCB7IE9EYXRhVjRSZXF1ZXN0IH0gZnJvbSAnLi4vcmVxdWVzdC9vZGF0YVY0UmVxdWVzdCc7XG5pbXBvcnQgeyBTZXJ2ZXJDb25maWcgfSBmcm9tICcuLi8uLi9hcGknO1xuXG4vKipcbiAqIFNpbXBsaWZpZWQvbW9ja2VkIGltcGxlbWVudGF0aW9uIG9mIGEgYmF0Y2ggY29udGV4dCByZXF1aXJlZCBieSB0aGVcbiAqIHhzMi94c29kYXRhIGxpYlxuICovXG5sZXQgaW5kZXggPSAwO1xuY29uc3QgbW9ja0NvbnRleHQgPSB7XG4gICAgZ2V0TmV4dEtleUNvdW50ZXIoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIGluZGV4Kys7XG4gICAgfVxufTtcblxuLyoqXG4gKiBXcml0ZSBiYXRjaCBjb250ZW50IHRvIHRoZSByZXNwb25zZS4gVGhlIG1ldGhvZCBoYXMgYmVlbiBjb3BpZWQgZnJvbSB0aGVcbiAqIHhzMi94c29kYXRhIHByb2plY3QgYW5kIG1vZGlmaWVkIGJlY2F1c2UgRkUgZXhwZWN0cyBzdGF0dXMgY29kZSAyMDIuXG4gKiBAcGFyYW0gYmF0Y2hcbiAqIEBwYXJhbSBjb250ZXh0XG4gKiBAcGFyYW0gcmVzcG9uc2VcbiAqL1xuZnVuY3Rpb24gd3JpdGVCYXRjaChiYXRjaCwgY29udGV4dCwgcmVzcG9uc2U6IFJlc3BvbnNlKTogdm9pZCB7XG4gICAgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9IDIwMDtcbiAgICBjb25zdCBib3VuZGFyeSA9ICdiYXRjaF8nICsgY3JlYXRlQm91bmRhcnkoY29udGV4dCk7XG4gICAgcmVzcG9uc2Uuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnbXVsdGlwYXJ0L21peGVkOyBib3VuZGFyeT0nICsgYm91bmRhcnkpO1xuICAgIHJlc3BvbnNlLndyaXRlKCctLScgKyBib3VuZGFyeSArICdcXHJcXG4nKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJhdGNoLnBhcnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmIChpICE9PSAwKSB7XG4gICAgICAgICAgICByZXNwb25zZS53cml0ZSgnXFxyXFxuLS0nICsgYm91bmRhcnkgKyAnXFxyXFxuJyk7XG4gICAgICAgIH1cbiAgICAgICAgYmF0Y2gucGFydHNbaV0ud3JpdGUoY29udGV4dCwgcmVzcG9uc2UpO1xuICAgIH1cbiAgICByZXNwb25zZS53cml0ZSgnXFxyXFxuLS0nICsgYm91bmRhcnkgKyAnLS1cXHJcXG4nKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGJhdGNoUmVxdWVzdEhhbmRsZXIoXG4gICAgbWV0YWRhdGE6IE9EYXRhTWV0YWRhdGEsXG4gICAgZGF0YUFjY2VzczogRGF0YUFjY2VzcyxcbiAgICBjb25maWc6IFNlcnZlckNvbmZpZ1xuKTogUmVxdWVzdEhhbmRsZXIge1xuICAgIHJldHVybiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogdm9pZCA9PiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSBjcmVhdGVSZXF1ZXN0KHJlcSwgJy8nKTtcbiAgICAgICAgaWYgKG1ldGFkYXRhLmdldFZlcnNpb24oKSA9PT0gJzIuMCcpIHtcbiAgICAgICAgICAgIHJlcy5zZXRIZWFkZXIoJ2RhdGFzZXJ2aWNldmVyc2lvbicsIG1ldGFkYXRhLmdldFZlcnNpb24oKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXMuc2V0SGVhZGVyKCdvZGF0YS12ZXJzaW9uJywgbWV0YWRhdGEuZ2V0VmVyc2lvbigpKTtcbiAgICAgICAgfVxuICAgICAgICByZXMuc3RhdHVzKDIwMCk7XG4gICAgICAgIGNvbnN0IGJvdW5kYXJ5ID0gZ2V0Qm91bmRhcnkocmVxLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogUHJvY2VzcyB0aGUgY3VycmVudCBwYXJ0IGFuZCBwcmVwYXJlIHRoZSByZXR1cm4gcGFydFxuICAgICAgICAgKiBAcGFyYW0gcGFydFxuICAgICAgICAgKi9cbiAgICAgICAgYXN5bmMgZnVuY3Rpb24gaGFuZGxlUGFydChwYXJ0OiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgICAgIGNvbnN0IGJhc2VVcmwgPSByZXEuYmFzZVVybC5yZXBsYWNlKCcvJGJhdGNoJywgJycpO1xuICAgICAgICAgICAgaWYgKGNvbmZpZy5kZWJ1Zykge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHBhcnQucmF3RGF0YS51cmwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgW21ldGhvZCwgdXJsXSA9IHBhcnQucmF3RGF0YS51cmwuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgIGNvbnN0IG9kYXRhUmVxOiBPRGF0YVJlcXVlc3QgPVxuICAgICAgICAgICAgICAgIG1ldGFkYXRhLmdldFZlcnNpb24oKSA9PT0gJzIuMCdcbiAgICAgICAgICAgICAgICAgICAgPyBuZXcgT0RhdGFWMlJlcXVlc3QoYmFzZVVybCwgdXJsLCBtZXRhZGF0YSlcbiAgICAgICAgICAgICAgICAgICAgOiBuZXcgT0RhdGFWNFJlcXVlc3QoYmFzZVVybCwgdXJsLCBtZXRhZGF0YSk7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHN3aXRjaCAobWV0aG9kKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ1BBVENIJzpcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnTUVSR0UnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXRjaERhdGEgPSBwYXJ0LnJhd0RhdGEucGF5bG9hZFswXS5sZW5ndGggPyBKU09OLnBhcnNlKHBhcnQucmF3RGF0YS5wYXlsb2FkWzBdKSA6IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdXBkYXRlZERhdGEgPSBhd2FpdCBkYXRhQWNjZXNzLnVwZGF0ZURhdGEob2RhdGFSZXEsIHBhdGNoRGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJ0LnJlc3BvbnNlID0gb2RhdGFSZXEuY3JlYXRlUmVzcG9uc2UodXBkYXRlZERhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnREVMRVRFJzpcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGRhdGFBY2Nlc3MuZGVsZXRlRGF0YShvZGF0YVJlcSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJ0LnJlc3BvbnNlID0gb2RhdGFSZXEuY3JlYXRlUmVzcG9uc2UobnVsbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUE9TVCc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvc3REYXRhID0gcGFydC5yYXdEYXRhLnBheWxvYWRbMF0ubGVuZ3RoID8gSlNPTi5wYXJzZShwYXJ0LnJhd0RhdGEucGF5bG9hZFswXSkgOiB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGlvblJlc3BvbnNlID0gYXdhaXQgZGF0YUFjY2Vzcy5wZXJmb3JtQWN0aW9uKG9kYXRhUmVxLCBwb3N0RGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aW9uUmVzcG9uc2UgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjcmVhdGVkRGF0YSA9IGF3YWl0IGRhdGFBY2Nlc3MuY3JlYXRlRGF0YShvZGF0YVJlcSwgcG9zdERhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQucmVzcG9uc2UgPSBvZGF0YVJlcS5jcmVhdGVSZXNwb25zZShjcmVhdGVkRGF0YSwgdHJ1ZSwgY3JlYXRlZERhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0LnJlc3BvbnNlID0gb2RhdGFSZXEuY3JlYXRlUmVzcG9uc2UoYWN0aW9uUmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnR0VUJzpcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IGRhdGFBY2Nlc3MuZ2V0RGF0YShvZGF0YVJlcSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJ0LnJlc3BvbnNlID0gb2RhdGFSZXEuY3JlYXRlUmVzcG9uc2UoZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBwYXJ0LnJlc3BvbnNlID0gb2RhdGFSZXEuY3JlYXRlRXJyb3JSZXNwb25zZShlKTtcbiAgICAgICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICAgICAgb2RhdGFSZXEuYXBwbHlSZXNwb25zZUhlYWRlcnMocmVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJlcXVlc3QuZ2V0Qm9keUFzU3RyaW5nKGFzeW5jIChib2R5KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBiYXRjaCA9IGNvbnZlcnRCYXRjaChib2R5LCBib3VuZGFyeSk7XG4gICAgICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgICAgICAgICBiYXRjaC5wYXJ0cy5tYXAoYXN5bmMgKHBhcnQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFydC5pc0NoYW5nZVNldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKHBhcnQucGFydHMubWFwKGFzeW5jIChzdWJQYXJ0KSA9PiBhd2FpdCBoYW5kbGVQYXJ0KHN1YlBhcnQpKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgaGFuZGxlUGFydChwYXJ0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgd3JpdGVCYXRjaChiYXRjaCwgbW9ja0NvbnRleHQsIHJlcyk7XG4gICAgICAgICAgICByZXMuZW5kKCk7XG4gICAgICAgIH0pO1xuICAgIH07XG59XG4iXX0=