"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.FileBasedMockData = void 0;
var lodash_clonedeep_1 = __importDefault(require("lodash.clonedeep"));
var id_1 = require("./id");
var FileBasedMockData = /** @class */ (function () {
    function FileBasedMockData(mockData, entityType, mockDataEntitySet) {
        var _this = this;
        this._entityType = entityType;
        this._mockDataEntitySet = mockDataEntitySet;
        if (mockData.length === 0 && mockData.__generateMockData) {
            this._mockData = this.generateMockData();
        }
        else {
            this._mockData = lodash_clonedeep_1.default(mockData);
            if (this._mockData.forEach) {
                this._mockData.forEach(function (mockLine) {
                    // We need to ensure that complex types are at least partially created
                    _this._entityType.entityProperties.forEach(function (prop) {
                        if (prop.targetType && !mockLine[prop.name]) {
                            mockLine[prop.name] = {};
                            prop.targetType.properties.forEach(function (subProp) {
                                mockLine[prop.name][subProp.name] = _this.getDefaultValueFromType(subProp.type, subProp.targetType, subProp.defaultValue);
                            });
                        }
                    });
                });
            }
        }
    }
    FileBasedMockData.prototype.addEntry = function (mockEntry) {
        this._mockData.push(mockEntry);
    };
    FileBasedMockData.prototype.updateEntry = function (keyValues, updatedData) {
        var dataIndex = this.getDataIndex(keyValues);
        this._mockData[dataIndex] = updatedData;
    };
    FileBasedMockData.prototype.fetchEntries = function (keyValues) {
        var _this = this;
        var keys = this._entityType.keys;
        return this._mockData.filter(function (mockData) {
            return Object.keys(keyValues).every(function (keyName) {
                return _this._mockDataEntitySet.checkKeyValue(mockData, keyValues, keyName, keys.find(function (keyProp) { return keyProp.name === keyName; }));
            });
        });
    };
    FileBasedMockData.prototype.hasEntry = function (keyValues) {
        return this.getDataIndex(keyValues) !== -1;
    };
    FileBasedMockData.prototype.hasEntries = function () {
        return this._mockData.length > 0;
    };
    FileBasedMockData.prototype.getAllEntries = function () {
        return lodash_clonedeep_1.default(this._mockData);
    };
    FileBasedMockData.prototype.getDataIndex = function (keyValues) {
        var _this = this;
        var keys = this._entityType.keys;
        return this._mockData.findIndex(function (mockData) {
            return Object.keys(keyValues).every(function (keyName) {
                return _this._mockDataEntitySet.checkKeyValue(mockData, keyValues, keyName, keys.find(function (keyProp) { return keyProp.name === keyName; }));
            });
        });
    };
    FileBasedMockData.prototype.removeEntry = function (keyValues) {
        var dataIndex = this.getDataIndex(keyValues);
        if (dataIndex !== -1) {
            this._mockData.splice(dataIndex, 1);
        }
    };
    FileBasedMockData.prototype.getDefaultValueFromType = function (type, complexType, defaultValue) {
        var _this = this;
        if (complexType) {
            var outData_1 = {};
            complexType.properties.forEach(function (subProp) {
                outData_1[subProp.name] = _this.getDefaultValueFromType(subProp.type, subProp.targetType, subProp.defaultValue);
            });
            return outData_1;
        }
        else {
            if (defaultValue !== undefined) {
                return defaultValue;
            }
            switch (type) {
                case 'Edm.Int16':
                case 'Edm.Byte':
                case 'Edm.Int32':
                case 'Edm.Int64':
                    return 0;
                case 'Edm.Boolean':
                    return false;
                default:
                    return '';
            }
        }
    };
    FileBasedMockData.prototype.getRandomValueFromType = function (type, complexType, propertyName, lineIndex) {
        var _this = this;
        if (complexType) {
            var outData_2 = {};
            complexType.properties.forEach(function (subProp) {
                outData_2[subProp.name] = _this.getRandomValueFromType(subProp.type, subProp.targetType, subProp.name, lineIndex);
            });
            return outData_2;
        }
        else {
            switch (type) {
                case 'Edm.Int16':
                case 'Edm.Int32':
                case 'Edm.Int64':
                    return Math.floor(Math.random() * 10000);
                case 'Edm.String':
                    return propertyName + "_" + lineIndex;
                case 'Edm.Boolean':
                    return Math.random() < 0.5;
                case 'Edm.Byte':
                    return Math.floor(Math.random() * 10);
                case 'Edm.Decimal':
                    return Math.floor(Math.random() * 100000) / 100;
                case 'Edm.Guid':
                    return id_1.uuidv4();
                case 'Edm.Date':
                case 'Edm.DateTime':
                case 'Edm.DateTimeOffset': {
                    var date = new Date();
                    date.setFullYear(2000 + Math.floor(Math.random() * 22));
                    date.setDate(Math.floor(Math.random() * 30));
                    date.setMonth(Math.floor(Math.random() * 12));
                    date.setMilliseconds(0);
                    return this._mockDataEntitySet.isV4() ? date.toISOString() : '/Date(' + date.getTime() + '+0000)/';
                }
                case 'Edm.Time':
                case 'Time':
                    // ODataModel expects ISO8601 duration format
                    return ('PT' +
                        Math.floor(Math.random() * 23) +
                        'H' +
                        Math.floor(Math.random() * 59) +
                        'M' +
                        Math.floor(Math.random() * 59) +
                        'S');
                case 'Edm.TimeOfDay':
                case 'Edm.Binary':
                default:
                    return '';
                    break;
            }
        }
    };
    FileBasedMockData.prototype.getEmptyObject = function () {
        var _this = this;
        var outObj = {};
        this._entityType.entityProperties.forEach(function (property) {
            outObj[property.name] = _this.getDefaultValueFromType(property.type, property.targetType, property.defaultValue);
        });
        return outObj;
    };
    FileBasedMockData.prototype.getDefaultElement = function () {
        if (this._mockData && !this._mockData.length) {
            return this._mockData;
        }
        else if (this._mockData.length >= 1) {
            return lodash_clonedeep_1.default(this._mockData[0]);
        }
        else {
            return this.getEmptyObject();
        }
    };
    FileBasedMockData.prototype.generateKey = function (property, lineIndex) {
        var currentMockData = this._mockData;
        var highestIndex;
        switch (property.type) {
            case 'Edm.Int32':
                highestIndex = 0;
                currentMockData.forEach(function (mockLine) {
                    var lineIndex = parseInt(mockLine[property.name]);
                    highestIndex = Math.max(highestIndex, lineIndex);
                });
                return highestIndex + 1;
            case 'Edm.Boolean':
                return Math.random() > 0.5;
            case 'Edm.Guid':
                return id_1.uuidv4();
            case 'Edm.String':
                if (lineIndex === undefined) {
                    lineIndex = currentMockData.length + 1;
                }
                return property.name + "_" + lineIndex;
            default:
                return id_1.generateId(12);
        }
    };
    FileBasedMockData.prototype.generateMockDataLine = function (iIndex) {
        var _this = this;
        var outObj = {};
        this._entityType.entityProperties.forEach(function (property) {
            if (property.isKey) {
                outObj[property.name] = _this.generateKey(property, iIndex);
            }
            else {
                outObj[property.name] = _this.getRandomValueFromType(property.type, property.targetType, property.name, iIndex);
            }
        });
        return outObj;
    };
    FileBasedMockData.prototype.generateMockData = function () {
        var mockData = [];
        for (var i = 0; i < 150; i++) {
            mockData.push(this.generateMockDataLine(i));
        }
        return mockData;
    };
    /**
     * Allow to modify the action data beforehand
     * @param actionDefinition
     * @param actionData
     */
    FileBasedMockData.prototype.onBeforeAction = function (actionDefinition, actionData, keys) {
        return actionData;
    };
    /**
     * Do something with the action
     * @param actionDefinition
     * @param actionData
     */
    FileBasedMockData.prototype.executeAction = function (actionDefinition, actionData, keys) {
        return actionData;
    };
    /**
     * Allow to modify the response data
     * @param actionDefinition
     * @param actionData
     */
    FileBasedMockData.prototype.onAfterAction = function (actionDefinition, actionData, keys, responseData) {
        return responseData;
    };
    //eslint-disable-next-line
    FileBasedMockData.prototype.onAfterUpdateEntry = function (keyValues, updatedData) { };
    //eslint-disable-next-line
    FileBasedMockData.prototype.onBeforeUpdateEntry = function (keyValues, updatedData) { };
    //eslint-disable-next-line
    FileBasedMockData.prototype.hasCustomAggregate = function (customAggregateName) {
        return false;
    };
    //eslint-disable-next-line
    FileBasedMockData.prototype.performCustomAggregate = function (customAggregateName, dataToAggregate) { };
    return FileBasedMockData;
}());
exports.FileBasedMockData = FileBasedMockData;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZUJhc2VkTW9ja0RhdGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcm91dGVyL2RhdGEvZmlsZUJhc2VkTW9ja0RhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsc0VBQXlDO0FBRXpDLDJCQUEwQztBQU0xQztJQUlJLDJCQUFZLFFBQWtCLEVBQUUsVUFBc0IsRUFBRSxpQkFBcUM7UUFBN0YsaUJBMEJDO1FBekJHLElBQUksQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFDO1FBRTlCLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxpQkFBaUIsQ0FBQztRQUM1QyxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFLLFFBQWdCLENBQUMsa0JBQWtCLEVBQUU7WUFDL0QsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztTQUM1QzthQUFNO1lBQ0gsSUFBSSxDQUFDLFNBQVMsR0FBRywwQkFBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3JDLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUU7Z0JBQ3hCLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFVBQUMsUUFBUTtvQkFDNUIsc0VBQXNFO29CQUN0RSxLQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQUk7d0JBQzNDLElBQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7NEJBQ3pDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDOzRCQUN6QixJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsVUFBQyxPQUFPO2dDQUN2QyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFJ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O1FBQzlFLE9BQU8sVUFBVSxDQUFDO0lBQ3RCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gseUNBQWEsR0FBYixVQUFjLGdCQUF3QixFQUFFLFVBQWUsRUFBRSxJQUF5QixFQUFFLFlBQWlCO1FBQ2pHLE9BQU8sWUFBWSxDQUFDO0lBQ3hCLENBQUM7SUFFRCwwQkFBMEI7SUFDMUIsOENBQWtCLEdBQWxCLFVBQW1CLFNBQXlCLEVBQUUsV0FBbUIsSUFBUyxDQUFDO0lBQzNFLDBCQUEwQjtJQUMxQiwrQ0FBbUIsR0FBbkIsVUFBb0IsU0FBeUIsRUFBRSxXQUFtQixJQUFTLENBQUM7SUFDNUUsMEJBQTBCO0lBQzFCLDhDQUFrQixHQUFsQixVQUFtQixtQkFBMkI7UUFDMUMsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUNELDBCQUEwQjtJQUMxQixrREFBc0IsR0FBdEIsVUFBdUIsbUJBQTJCLEVBQUUsZUFBc0IsSUFBUSxDQUFDO0lBQ3ZGLHdCQUFDO0FBQUQsQ0FBQyxBQW5TRCxJQW1TQztBQW5TWSw4Q0FBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2xvbmVEZWVwIGZyb20gJ2xvZGFzaC5jbG9uZWRlZXAnO1xuaW1wb3J0IHsgQ29tcGxleFR5cGUsIEVudGl0eVNldCwgUHJvcGVydHksIEVudGl0eVR5cGUgfSBmcm9tICdAc2FwLXV4L2Fubm90YXRpb24tY29udmVydGVyJztcbmltcG9ydCB7IGdlbmVyYXRlSWQsIHV1aWR2NCB9IGZyb20gJy4vaWQnO1xuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSAnQHNhcC11eC92b2NhYnVsYXJpZXMtdHlwZXMnO1xuaW1wb3J0IHsgRW50aXR5U2V0SW50ZXJmYWNlIH0gZnJvbSAnLi9jb21tb24nO1xuXG5leHBvcnQgdHlwZSBLZXlEZWZpbml0aW9ucyA9IFJlY29yZDxzdHJpbmcsIG51bWJlciB8IGJvb2xlYW4gfCBzdHJpbmc+O1xuXG5leHBvcnQgY2xhc3MgRmlsZUJhc2VkTW9ja0RhdGEge1xuICAgIHByb3RlY3RlZCBfbW9ja0RhdGE6IG9iamVjdFtdO1xuICAgIHByb3RlY3RlZCBfZW50aXR5VHlwZTogRW50aXR5VHlwZTtcbiAgICBwcm90ZWN0ZWQgX21vY2tEYXRhRW50aXR5U2V0OiBFbnRpdHlTZXRJbnRlcmZhY2U7XG4gICAgY29uc3RydWN0b3IobW9ja0RhdGE6IG9iamVjdFtdLCBlbnRpdHlUeXBlOiBFbnRpdHlUeXBlLCBtb2NrRGF0YUVudGl0eVNldDogRW50aXR5U2V0SW50ZXJmYWNlKSB7XG4gICAgICAgIHRoaXMuX2VudGl0eVR5cGUgPSBlbnRpdHlUeXBlO1xuXG4gICAgICAgIHRoaXMuX21vY2tEYXRhRW50aXR5U2V0ID0gbW9ja0RhdGFFbnRpdHlTZXQ7XG4gICAgICAgIGlmIChtb2NrRGF0YS5sZW5ndGggPT09IDAgJiYgKG1vY2tEYXRhIGFzIGFueSkuX19nZW5lcmF0ZU1vY2tEYXRhKSB7XG4gICAgICAgICAgICB0aGlzLl9tb2NrRGF0YSA9IHRoaXMuZ2VuZXJhdGVNb2NrRGF0YSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fbW9ja0RhdGEgPSBjbG9uZURlZXAobW9ja0RhdGEpO1xuICAgICAgICAgICAgaWYgKHRoaXMuX21vY2tEYXRhLmZvckVhY2gpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9tb2NrRGF0YS5mb3JFYWNoKChtb2NrTGluZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGVuc3VyZSB0aGF0IGNvbXBsZXggdHlwZXMgYXJlIGF0IGxlYXN0IHBhcnRpYWxseSBjcmVhdGVkXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2VudGl0eVR5cGUuZW50aXR5UHJvcGVydGllcy5mb3JFYWNoKChwcm9wKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvcC50YXJnZXRUeXBlICYmICFtb2NrTGluZVtwcm9wLm5hbWVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9ja0xpbmVbcHJvcC5uYW1lXSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3AudGFyZ2V0VHlwZS5wcm9wZXJ0aWVzLmZvckVhY2goKHN1YlByb3ApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9ja0xpbmVbcHJvcC5uYW1lXVtzdWJQcm9wLm5hbWVdID0gdGhpcy5nZXREZWZhdWx0VmFsdWVGcm9tVHlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YlByb3AudHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YlByb3AudGFyZ2V0VHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YlByb3AuZGVmYXVsdFZhbHVlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgYWRkRW50cnkobW9ja0VudHJ5KTogdm9pZCB7XG4gICAgICAgIHRoaXMuX21vY2tEYXRhLnB1c2gobW9ja0VudHJ5KTtcbiAgICB9XG5cbiAgICB1cGRhdGVFbnRyeShrZXlWYWx1ZXM6IEtleURlZmluaXRpb25zLCB1cGRhdGVkRGF0YTogb2JqZWN0KTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGRhdGFJbmRleCA9IHRoaXMuZ2V0RGF0YUluZGV4KGtleVZhbHVlcyk7XG4gICAgICAgIHRoaXMuX21vY2tEYXRhW2RhdGFJbmRleF0gPSB1cGRhdGVkRGF0YTtcbiAgICB9XG5cbiAgICBmZXRjaEVudHJpZXMoa2V5VmFsdWVzOiBLZXlEZWZpbml0aW9ucyk6IG9iamVjdFtdIHtcbiAgICAgICAgY29uc3Qga2V5cyA9IHRoaXMuX2VudGl0eVR5cGUua2V5cztcbiAgICAgICAgcmV0dXJuIHRoaXMuX21vY2tEYXRhLmZpbHRlcigobW9ja0RhdGEpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhrZXlWYWx1ZXMpLmV2ZXJ5KChrZXlOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21vY2tEYXRhRW50aXR5U2V0LmNoZWNrS2V5VmFsdWUoXG4gICAgICAgICAgICAgICAgICAgIG1vY2tEYXRhLFxuICAgICAgICAgICAgICAgICAgICBrZXlWYWx1ZXMsXG4gICAgICAgICAgICAgICAgICAgIGtleU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGtleXMuZmluZCgoa2V5UHJvcCkgPT4ga2V5UHJvcC5uYW1lID09PSBrZXlOYW1lKSBhcyBQcm9wZXJ0eVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgaGFzRW50cnkoa2V5VmFsdWVzOiBLZXlEZWZpbml0aW9ucyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXREYXRhSW5kZXgoa2V5VmFsdWVzKSAhPT0gLTE7XG4gICAgfVxuXG4gICAgaGFzRW50cmllcygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX21vY2tEYXRhLmxlbmd0aCA+IDA7XG4gICAgfVxuXG4gICAgZ2V0QWxsRW50cmllcygpOiBvYmplY3RbXSB7XG4gICAgICAgIHJldHVybiBjbG9uZURlZXAodGhpcy5fbW9ja0RhdGEpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXREYXRhSW5kZXgoa2V5VmFsdWVzOiBLZXlEZWZpbml0aW9ucyk6IG51bWJlciB7XG4gICAgICAgIGNvbnN0IGtleXMgPSB0aGlzLl9lbnRpdHlUeXBlLmtleXM7XG4gICAgICAgIHJldHVybiB0aGlzLl9tb2NrRGF0YS5maW5kSW5kZXgoKG1vY2tEYXRhKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMoa2V5VmFsdWVzKS5ldmVyeSgoa2V5TmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9tb2NrRGF0YUVudGl0eVNldC5jaGVja0tleVZhbHVlKFxuICAgICAgICAgICAgICAgICAgICBtb2NrRGF0YSxcbiAgICAgICAgICAgICAgICAgICAga2V5VmFsdWVzLFxuICAgICAgICAgICAgICAgICAgICBrZXlOYW1lLFxuICAgICAgICAgICAgICAgICAgICBrZXlzLmZpbmQoKGtleVByb3ApID0+IGtleVByb3AubmFtZSA9PT0ga2V5TmFtZSkgYXMgUHJvcGVydHlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHJlbW92ZUVudHJ5KGtleVZhbHVlczogS2V5RGVmaW5pdGlvbnMpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZGF0YUluZGV4ID0gdGhpcy5nZXREYXRhSW5kZXgoa2V5VmFsdWVzKTtcbiAgICAgICAgaWYgKGRhdGFJbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgIHRoaXMuX21vY2tEYXRhLnNwbGljZShkYXRhSW5kZXgsIDEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldERlZmF1bHRWYWx1ZUZyb21UeXBlKHR5cGU6IHN0cmluZywgY29tcGxleFR5cGU6IENvbXBsZXhUeXBlLCBkZWZhdWx0VmFsdWU/OiBhbnkpOiBhbnkge1xuICAgICAgICBpZiAoY29tcGxleFR5cGUpIHtcbiAgICAgICAgICAgIGNvbnN0IG91dERhdGEgPSB7fTtcbiAgICAgICAgICAgIGNvbXBsZXhUeXBlLnByb3BlcnRpZXMuZm9yRWFjaCgoc3ViUHJvcCkgPT4ge1xuICAgICAgICAgICAgICAgIG91dERhdGFbc3ViUHJvcC5uYW1lXSA9IHRoaXMuZ2V0RGVmYXVsdFZhbHVlRnJvbVR5cGUoXG4gICAgICAgICAgICAgICAgICAgIHN1YlByb3AudHlwZSxcbiAgICAgICAgICAgICAgICAgICAgc3ViUHJvcC50YXJnZXRUeXBlLFxuICAgICAgICAgICAgICAgICAgICBzdWJQcm9wLmRlZmF1bHRWYWx1ZVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBvdXREYXRhO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGRlZmF1bHRWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5JbnQxNic6XG4gICAgICAgICAgICAgICAgY2FzZSAnRWRtLkJ5dGUnOlxuICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5JbnQzMic6XG4gICAgICAgICAgICAgICAgY2FzZSAnRWRtLkludDY0JzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICAgICAgY2FzZSAnRWRtLkJvb2xlYW4nOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldFJhbmRvbVZhbHVlRnJvbVR5cGUoXG4gICAgICAgIHR5cGU6IHN0cmluZyxcbiAgICAgICAgY29tcGxleFR5cGU6IENvbXBsZXhUeXBlLFxuICAgICAgICBwcm9wZXJ0eU5hbWU6IHN0cmluZyxcbiAgICAgICAgbGluZUluZGV4OiBudW1iZXJcbiAgICApOiBhbnkge1xuICAgICAgICBpZiAoY29tcGxleFR5cGUpIHtcbiAgICAgICAgICAgIGNvbnN0IG91dERhdGEgPSB7fTtcbiAgICAgICAgICAgIGNvbXBsZXhUeXBlLnByb3BlcnRpZXMuZm9yRWFjaCgoc3ViUHJvcCkgPT4ge1xuICAgICAgICAgICAgICAgIG91dERhdGFbc3ViUHJvcC5uYW1lXSA9IHRoaXMuZ2V0UmFuZG9tVmFsdWVGcm9tVHlwZShcbiAgICAgICAgICAgICAgICAgICAgc3ViUHJvcC50eXBlLFxuICAgICAgICAgICAgICAgICAgICBzdWJQcm9wLnRhcmdldFR5cGUsXG4gICAgICAgICAgICAgICAgICAgIHN1YlByb3AubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgbGluZUluZGV4XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIG91dERhdGE7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgICAgICAgICAgICBjYXNlICdFZG0uSW50MTYnOlxuICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5JbnQzMic6XG4gICAgICAgICAgICAgICAgY2FzZSAnRWRtLkludDY0JzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEwMDAwKTtcbiAgICAgICAgICAgICAgICBjYXNlICdFZG0uU3RyaW5nJzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAke3Byb3BlcnR5TmFtZX1fJHtsaW5lSW5kZXh9YDtcbiAgICAgICAgICAgICAgICBjYXNlICdFZG0uQm9vbGVhbic6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLnJhbmRvbSgpIDwgMC41O1xuICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5CeXRlJzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEwKTtcbiAgICAgICAgICAgICAgICBjYXNlICdFZG0uRGVjaW1hbCc6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMDAwMDApIC8gMTAwO1xuICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5HdWlkJzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHV1aWR2NCgpO1xuICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5EYXRlJzpcbiAgICAgICAgICAgICAgICBjYXNlICdFZG0uRGF0ZVRpbWUnOlxuICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5EYXRlVGltZU9mZnNldCc6IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIGRhdGUuc2V0RnVsbFllYXIoMjAwMCArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIyKSk7XG4gICAgICAgICAgICAgICAgICAgIGRhdGUuc2V0RGF0ZShNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAzMCkpO1xuICAgICAgICAgICAgICAgICAgICBkYXRlLnNldE1vbnRoKE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEyKSk7XG4gICAgICAgICAgICAgICAgICAgIGRhdGUuc2V0TWlsbGlzZWNvbmRzKDApO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbW9ja0RhdGFFbnRpdHlTZXQuaXNWNCgpID8gZGF0ZS50b0lTT1N0cmluZygpIDogJy9EYXRlKCcgKyBkYXRlLmdldFRpbWUoKSArICcrMDAwMCkvJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2FzZSAnRWRtLlRpbWUnOlxuICAgICAgICAgICAgICAgIGNhc2UgJ1RpbWUnOlxuICAgICAgICAgICAgICAgICAgICAvLyBPRGF0YU1vZGVsIGV4cGVjdHMgSVNPODYwMSBkdXJhdGlvbiBmb3JtYXRcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgICAgICdQVCcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjMpICtcbiAgICAgICAgICAgICAgICAgICAgICAgICdIJyArXG4gICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA1OSkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ00nICtcbiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDU5KSArXG4gICAgICAgICAgICAgICAgICAgICAgICAnUydcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBjYXNlICdFZG0uVGltZU9mRGF5JzpcbiAgICAgICAgICAgICAgICBjYXNlICdFZG0uQmluYXJ5JzpcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0RW1wdHlPYmplY3QoKTogb2JqZWN0IHtcbiAgICAgICAgY29uc3Qgb3V0T2JqID0ge307XG4gICAgICAgIHRoaXMuX2VudGl0eVR5cGUuZW50aXR5UHJvcGVydGllcy5mb3JFYWNoKChwcm9wZXJ0eSkgPT4ge1xuICAgICAgICAgICAgb3V0T2JqW3Byb3BlcnR5Lm5hbWVdID0gdGhpcy5nZXREZWZhdWx0VmFsdWVGcm9tVHlwZShcbiAgICAgICAgICAgICAgICBwcm9wZXJ0eS50eXBlLFxuICAgICAgICAgICAgICAgIHByb3BlcnR5LnRhcmdldFR5cGUsXG4gICAgICAgICAgICAgICAgcHJvcGVydHkuZGVmYXVsdFZhbHVlXG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gb3V0T2JqO1xuICAgIH1cblxuICAgIGdldERlZmF1bHRFbGVtZW50KCk6IG9iamVjdCB7XG4gICAgICAgIGlmICh0aGlzLl9tb2NrRGF0YSAmJiAhdGhpcy5fbW9ja0RhdGEubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fbW9ja0RhdGE7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbW9ja0RhdGEubGVuZ3RoID49IDEpIHtcbiAgICAgICAgICAgIHJldHVybiBjbG9uZURlZXAodGhpcy5fbW9ja0RhdGFbMF0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RW1wdHlPYmplY3QoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdlbmVyYXRlS2V5KHByb3BlcnR5OiBQcm9wZXJ0eSwgbGluZUluZGV4PzogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRNb2NrRGF0YSA9IHRoaXMuX21vY2tEYXRhO1xuICAgICAgICBsZXQgaGlnaGVzdEluZGV4O1xuICAgICAgICBzd2l0Y2ggKHByb3BlcnR5LnR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgJ0VkbS5JbnQzMic6XG4gICAgICAgICAgICAgICAgaGlnaGVzdEluZGV4ID0gMDtcbiAgICAgICAgICAgICAgICBjdXJyZW50TW9ja0RhdGEuZm9yRWFjaCgobW9ja0xpbmU6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW5lSW5kZXggPSBwYXJzZUludChtb2NrTGluZVtwcm9wZXJ0eS5uYW1lXSk7XG4gICAgICAgICAgICAgICAgICAgIGhpZ2hlc3RJbmRleCA9IE1hdGgubWF4KGhpZ2hlc3RJbmRleCwgbGluZUluZGV4KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gaGlnaGVzdEluZGV4ICsgMTtcbiAgICAgICAgICAgIGNhc2UgJ0VkbS5Cb29sZWFuJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5yYW5kb20oKSA+IDAuNTtcbiAgICAgICAgICAgIGNhc2UgJ0VkbS5HdWlkJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gdXVpZHY0KCk7XG4gICAgICAgICAgICBjYXNlICdFZG0uU3RyaW5nJzpcbiAgICAgICAgICAgICAgICBpZiAobGluZUluZGV4ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgbGluZUluZGV4ID0gY3VycmVudE1vY2tEYXRhLmxlbmd0aCArIDE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBgJHtwcm9wZXJ0eS5uYW1lfV8ke2xpbmVJbmRleH1gO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gZ2VuZXJhdGVJZCgxMik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZW5lcmF0ZU1vY2tEYXRhTGluZShpSW5kZXg6IG51bWJlcikge1xuICAgICAgICBjb25zdCBvdXRPYmogPSB7fTtcbiAgICAgICAgdGhpcy5fZW50aXR5VHlwZS5lbnRpdHlQcm9wZXJ0aWVzLmZvckVhY2goKHByb3BlcnR5KSA9PiB7XG4gICAgICAgICAgICBpZiAocHJvcGVydHkuaXNLZXkpIHtcbiAgICAgICAgICAgICAgICBvdXRPYmpbcHJvcGVydHkubmFtZV0gPSB0aGlzLmdlbmVyYXRlS2V5KHByb3BlcnR5LCBpSW5kZXgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBvdXRPYmpbcHJvcGVydHkubmFtZV0gPSB0aGlzLmdldFJhbmRvbVZhbHVlRnJvbVR5cGUoXG4gICAgICAgICAgICAgICAgICAgIHByb3BlcnR5LnR5cGUsXG4gICAgICAgICAgICAgICAgICAgIHByb3BlcnR5LnRhcmdldFR5cGUsXG4gICAgICAgICAgICAgICAgICAgIHByb3BlcnR5Lm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGlJbmRleFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBvdXRPYmo7XG4gICAgfVxuXG4gICAgZ2VuZXJhdGVNb2NrRGF0YSgpIHtcbiAgICAgICAgY29uc3QgbW9ja0RhdGEgPSBbXTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxNTA7IGkrKykge1xuICAgICAgICAgICAgbW9ja0RhdGEucHVzaCh0aGlzLmdlbmVyYXRlTW9ja0RhdGFMaW5lKGkpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbW9ja0RhdGE7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWxsb3cgdG8gbW9kaWZ5IHRoZSBhY3Rpb24gZGF0YSBiZWZvcmVoYW5kXG4gICAgICogQHBhcmFtIGFjdGlvbkRlZmluaXRpb25cbiAgICAgKiBAcGFyYW0gYWN0aW9uRGF0YVxuICAgICAqL1xuICAgIG9uQmVmb3JlQWN0aW9uKGFjdGlvbkRlZmluaXRpb246IEFjdGlvbiwgYWN0aW9uRGF0YTogYW55LCBrZXlzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogb2JqZWN0IHtcbiAgICAgICAgcmV0dXJuIGFjdGlvbkRhdGE7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIERvIHNvbWV0aGluZyB3aXRoIHRoZSBhY3Rpb25cbiAgICAgKiBAcGFyYW0gYWN0aW9uRGVmaW5pdGlvblxuICAgICAqIEBwYXJhbSBhY3Rpb25EYXRhXG4gICAgICovXG4gICAgZXhlY3V0ZUFjdGlvbihhY3Rpb25EZWZpbml0aW9uOiBBY3Rpb24sIGFjdGlvbkRhdGE6IGFueSwga2V5czogUmVjb3JkPHN0cmluZywgYW55Pik6IG9iamVjdCB7XG4gICAgICAgIHJldHVybiBhY3Rpb25EYXRhO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFsbG93IHRvIG1vZGlmeSB0aGUgcmVzcG9uc2UgZGF0YVxuICAgICAqIEBwYXJhbSBhY3Rpb25EZWZpbml0aW9uXG4gICAgICogQHBhcmFtIGFjdGlvbkRhdGFcbiAgICAgKi9cbiAgICBvbkFmdGVyQWN0aW9uKGFjdGlvbkRlZmluaXRpb246IEFjdGlvbiwgYWN0aW9uRGF0YTogYW55LCBrZXlzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LCByZXNwb25zZURhdGE6IGFueSk6IGFueSB7XG4gICAgICAgIHJldHVybiByZXNwb25zZURhdGE7XG4gICAgfVxuXG4gICAgLy9lc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmVcbiAgICBvbkFmdGVyVXBkYXRlRW50cnkoa2V5VmFsdWVzOiBLZXlEZWZpbml0aW9ucywgdXBkYXRlZERhdGE6IG9iamVjdCk6IHZvaWQge31cbiAgICAvL2VzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICAgIG9uQmVmb3JlVXBkYXRlRW50cnkoa2V5VmFsdWVzOiBLZXlEZWZpbml0aW9ucywgdXBkYXRlZERhdGE6IG9iamVjdCk6IHZvaWQge31cbiAgICAvL2VzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICAgIGhhc0N1c3RvbUFnZ3JlZ2F0ZShjdXN0b21BZ2dyZWdhdGVOYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICAvL2VzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICAgIHBlcmZvcm1DdXN0b21BZ2dyZWdhdGUoY3VzdG9tQWdncmVnYXRlTmFtZTogc3RyaW5nLCBkYXRhVG9BZ2dyZWdhdGU6IGFueVtdKTogYW55IHt9XG59XG4iXX0=