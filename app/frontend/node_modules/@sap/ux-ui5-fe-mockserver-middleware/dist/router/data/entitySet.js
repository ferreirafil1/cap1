"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MockDataEntitySet = void 0;
var path_1 = require("path");
var lodash_clonedeep_1 = __importDefault(require("lodash.clonedeep"));
var fileBasedMockData_1 = require("./fileBasedMockData");
var functionBasedMockData_1 = require("./functionBasedMockData");
var fileLoader_1 = require("../utils/fileLoader");
var MockDataEntitySet = /** @class */ (function () {
    function MockDataEntitySet(rootFolder, entitySetDefinition, dataAccess, generateMockData, initializeMockData, isDraft) {
        var _this = this;
        if (initializeMockData === void 0) { initializeMockData = true; }
        if (isDraft === void 0) { isDraft = false; }
        this._rootMockData = [];
        this.contextBasedMockData = {};
        if (entitySetDefinition._type === 'EntityType') {
            this.entitySetDefinition = null;
            this.entityTypeDefinition = entitySetDefinition;
        }
        else {
            this.entitySetDefinition = entitySetDefinition;
            this.entityTypeDefinition = this.entitySetDefinition.entityType;
        }
        this.dataAccess = dataAccess;
        if (initializeMockData) {
            this.readyPromise = MockDataEntitySet.read(rootFolder, entitySetDefinition.name, generateMockData, isDraft).then(function (mockData) {
                if (typeof mockData === 'object' && !Array.isArray(mockData)) {
                    _this._rootMockDataFn = mockData;
                }
                else {
                    _this._rootMockData = mockData;
                }
                return _this;
            });
        }
    }
    MockDataEntitySet.read = function (mockDataRootFolder, entity, generateMockData, isDraft) {
        return __awaiter(this, void 0, void 0, function () {
            var path, jsPath, out;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        path = path_1.join(mockDataRootFolder, entity) + '.json';
                        jsPath = path_1.join(mockDataRootFolder, entity) + '.js';
                        return [4 /*yield*/, fileLoader_1.exists(jsPath)];
                    case 1:
                        if (!_a.sent()) return [3 /*break*/, 2];
                        try {
                            //eslint-disable-next-line
                            return [2 /*return*/, fileLoader_1.loadJS(jsPath)];
                        }
                        catch (e) {
                            console.error(e);
                            return [2 /*return*/, Promise.resolve([])];
                        }
                        return [3 /*break*/, 4];
                    case 2: return [4 /*yield*/, fileLoader_1.exists(path)];
                    case 3:
                        if (_a.sent()) {
                            try {
                                return [2 /*return*/, fileLoader_1.loadFile(path).then(function (fileContent) {
                                        if (fileContent.length === 0) {
                                            return [];
                                        }
                                        var jsonData = JSON.parse(fileContent);
                                        if (isDraft) {
                                            jsonData.forEach(function (jsonLine) {
                                                var IsActiveEntityValue = jsonLine.IsActiveEntity;
                                                if (IsActiveEntityValue === undefined) {
                                                    jsonLine.IsActiveEntity = true;
                                                    jsonLine.HasActiveEntity = true;
                                                    jsonLine.HasDraftEntity = false;
                                                }
                                            });
                                        }
                                        return jsonData;
                                    })];
                            }
                            catch (_b) {
                                return [2 /*return*/, Promise.resolve([])];
                            }
                        }
                        else {
                            out = [];
                            if (generateMockData) {
                                out.__generateMockData = generateMockData;
                            }
                            return [2 /*return*/, Promise.resolve(out)];
                        }
                        _a.label = 4;
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    MockDataEntitySet.prototype.getMockData = function (contextId) {
        if (!Object.prototype.hasOwnProperty.apply(this.contextBasedMockData, [contextId])) {
            this.contextBasedMockData[contextId] = this._rootMockDataFn
                ? new functionBasedMockData_1.FunctionBasedMockData(this._rootMockDataFn, this.entityTypeDefinition, this, contextId)
                : new fileBasedMockData_1.FileBasedMockData(this._rootMockData, this.entityTypeDefinition, this);
        }
        return this.contextBasedMockData[contextId];
    };
    MockDataEntitySet.prototype.checkKeys = function (keyValues, dataLine, keyDefinition) {
        var _this = this;
        return Object.keys(keyValues).every(function (keyName) {
            return _this.checkKeyValue(dataLine, keyValues, keyName, keyDefinition.find(function (keyProp) { return keyProp.name === keyName; }));
        });
    };
    MockDataEntitySet.prototype.checkSpecificProperties = function (filterExpression, mockData, allData, forceToLower) {
        if (forceToLower === void 0) { forceToLower = false; }
        return true;
    };
    MockDataEntitySet.prototype.isV4 = function () {
        return this.dataAccess.isV4();
    };
    MockDataEntitySet.prototype.checkFilter = function (mockData, filterExpression, tenantId) {
        var _this = this;
        var isValid = true;
        if (Array.isArray(filterExpression)) {
            if (filterExpression.operator === 'AND') {
                isValid = filterExpression.every(function (filterValue) {
                    return _this.checkFilter(mockData, filterValue, tenantId);
                });
            }
            else {
                isValid = filterExpression.some(function (filterValue) {
                    return _this.checkFilter(mockData, filterValue, tenantId);
                });
            }
        }
        else {
            var forceLowerCase = false;
            if (filterExpression.prop.indexOf('tolower') === 0) {
                forceLowerCase = true;
                filterExpression.prop = filterExpression.prop.substr(8, filterExpression.prop.length - 9);
            }
            if (filterExpression.eqValue.indexOf('tolower') === 0) {
                filterExpression.eqValue = filterExpression.eqValue
                    .substr(8, filterExpression.eqValue.length - 9)
                    .toLowerCase();
            }
            var property = this.entityTypeDefinition.entityProperties.find(function (prop) { return prop.name === filterExpression.prop; });
            if (!property) {
                var currentMockData = this.getMockData(tenantId);
                return this.checkSpecificProperties(filterExpression, mockData, currentMockData, forceLowerCase);
            }
            var hasIntValue = false;
            switch (property.type) {
                case 'Edm.Boolean':
                    isValid = !!mockData[filterExpression.prop] === (filterExpression.eqValue === 'true');
                    break;
                case 'Edm.String':
                case 'Edm.Guid':
                    if (filterExpression.eqValue && filterExpression.eqValue.startsWith("'")) {
                        var valueToTest = forceLowerCase
                            ? mockData[filterExpression.prop].toLowerCase()
                            : mockData[filterExpression.prop];
                        isValid =
                            valueToTest === filterExpression.eqValue.substr(1, filterExpression.eqValue.length - 2);
                    }
                    else {
                        isValid = mockData[filterExpression.prop] === filterExpression.eqValue;
                    }
                    break;
                case 'Edm.Byte':
                case 'Edm.Int16':
                case 'Edm.Int32':
                case 'Edm.Int64': {
                    var testValue = parseInt(filterExpression.eqValue);
                    switch (filterExpression.operator) {
                        case 'gt':
                            isValid = mockData[filterExpression.prop] > testValue;
                            break;
                        case 'ge':
                            isValid = mockData[filterExpression.prop] >= testValue;
                            break;
                        case 'lt':
                            isValid = mockData[filterExpression.prop] < testValue;
                            break;
                        case 'le':
                            isValid = mockData[filterExpression.prop] <= testValue;
                            break;
                        case 'ne':
                            isValid = mockData[filterExpression.prop] !== testValue;
                            break;
                        case 'eq':
                        default:
                            isValid = mockData[filterExpression.prop] === testValue;
                            break;
                    }
                    break;
                }
                case 'Edm.Decimal': {
                    var testValue = parseFloat(filterExpression.eqValue);
                    switch (filterExpression.operator) {
                        case 'gt':
                            isValid = mockData[filterExpression.prop] > testValue;
                            break;
                        case 'ge':
                            isValid = mockData[filterExpression.prop] >= testValue;
                            break;
                        case 'lt':
                            isValid = mockData[filterExpression.prop] < testValue;
                            break;
                        case 'le':
                            isValid = mockData[filterExpression.prop] <= testValue;
                            break;
                        case 'ne':
                            isValid = mockData[filterExpression.prop] !== testValue;
                            break;
                        case 'eq':
                        default:
                            isValid = mockData[filterExpression.prop] === testValue;
                            break;
                    }
                    break;
                }
                default:
                    break;
            }
        }
        return isValid;
    };
    MockDataEntitySet.prototype.checkSearch = function (mockData, searchQuery) {
        return this.entityTypeDefinition.entityProperties
            .filter(function (property) {
            switch (property.type) {
                case 'Edm.Boolean':
                case 'Edm.Int32':
                    return false;
                case 'Edm.String':
                    return true;
                default:
                    return false;
            }
        })
            .some(function (property) {
            var mockValue = mockData[property.name];
            return mockValue && mockValue.indexOf(searchQuery) !== -1;
        });
    };
    MockDataEntitySet.prototype.checkKeyValue = function (mockData, keyValues, keyName, keyProp) {
        if (keyProp) {
            switch (keyProp.type) {
                case 'Edm.Guid':
                    if (keyValues[keyName] && keyValues[keyName].startsWith("guid'")) {
                        return mockData[keyName] === keyValues[keyName].substr(5, keyValues[keyName].length - 6);
                    }
                    return mockData[keyName] === keyValues[keyName];
                case 'Edm.String':
                    if (keyValues[keyName] && keyValues[keyName].startsWith("'")) {
                        return mockData[keyName] === keyValues[keyName].substr(1, keyValues[keyName].length - 2);
                    }
                    return mockData[keyName] === keyValues[keyName];
                case 'Edm.Int32':
                case 'Edm.Int64':
                case 'Edm.Int16':
                    return mockData[keyName] === parseInt(keyValues[keyName]);
                default:
                    return mockData[keyName] === keyValues[keyName];
            }
        }
        return mockData[keyName] === keyValues[keyName];
    };
    MockDataEntitySet.prototype.getKeys = function (dataLine) {
        var keys = this.entityTypeDefinition.keys;
        var keyValues = {};
        keys.forEach(function (keyProp) {
            keyValues[keyProp.name] = dataLine[keyProp.name];
        });
        return keyValues;
    };
    MockDataEntitySet.prototype.prepareKeys = function (keyValues) {
        var _this = this;
        var outKeys = {};
        if (keyValues === undefined) {
            return outKeys;
        }
        if (Object.keys(keyValues).length === 1 && Object.values(keyValues)[0] === undefined) {
            var keyValue_1;
            Object.keys(keyValues).forEach(function (keyName) {
                keyValue_1 = keyName;
                if (keyValue_1.startsWith("'")) {
                    keyValue_1 = keyValue_1.substr(1, keyValue_1.length - 2);
                }
            });
            var keyName = this.entityTypeDefinition.keys[0].name;
            outKeys[keyName] = keyValue_1;
        }
        else {
            outKeys = keyValues;
        }
        // Remove non key items only if all keys are provided
        var realKeys = outKeys;
        if (this.entityTypeDefinition.keys.every(function (keyProp) { return outKeys[keyProp.name] !== undefined; })) {
            realKeys = {};
            Object.keys(outKeys).forEach(function (keyName) {
                if (_this.entityTypeDefinition.keys.find(function (keyProp) { return keyProp.name === keyName; })) {
                    realKeys[keyName] = outKeys[keyName];
                }
            });
        }
        return realKeys;
    };
    MockDataEntitySet.prototype.performGET = function (keyValues, asArray, tenantId, dontClone) {
        var _a, _b, _c, _d, _e;
        if (dontClone === void 0) { dontClone = false; }
        var currentMockData = this.getMockData(tenantId);
        if (keyValues && Object.keys(keyValues).length) {
            keyValues = this.prepareKeys(keyValues);
            var data = currentMockData.fetchEntries(keyValues);
            if (!data || (Array.isArray(data) && data.length === 0 && !asArray)) {
                if (!currentMockData.hasEntries()) {
                    return currentMockData.getEmptyObject();
                }
                else {
                    return null;
                }
            }
            if (Array.isArray(data) && !asArray) {
                if (dontClone) {
                    return data[0];
                }
                return lodash_clonedeep_1.default(data[0]);
            }
            if (dontClone) {
                return data;
            }
            return lodash_clonedeep_1.default(data);
        }
        if ((_e = (_d = (_c = (_b = (_a = this.entitySetDefinition) === null || _a === void 0 ? void 0 : _a.entityType) === null || _b === void 0 ? void 0 : _b.annotations) === null || _c === void 0 ? void 0 : _c.Common) === null || _d === void 0 ? void 0 : _d.ResultContext) === null || _e === void 0 ? void 0 : _e.valueOf()) {
            // Parametrized entityset, they cannot be requested directly
            throw new Error(JSON.stringify({ message: 'Parametrized entityset need to be queried with keys' }));
        }
        if (!asArray) {
            return lodash_clonedeep_1.default(currentMockData.getDefaultElement());
        }
        return currentMockData.getAllEntries();
    };
    MockDataEntitySet.prototype.performPOST = function (keyValues, postData, tenantId) {
        // Validate potentially missing keys
        keyValues = this.prepareKeys(keyValues);
        var currentMockData = this.getMockData(tenantId);
        Object.keys(keyValues).forEach(function (key) {
            if (!postData[key]) {
                postData[key] = keyValues[key];
            }
        });
        this.entityTypeDefinition.keys.forEach(function (keyProp) {
            if (postData[keyProp.name] === undefined || postData[keyProp.name].length === 0) {
                // Missing key
                if (keyProp.name === 'IsActiveEntity') {
                    postData['IsActiveEntity'] = false;
                }
                else {
                    postData[keyProp.name] = currentMockData.generateKey(keyProp);
                }
            }
        });
        var newObject = currentMockData.getEmptyObject();
        newObject = Object.assign(newObject, postData);
        currentMockData.addEntry(newObject);
        return newObject;
    };
    MockDataEntitySet.prototype.performPATCH = function (keyValues, patchData, tenantId) {
        keyValues = this.prepareKeys(keyValues);
        var data = this.performGET(keyValues, false, tenantId);
        var currentMockData = this.getMockData(tenantId);
        var updatedData = Object.assign(data, patchData);
        currentMockData.onBeforeUpdateEntry(keyValues, updatedData);
        currentMockData.updateEntry(keyValues, updatedData);
        currentMockData.onAfterUpdateEntry(keyValues, updatedData);
        return updatedData;
    };
    MockDataEntitySet.prototype.performDELETE = function (keyValues, tenantId) {
        return __awaiter(this, void 0, void 0, function () {
            var currentMockData;
            return __generator(this, function (_a) {
                currentMockData = this.getMockData(tenantId);
                keyValues = this.prepareKeys(keyValues);
                currentMockData.removeEntry(keyValues);
                return [2 /*return*/];
            });
        });
    };
    MockDataEntitySet.prototype.executeAction = function (actionDefinition, actionData, odataRequest, keys) {
        return __awaiter(this, void 0, void 0, function () {
            var currentMockData, responseObject;
            return __generator(this, function (_a) {
                currentMockData = this.getMockData(odataRequest.tenantId);
                keys = this.prepareKeys(keys);
                actionData = currentMockData.onBeforeAction(actionDefinition, actionData, keys);
                responseObject = currentMockData.executeAction(actionDefinition, actionData, keys);
                responseObject = currentMockData.onAfterAction(actionDefinition, actionData, keys, responseObject);
                return [2 /*return*/, responseObject];
            });
        });
    };
    return MockDataEntitySet;
}());
exports.MockDataEntitySet = MockDataEntitySet;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5U2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3JvdXRlci9kYXRhL2VudGl0eVNldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw2QkFBNEI7QUFJNUIsc0VBQXlDO0FBQ3pDLHlEQUF3RTtBQUN4RSxpRUFBcUY7QUFDckYsa0RBQStEO0FBRy9EO0lBeURJLDJCQUNJLFVBQWtCLEVBQ2xCLG1CQUEyQyxFQUMzQyxVQUErQixFQUMvQixnQkFBeUIsRUFDekIsa0JBQXlCLEVBQ3pCLE9BQWU7UUFObkIsaUJBZ0NDO1FBM0JHLG1DQUFBLEVBQUEseUJBQXlCO1FBQ3pCLHdCQUFBLEVBQUEsZUFBZTtRQWRULGtCQUFhLEdBQWEsRUFBRSxDQUFDO1FBRTdCLHlCQUFvQixHQUFzQyxFQUFFLENBQUM7UUFjbkUsSUFBSSxtQkFBbUIsQ0FBQyxLQUFLLEtBQUssWUFBWSxFQUFFO1lBQzVDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUM7WUFDaEMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLG1CQUFpQyxDQUFDO1NBQ2pFO2FBQU07WUFDSCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsbUJBQWdDLENBQUM7WUFDNUQsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxVQUFVLENBQUM7U0FDbkU7UUFFRCxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUM3QixJQUFJLGtCQUFrQixFQUFFO1lBQ3BCLElBQUksQ0FBQyxZQUFZLEdBQUcsaUJBQWlCLENBQUMsSUFBSSxDQUN0QyxVQUFVLEVBQ1YsbUJBQW1CLENBQUMsSUFBSSxFQUN4QixnQkFBZ0IsRUFDaEIsT0FBTyxDQUNWLENBQUMsSUFBSSxDQUFDLFVBQUMsUUFBUTtnQkFDWixJQUFJLE9BQU8sUUFBUSxLQUFLLFFBQVEsSUFBSSxDQUFDLEtB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RSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDOUIsVUFBVSxHQUFHLGVBQWUsQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUM1RSxjQUFjLEdBQUcsZUFBZSxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ3ZGLGNBQWMsR0FBRyxlQUFlLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsY0FBYyxDQUFDLENBQUM7Z0JBQ25HLHNCQUFPLGNBQWMsRUFBQzs7O0tBQ3pCO0lBQ0wsd0JBQUM7QUFBRCxDQUFDLEFBblpELElBbVpDO0FBblpZLDhDQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcblxuaW1wb3J0IHsgT0RhdGFSZXF1ZXN0IH0gZnJvbSAnLi4vcmVxdWVzdC9vZGF0YVJlcXVlc3QnO1xuaW1wb3J0IHsgRW50aXR5U2V0LCBFbnRpdHlUeXBlLCBBY3Rpb24sIFByb3BlcnR5LCBDb21wbGV4VHlwZSB9IGZyb20gJ0BzYXAtdXgvYW5ub3RhdGlvbi1jb252ZXJ0ZXInO1xuaW1wb3J0IGNsb25lRGVlcCBmcm9tICdsb2Rhc2guY2xvbmVkZWVwJztcbmltcG9ydCB7IEZpbGVCYXNlZE1vY2tEYXRhLCBLZXlEZWZpbml0aW9ucyB9IGZyb20gJy4vZmlsZUJhc2VkTW9ja0RhdGEnO1xuaW1wb3J0IHsgRnVuY3Rpb25CYXNlZE1vY2tEYXRhLCBNb2NrRGF0YUNvbnRyaWJ1dG9yIH0gZnJvbSAnLi9mdW5jdGlvbkJhc2VkTW9ja0RhdGEnO1xuaW1wb3J0IHsgbG9hZEZpbGUsIGV4aXN0cywgbG9hZEpTIH0gZnJvbSAnLi4vdXRpbHMvZmlsZUxvYWRlcic7XG5pbXBvcnQgeyBEYXRhQWNjZXNzSW50ZXJmYWNlLCBFbnRpdHlTZXRJbnRlcmZhY2UgfSBmcm9tICcuL2NvbW1vbic7XG5cbmV4cG9ydCBjbGFzcyBNb2NrRGF0YUVudGl0eVNldCBpbXBsZW1lbnRzIEVudGl0eVNldEludGVyZmFjZSB7XG4gICAgcHVibGljIHN0YXRpYyBhc3luYyByZWFkKFxuICAgICAgICBtb2NrRGF0YVJvb3RGb2xkZXI6IHN0cmluZyxcbiAgICAgICAgZW50aXR5OiBzdHJpbmcsXG4gICAgICAgIGdlbmVyYXRlTW9ja0RhdGE6IGJvb2xlYW4sXG4gICAgICAgIGlzRHJhZnQ6IGJvb2xlYW5cbiAgICApOiBQcm9taXNlPG9iamVjdFtdPiB7XG4gICAgICAgIGNvbnN0IHBhdGggPSBqb2luKG1vY2tEYXRhUm9vdEZvbGRlciwgZW50aXR5KSArICcuanNvbic7XG4gICAgICAgIGNvbnN0IGpzUGF0aCA9IGpvaW4obW9ja0RhdGFSb290Rm9sZGVyLCBlbnRpdHkpICsgJy5qcyc7XG4gICAgICAgIGlmIChhd2FpdCBleGlzdHMoanNQYXRoKSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAvL2VzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICAgICAgICAgICAgICAgIHJldHVybiBsb2FkSlMoanNQYXRoKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW10pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGF3YWl0IGV4aXN0cyhwYXRoKSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbG9hZEZpbGUocGF0aCkudGhlbigoZmlsZUNvbnRlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGVDb250ZW50Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGpzb25EYXRhID0gSlNPTi5wYXJzZShmaWxlQ29udGVudCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0RyYWZ0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBqc29uRGF0YS5mb3JFYWNoKChqc29uTGluZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IElzQWN0aXZlRW50aXR5VmFsdWUgPSBqc29uTGluZS5Jc0FjdGl2ZUVudGl0eTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoSXNBY3RpdmVFbnRpdHlWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpzb25MaW5lLklzQWN0aXZlRW50aXR5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganNvbkxpbmUuSGFzQWN0aXZlRW50aXR5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganNvbkxpbmUuSGFzRHJhZnRFbnRpdHkgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBqc29uRGF0YTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW10pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3Qgb3V0ID0gW107XG4gICAgICAgICAgICBpZiAoZ2VuZXJhdGVNb2NrRGF0YSkge1xuICAgICAgICAgICAgICAgIChvdXQgYXMgYW55KS5fX2dlbmVyYXRlTW9ja0RhdGEgPSBnZW5lcmF0ZU1vY2tEYXRhO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShvdXQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF9yb290TW9ja0RhdGE6IG9iamVjdFtdID0gW107XG4gICAgcHJpdmF0ZSBfcm9vdE1vY2tEYXRhRm46IE1vY2tEYXRhQ29udHJpYnV0b3I7XG4gICAgcHJvdGVjdGVkIGNvbnRleHRCYXNlZE1vY2tEYXRhOiBSZWNvcmQ8c3RyaW5nLCBGaWxlQmFzZWRNb2NrRGF0YT4gPSB7fTtcbiAgICBwdWJsaWMgcmVhZHlQcm9taXNlOiBQcm9taXNlPE1vY2tEYXRhRW50aXR5U2V0PjtcbiAgICBwcm90ZWN0ZWQgZW50aXR5U2V0RGVmaW5pdGlvbjogRW50aXR5U2V0IHwgbnVsbDtcbiAgICBwcm90ZWN0ZWQgZW50aXR5VHlwZURlZmluaXRpb246IEVudGl0eVR5cGU7XG4gICAgcHJvdGVjdGVkIGRhdGFBY2Nlc3M6IERhdGFBY2Nlc3NJbnRlcmZhY2U7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcm9vdEZvbGRlcjogc3RyaW5nLFxuICAgICAgICBlbnRpdHlTZXREZWZpbml0aW9uOiBFbnRpdHlTZXQgfCBFbnRpdHlUeXBlLFxuICAgICAgICBkYXRhQWNjZXNzOiBEYXRhQWNjZXNzSW50ZXJmYWNlLFxuICAgICAgICBnZW5lcmF0ZU1vY2tEYXRhOiBib29sZWFuLFxuICAgICAgICBpbml0aWFsaXplTW9ja0RhdGEgPSB0cnVlLFxuICAgICAgICBpc0RyYWZ0ID0gZmFsc2VcbiAgICApIHtcbiAgICAgICAgaWYgKGVudGl0eVNldERlZmluaXRpb24uX3R5cGUgPT09ICdFbnRpdHlUeXBlJykge1xuICAgICAgICAgICAgdGhpcy5lbnRpdHlTZXREZWZpbml0aW9uID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMuZW50aXR5VHlwZURlZmluaXRpb24gPSBlbnRpdHlTZXREZWZpbml0aW9uIGFzIEVudGl0eVR5cGU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmVudGl0eVNldERlZmluaXRpb24gPSBlbnRpdHlTZXREZWZpbml0aW9uIGFzIEVudGl0eVNldDtcbiAgICAgICAgICAgIHRoaXMuZW50aXR5VHlwZURlZmluaXRpb24gPSB0aGlzLmVudGl0eVNldERlZmluaXRpb24uZW50aXR5VHlwZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZGF0YUFjY2VzcyA9IGRhdGFBY2Nlc3M7XG4gICAgICAgIGlmIChpbml0aWFsaXplTW9ja0RhdGEpIHtcbiAgICAgICAgICAgIHRoaXMucmVhZHlQcm9taXNlID0gTW9ja0RhdGFFbnRpdHlTZXQucmVhZChcbiAgICAgICAgICAgICAgICByb290Rm9sZGVyLFxuICAgICAgICAgICAgICAgIGVudGl0eVNldERlZmluaXRpb24ubmFtZSxcbiAgICAgICAgICAgICAgICBnZW5lcmF0ZU1vY2tEYXRhLFxuICAgICAgICAgICAgICAgIGlzRHJhZnRcbiAgICAgICAgICAgICkudGhlbigobW9ja0RhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG1vY2tEYXRhID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheShtb2NrRGF0YSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcm9vdE1vY2tEYXRhRm4gPSBtb2NrRGF0YSBhcyBNb2NrRGF0YUNvbnRyaWJ1dG9yO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jvb3RNb2NrRGF0YSA9IG1vY2tEYXRhO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldE1vY2tEYXRhKGNvbnRleHRJZDogc3RyaW5nKTogRmlsZUJhc2VkTW9ja0RhdGEge1xuICAgICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuYXBwbHkodGhpcy5jb250ZXh0QmFzZWRNb2NrRGF0YSwgW2NvbnRleHRJZF0pKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRleHRCYXNlZE1vY2tEYXRhW2NvbnRleHRJZF0gPSB0aGlzLl9yb290TW9ja0RhdGFGblxuICAgICAgICAgICAgICAgID8gbmV3IEZ1bmN0aW9uQmFzZWRNb2NrRGF0YSh0aGlzLl9yb290TW9ja0RhdGFGbiwgdGhpcy5lbnRpdHlUeXBlRGVmaW5pdGlvbiwgdGhpcywgY29udGV4dElkKVxuICAgICAgICAgICAgICAgIDogbmV3IEZpbGVCYXNlZE1vY2tEYXRhKHRoaXMuX3Jvb3RNb2NrRGF0YSwgdGhpcy5lbnRpdHlUeXBlRGVmaW5pdGlvbiwgdGhpcyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuY29udGV4dEJhc2VkTW9ja0RhdGFbY29udGV4dElkXTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgY2hlY2tLZXlzKGtleVZhbHVlczogS2V5RGVmaW5pdGlvbnMsIGRhdGFMaW5lOiBvYmplY3QsIGtleURlZmluaXRpb246IFByb3BlcnR5W10pOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGtleVZhbHVlcykuZXZlcnkoKGtleU5hbWUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNoZWNrS2V5VmFsdWUoXG4gICAgICAgICAgICAgICAgZGF0YUxpbmUsXG4gICAgICAgICAgICAgICAga2V5VmFsdWVzLFxuICAgICAgICAgICAgICAgIGtleU5hbWUsXG4gICAgICAgICAgICAgICAga2V5RGVmaW5pdGlvbi5maW5kKChrZXlQcm9wKSA9PiBrZXlQcm9wLm5hbWUgPT09IGtleU5hbWUpIGFzIFByb3BlcnR5XG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgY2hlY2tTcGVjaWZpY1Byb3BlcnRpZXMoXG4gICAgICAgIGZpbHRlckV4cHJlc3Npb246IGFueSxcbiAgICAgICAgbW9ja0RhdGE6IGFueSxcbiAgICAgICAgYWxsRGF0YTogYW55LFxuICAgICAgICBmb3JjZVRvTG93ZXIgPSBmYWxzZVxuICAgICk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaXNWNCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YUFjY2Vzcy5pc1Y0KCk7XG4gICAgfVxuICAgIHB1YmxpYyBjaGVja0ZpbHRlcihtb2NrRGF0YTogb2JqZWN0LCBmaWx0ZXJFeHByZXNzaW9uOiBhbnksIHRlbmFudElkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgbGV0IGlzVmFsaWQgPSB0cnVlO1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShmaWx0ZXJFeHByZXNzaW9uKSkge1xuICAgICAgICAgICAgaWYgKChmaWx0ZXJFeHByZXNzaW9uIGFzIGFueSkub3BlcmF0b3IgPT09ICdBTkQnKSB7XG4gICAgICAgICAgICAgICAgaXNWYWxpZCA9IGZpbHRlckV4cHJlc3Npb24uZXZlcnkoKGZpbHRlclZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNoZWNrRmlsdGVyKG1vY2tEYXRhLCBmaWx0ZXJWYWx1ZSwgdGVuYW50SWQpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpc1ZhbGlkID0gZmlsdGVyRXhwcmVzc2lvbi5zb21lKChmaWx0ZXJWYWx1ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGVja0ZpbHRlcihtb2NrRGF0YSwgZmlsdGVyVmFsdWUsIHRlbmFudElkKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxldCBmb3JjZUxvd2VyQ2FzZSA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKGZpbHRlckV4cHJlc3Npb24ucHJvcC5pbmRleE9mKCd0b2xvd2VyJykgPT09IDApIHtcbiAgICAgICAgICAgICAgICBmb3JjZUxvd2VyQ2FzZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgZmlsdGVyRXhwcmVzc2lvbi5wcm9wID0gZmlsdGVyRXhwcmVzc2lvbi5wcm9wLnN1YnN0cig4LCBmaWx0ZXJFeHByZXNzaW9uLnByb3AubGVuZ3RoIC0gOSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZmlsdGVyRXhwcmVzc2lvbi5lcVZhbHVlLmluZGV4T2YoJ3RvbG93ZXInKSA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGZpbHRlckV4cHJlc3Npb24uZXFWYWx1ZSA9IGZpbHRlckV4cHJlc3Npb24uZXFWYWx1ZVxuICAgICAgICAgICAgICAgICAgICAuc3Vic3RyKDgsIGZpbHRlckV4cHJlc3Npb24uZXFWYWx1ZS5sZW5ndGggLSA5KVxuICAgICAgICAgICAgICAgICAgICAudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHByb3BlcnR5ID0gdGhpcy5lbnRpdHlUeXBlRGVmaW5pdGlvbi5lbnRpdHlQcm9wZXJ0aWVzLmZpbmQoXG4gICAgICAgICAgICAgICAgKHByb3ApID0+IHByb3AubmFtZSA9PT0gZmlsdGVyRXhwcmVzc2lvbi5wcm9wXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgaWYgKCFwcm9wZXJ0eSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRNb2NrRGF0YSA9IHRoaXMuZ2V0TW9ja0RhdGEodGVuYW50SWQpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNoZWNrU3BlY2lmaWNQcm9wZXJ0aWVzKGZpbHRlckV4cHJlc3Npb24sIG1vY2tEYXRhLCBjdXJyZW50TW9ja0RhdGEsIGZvcmNlTG93ZXJDYXNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGhhc0ludFZhbHVlID0gZmFsc2U7XG4gICAgICAgICAgICBzd2l0Y2ggKHByb3BlcnR5LnR5cGUpIHtcbiAgICAgICAgICAgICAgICBjYXNlICdFZG0uQm9vbGVhbic6XG4gICAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSAhIW1vY2tEYXRhW2ZpbHRlckV4cHJlc3Npb24ucHJvcF0gPT09IChmaWx0ZXJFeHByZXNzaW9uLmVxVmFsdWUgPT09ICd0cnVlJyk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5TdHJpbmcnOlxuICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5HdWlkJzpcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlckV4cHJlc3Npb24uZXFWYWx1ZSAmJiBmaWx0ZXJFeHByZXNzaW9uLmVxVmFsdWUuc3RhcnRzV2l0aChcIidcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlVG9UZXN0ID0gZm9yY2VMb3dlckNhc2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IG1vY2tEYXRhW2ZpbHRlckV4cHJlc3Npb24ucHJvcF0udG9Mb3dlckNhc2UoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogbW9ja0RhdGFbZmlsdGVyRXhwcmVzc2lvbi5wcm9wXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlVG9UZXN0ID09PSBmaWx0ZXJFeHByZXNzaW9uLmVxVmFsdWUuc3Vic3RyKDEsIGZpbHRlckV4cHJlc3Npb24uZXFWYWx1ZS5sZW5ndGggLSAyKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSBtb2NrRGF0YVtmaWx0ZXJFeHByZXNzaW9uLnByb3BdID09PSBmaWx0ZXJFeHByZXNzaW9uLmVxVmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSAnRWRtLkJ5dGUnOlxuICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5JbnQxNic6XG4gICAgICAgICAgICAgICAgY2FzZSAnRWRtLkludDMyJzpcbiAgICAgICAgICAgICAgICBjYXNlICdFZG0uSW50NjQnOiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRlc3RWYWx1ZSA9IHBhcnNlSW50KGZpbHRlckV4cHJlc3Npb24uZXFWYWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZmlsdGVyRXhwcmVzc2lvbi5vcGVyYXRvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZ3QnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSBtb2NrRGF0YVtmaWx0ZXJFeHByZXNzaW9uLnByb3BdID4gdGVzdFZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZ2UnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSBtb2NrRGF0YVtmaWx0ZXJFeHByZXNzaW9uLnByb3BdID49IHRlc3RWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2x0JzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gbW9ja0RhdGFbZmlsdGVyRXhwcmVzc2lvbi5wcm9wXSA8IHRlc3RWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2xlJzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gbW9ja0RhdGFbZmlsdGVyRXhwcmVzc2lvbi5wcm9wXSA8PSB0ZXN0VmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICduZSc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IG1vY2tEYXRhW2ZpbHRlckV4cHJlc3Npb24ucHJvcF0gIT09IHRlc3RWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2VxJzpcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IG1vY2tEYXRhW2ZpbHRlckV4cHJlc3Npb24ucHJvcF0gPT09IHRlc3RWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2FzZSAnRWRtLkRlY2ltYWwnOiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRlc3RWYWx1ZSA9IHBhcnNlRmxvYXQoZmlsdGVyRXhwcmVzc2lvbi5lcVZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChmaWx0ZXJFeHByZXNzaW9uLm9wZXJhdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdndCc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IG1vY2tEYXRhW2ZpbHRlckV4cHJlc3Npb24ucHJvcF0gPiB0ZXN0VmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdnZSc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IG1vY2tEYXRhW2ZpbHRlckV4cHJlc3Npb24ucHJvcF0gPj0gdGVzdFZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbHQnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSBtb2NrRGF0YVtmaWx0ZXJFeHByZXNzaW9uLnByb3BdIDwgdGVzdFZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbGUnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSBtb2NrRGF0YVtmaWx0ZXJFeHByZXNzaW9uLnByb3BdIDw9IHRlc3RWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ25lJzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gbW9ja0RhdGFbZmlsdGVyRXhwcmVzc2lvbi5wcm9wXSAhPT0gdGVzdFZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZXEnOlxuICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gbW9ja0RhdGFbZmlsdGVyRXhwcmVzc2lvbi5wcm9wXSA9PT0gdGVzdFZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaXNWYWxpZDtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2hlY2tTZWFyY2gobW9ja0RhdGE6IG9iamVjdCwgc2VhcmNoUXVlcnk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5lbnRpdHlUeXBlRGVmaW5pdGlvbi5lbnRpdHlQcm9wZXJ0aWVzXG4gICAgICAgICAgICAuZmlsdGVyKChwcm9wZXJ0eSkgPT4ge1xuICAgICAgICAgICAgICAgIHN3aXRjaCAocHJvcGVydHkudHlwZSkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdFZG0uQm9vbGVhbic6XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5JbnQzMic6XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5TdHJpbmcnOlxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5zb21lKChwcm9wZXJ0eSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1vY2tWYWx1ZSA9IG1vY2tEYXRhW3Byb3BlcnR5Lm5hbWVdO1xuICAgICAgICAgICAgICAgIHJldHVybiBtb2NrVmFsdWUgJiYgbW9ja1ZhbHVlLmluZGV4T2Yoc2VhcmNoUXVlcnkpICE9PSAtMTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBjaGVja0tleVZhbHVlKG1vY2tEYXRhOiBvYmplY3QsIGtleVZhbHVlczogb2JqZWN0LCBrZXlOYW1lOiBzdHJpbmcsIGtleVByb3A/OiBQcm9wZXJ0eSk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoa2V5UHJvcCkge1xuICAgICAgICAgICAgc3dpdGNoIChrZXlQcm9wLnR5cGUpIHtcbiAgICAgICAgICAgICAgICBjYXNlICdFZG0uR3VpZCc6XG4gICAgICAgICAgICAgICAgICAgIGlmIChrZXlWYWx1ZXNba2V5TmFtZV0gJiYga2V5VmFsdWVzW2tleU5hbWVdLnN0YXJ0c1dpdGgoXCJndWlkJ1wiKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vY2tEYXRhW2tleU5hbWVdID09PSBrZXlWYWx1ZXNba2V5TmFtZV0uc3Vic3RyKDUsIGtleVZhbHVlc1trZXlOYW1lXS5sZW5ndGggLSA2KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbW9ja0RhdGFba2V5TmFtZV0gPT09IGtleVZhbHVlc1trZXlOYW1lXTtcbiAgICAgICAgICAgICAgICBjYXNlICdFZG0uU3RyaW5nJzpcbiAgICAgICAgICAgICAgICAgICAgaWYgKGtleVZhbHVlc1trZXlOYW1lXSAmJiBrZXlWYWx1ZXNba2V5TmFtZV0uc3RhcnRzV2l0aChcIidcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtb2NrRGF0YVtrZXlOYW1lXSA9PT0ga2V5VmFsdWVzW2tleU5hbWVdLnN1YnN0cigxLCBrZXlWYWx1ZXNba2V5TmFtZV0ubGVuZ3RoIC0gMik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vY2tEYXRhW2tleU5hbWVdID09PSBrZXlWYWx1ZXNba2V5TmFtZV07XG4gICAgICAgICAgICAgICAgY2FzZSAnRWRtLkludDMyJzpcbiAgICAgICAgICAgICAgICBjYXNlICdFZG0uSW50NjQnOlxuICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5JbnQxNic6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBtb2NrRGF0YVtrZXlOYW1lXSA9PT0gcGFyc2VJbnQoa2V5VmFsdWVzW2tleU5hbWVdKTtcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbW9ja0RhdGFba2V5TmFtZV0gPT09IGtleVZhbHVlc1trZXlOYW1lXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbW9ja0RhdGFba2V5TmFtZV0gPT09IGtleVZhbHVlc1trZXlOYW1lXTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0S2V5cyhkYXRhTGluZTogb2JqZWN0KTogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbj4ge1xuICAgICAgICBjb25zdCBrZXlzID0gdGhpcy5lbnRpdHlUeXBlRGVmaW5pdGlvbi5rZXlzO1xuICAgICAgICBjb25zdCBrZXlWYWx1ZXMgPSB7fTtcbiAgICAgICAga2V5cy5mb3JFYWNoKChrZXlQcm9wKSA9PiB7XG4gICAgICAgICAgICBrZXlWYWx1ZXNba2V5UHJvcC5uYW1lXSA9IGRhdGFMaW5lW2tleVByb3AubmFtZV07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBrZXlWYWx1ZXM7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHByZXBhcmVLZXlzKGtleVZhbHVlczogS2V5RGVmaW5pdGlvbnMpOiBLZXlEZWZpbml0aW9ucyB7XG4gICAgICAgIGxldCBvdXRLZXlzID0ge307XG4gICAgICAgIGlmIChrZXlWYWx1ZXMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmV0dXJuIG91dEtleXM7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKE9iamVjdC5rZXlzKGtleVZhbHVlcykubGVuZ3RoID09PSAxICYmIE9iamVjdC52YWx1ZXMoa2V5VmFsdWVzKVswXSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBsZXQga2V5VmFsdWU7XG4gICAgICAgICAgICBPYmplY3Qua2V5cyhrZXlWYWx1ZXMpLmZvckVhY2goKGtleU5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBrZXlWYWx1ZSA9IGtleU5hbWU7XG4gICAgICAgICAgICAgICAgaWYgKGtleVZhbHVlLnN0YXJ0c1dpdGgoXCInXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgIGtleVZhbHVlID0ga2V5VmFsdWUuc3Vic3RyKDEsIGtleVZhbHVlLmxlbmd0aCAtIDIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY29uc3Qga2V5TmFtZSA9IHRoaXMuZW50aXR5VHlwZURlZmluaXRpb24ua2V5c1swXS5uYW1lO1xuICAgICAgICAgICAgb3V0S2V5c1trZXlOYW1lXSA9IGtleVZhbHVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3V0S2V5cyA9IGtleVZhbHVlcztcbiAgICAgICAgfVxuICAgICAgICAvLyBSZW1vdmUgbm9uIGtleSBpdGVtcyBvbmx5IGlmIGFsbCBrZXlzIGFyZSBwcm92aWRlZFxuICAgICAgICBsZXQgcmVhbEtleXMgPSBvdXRLZXlzO1xuICAgICAgICBpZiAodGhpcy5lbnRpdHlUeXBlRGVmaW5pdGlvbi5rZXlzLmV2ZXJ5KChrZXlQcm9wKSA9PiBvdXRLZXlzW2tleVByb3AubmFtZV0gIT09IHVuZGVmaW5lZCkpIHtcbiAgICAgICAgICAgIHJlYWxLZXlzID0ge307XG4gICAgICAgICAgICBPYmplY3Qua2V5cyhvdXRLZXlzKS5mb3JFYWNoKChrZXlOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXR5VHlwZURlZmluaXRpb24ua2V5cy5maW5kKChrZXlQcm9wKSA9PiBrZXlQcm9wLm5hbWUgPT09IGtleU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlYWxLZXlzW2tleU5hbWVdID0gb3V0S2V5c1trZXlOYW1lXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZWFsS2V5cztcbiAgICB9XG5cbiAgICBwdWJsaWMgcGVyZm9ybUdFVChrZXlWYWx1ZXM6IEtleURlZmluaXRpb25zLCBhc0FycmF5OiBib29sZWFuLCB0ZW5hbnRJZDogc3RyaW5nLCBkb250Q2xvbmUgPSBmYWxzZSk6IGFueSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRNb2NrRGF0YSA9IHRoaXMuZ2V0TW9ja0RhdGEodGVuYW50SWQpO1xuICAgICAgICBpZiAoa2V5VmFsdWVzICYmIE9iamVjdC5rZXlzKGtleVZhbHVlcykubGVuZ3RoKSB7XG4gICAgICAgICAgICBrZXlWYWx1ZXMgPSB0aGlzLnByZXBhcmVLZXlzKGtleVZhbHVlcyk7XG4gICAgICAgICAgICBjb25zdCBkYXRhID0gY3VycmVudE1vY2tEYXRhLmZldGNoRW50cmllcyhrZXlWYWx1ZXMpO1xuICAgICAgICAgICAgaWYgKCFkYXRhIHx8IChBcnJheS5pc0FycmF5KGRhdGEpICYmIGRhdGEubGVuZ3RoID09PSAwICYmICFhc0FycmF5KSkge1xuICAgICAgICAgICAgICAgIGlmICghY3VycmVudE1vY2tEYXRhLmhhc0VudHJpZXMoKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudE1vY2tEYXRhLmdldEVtcHR5T2JqZWN0KCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkgJiYgIWFzQXJyYXkpIHtcbiAgICAgICAgICAgICAgICBpZiAoZG9udENsb25lKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhWzBdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gY2xvbmVEZWVwKGRhdGFbMF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRvbnRDbG9uZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGNsb25lRGVlcChkYXRhKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5lbnRpdHlTZXREZWZpbml0aW9uPy5lbnRpdHlUeXBlPy5hbm5vdGF0aW9ucz8uQ29tbW9uPy5SZXN1bHRDb250ZXh0Py52YWx1ZU9mKCkpIHtcbiAgICAgICAgICAgIC8vIFBhcmFtZXRyaXplZCBlbnRpdHlzZXQsIHRoZXkgY2Fubm90IGJlIHJlcXVlc3RlZCBkaXJlY3RseVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogJ1BhcmFtZXRyaXplZCBlbnRpdHlzZXQgbmVlZCB0byBiZSBxdWVyaWVkIHdpdGgga2V5cycgfSkpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghYXNBcnJheSkge1xuICAgICAgICAgICAgcmV0dXJuIGNsb25lRGVlcChjdXJyZW50TW9ja0RhdGEuZ2V0RGVmYXVsdEVsZW1lbnQoKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGN1cnJlbnRNb2NrRGF0YS5nZXRBbGxFbnRyaWVzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHBlcmZvcm1QT1NUKGtleVZhbHVlczogS2V5RGVmaW5pdGlvbnMsIHBvc3REYXRhOiBvYmplY3QsIHRlbmFudElkOiBzdHJpbmcpOiBhbnkge1xuICAgICAgICAvLyBWYWxpZGF0ZSBwb3RlbnRpYWxseSBtaXNzaW5nIGtleXNcbiAgICAgICAga2V5VmFsdWVzID0gdGhpcy5wcmVwYXJlS2V5cyhrZXlWYWx1ZXMpO1xuICAgICAgICBjb25zdCBjdXJyZW50TW9ja0RhdGEgPSB0aGlzLmdldE1vY2tEYXRhKHRlbmFudElkKTtcbiAgICAgICAgT2JqZWN0LmtleXMoa2V5VmFsdWVzKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgIGlmICghcG9zdERhdGFba2V5XSkge1xuICAgICAgICAgICAgICAgIHBvc3REYXRhW2tleV0gPSBrZXlWYWx1ZXNba2V5XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuZW50aXR5VHlwZURlZmluaXRpb24ua2V5cy5mb3JFYWNoKChrZXlQcm9wKSA9PiB7XG4gICAgICAgICAgICBpZiAocG9zdERhdGFba2V5UHJvcC5uYW1lXSA9PT0gdW5kZWZpbmVkIHx8IHBvc3REYXRhW2tleVByb3AubmFtZV0ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgLy8gTWlzc2luZyBrZXlcbiAgICAgICAgICAgICAgICBpZiAoa2V5UHJvcC5uYW1lID09PSAnSXNBY3RpdmVFbnRpdHknKSB7XG4gICAgICAgICAgICAgICAgICAgIHBvc3REYXRhWydJc0FjdGl2ZUVudGl0eSddID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcG9zdERhdGFba2V5UHJvcC5uYW1lXSA9IGN1cnJlbnRNb2NrRGF0YS5nZW5lcmF0ZUtleShrZXlQcm9wIGFzIFByb3BlcnR5KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBsZXQgbmV3T2JqZWN0ID0gY3VycmVudE1vY2tEYXRhLmdldEVtcHR5T2JqZWN0KCk7XG4gICAgICAgIG5ld09iamVjdCA9IE9iamVjdC5hc3NpZ24obmV3T2JqZWN0LCBwb3N0RGF0YSk7XG4gICAgICAgIGN1cnJlbnRNb2NrRGF0YS5hZGRFbnRyeShuZXdPYmplY3QpO1xuICAgICAgICByZXR1cm4gbmV3T2JqZWN0O1xuICAgIH1cblxuICAgIHB1YmxpYyBwZXJmb3JtUEFUQ0goa2V5VmFsdWVzOiBLZXlEZWZpbml0aW9ucywgcGF0Y2hEYXRhOiBvYmplY3QsIHRlbmFudElkOiBzdHJpbmcpOiBhbnkge1xuICAgICAgICBrZXlWYWx1ZXMgPSB0aGlzLnByZXBhcmVLZXlzKGtleVZhbHVlcyk7XG4gICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLnBlcmZvcm1HRVQoa2V5VmFsdWVzLCBmYWxzZSwgdGVuYW50SWQpO1xuICAgICAgICBjb25zdCBjdXJyZW50TW9ja0RhdGEgPSB0aGlzLmdldE1vY2tEYXRhKHRlbmFudElkKTtcbiAgICAgICAgY29uc3QgdXBkYXRlZERhdGEgPSBPYmplY3QuYXNzaWduKGRhdGEsIHBhdGNoRGF0YSk7XG4gICAgICAgIGN1cnJlbnRNb2NrRGF0YS5vbkJlZm9yZVVwZGF0ZUVudHJ5KGtleVZhbHVlcywgdXBkYXRlZERhdGEpO1xuICAgICAgICBjdXJyZW50TW9ja0RhdGEudXBkYXRlRW50cnkoa2V5VmFsdWVzLCB1cGRhdGVkRGF0YSk7XG4gICAgICAgIGN1cnJlbnRNb2NrRGF0YS5vbkFmdGVyVXBkYXRlRW50cnkoa2V5VmFsdWVzLCB1cGRhdGVkRGF0YSk7XG4gICAgICAgIHJldHVybiB1cGRhdGVkRGF0YTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgcGVyZm9ybURFTEVURShrZXlWYWx1ZXM6IEtleURlZmluaXRpb25zLCB0ZW5hbnRJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRNb2NrRGF0YSA9IHRoaXMuZ2V0TW9ja0RhdGEodGVuYW50SWQpO1xuICAgICAgICBrZXlWYWx1ZXMgPSB0aGlzLnByZXBhcmVLZXlzKGtleVZhbHVlcyk7XG4gICAgICAgIGN1cnJlbnRNb2NrRGF0YS5yZW1vdmVFbnRyeShrZXlWYWx1ZXMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBleGVjdXRlQWN0aW9uKFxuICAgICAgICBhY3Rpb25EZWZpbml0aW9uOiBBY3Rpb24sXG4gICAgICAgIGFjdGlvbkRhdGE6IG9iamVjdCxcbiAgICAgICAgb2RhdGFSZXF1ZXN0OiBPRGF0YVJlcXVlc3QsXG4gICAgICAgIGtleXM6IFJlY29yZDxzdHJpbmcsIGFueT5cbiAgICApOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCBjdXJyZW50TW9ja0RhdGEgPSB0aGlzLmdldE1vY2tEYXRhKG9kYXRhUmVxdWVzdC50ZW5hbnRJZCk7XG4gICAgICAgIGtleXMgPSB0aGlzLnByZXBhcmVLZXlzKGtleXMpO1xuICAgICAgICBhY3Rpb25EYXRhID0gY3VycmVudE1vY2tEYXRhLm9uQmVmb3JlQWN0aW9uKGFjdGlvbkRlZmluaXRpb24sIGFjdGlvbkRhdGEsIGtleXMpO1xuICAgICAgICBsZXQgcmVzcG9uc2VPYmplY3QgPSBjdXJyZW50TW9ja0RhdGEuZXhlY3V0ZUFjdGlvbihhY3Rpb25EZWZpbml0aW9uLCBhY3Rpb25EYXRhLCBrZXlzKTtcbiAgICAgICAgcmVzcG9uc2VPYmplY3QgPSBjdXJyZW50TW9ja0RhdGEub25BZnRlckFjdGlvbihhY3Rpb25EZWZpbml0aW9uLCBhY3Rpb25EYXRhLCBrZXlzLCByZXNwb25zZU9iamVjdCk7XG4gICAgICAgIHJldHVybiByZXNwb25zZU9iamVjdDtcbiAgICB9XG59XG4iXX0=