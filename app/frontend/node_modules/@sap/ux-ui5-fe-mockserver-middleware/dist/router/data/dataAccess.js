"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DataAccess = void 0;
var entitySet_1 = require("./entitySet");
var draftEntitySet_1 = require("./draftEntitySet");
var stickyEntitySet_1 = require("./stickyEntitySet");
var lodash_clonedeep_1 = __importDefault(require("lodash.clonedeep"));
var ContainedDataEntitySet_1 = require("./ContainedDataEntitySet");
var DataAccess = /** @class */ (function () {
    function DataAccess(root, metadata, strictKeyMode, contextBasedIsolation, generateMockData) {
        var _this = this;
        this.entitySets = {};
        this.stickyEntitySets = [];
        this.mockDataRootFolder = root;
        this.metadata = metadata;
        this.strictKeyMode = strictKeyMode;
        this.contextBasedIsolation = contextBasedIsolation;
        this.metadata.getEntitySets().forEach(function (entitySet) {
            _this.getMockEntitySet(entitySet.name, generateMockData);
        });
    }
    DataAccess.prototype.isV4 = function () {
        return this.metadata.getVersion() !== '2.0';
    };
    DataAccess.prototype.getMockEntitySet = function (entityTypeName, generateMockData, containedEntityType, containedData) {
        return __awaiter(this, void 0, void 0, function () {
            var mockEntitySet, entitySet, entityType, mockEntitySet;
            return __generator(this, function (_a) {
                if (containedEntityType) {
                    mockEntitySet = new ContainedDataEntitySet_1.ContainedDataEntitySet(containedEntityType, containedData, this);
                    return [2 /*return*/, mockEntitySet.readyPromise];
                }
                else if (!this.entitySets[entityTypeName]) {
                    entitySet = this.metadata.getEntitySet(entityTypeName);
                    entityType = this.metadata.getEntityType(entityTypeName);
                    mockEntitySet = void 0;
                    if (this.metadata.isDraftEntity(entitySet)) {
                        mockEntitySet = new draftEntitySet_1.DraftMockEntitySet(this.mockDataRootFolder, entitySet || entityType, this, generateMockData);
                    }
                    else if (this.metadata.isStickyEntity(entitySet)) {
                        mockEntitySet = new stickyEntitySet_1.StickyMockEntitySet(this.mockDataRootFolder, entitySet || entityType, this, generateMockData);
                        this.stickyEntitySets.push(mockEntitySet);
                    }
                    else {
                        mockEntitySet = new entitySet_1.MockDataEntitySet(this.mockDataRootFolder, entitySet || entityType, this, generateMockData);
                    }
                    this.entitySets[entityTypeName] = mockEntitySet;
                }
                return [2 /*return*/, this.entitySets[entityTypeName].readyPromise];
            });
        });
    };
    DataAccess.prototype.performAction = function (odataRequest, actionData) {
        return __awaiter(this, void 0, void 0, function () {
            var rootEntitySet, currentEntityType, currentEntitySet, i, _loop_1, entitySetName, actionName, fqActionName, actionDefinition, collecfqActionName, collecactionDefinition, actionName, fqActionName, actionDefinition, targetEntitySet_1, outData, enrichElement_1, fqActionName_1, actionDefinition_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        rootEntitySet = this.metadata.getEntitySet(odataRequest.query.queryPath[0].path);
                        if (!rootEntitySet) return [3 /*break*/, 5];
                        currentEntityType = rootEntitySet.entityType;
                        currentEntitySet = rootEntitySet;
                        i = 1;
                        _loop_1 = function () {
                            var queryPart = odataRequest.query.queryPath[i].path;
                            var targetNavProp = currentEntityType.navigationProperties.find(function (navProp) { return navProp.name === queryPart; });
                            if (targetNavProp) {
                                currentEntityType = targetNavProp.targetType;
                                if (currentEntitySet) {
                                    currentEntitySet = currentEntitySet.navigationPropertyBinding[queryPart];
                                }
                            }
                        };
                        for (i = 1; i < odataRequest.query.queryPath.length - 1; i++) {
                            _loop_1();
                        }
                        entitySetName = currentEntitySet ? currentEntitySet.name : currentEntityType.name;
                        actionName = odataRequest.query.queryPath[i] ? odataRequest.query.queryPath[i].path : undefined;
                        if (!(actionName && actionName.length > 0)) return [3 /*break*/, 4];
                        fqActionName = actionName + "(" + currentEntityType.fullyQualifiedName + ")";
                        actionDefinition = this.metadata.getActionByFQN(fqActionName);
                        if (!actionDefinition) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.getMockEntitySet(entitySetName)];
                    case 1: return [2 /*return*/, (_a.sent()).executeAction(actionDefinition, actionData, odataRequest, odataRequest.query.queryPath[i - 1].keys)];
                    case 2:
                        collecfqActionName = actionName + "(Collection(" + currentEntityType.fullyQualifiedName + "))";
                        collecactionDefinition = this.metadata.getActionByFQN(collecfqActionName);
                        if (!collecactionDefinition) return [3 /*break*/, 4];
                        return [4 /*yield*/, this.getMockEntitySet(entitySetName)];
                    case 3: return [2 /*return*/, (_a.sent()).executeAction(collecactionDefinition, actionData, odataRequest, odataRequest.query.queryPath[0].keys)];
                    case 4: return [3 /*break*/, 8];
                    case 5:
                        actionName = odataRequest.query.queryPath[0].path;
                        fqActionName = this.metadata.getEntityContainerPath() + "/" + actionName + "()";
                        actionDefinition = this.metadata.getActionByFQN(fqActionName);
                        if (!(actionDefinition && this.metadata.getEntitySetByType(actionDefinition.sourceType))) return [3 /*break*/, 7];
                        targetEntitySet_1 = this.metadata.getEntitySetByType(actionDefinition.sourceType);
                        return [4 /*yield*/, this.getMockEntitySet(targetEntitySet_1.name)];
                    case 6:
                        outData = (_a.sent()).executeAction(actionDefinition, Object.assign({}, actionData, odataRequest.query.rawParams), odataRequest, odataRequest.query.rawParams);
                        if (this.metadata.getVersion() === '2.0') {
                            enrichElement_1 = function (entitySet, dataLine) {
                                var keyValues = [];
                                entitySet.entityType.keys.forEach(function (key) {
                                    keyValues.push(key.name + "='" + dataLine[key.name] + "'");
                                });
                                var uri = odataRequest.baseUrl + "/" + entitySet.name + "(" + keyValues.join(',') + ")";
                                dataLine['__metadata'] = {
                                    id: uri,
                                    uri: uri,
                                    type: entitySet.entityTypeName
                                };
                                return dataLine;
                            };
                            // Enrich data with __metadata for v2
                            if (Array.isArray(outData)) {
                                outData = outData.map(function (element) {
                                    return enrichElement_1(targetEntitySet_1, element);
                                });
                            }
                            else if (outData != null) {
                                outData = enrichElement_1(targetEntitySet_1, outData);
                            }
                        }
                        return [2 /*return*/, outData];
                    case 7:
                        fqActionName_1 = actionName + "()";
                        actionDefinition_1 = this.metadata.getActionByFQN(fqActionName_1);
                        if (actionDefinition_1) {
                            this.stickyEntitySets.forEach(function (entitySet) {
                                entitySet.executeAction(actionDefinition_1, actionData, odataRequest, odataRequest.query.queryPath[0].keys);
                            });
                            return [2 /*return*/, true];
                        }
                        return [2 /*return*/, null];
                    case 8: return [2 /*return*/, null];
                }
            });
        });
    };
    DataAccess.prototype.getNavigationPropertyKeys = function (data, navPropDetail, currentEntityType, currentKeys, forCreate) {
        if (forCreate === void 0) { forCreate = false; }
        if (navPropDetail.referentialConstraint && navPropDetail.referentialConstraint.length > 0) {
            var dataArray = Array.isArray(data) ? data : [data];
            dataArray.forEach(function (data) {
                navPropDetail.referentialConstraint.forEach(function (refConstr) {
                    currentKeys[refConstr.targetProperty] = data[refConstr.sourceProperty];
                });
            });
        }
        else {
            // Try to find a back link (a nav property going back to the original entityType)
            var originalData_1 = lodash_clonedeep_1.default(data);
            var backNav = navPropDetail.targetType.navigationProperties.find(function (targetNavProp) { return targetNavProp.targetTypeName === currentEntityType.fullyQualifiedName; });
            if (backNav && backNav.referentialConstraint && backNav.referentialConstraint.length > 0) {
                backNav.referentialConstraint.forEach(function (refConstr) {
                    if (originalData_1[refConstr.targetProperty] !== undefined) {
                        currentKeys[refConstr.sourceProperty] = originalData_1[refConstr.targetProperty];
                        delete originalData_1[refConstr.targetProperty];
                    }
                });
                navPropDetail.targetType.keys.forEach(function (propKey) {
                    var _a, _b;
                    if (propKey.name === 'IsActiveEntity' &&
                        currentKeys[propKey.name] === undefined &&
                        Object.hasOwnProperty.call(originalData_1, propKey.name) &&
                        (!forCreate || !((_b = (_a = propKey.annotations) === null || _a === void 0 ? void 0 : _a.Core) === null || _b === void 0 ? void 0 : _b.Computed))) {
                        currentKeys[propKey.name] = originalData_1[propKey.name];
                        delete originalData_1[propKey.name];
                    }
                });
            }
            else if (!this.strictKeyMode) {
                navPropDetail.targetType.keys.forEach(function (propKey) {
                    var _a, _b;
                    if (Object.hasOwnProperty.call(originalData_1, propKey.name) &&
                        (!forCreate || !((_b = (_a = propKey.annotations) === null || _a === void 0 ? void 0 : _a.Core) === null || _b === void 0 ? void 0 : _b.Computed))) {
                        currentKeys[propKey.name] = originalData_1[propKey.name];
                        delete originalData_1[propKey.name];
                    }
                });
                // If there is no key or only draft stuff
                if (Object.keys(currentKeys).length === 0 ||
                    (Object.keys(currentKeys).length === 1 && currentKeys['IsActiveEntity'])) {
                    // If we still don't have anything, try to get the keys from the current entity that are properties in the target
                    currentEntityType.keys.forEach(function (propKey) {
                        if (navPropDetail.targetType.entityProperties.find(function (prop) { return prop.name === propKey.name; }) &&
                            originalData_1[propKey.name] !== undefined) {
                            currentKeys[propKey.name] = originalData_1[propKey.name];
                            delete originalData_1[propKey.name];
                        }
                    });
                }
            }
        }
        return currentKeys;
    };
    DataAccess.prototype.getExpandData = function (currentEntitySet, entityType, expandNavProp, data, requestExpandObject, tenantId, previousEntitySet, visitedPaths) {
        return __awaiter(this, void 0, void 0, function () {
            var navProp, targetEntitySet, navEntitySet, dataArray, _loop_2, this_1, _i, dataArray_1, data_1;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (data === null) {
                            return [2 /*return*/];
                        }
                        navProp = entityType.navigationProperties.find(function (navProp) { return navProp.name === expandNavProp; });
                        visitedPaths = visitedPaths.concat();
                        visitedPaths.push(expandNavProp);
                        if (navProp && currentEntitySet && currentEntitySet.navigationPropertyBinding[expandNavProp]) {
                            targetEntitySet = currentEntitySet.navigationPropertyBinding[expandNavProp];
                        }
                        else if (previousEntitySet && previousEntitySet.navigationPropertyBinding[visitedPaths.join('/')]) {
                            targetEntitySet = previousEntitySet.navigationPropertyBinding[visitedPaths.join('/')];
                        }
                        if (!targetEntitySet) return [3 /*break*/, 5];
                        return [4 /*yield*/, this.getMockEntitySet(targetEntitySet.name)];
                    case 1:
                        navEntitySet = _a.sent();
                        dataArray = Array.isArray(data) ? data : [data];
                        _loop_2 = function (data_1) {
                            var currentKeys, expandData_1, expandDetail_1;
                            return __generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        currentKeys = this_1.getNavigationPropertyKeys(data_1, navProp, entityType, {});
                                        if (!!navProp.containsTarget) return [3 /*break*/, 2];
                                        expandData_1 = navEntitySet.performGET(currentKeys, navProp.isCollection, tenantId);
                                        data_1[expandNavProp] = expandData_1;
                                        expandDetail_1 = requestExpandObject.expand[expandNavProp];
                                        if (!(expandDetail_1.expand && Object.keys(expandDetail_1.expand).length > 0)) return [3 /*break*/, 2];
                                        return [4 /*yield*/, Promise.all(Object.keys(expandDetail_1.expand).map(function (subExpandNavProp) { return __awaiter(_this, void 0, void 0, function () {
                                                return __generator(this, function (_a) {
                                                    return [2 /*return*/, this.getExpandData(targetEntitySet, navProp.targetType, subExpandNavProp, expandData_1, expandDetail_1, tenantId, targetEntitySet, [])];
                                                });
                                            }); }))];
                                    case 1:
                                        _a.sent();
                                        _a.label = 2;
                                    case 2: return [2 /*return*/];
                                }
                            });
                        };
                        this_1 = this;
                        _i = 0, dataArray_1 = dataArray;
                        _a.label = 2;
                    case 2:
                        if (!(_i < dataArray_1.length)) return [3 /*break*/, 5];
                        data_1 = dataArray_1[_i];
                        return [5 /*yield**/, _loop_2(data_1)];
                    case 3:
                        _a.sent();
                        _a.label = 4;
                    case 4:
                        _i++;
                        return [3 /*break*/, 2];
                    case 5: return [2 /*return*/];
                }
            });
        });
    };
    DataAccess.prototype.getData = function (odataRequest) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l;
        return __awaiter(this, void 0, void 0, function () {
            var currentEntitySet, previousEntitySet, currentEntityType, visitedPaths, targetContainedData, targetContainedEntityType, rootEntitySet, isCount, data, potentialTarget, filterDef_1, mockEntitySet_1, mockEntitySet_2, dataByGroup_1, mockEntitySet, mockData_1, getAggregateKey_1, originalData_2, queryPropsKeys_1, compareByKey_1, enrichElement_2;
            var _this = this;
            return __generator(this, function (_m) {
                switch (_m.label) {
                    case 0:
                        currentEntitySet = null;
                        previousEntitySet = null;
                        currentEntityType = null;
                        visitedPaths = [];
                        targetContainedEntityType = null;
                        rootEntitySet = this.metadata.getEntitySet(odataRequest.query.queryPath[0].path);
                        isCount = false;
                        return [4 /*yield*/, odataRequest.query.queryPath.reduce(function (data, queryPathPart, index) { return __awaiter(_this, void 0, void 0, function () {
                                var currentKeys, asArray, navPropDetail, navPropDetail;
                                return __generator(this, function (_a) {
                                    switch (_a.label) {
                                        case 0: return [4 /*yield*/, data];
                                        case 1:
                                            data = _a.sent();
                                            currentKeys = queryPathPart.keys || {};
                                            asArray = Object.keys(currentKeys).length === 0;
                                            if (queryPathPart.path === '$count') {
                                                isCount = true;
                                                return [2 /*return*/, data];
                                            }
                                            if ((!currentEntityType || data === null) && index > 0) {
                                                if (data === null) {
                                                    if (currentEntityType) {
                                                        navPropDetail = currentEntityType.navigationProperties.find(function (navProp) { return navProp.name === queryPathPart.path; });
                                                        asArray = asArray && navPropDetail.isCollection;
                                                    }
                                                    return [2 /*return*/, asArray ? [] : null];
                                                }
                                                return [2 /*return*/, data];
                                            }
                                            if (!currentEntityType) {
                                                // First level if entity set, then it's navigation properties
                                                currentEntitySet = this.metadata.getEntitySet(queryPathPart.path);
                                                previousEntitySet = currentEntitySet;
                                                currentEntityType = currentEntitySet.entityType;
                                            }
                                            else {
                                                navPropDetail = currentEntityType.navigationProperties.find(function (navProp) { return navProp.name === queryPathPart.path; });
                                                if (navPropDetail.name === 'SiblingEntity' && currentEntityType) {
                                                    asArray = asArray && navPropDetail.isCollection;
                                                    currentKeys.IsActiveEntity = !data.IsActiveEntity;
                                                }
                                                else {
                                                    visitedPaths.push(queryPathPart.path);
                                                    if (navPropDetail) {
                                                        if (asArray) {
                                                            currentKeys = this.getNavigationPropertyKeys(data, navPropDetail, currentEntityType, currentKeys);
                                                        }
                                                        if (!navPropDetail.containsTarget && previousEntitySet) {
                                                            currentEntitySet = previousEntitySet.navigationPropertyBinding[visitedPaths.join('/')];
                                                            previousEntitySet = currentEntitySet;
                                                            visitedPaths = [];
                                                            currentEntityType = currentEntitySet.entityType;
                                                            targetContainedEntityType = null;
                                                            targetContainedData = null;
                                                        }
                                                        else {
                                                            targetContainedEntityType = navPropDetail.targetType;
                                                            targetContainedData = data[queryPathPart.path];
                                                            currentEntitySet = null;
                                                            currentEntityType = targetContainedEntityType;
                                                        }
                                                    }
                                                    else {
                                                        currentEntitySet = null;
                                                        currentEntityType = null;
                                                    }
                                                    asArray = asArray && navPropDetail.isCollection;
                                                }
                                            }
                                            if (!currentEntitySet && !targetContainedEntityType) {
                                                if (Array.isArray(data)) {
                                                    return [2 /*return*/, asArray ? [] : null];
                                                }
                                                else {
                                                    return [2 /*return*/, data[queryPathPart.path]];
                                                }
                                            }
                                            return [4 /*yield*/, this.getMockEntitySet(currentEntitySet === null || currentEntitySet === void 0 ? void 0 : currentEntitySet.name, undefined, targetContainedEntityType, targetContainedData)];
                                        case 2: return [2 /*return*/, (_a.sent()).performGET(currentKeys, asArray, odataRequest.tenantId)];
                                    }
                                });
                            }); }, {})];
                    case 1:
                        data = _m.sent();
                        if (((_d = (_c = (_b = (_a = rootEntitySet.entityType) === null || _a === void 0 ? void 0 : _a.annotations) === null || _b === void 0 ? void 0 : _b.Common) === null || _c === void 0 ? void 0 : _c.ResultContext) === null || _d === void 0 ? void 0 : _d.valueOf()) &&
                            odataRequest.query.queryPath.length === 1) {
                            potentialTarget = rootEntitySet.entityType.navigationProperties.find(function (navProp) { return navProp.containsTarget; });
                            throw new Error(JSON.stringify({
                                message: 'Parametrized entityset cannot be queried directly, you need to load the result set, most likely "' +
                                    potentialTarget.name +
                                    '" in this case'
                            }));
                        }
                        if (!(data !== null || (Array.isArray(data) && data.length > 0))) return [3 /*break*/, 12];
                        if (!odataRequest.query.expand) return [3 /*break*/, 3];
                        return [4 /*yield*/, Promise.all(Object.keys(odataRequest.query.expand).map(function (expandNavProp) { return __awaiter(_this, void 0, void 0, function () {
                                return __generator(this, function (_a) {
                                    return [2 /*return*/, this.getExpandData(currentEntitySet, currentEntityType, expandNavProp, data, odataRequest.query, odataRequest.tenantId, previousEntitySet, visitedPaths)];
                                });
                            }); }))];
                    case 2:
                        _m.sent();
                        _m.label = 3;
                    case 3:
                        if (!((odataRequest.query.filter || ((_f = (_e = odataRequest.query) === null || _e === void 0 ? void 0 : _e.aggregateDefinition) === null || _f === void 0 ? void 0 : _f.filter)) && Array.isArray(data))) return [3 /*break*/, 5];
                        filterDef_1 = odataRequest.query.filter || ((_h = (_g = odataRequest.query) === null || _g === void 0 ? void 0 : _g.aggregateDefinition) === null || _h === void 0 ? void 0 : _h.filter);
                        return [4 /*yield*/, this.getMockEntitySet(currentEntitySet ? currentEntitySet.name : currentEntityType.name)];
                    case 4:
                        mockEntitySet_1 = _m.sent();
                        data = data.filter(function (dataLine) {
                            return mockEntitySet_1.checkFilter(dataLine, filterDef_1, odataRequest.tenantId);
                        });
                        _m.label = 5;
                    case 5:
                        if (!(odataRequest.query.searchQuery && Array.isArray(data))) return [3 /*break*/, 7];
                        return [4 /*yield*/, this.getMockEntitySet(currentEntityType.name)];
                    case 6:
                        mockEntitySet_2 = _m.sent();
                        data = data.filter(function (dataLine) {
                            return mockEntitySet_2.checkSearch(dataLine, odataRequest.query.searchQuery);
                        });
                        _m.label = 7;
                    case 7:
                        if (!odataRequest.query.aggregateDefinition) return [3 /*break*/, 11];
                        dataByGroup_1 = {};
                        return [4 /*yield*/, this.getMockEntitySet(currentEntityType.name)];
                    case 8:
                        mockEntitySet = _m.sent();
                        if (!mockEntitySet) return [3 /*break*/, 10];
                        return [4 /*yield*/, mockEntitySet.getMockData(odataRequest.tenantId)];
                    case 9:
                        mockData_1 = _m.sent();
                        _m.label = 10;
                    case 10:
                        getAggregateKey_1 = function (dataLine) {
                            return odataRequest.query.aggregateDefinition.groupBy.reduce(function (key, groupByProp) {
                                if (key.length > 0) {
                                    key += ',';
                                }
                                key += dataLine[groupByProp];
                                return key;
                            }, '');
                        };
                        data.forEach(function (dataLine) {
                            var aggregateKey = getAggregateKey_1(dataLine);
                            if (!dataByGroup_1[aggregateKey]) {
                                dataByGroup_1[aggregateKey] = [];
                            }
                            dataByGroup_1[aggregateKey].push(dataLine);
                        });
                        data = Object.keys(dataByGroup_1).map(function (groupName) {
                            var dataToAggregate = dataByGroup_1[groupName];
                            var outData = {};
                            odataRequest.query.aggregateDefinition.groupBy.forEach(function (propName) {
                                outData[propName] = dataToAggregate[0][propName];
                            });
                            odataRequest.query.aggregateDefinition.aggregates.forEach(function (aggregateDefinition) {
                                var propValue = undefined;
                                if (aggregateDefinition.operator === undefined &&
                                    mockData_1 &&
                                    mockData_1.hasCustomAggregate(aggregateDefinition.name)) {
                                    propValue = mockData_1.performCustomAggregate(aggregateDefinition.name, dataToAggregate);
                                }
                                else {
                                    dataToAggregate.forEach(function (dataLine) {
                                        var currentValue = dataLine[aggregateDefinition.sourceProperty];
                                        if (propValue === undefined) {
                                            propValue = currentValue;
                                        }
                                        else {
                                            switch (aggregateDefinition.operator) {
                                                case 'max':
                                                    propValue = Math.max(propValue, currentValue);
                                                    break;
                                                case 'min':
                                                    propValue = Math.min(propValue, currentValue);
                                                    break;
                                                case 'average':
                                                    propValue += currentValue;
                                                    break;
                                                default:
                                                    propValue += currentValue;
                                                    break;
                                            }
                                        }
                                    });
                                }
                                if (aggregateDefinition.operator === 'average') {
                                    propValue = propValue / dataToAggregate.length;
                                }
                                outData[aggregateDefinition.name] = propValue;
                            });
                            return outData;
                        });
                        _m.label = 11;
                    case 11:
                        originalData_2 = lodash_clonedeep_1.default(data);
                        if ((_j = odataRequest === null || odataRequest === void 0 ? void 0 : odataRequest.query) === null || _j === void 0 ? void 0 : _j.properties) {
                            if (odataRequest.query.properties['DraftAdministrativeData']) {
                                if (Array.isArray(data)) {
                                    data = data.map(function (element) {
                                        if (!element.DraftAdministrativeData) {
                                            element.DraftAdministrativeData = null;
                                        }
                                        return element;
                                    });
                                }
                                else if (data != null && data.constructor.name === 'Object') {
                                    if (!data.DraftAdministrativeData) {
                                        data.DraftAdministrativeData = null;
                                    }
                                }
                            }
                        }
                        if (((_k = odataRequest === null || odataRequest === void 0 ? void 0 : odataRequest.query) === null || _k === void 0 ? void 0 : _k.properties) && Object.keys((_l = odataRequest === null || odataRequest === void 0 ? void 0 : odataRequest.query) === null || _l === void 0 ? void 0 : _l.properties).length > 0) {
                            queryPropsKeys_1 = Object.keys(odataRequest.query.properties);
                            compareByKey_1 = function (element) {
                                var elemKeys = Object.keys(element);
                                var differenceKeys = elemKeys.filter(function (x) { return !queryPropsKeys_1.includes(x); });
                                differenceKeys.forEach(function (k) {
                                    delete element[k];
                                });
                                if (odataRequest.query.expand) {
                                    var expandKeys = Object.keys(odataRequest.query.expand);
                                    expandKeys.forEach(function (expandKey) {
                                        var expandElem = element[expandKey];
                                        if (expandElem) {
                                            if (odataRequest.query.expand[expandKey].select) {
                                                var expandSelectKeys_1 = Object.keys(odataRequest.query.expand[expandKey].select);
                                                if (Array.isArray(expandElem)) {
                                                    expandElem.forEach(function (expandItem) {
                                                        var expandElemKeys = Object.keys(expandItem);
                                                        var differenceKeys = expandElemKeys.filter(function (x) { return !expandSelectKeys_1.includes(x); });
                                                        differenceKeys.forEach(function (k) {
                                                            delete expandItem[k];
                                                        });
                                                    });
                                                }
                                                else {
                                                    var expandElemKeys = Object.keys(expandElem);
                                                    var differenceKeys_1 = expandElemKeys.filter(function (x) { return !expandSelectKeys_1.includes(x); });
                                                    differenceKeys_1.forEach(function (k) {
                                                        delete expandElem[k];
                                                    });
                                                }
                                            }
                                        }
                                    });
                                }
                                return element;
                            };
                            if (Array.isArray(data)) {
                                data = data.map(function (element) {
                                    return compareByKey_1(element);
                                });
                            }
                            else if (data != null && data.constructor.name === 'Object') {
                                data = compareByKey_1(data);
                            }
                        }
                        odataRequest.dataLength = (Array.isArray(data) && data.length) || 1;
                        // Apply $skip / $top
                        if (Array.isArray(data) && odataRequest.query.startIndex !== undefined && odataRequest.query.maxElements) {
                            data = data.slice(odataRequest.query.startIndex, odataRequest.query.startIndex + odataRequest.query.maxElements);
                        }
                        if (this.metadata.getVersion() === '2.0') {
                            enrichElement_2 = function (entitySet, dataLine, originalDataLine) {
                                var keyValues = [];
                                entitySet.entityType.keys.forEach(function (key) {
                                    keyValues.push(key.name + "='" + (dataLine[key.name] || originalDataLine[key.name]) + "'");
                                });
                                var uri = odataRequest.baseUrl + "/" + entitySet.name + "(" + keyValues.join(',') + ")";
                                dataLine['__metadata'] = {
                                    id: uri,
                                    uri: uri,
                                    type: entitySet.entityTypeName
                                };
                                entitySet.entityType.navigationProperties.forEach(function (navProp) {
                                    //eslint-disable-next-line
                                    if (dataLine.hasOwnProperty(navProp.name)) {
                                        if (entitySet.navigationPropertyBinding[navProp.name]) {
                                            if (navProp.isCollection) {
                                                dataLine[navProp.name] = {
                                                    results: dataLine[navProp.name].map(function (element, idx) {
                                                        return enrichElement_2(entitySet.navigationPropertyBinding[navProp.name], element, originalDataLine[navProp.name][idx]);
                                                    })
                                                };
                                            }
                                            else if (dataLine[navProp.name] !== null) {
                                                dataLine[navProp.name] = enrichElement_2(entitySet.navigationPropertyBinding[navProp.name], dataLine[navProp.name], originalDataLine[navProp.name]);
                                            }
                                        }
                                    }
                                });
                                return dataLine;
                            };
                            // Enrich data with __metadata for v2
                            if (Array.isArray(data)) {
                                data = data.map(function (element, idx) {
                                    return enrichElement_2(currentEntitySet, element, originalData_2[idx]);
                                });
                            }
                            else if (data != null) {
                                data = enrichElement_2(currentEntitySet, data, originalData_2);
                            }
                        }
                        if (isCount) {
                            data = odataRequest.dataLength;
                        }
                        _m.label = 12;
                    case 12: return [2 /*return*/, data];
                }
            });
        });
    };
    DataAccess.prototype.updateData = function (odataRequest, patchData) {
        return __awaiter(this, void 0, void 0, function () {
            var entitySetName;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        entitySetName = odataRequest.query.queryPath[0].path;
                        return [4 /*yield*/, this.getMockEntitySet(entitySetName)];
                    case 1: return [2 /*return*/, (_a.sent()).performPATCH(odataRequest.query.queryPath[0].keys, patchData, odataRequest.tenantId)];
                }
            });
        });
    };
    DataAccess.prototype.createData = function (odataRequest, postData) {
        return __awaiter(this, void 0, void 0, function () {
            var entitySetName, navPropertyName, entitySet, entityType, navPropDetail, navPropEntityType, data, providedKeys_1, currentKeys_1, targetEntitySet, currentKeys_2;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        entitySetName = odataRequest.query.queryPath[0].path;
                        navPropertyName = odataRequest.query.queryPath.length > 1 ? odataRequest.query.queryPath[1].path : undefined;
                        entitySet = this.metadata.getEntitySet(entitySetName);
                        if (!navPropertyName) return [3 /*break*/, 5];
                        entityType = entitySet.entityType;
                        navPropDetail = entityType.navigationProperties.find(function (navProp) { return navProp.name === navPropertyName; });
                        navPropEntityType = navPropDetail.targetType;
                        return [4 /*yield*/, this.getMockEntitySet(entitySetName)];
                    case 1:
                        data = (_a.sent()).performGET(odataRequest.query.queryPath[0].keys, false, odataRequest.tenantId);
                        if (!data[navPropertyName]) {
                            data[navPropertyName] = [];
                        }
                        providedKeys_1 = {};
                        navPropEntityType.keys.forEach(function (key) {
                            if (postData[key.name] !== undefined) {
                                providedKeys_1[key.name] = postData[key.name];
                            }
                        });
                        currentKeys_1 = this.getNavigationPropertyKeys(data, navPropDetail, entitySet.entityType, providedKeys_1, true);
                        if (!!navPropDetail.containsTarget) return [3 /*break*/, 3];
                        targetEntitySet = entitySet.navigationPropertyBinding[navPropertyName];
                        odataRequest.context = "../$metadata#" + targetEntitySet.name + "/$entity";
                        odataRequest.location = targetEntitySet.name + "(" + Object.keys(currentKeys_1)
                            .map(function (key) { return key + "='" + currentKeys_1[key] + "'"; })
                            .join(',') + ")";
                        return [4 /*yield*/, this.getMockEntitySet(targetEntitySet.name)];
                    case 2:
                        (_a.sent()).performPOST(currentKeys_1, postData, odataRequest.tenantId);
                        return [3 /*break*/, 4];
                    case 3:
                        data[navPropertyName].push(postData);
                        _a.label = 4;
                    case 4: return [2 /*return*/, postData];
                    case 5:
                        currentKeys_2 = {};
                        entitySet.entityType.keys.forEach(function (key) {
                            if (postData[key.name] !== undefined) {
                                currentKeys_2[key.name] = postData[key.name];
                            }
                        });
                        return [4 /*yield*/, this.getMockEntitySet(entitySet.name)];
                    case 6:
                        (_a.sent()).performPOST(currentKeys_2, postData, odataRequest.tenantId);
                        odataRequest.context = "../$metadata#" + entitySet.name + "/$entity";
                        odataRequest.location = entitySet.name + "(" + Object.keys(currentKeys_2)
                            .map(function (key) { return key + "='" + currentKeys_2[key] + "'"; })
                            .join(',') + ")";
                        return [2 /*return*/, postData];
                }
            });
        });
    };
    DataAccess.prototype.deleteData = function (odataRequest) {
        return __awaiter(this, void 0, void 0, function () {
            var entitySetName;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        entitySetName = odataRequest.query.queryPath[0].path;
                        return [4 /*yield*/, this.getMockEntitySet(entitySetName)];
                    case 1: return [2 /*return*/, (_a.sent()).performDELETE(odataRequest.query.queryPath[0].keys, odataRequest.tenantId)];
                }
            });
        });
    };
    DataAccess.prototype.resetStickySessionTimeout = function (res, tenantId) {
        res.header('odata-version', '4.0');
        var UUID = '';
        var timeoutTime = 20;
        this.stickyEntitySets.forEach(function (entitySet) {
            UUID = entitySet.resetSessionTimeout(tenantId);
            timeoutTime = entitySet.sessionTimeoutTime;
        });
        res.header('sap-contextid', UUID);
        res.header('sap-http-session-timeout', timeoutTime.toString());
        res.status(200);
        res.end();
    };
    return DataAccess;
}());
exports.DataAccess = DataAccess;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YUFjY2Vzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9yb3V0ZXIvZGF0YS9kYXRhQWNjZXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBLHlDQUFnRDtBQUNoRCxtREFBc0Q7QUFDdEQscURBQXdEO0FBR3hELHNFQUF5QztBQUN6QyxtRUFBa0U7QUFHbEU7SUFRSSxvQkFDSSxJQUFZLEVBQ1osUUFBdUIsRUFDdkIsYUFBc0IsRUFDdEIscUJBQThCLEVBQzlCLGdCQUF5QjtRQUw3QixpQkFjQztRQWpCUyxlQUFVLEdBQXNDLEVBQUUsQ0FBQztRQUNuRCxxQkFBZ0IsR0FBMEIsRUFBRSxDQUFDO1FBU25ELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUM7UUFDL0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7UUFDbkMsSUFBSSxDQUFDLHFCQUFxQixHQUFHLHFCQUFxQixDQUFDO1FBQ25ELElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQUMsU0FBUztZQUM1QyxLQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzVELENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVNLHlCQUFJLEdBQVg7UUFDSSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLEtBQUssS0FBSyxDQUFDO0lBQ2hELENBQUM7SUFFWSxxQ0FBZ0IsR0FBN0IsVUFDSSxjQUFjLEVBQ2QsZ0JBQTBCLEVBQzFCLG1CQUFnQyxFQUNoQyxhQUFtQjs7OztnQkFFbkIsSUFBSSxtQkFBbUIsRUFBRTtvQkFDZixhQUFhLEdBQUcsSUFBSSwrQ0FBc0IsQ0FBQyxtQkFBbUIsRUFBRSxh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UUFDSCxHQUFHLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNsQyxHQUFHLENBQUMsTUFBTSxDQUFDLDBCQUEwQixFQUFFLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQy9ELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEIsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUNMLGlCQUFDO0FBQUQsQ0FBQyxBQXR1QkQsSUFzdUJDO0FBdHVCWSxnQ0FBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9EYXRhUmVxdWVzdCB9IGZyb20gJy4uL3JlcXVlc3Qvb2RhdGFSZXF1ZXN0JztcbmltcG9ydCB7IE9EYXRhTWV0YWRhdGEgfSBmcm9tICcuL21ldGFkYXRhJztcbmltcG9ydCB7IE1vY2tEYXRhRW50aXR5U2V0IH0gZnJvbSAnLi9lbnRpdHlTZXQnO1xuaW1wb3J0IHsgRHJhZnRNb2NrRW50aXR5U2V0IH0gZnJvbSAnLi9kcmFmdEVudGl0eVNldCc7XG5pbXBvcnQgeyBTdGlja3lNb2NrRW50aXR5U2V0IH0gZnJvbSAnLi9zdGlja3lFbnRpdHlTZXQnO1xuaW1wb3J0IHsgRW50aXR5U2V0LCBFbnRpdHlUeXBlIH0gZnJvbSAnQHNhcC11eC9hbm5vdGF0aW9uLWNvbnZlcnRlcic7XG5pbXBvcnQgeyBPRGF0YVY0UmVxdWVzdCB9IGZyb20gJy4uL3JlcXVlc3Qvb2RhdGFWNFJlcXVlc3QnO1xuaW1wb3J0IGNsb25lRGVlcCBmcm9tICdsb2Rhc2guY2xvbmVkZWVwJztcbmltcG9ydCB7IENvbnRhaW5lZERhdGFFbnRpdHlTZXQgfSBmcm9tICcuL0NvbnRhaW5lZERhdGFFbnRpdHlTZXQnO1xuaW1wb3J0IHsgRGF0YUFjY2Vzc0ludGVyZmFjZSB9IGZyb20gJy4vY29tbW9uJztcblxuZXhwb3J0IGNsYXNzIERhdGFBY2Nlc3MgaW1wbGVtZW50cyBEYXRhQWNjZXNzSW50ZXJmYWNlIHtcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgbW9ja0RhdGFSb290Rm9sZGVyOiBzdHJpbmc7XG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IG1ldGFkYXRhOiBPRGF0YU1ldGFkYXRhO1xuICAgIHByb3RlY3RlZCByZWFkb25seSBzdHJpY3RLZXlNb2RlOiBib29sZWFuO1xuICAgIHByb3RlY3RlZCByZWFkb25seSBjb250ZXh0QmFzZWRJc29sYXRpb246IGJvb2xlYW47XG4gICAgcHJvdGVjdGVkIGVudGl0eVNldHM6IFJlY29yZDxzdHJpbmcsIE1vY2tEYXRhRW50aXR5U2V0PiA9IHt9O1xuICAgIHByb3RlY3RlZCBzdGlja3lFbnRpdHlTZXRzOiBTdGlja3lNb2NrRW50aXR5U2V0W10gPSBbXTtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICAgICAgcm9vdDogc3RyaW5nLFxuICAgICAgICBtZXRhZGF0YTogT0RhdGFNZXRhZGF0YSxcbiAgICAgICAgc3RyaWN0S2V5TW9kZTogYm9vbGVhbixcbiAgICAgICAgY29udGV4dEJhc2VkSXNvbGF0aW9uOiBib29sZWFuLFxuICAgICAgICBnZW5lcmF0ZU1vY2tEYXRhOiBib29sZWFuXG4gICAgKSB7XG4gICAgICAgIHRoaXMubW9ja0RhdGFSb290Rm9sZGVyID0gcm9vdDtcbiAgICAgICAgdGhpcy5tZXRhZGF0YSA9IG1ldGFkYXRhO1xuICAgICAgICB0aGlzLnN0cmljdEtleU1vZGUgPSBzdHJpY3RLZXlNb2RlO1xuICAgICAgICB0aGlzLmNvbnRleHRCYXNlZElzb2xhdGlvbiA9IGNvbnRleHRCYXNlZElzb2xhdGlvbjtcbiAgICAgICAgdGhpcy5tZXRhZGF0YS5nZXRFbnRpdHlTZXRzKCkuZm9yRWFjaCgoZW50aXR5U2V0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmdldE1vY2tFbnRpdHlTZXQoZW50aXR5U2V0Lm5hbWUsIGdlbmVyYXRlTW9ja0RhdGEpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaXNWNCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWV0YWRhdGEuZ2V0VmVyc2lvbigpICE9PSAnMi4wJztcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZ2V0TW9ja0VudGl0eVNldChcbiAgICAgICAgZW50aXR5VHlwZU5hbWUsXG4gICAgICAgIGdlbmVyYXRlTW9ja0RhdGE/OiBib29sZWFuLFxuICAgICAgICBjb250YWluZWRFbnRpdHlUeXBlPzogRW50aXR5VHlwZSxcbiAgICAgICAgY29udGFpbmVkRGF0YT86IGFueVxuICAgICk6IFByb21pc2U8TW9ja0RhdGFFbnRpdHlTZXQ+IHtcbiAgICAgICAgaWYgKGNvbnRhaW5lZEVudGl0eVR5cGUpIHtcbiAgICAgICAgICAgIGNvbnN0IG1vY2tFbnRpdHlTZXQgPSBuZXcgQ29udGFpbmVkRGF0YUVudGl0eVNldChjb250YWluZWRFbnRpdHlUeXBlLCBjb250YWluZWREYXRhLCB0aGlzKTtcbiAgICAgICAgICAgIHJldHVybiBtb2NrRW50aXR5U2V0LnJlYWR5UHJvbWlzZTtcbiAgICAgICAgfSBlbHNlIGlmICghdGhpcy5lbnRpdHlTZXRzW2VudGl0eVR5cGVOYW1lXSkge1xuICAgICAgICAgICAgY29uc3QgZW50aXR5U2V0ID0gdGhpcy5tZXRhZGF0YS5nZXRFbnRpdHlTZXQoZW50aXR5VHlwZU5hbWUpO1xuICAgICAgICAgICAgY29uc3QgZW50aXR5VHlwZSA9IHRoaXMubWV0YWRhdGEuZ2V0RW50aXR5VHlwZShlbnRpdHlUeXBlTmFtZSk7XG4gICAgICAgICAgICBsZXQgbW9ja0VudGl0eVNldDogTW9ja0RhdGFFbnRpdHlTZXQ7XG4gICAgICAgICAgICBpZiAodGhpcy5tZXRhZGF0YS5pc0RyYWZ0RW50aXR5KGVudGl0eVNldCkpIHtcbiAgICAgICAgICAgICAgICBtb2NrRW50aXR5U2V0ID0gbmV3IERyYWZ0TW9ja0VudGl0eVNldChcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2NrRGF0YVJvb3RGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgIGVudGl0eVNldCB8fCBlbnRpdHlUeXBlLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgICAgICAgICBnZW5lcmF0ZU1vY2tEYXRhXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5tZXRhZGF0YS5pc1N0aWNreUVudGl0eShlbnRpdHlTZXQpKSB7XG4gICAgICAgICAgICAgICAgbW9ja0VudGl0eVNldCA9IG5ldyBTdGlja3lNb2NrRW50aXR5U2V0KFxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1vY2tEYXRhUm9vdEZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgZW50aXR5U2V0IHx8IGVudGl0eVR5cGUsXG4gICAgICAgICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgICAgICAgIGdlbmVyYXRlTW9ja0RhdGFcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RpY2t5RW50aXR5U2V0cy5wdXNoKG1vY2tFbnRpdHlTZXQgYXMgU3RpY2t5TW9ja0VudGl0eVNldCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG1vY2tFbnRpdHlTZXQgPSBuZXcgTW9ja0RhdGFFbnRpdHlTZXQoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubW9ja0RhdGFSb290Rm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHlTZXQgfHwgZW50aXR5VHlwZSxcbiAgICAgICAgICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGVNb2NrRGF0YVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmVudGl0eVNldHNbZW50aXR5VHlwZU5hbWVdID0gbW9ja0VudGl0eVNldDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5lbnRpdHlTZXRzW2VudGl0eVR5cGVOYW1lXS5yZWFkeVByb21pc2U7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHBlcmZvcm1BY3Rpb24ob2RhdGFSZXF1ZXN0OiBPRGF0YVJlcXVlc3QsIGFjdGlvbkRhdGE6IG9iamVjdCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIC8vIGlmIGl0J3MgYSBib3VuZCBhY3Rpb24gd2UgbmVlZCB0byBsb29rIGZvciB0aGUgYWN0aW9uIHR5cGVcbiAgICAgICAgY29uc3Qgcm9vdEVudGl0eVNldCA9IHRoaXMubWV0YWRhdGEuZ2V0RW50aXR5U2V0KG9kYXRhUmVxdWVzdC5xdWVyeS5xdWVyeVBhdGhbMF0ucGF0aCk7XG4gICAgICAgIGlmIChyb290RW50aXR5U2V0KSB7XG4gICAgICAgICAgICBsZXQgY3VycmVudEVudGl0eVR5cGUgPSByb290RW50aXR5U2V0LmVudGl0eVR5cGU7XG4gICAgICAgICAgICBsZXQgY3VycmVudEVudGl0eVNldCA9IHJvb3RFbnRpdHlTZXQ7XG4gICAgICAgICAgICBsZXQgaSA9IDE7XG4gICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgb2RhdGFSZXF1ZXN0LnF1ZXJ5LnF1ZXJ5UGF0aC5sZW5ndGggLSAxOyBpKyspIHtcbiAgICAgICAgICAgICAgICBjb25zdCBxdWVyeVBhcnQgPSBvZGF0YVJlcXVlc3QucXVlcnkucXVlcnlQYXRoW2ldLnBhdGg7XG4gICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0TmF2UHJvcCA9IGN1cnJlbnRFbnRpdHlUeXBlLm5hdmlnYXRpb25Qcm9wZXJ0aWVzLmZpbmQoXG4gICAgICAgICAgICAgICAgICAgIChuYXZQcm9wKSA9PiBuYXZQcm9wLm5hbWUgPT09IHF1ZXJ5UGFydFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldE5hdlByb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudEVudGl0eVR5cGUgPSB0YXJnZXROYXZQcm9wLnRhcmdldFR5cGU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50RW50aXR5U2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50RW50aXR5U2V0ID0gY3VycmVudEVudGl0eVNldC5uYXZpZ2F0aW9uUHJvcGVydHlCaW5kaW5nW3F1ZXJ5UGFydF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBlbnRpdHlTZXROYW1lID0gY3VycmVudEVudGl0eVNldCA/IGN1cnJlbnRFbnRpdHlTZXQubmFtZSA6IGN1cnJlbnRFbnRpdHlUeXBlLm5hbWU7XG4gICAgICAgICAgICBjb25zdCBhY3Rpb25OYW1lID0gb2RhdGFSZXF1ZXN0LnF1ZXJ5LnF1ZXJ5UGF0aFtpXSA/IG9kYXRhUmVxdWVzdC5xdWVyeS5xdWVyeVBhdGhbaV0ucGF0aCA6IHVuZGVmaW5lZDsgLy8gRG91YmxlIGFzIGFjdGlvbiBuYW1lXG4gICAgICAgICAgICBpZiAoYWN0aW9uTmFtZSAmJiBhY3Rpb25OYW1lLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmcUFjdGlvbk5hbWUgPSBgJHthY3Rpb25OYW1lfSgke2N1cnJlbnRFbnRpdHlUeXBlLmZ1bGx5UXVhbGlmaWVkTmFtZX0pYDtcbiAgICAgICAgICAgICAgICBjb25zdCBhY3Rpb25EZWZpbml0aW9uID0gdGhpcy5tZXRhZGF0YS5nZXRBY3Rpb25CeUZRTihmcUFjdGlvbk5hbWUpO1xuICAgICAgICAgICAgICAgIGlmIChhY3Rpb25EZWZpbml0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXRNb2NrRW50aXR5U2V0KGVudGl0eVNldE5hbWUpKS5leGVjdXRlQWN0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uRGVmaW5pdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICBvZGF0YVJlcXVlc3QsXG4gICAgICAgICAgICAgICAgICAgICAgICBvZGF0YVJlcXVlc3QucXVlcnkucXVlcnlQYXRoW2kgLSAxXS5rZXlzXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbGxlY2ZxQWN0aW9uTmFtZSA9IGAke2FjdGlvbk5hbWV9KENvbGxlY3Rpb24oJHtjdXJyZW50RW50aXR5VHlwZS5mdWxseVF1YWxpZmllZE5hbWV9KSlgO1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbGxlY2FjdGlvbkRlZmluaXRpb24gPSB0aGlzLm1ldGFkYXRhLmdldEFjdGlvbkJ5RlFOKGNvbGxlY2ZxQWN0aW9uTmFtZSk7XG4gICAgICAgICAgICAgICAgaWYgKGNvbGxlY2FjdGlvbkRlZmluaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChhd2FpdCB0aGlzLmdldE1vY2tFbnRpdHlTZXQoZW50aXR5U2V0TmFtZSkpLmV4ZWN1dGVBY3Rpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWNhY3Rpb25EZWZpbml0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uRGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9kYXRhUmVxdWVzdCxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9kYXRhUmVxdWVzdC5xdWVyeS5xdWVyeVBhdGhbMF0ua2V5c1xuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIFVuYm91bmQgYWN0aW9uXG4gICAgICAgICAgICBjb25zdCBhY3Rpb25OYW1lID0gb2RhdGFSZXF1ZXN0LnF1ZXJ5LnF1ZXJ5UGF0aFswXS5wYXRoO1xuICAgICAgICAgICAgY29uc3QgZnFBY3Rpb25OYW1lID0gYCR7dGhpcy5tZXRhZGF0YS5nZXRFbnRpdHlDb250YWluZXJQYXRoKCl9LyR7YWN0aW9uTmFtZX0oKWA7XG4gICAgICAgICAgICBjb25zdCBhY3Rpb25EZWZpbml0aW9uID0gdGhpcy5tZXRhZGF0YS5nZXRBY3Rpb25CeUZRTihmcUFjdGlvbk5hbWUpO1xuICAgICAgICAgICAgLy8gVGVjaG5pY2FsbHkgaSdtIG5vdCBzdXJlIHdoYXQgd2UgY2FuIGRvIGhlcmUgYnV0IHdlIGNuYSBhdCBsZWFzdCBjaGVjayBpZiBpdCdzIGEgc3RpY2t5IGFjdGlvblxuICAgICAgICAgICAgaWYgKGFjdGlvbkRlZmluaXRpb24gJiYgdGhpcy5tZXRhZGF0YS5nZXRFbnRpdHlTZXRCeVR5cGUoYWN0aW9uRGVmaW5pdGlvbi5zb3VyY2VUeXBlKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldEVudGl0eVNldCA9IHRoaXMubWV0YWRhdGEuZ2V0RW50aXR5U2V0QnlUeXBlKGFjdGlvbkRlZmluaXRpb24uc291cmNlVHlwZSk7XG4gICAgICAgICAgICAgICAgbGV0IG91dERhdGE6IGFueSA9IChhd2FpdCB0aGlzLmdldE1vY2tFbnRpdHlTZXQodGFyZ2V0RW50aXR5U2V0Lm5hbWUpKS5leGVjdXRlQWN0aW9uKFxuICAgICAgICAgICAgICAgICAgICBhY3Rpb25EZWZpbml0aW9uLFxuICAgICAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHt9LCBhY3Rpb25EYXRhLCBvZGF0YVJlcXVlc3QucXVlcnkucmF3UGFyYW1zKSxcbiAgICAgICAgICAgICAgICAgICAgb2RhdGFSZXF1ZXN0LFxuICAgICAgICAgICAgICAgICAgICBvZGF0YVJlcXVlc3QucXVlcnkucmF3UGFyYW1zXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5tZXRhZGF0YS5nZXRWZXJzaW9uKCkgPT09ICcyLjAnKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVucmljaEVsZW1lbnQgPSAoZW50aXR5U2V0OiBFbnRpdHlTZXQsIGRhdGFMaW5lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXlWYWx1ZXM6IHN0cmluZ1tdID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHlTZXQuZW50aXR5VHlwZS5rZXlzLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleVZhbHVlcy5wdXNoKGAke2tleS5uYW1lfT0nJHtkYXRhTGluZVtrZXkubmFtZV19J2ApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1cmkgPSBgJHtvZGF0YVJlcXVlc3QuYmFzZVVybH0vJHtlbnRpdHlTZXQubmFtZX0oJHtrZXlWYWx1ZXMuam9pbignLCcpfSlgO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YUxpbmVbJ19fbWV0YWRhdGEnXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogdXJpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVyaTogdXJpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGVudGl0eVNldC5lbnRpdHlUeXBlTmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhTGluZTtcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBFbnJpY2ggZGF0YSB3aXRoIF9fbWV0YWRhdGEgZm9yIHYyXG4gICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG91dERhdGEpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvdXREYXRhID0gKG91dERhdGEgYXMgYW55W10pLm1hcCgoZWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbnJpY2hFbGVtZW50KHRhcmdldEVudGl0eVNldCwgZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvdXREYXRhICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dERhdGEgPSBlbnJpY2hFbGVtZW50KHRhcmdldEVudGl0eVNldCwgb3V0RGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG91dERhdGE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IGZxQWN0aW9uTmFtZSA9IGAke2FjdGlvbk5hbWV9KClgO1xuICAgICAgICAgICAgICAgIGNvbnN0IGFjdGlvbkRlZmluaXRpb24gPSB0aGlzLm1ldGFkYXRhLmdldEFjdGlvbkJ5RlFOKGZxQWN0aW9uTmFtZSk7XG4gICAgICAgICAgICAgICAgaWYgKGFjdGlvbkRlZmluaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGlja3lFbnRpdHlTZXRzLmZvckVhY2goKGVudGl0eVNldCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5U2V0LmV4ZWN1dGVBY3Rpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uRGVmaW5pdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25EYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9kYXRhUmVxdWVzdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZGF0YVJlcXVlc3QucXVlcnkucXVlcnlQYXRoWzBdLmtleXNcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHVibGljIGdldE5hdmlnYXRpb25Qcm9wZXJ0eUtleXMoXG4gICAgICAgIGRhdGE6IGFueSxcbiAgICAgICAgbmF2UHJvcERldGFpbDogYW55LFxuICAgICAgICBjdXJyZW50RW50aXR5VHlwZTogRW50aXR5VHlwZSxcbiAgICAgICAgY3VycmVudEtleXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4sXG4gICAgICAgIGZvckNyZWF0ZSA9IGZhbHNlXG4gICAgKTogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB7XG4gICAgICAgIGlmIChuYXZQcm9wRGV0YWlsLnJlZmVyZW50aWFsQ29uc3RyYWludCAmJiBuYXZQcm9wRGV0YWlsLnJlZmVyZW50aWFsQ29uc3RyYWludC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBkYXRhQXJyYXkgPSBBcnJheS5pc0FycmF5KGRhdGEpID8gZGF0YSA6IFtkYXRhXTtcbiAgICAgICAgICAgIGRhdGFBcnJheS5mb3JFYWNoKChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgbmF2UHJvcERldGFpbC5yZWZlcmVudGlhbENvbnN0cmFpbnQuZm9yRWFjaCgocmVmQ29uc3RyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRLZXlzW3JlZkNvbnN0ci50YXJnZXRQcm9wZXJ0eV0gPSBkYXRhW3JlZkNvbnN0ci5zb3VyY2VQcm9wZXJ0eV07XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIFRyeSB0byBmaW5kIGEgYmFjayBsaW5rIChhIG5hdiBwcm9wZXJ0eSBnb2luZyBiYWNrIHRvIHRoZSBvcmlnaW5hbCBlbnRpdHlUeXBlKVxuICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxEYXRhID0gY2xvbmVEZWVwKGRhdGEpO1xuICAgICAgICAgICAgY29uc3QgYmFja05hdjogYW55ID0gKG5hdlByb3BEZXRhaWwudGFyZ2V0VHlwZSBhcyBFbnRpdHlUeXBlKS5uYXZpZ2F0aW9uUHJvcGVydGllcy5maW5kKFxuICAgICAgICAgICAgICAgICh0YXJnZXROYXZQcm9wKSA9PiAodGFyZ2V0TmF2UHJvcCBhcyBhbnkpLnRhcmdldFR5cGVOYW1lID09PSBjdXJyZW50RW50aXR5VHlwZS5mdWxseVF1YWxpZmllZE5hbWVcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBpZiAoYmFja05hdiAmJiBiYWNrTmF2LnJlZmVyZW50aWFsQ29uc3RyYWludCAmJiBiYWNrTmF2LnJlZmVyZW50aWFsQ29uc3RyYWludC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgYmFja05hdi5yZWZlcmVudGlhbENvbnN0cmFpbnQuZm9yRWFjaCgocmVmQ29uc3RyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbERhdGFbcmVmQ29uc3RyLnRhcmdldFByb3BlcnR5XSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50S2V5c1tyZWZDb25zdHIuc291cmNlUHJvcGVydHldID0gb3JpZ2luYWxEYXRhW3JlZkNvbnN0ci50YXJnZXRQcm9wZXJ0eV07XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb3JpZ2luYWxEYXRhW3JlZkNvbnN0ci50YXJnZXRQcm9wZXJ0eV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBuYXZQcm9wRGV0YWlsLnRhcmdldFR5cGUua2V5cy5mb3JFYWNoKChwcm9wS2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BLZXkubmFtZSA9PT0gJ0lzQWN0aXZlRW50aXR5JyAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEtleXNbcHJvcEtleS5uYW1lXSA9PT0gdW5kZWZpbmVkICYmXG4gICAgICAgICAgICAgICAgICAgICAgICBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChvcmlnaW5hbERhdGEsIHByb3BLZXkubmFtZSkgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICghZm9yQ3JlYXRlIHx8ICFwcm9wS2V5LmFubm90YXRpb25zPy5Db3JlPy5Db21wdXRlZClcbiAgICAgICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50S2V5c1twcm9wS2V5Lm5hbWVdID0gb3JpZ2luYWxEYXRhW3Byb3BLZXkubmFtZV07XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb3JpZ2luYWxEYXRhW3Byb3BLZXkubmFtZV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuc3RyaWN0S2V5TW9kZSkge1xuICAgICAgICAgICAgICAgIG5hdlByb3BEZXRhaWwudGFyZ2V0VHlwZS5rZXlzLmZvckVhY2goKHByb3BLZXkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwob3JpZ2luYWxEYXRhLCBwcm9wS2V5Lm5hbWUpICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAoIWZvckNyZWF0ZSB8fCAhcHJvcEtleS5hbm5vdGF0aW9ucz8uQ29yZT8uQ29tcHV0ZWQpXG4gICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEtleXNbcHJvcEtleS5uYW1lXSA9IG9yaWdpbmFsRGF0YVtwcm9wS2V5Lm5hbWVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG9yaWdpbmFsRGF0YVtwcm9wS2V5Lm5hbWVdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgaXMgbm8ga2V5IG9yIG9ubHkgZHJhZnQgc3R1ZmZcbiAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKGN1cnJlbnRLZXlzKS5sZW5ndGggPT09IDAgfHxcbiAgICAgICAgICAgICAgICAgICAgKE9iamVjdC5rZXlzKGN1cnJlbnRLZXlzKS5sZW5ndGggPT09IDEgJiYgY3VycmVudEtleXNbJ0lzQWN0aXZlRW50aXR5J10pXG4gICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIElmIHdlIHN0aWxsIGRvbid0IGhhdmUgYW55dGhpbmcsIHRyeSB0byBnZXQgdGhlIGtleXMgZnJvbSB0aGUgY3VycmVudCBlbnRpdHkgdGhhdCBhcmUgcHJvcGVydGllcyBpbiB0aGUgdGFyZ2V0XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRFbnRpdHlUeXBlLmtleXMuZm9yRWFjaCgocHJvcEtleSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hdlByb3BEZXRhaWwudGFyZ2V0VHlwZS5lbnRpdHlQcm9wZXJ0aWVzLmZpbmQoKHByb3ApID0+IHByb3AubmFtZSA9PT0gcHJvcEtleS5uYW1lKSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsRGF0YVtwcm9wS2V5Lm5hbWVdICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRLZXlzW3Byb3BLZXkubmFtZV0gPSBvcmlnaW5hbERhdGFbcHJvcEtleS5uYW1lXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb3JpZ2luYWxEYXRhW3Byb3BLZXkubmFtZV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY3VycmVudEtleXM7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0RXhwYW5kRGF0YShcbiAgICAgICAgY3VycmVudEVudGl0eVNldDogRW50aXR5U2V0LFxuICAgICAgICBlbnRpdHlUeXBlOiBFbnRpdHlUeXBlLFxuICAgICAgICBleHBhbmROYXZQcm9wOiBzdHJpbmcsXG4gICAgICAgIGRhdGE6IG9iamVjdCxcbiAgICAgICAgcmVxdWVzdEV4cGFuZE9iamVjdDogYW55LFxuICAgICAgICB0ZW5hbnRJZDogc3RyaW5nLFxuICAgICAgICBwcmV2aW91c0VudGl0eVNldDogRW50aXR5U2V0LFxuICAgICAgICB2aXNpdGVkUGF0aHM6IHN0cmluZ1tdXG4gICAgKSB7XG4gICAgICAgIGlmIChkYXRhID09PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbmF2UHJvcCA9IGVudGl0eVR5cGUubmF2aWdhdGlvblByb3BlcnRpZXMuZmluZCgobmF2UHJvcCkgPT4gbmF2UHJvcC5uYW1lID09PSBleHBhbmROYXZQcm9wKTtcbiAgICAgICAgdmlzaXRlZFBhdGhzID0gdmlzaXRlZFBhdGhzLmNvbmNhdCgpO1xuICAgICAgICB2aXNpdGVkUGF0aHMucHVzaChleHBhbmROYXZQcm9wKTtcbiAgICAgICAgbGV0IHRhcmdldEVudGl0eVNldDtcbiAgICAgICAgaWYgKG5hdlByb3AgJiYgY3VycmVudEVudGl0eVNldCAmJiBjdXJyZW50RW50aXR5U2V0Lm5hdmlnYXRpb25Qcm9wZXJ0eUJpbmRpbmdbZXhwYW5kTmF2UHJvcF0pIHtcbiAgICAgICAgICAgIHRhcmdldEVudGl0eVNldCA9IGN1cnJlbnRFbnRpdHlTZXQubmF2aWdhdGlvblByb3BlcnR5QmluZGluZ1tleHBhbmROYXZQcm9wXTtcbiAgICAgICAgfSBlbHNlIGlmIChwcmV2aW91c0VudGl0eVNldCAmJiBwcmV2aW91c0VudGl0eVNldC5uYXZpZ2F0aW9uUHJvcGVydHlCaW5kaW5nW3Zpc2l0ZWRQYXRocy5qb2luKCcvJyldKSB7XG4gICAgICAgICAgICB0YXJnZXRFbnRpdHlTZXQgPSBwcmV2aW91c0VudGl0eVNldC5uYXZpZ2F0aW9uUHJvcGVydHlCaW5kaW5nW3Zpc2l0ZWRQYXRocy5qb2luKCcvJyldO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0YXJnZXRFbnRpdHlTZXQpIHtcbiAgICAgICAgICAgIGNvbnN0IG5hdkVudGl0eVNldCA9IGF3YWl0IHRoaXMuZ2V0TW9ja0VudGl0eVNldCh0YXJnZXRFbnRpdHlTZXQubmFtZSk7XG4gICAgICAgICAgICBjb25zdCBkYXRhQXJyYXkgPSBBcnJheS5pc0FycmF5KGRhdGEpID8gZGF0YSA6IFtkYXRhXTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgZGF0YSBvZiBkYXRhQXJyYXkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50S2V5cyA9IHRoaXMuZ2V0TmF2aWdhdGlvblByb3BlcnR5S2V5cyhkYXRhLCBuYXZQcm9wLCBlbnRpdHlUeXBlLCB7fSk7XG4gICAgICAgICAgICAgICAgaWYgKCFuYXZQcm9wLmNvbnRhaW5zVGFyZ2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4cGFuZERhdGEgPSBuYXZFbnRpdHlTZXQucGVyZm9ybUdFVChjdXJyZW50S2V5cywgbmF2UHJvcC5pc0NvbGxlY3Rpb24sIHRlbmFudElkKTtcbiAgICAgICAgICAgICAgICAgICAgZGF0YVtleHBhbmROYXZQcm9wXSA9IGV4cGFuZERhdGE7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4cGFuZERldGFpbCA9IHJlcXVlc3RFeHBhbmRPYmplY3QuZXhwYW5kW2V4cGFuZE5hdlByb3BdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhwYW5kRGV0YWlsLmV4cGFuZCAmJiBPYmplY3Qua2V5cyhleHBhbmREZXRhaWwuZXhwYW5kKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyhleHBhbmREZXRhaWwuZXhwYW5kKS5tYXAoYXN5bmMgKHN1YkV4cGFuZE5hdlByb3ApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RXhwYW5kRGF0YShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldEVudGl0eVNldCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hdlByb3AudGFyZ2V0VHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YkV4cGFuZE5hdlByb3AsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHBhbmREYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhwYW5kRGV0YWlsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVuYW50SWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRFbnRpdHlTZXQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGdldERhdGEob2RhdGFSZXF1ZXN0OiBPRGF0YVJlcXVlc3QpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBsZXQgY3VycmVudEVudGl0eVNldDogRW50aXR5U2V0ID0gbnVsbDtcbiAgICAgICAgbGV0IHByZXZpb3VzRW50aXR5U2V0OiBFbnRpdHlTZXQgPSBudWxsO1xuICAgICAgICBsZXQgY3VycmVudEVudGl0eVR5cGU6IEVudGl0eVR5cGUgPSBudWxsO1xuICAgICAgICBsZXQgdmlzaXRlZFBhdGhzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBsZXQgdGFyZ2V0Q29udGFpbmVkRGF0YTogYW55O1xuICAgICAgICBsZXQgdGFyZ2V0Q29udGFpbmVkRW50aXR5VHlwZSA9IG51bGw7XG4gICAgICAgIGNvbnN0IHJvb3RFbnRpdHlTZXQgPSB0aGlzLm1ldGFkYXRhLmdldEVudGl0eVNldChvZGF0YVJlcXVlc3QucXVlcnkucXVlcnlQYXRoWzBdLnBhdGgpO1xuICAgICAgICBsZXQgaXNDb3VudCA9IGZhbHNlO1xuICAgICAgICBsZXQgZGF0YTogYW55ID0gYXdhaXQgb2RhdGFSZXF1ZXN0LnF1ZXJ5LnF1ZXJ5UGF0aC5yZWR1Y2UoYXN5bmMgKGRhdGEsIHF1ZXJ5UGF0aFBhcnQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICBkYXRhID0gYXdhaXQgZGF0YTtcbiAgICAgICAgICAgIGxldCBjdXJyZW50S2V5czogUmVjb3JkPHN0cmluZywgYW55PiA9IHF1ZXJ5UGF0aFBhcnQua2V5cyB8fCB7fTtcbiAgICAgICAgICAgIGxldCBhc0FycmF5OiBib29sZWFuID0gT2JqZWN0LmtleXMoY3VycmVudEtleXMpLmxlbmd0aCA9PT0gMDtcbiAgICAgICAgICAgIGlmIChxdWVyeVBhdGhQYXJ0LnBhdGggPT09ICckY291bnQnKSB7XG4gICAgICAgICAgICAgICAgaXNDb3VudCA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoKCFjdXJyZW50RW50aXR5VHlwZSB8fCBkYXRhID09PSBudWxsKSAmJiBpbmRleCA+IDApIHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEVudGl0eVR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hdlByb3BEZXRhaWwgPSBjdXJyZW50RW50aXR5VHlwZS5uYXZpZ2F0aW9uUHJvcGVydGllcy5maW5kKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIChuYXZQcm9wKSA9PiBuYXZQcm9wLm5hbWUgPT09IHF1ZXJ5UGF0aFBhcnQucGF0aFxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzQXJyYXkgPSBhc0FycmF5ICYmIG5hdlByb3BEZXRhaWwuaXNDb2xsZWN0aW9uO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhc0FycmF5ID8gW10gOiBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghY3VycmVudEVudGl0eVR5cGUpIHtcbiAgICAgICAgICAgICAgICAvLyBGaXJzdCBsZXZlbCBpZiBlbnRpdHkgc2V0LCB0aGVuIGl0J3MgbmF2aWdhdGlvbiBwcm9wZXJ0aWVzXG4gICAgICAgICAgICAgICAgY3VycmVudEVudGl0eVNldCA9IHRoaXMubWV0YWRhdGEuZ2V0RW50aXR5U2V0KHF1ZXJ5UGF0aFBhcnQucGF0aCk7XG4gICAgICAgICAgICAgICAgcHJldmlvdXNFbnRpdHlTZXQgPSBjdXJyZW50RW50aXR5U2V0O1xuICAgICAgICAgICAgICAgIGN1cnJlbnRFbnRpdHlUeXBlID0gY3VycmVudEVudGl0eVNldC5lbnRpdHlUeXBlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBuYXZQcm9wRGV0YWlsID0gY3VycmVudEVudGl0eVR5cGUubmF2aWdhdGlvblByb3BlcnRpZXMuZmluZChcbiAgICAgICAgICAgICAgICAgICAgKG5hdlByb3ApID0+IG5hdlByb3AubmFtZSA9PT0gcXVlcnlQYXRoUGFydC5wYXRoXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBpZiAobmF2UHJvcERldGFpbC5uYW1lID09PSAnU2libGluZ0VudGl0eScgJiYgY3VycmVudEVudGl0eVR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNBcnJheSA9IGFzQXJyYXkgJiYgbmF2UHJvcERldGFpbC5pc0NvbGxlY3Rpb247XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRLZXlzLklzQWN0aXZlRW50aXR5ID0gIShkYXRhIGFzIGFueSkuSXNBY3RpdmVFbnRpdHk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdmlzaXRlZFBhdGhzLnB1c2gocXVlcnlQYXRoUGFydC5wYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5hdlByb3BEZXRhaWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhc0FycmF5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEtleXMgPSB0aGlzLmdldE5hdmlnYXRpb25Qcm9wZXJ0eUtleXMoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hdlByb3BEZXRhaWwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRFbnRpdHlUeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50S2V5c1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5hdlByb3BEZXRhaWwuY29udGFpbnNUYXJnZXQgJiYgcHJldmlvdXNFbnRpdHlTZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50RW50aXR5U2V0ID0gcHJldmlvdXNFbnRpdHlTZXQubmF2aWdhdGlvblByb3BlcnR5QmluZGluZ1t2aXNpdGVkUGF0aHMuam9pbignLycpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0VudGl0eVNldCA9IGN1cnJlbnRFbnRpdHlTZXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlzaXRlZFBhdGhzID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEVudGl0eVR5cGUgPSBjdXJyZW50RW50aXR5U2V0LmVudGl0eVR5cGU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVkRW50aXR5VHlwZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVkRGF0YSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldENvbnRhaW5lZEVudGl0eVR5cGUgPSBuYXZQcm9wRGV0YWlsLnRhcmdldFR5cGU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVkRGF0YSA9IGRhdGFbcXVlcnlQYXRoUGFydC5wYXRoXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50RW50aXR5U2V0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50RW50aXR5VHlwZSA9IHRhcmdldENvbnRhaW5lZEVudGl0eVR5cGU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50RW50aXR5U2V0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRFbnRpdHlUeXBlID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBhc0FycmF5ID0gYXNBcnJheSAmJiBuYXZQcm9wRGV0YWlsLmlzQ29sbGVjdGlvbjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIWN1cnJlbnRFbnRpdHlTZXQgJiYgIXRhcmdldENvbnRhaW5lZEVudGl0eVR5cGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXNBcnJheSA/IFtdIDogbnVsbDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YVtxdWVyeVBhdGhQYXJ0LnBhdGhdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5nZXRNb2NrRW50aXR5U2V0KFxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50RW50aXR5U2V0Py5uYW1lLFxuICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldENvbnRhaW5lZEVudGl0eVR5cGUsXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldENvbnRhaW5lZERhdGFcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApLnBlcmZvcm1HRVQoY3VycmVudEtleXMsIGFzQXJyYXksIG9kYXRhUmVxdWVzdC50ZW5hbnRJZCk7XG4gICAgICAgIH0sIHt9KTtcblxuICAgICAgICBpZiAoXG4gICAgICAgICAgICByb290RW50aXR5U2V0LmVudGl0eVR5cGU/LmFubm90YXRpb25zPy5Db21tb24/LlJlc3VsdENvbnRleHQ/LnZhbHVlT2YoKSAmJlxuICAgICAgICAgICAgb2RhdGFSZXF1ZXN0LnF1ZXJ5LnF1ZXJ5UGF0aC5sZW5ndGggPT09IDFcbiAgICAgICAgKSB7XG4gICAgICAgICAgICAvLyBQYXJhbWV0cml6ZWQgZW50aXR5c2V0LCB0aGV5IGNhbm5vdCBiZSByZXF1ZXN0ZWQgZGlyZWN0bHlcbiAgICAgICAgICAgIGNvbnN0IHBvdGVudGlhbFRhcmdldCA9IHJvb3RFbnRpdHlTZXQuZW50aXR5VHlwZS5uYXZpZ2F0aW9uUHJvcGVydGllcy5maW5kKFxuICAgICAgICAgICAgICAgIChuYXZQcm9wKSA9PiBuYXZQcm9wLmNvbnRhaW5zVGFyZ2V0XG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAgICAgICAgICAgICAgICdQYXJhbWV0cml6ZWQgZW50aXR5c2V0IGNhbm5vdCBiZSBxdWVyaWVkIGRpcmVjdGx5LCB5b3UgbmVlZCB0byBsb2FkIHRoZSByZXN1bHQgc2V0LCBtb3N0IGxpa2VseSBcIicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgcG90ZW50aWFsVGFyZ2V0Lm5hbWUgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ1wiIGluIHRoaXMgY2FzZSdcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChkYXRhICE9PSBudWxsIHx8IChBcnJheS5pc0FycmF5KGRhdGEpICYmIGRhdGEubGVuZ3RoID4gMCkpIHtcbiAgICAgICAgICAgIC8vIEFwcGx5ICRleHBhbmRcbiAgICAgICAgICAgIGlmIChvZGF0YVJlcXVlc3QucXVlcnkuZXhwYW5kKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKG9kYXRhUmVxdWVzdC5xdWVyeS5leHBhbmQpLm1hcChhc3luYyAoZXhwYW5kTmF2UHJvcCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RXhwYW5kRGF0YShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50RW50aXR5U2V0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRFbnRpdHlUeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGFuZE5hdlByb3AsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZGF0YVJlcXVlc3QucXVlcnksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2RhdGFSZXF1ZXN0LnRlbmFudElkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzRW50aXR5U2V0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpc2l0ZWRQYXRoc1xuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBBcHBseSAkZmlsdGVyXG4gICAgICAgICAgICBpZiAoKG9kYXRhUmVxdWVzdC5xdWVyeS5maWx0ZXIgfHwgb2RhdGFSZXF1ZXN0LnF1ZXJ5Py5hZ2dyZWdhdGVEZWZpbml0aW9uPy5maWx0ZXIpICYmIEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJEZWYgPSBvZGF0YVJlcXVlc3QucXVlcnkuZmlsdGVyIHx8IG9kYXRhUmVxdWVzdC5xdWVyeT8uYWdncmVnYXRlRGVmaW5pdGlvbj8uZmlsdGVyO1xuICAgICAgICAgICAgICAgIGNvbnN0IG1vY2tFbnRpdHlTZXQgPSBhd2FpdCB0aGlzLmdldE1vY2tFbnRpdHlTZXQoXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRFbnRpdHlTZXQgPyBjdXJyZW50RW50aXR5U2V0Lm5hbWUgOiBjdXJyZW50RW50aXR5VHlwZS5uYW1lXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5maWx0ZXIoKGRhdGFMaW5lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBtb2NrRW50aXR5U2V0LmNoZWNrRmlsdGVyKGRhdGFMaW5lLCBmaWx0ZXJEZWYsIG9kYXRhUmVxdWVzdC50ZW5hbnRJZCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBBcHBseSAkc2VhcmNoXG4gICAgICAgICAgICBpZiAob2RhdGFSZXF1ZXN0LnF1ZXJ5LnNlYXJjaFF1ZXJ5ICYmIEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtb2NrRW50aXR5U2V0ID0gYXdhaXQgdGhpcy5nZXRNb2NrRW50aXR5U2V0KGN1cnJlbnRFbnRpdHlUeXBlLm5hbWUpO1xuICAgICAgICAgICAgICAgIGRhdGEgPSBkYXRhLmZpbHRlcigoZGF0YUxpbmUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vY2tFbnRpdHlTZXQuY2hlY2tTZWFyY2goZGF0YUxpbmUsIG9kYXRhUmVxdWVzdC5xdWVyeS5zZWFyY2hRdWVyeSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEFwcGx5ICRhcHBseSBmb3IgYWdncmVnYXRlc1xuICAgICAgICAgICAgaWYgKG9kYXRhUmVxdWVzdC5xdWVyeS5hZ2dyZWdhdGVEZWZpbml0aW9uKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YUJ5R3JvdXAgPSB7fTtcbiAgICAgICAgICAgICAgICBjb25zdCBtb2NrRW50aXR5U2V0ID0gYXdhaXQgdGhpcy5nZXRNb2NrRW50aXR5U2V0KGN1cnJlbnRFbnRpdHlUeXBlLm5hbWUpO1xuICAgICAgICAgICAgICAgIGxldCBtb2NrRGF0YTtcbiAgICAgICAgICAgICAgICBpZiAobW9ja0VudGl0eVNldCkge1xuICAgICAgICAgICAgICAgICAgICBtb2NrRGF0YSA9IGF3YWl0IG1vY2tFbnRpdHlTZXQuZ2V0TW9ja0RhdGEob2RhdGFSZXF1ZXN0LnRlbmFudElkKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBnZXRBZ2dyZWdhdGVLZXkgPSBmdW5jdGlvbihkYXRhTGluZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2RhdGFSZXF1ZXN0LnF1ZXJ5LmFnZ3JlZ2F0ZURlZmluaXRpb24uZ3JvdXBCeS5yZWR1Y2UoKGtleSwgZ3JvdXBCeVByb3ApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleSArPSAnLCc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBrZXkgKz0gZGF0YUxpbmVbZ3JvdXBCeVByb3BdO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtleTtcbiAgICAgICAgICAgICAgICAgICAgfSwgJycpO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgZGF0YS5mb3JFYWNoKChkYXRhTGluZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBhZ2dyZWdhdGVLZXkgPSBnZXRBZ2dyZWdhdGVLZXkoZGF0YUxpbmUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWRhdGFCeUdyb3VwW2FnZ3JlZ2F0ZUtleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFCeUdyb3VwW2FnZ3JlZ2F0ZUtleV0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBkYXRhQnlHcm91cFthZ2dyZWdhdGVLZXldLnB1c2goZGF0YUxpbmUpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgZGF0YSA9IE9iamVjdC5rZXlzKGRhdGFCeUdyb3VwKS5tYXAoKGdyb3VwTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhVG9BZ2dyZWdhdGUgPSBkYXRhQnlHcm91cFtncm91cE5hbWVdO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvdXREYXRhID0ge307XG4gICAgICAgICAgICAgICAgICAgIG9kYXRhUmVxdWVzdC5xdWVyeS5hZ2dyZWdhdGVEZWZpbml0aW9uLmdyb3VwQnkuZm9yRWFjaCgocHJvcE5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dERhdGFbcHJvcE5hbWVdID0gZGF0YVRvQWdncmVnYXRlWzBdW3Byb3BOYW1lXTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIG9kYXRhUmVxdWVzdC5xdWVyeS5hZ2dyZWdhdGVEZWZpbml0aW9uLmFnZ3JlZ2F0ZXMuZm9yRWFjaCgoYWdncmVnYXRlRGVmaW5pdGlvbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHByb3BWYWx1ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZ2dyZWdhdGVEZWZpbml0aW9uLm9wZXJhdG9yID09PSB1bmRlZmluZWQgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2NrRGF0YSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vY2tEYXRhLmhhc0N1c3RvbUFnZ3JlZ2F0ZShhZ2dyZWdhdGVEZWZpbml0aW9uLm5hbWUpXG4gICAgICAgICAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wVmFsdWUgPSBtb2NrRGF0YS5wZXJmb3JtQ3VzdG9tQWdncmVnYXRlKGFnZ3JlZ2F0ZURlZmluaXRpb24ubmFtZSwgZGF0YVRvQWdncmVnYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVRvQWdncmVnYXRlLmZvckVhY2goKGRhdGFMaW5lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRWYWx1ZSA9IGRhdGFMaW5lW2FnZ3JlZ2F0ZURlZmluaXRpb24uc291cmNlUHJvcGVydHldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvcFZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BWYWx1ZSA9IGN1cnJlbnRWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoYWdncmVnYXRlRGVmaW5pdGlvbi5vcGVyYXRvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ21heCc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BWYWx1ZSA9IE1hdGgubWF4KHByb3BWYWx1ZSwgY3VycmVudFZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbWluJzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcFZhbHVlID0gTWF0aC5taW4ocHJvcFZhbHVlLCBjdXJyZW50VmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdhdmVyYWdlJzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcFZhbHVlICs9IGN1cnJlbnRWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcFZhbHVlICs9IGN1cnJlbnRWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhZ2dyZWdhdGVEZWZpbml0aW9uLm9wZXJhdG9yID09PSAnYXZlcmFnZScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wVmFsdWUgPSBwcm9wVmFsdWUgLyBkYXRhVG9BZ2dyZWdhdGUubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0RGF0YVthZ2dyZWdhdGVEZWZpbml0aW9uLm5hbWVdID0gcHJvcFZhbHVlO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dERhdGE7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBBcHBseSAkc2VsZWN0XG4gICAgICAgICAgICBjb25zdCBvcmlnaW5hbERhdGEgPSBjbG9uZURlZXAoZGF0YSk7XG4gICAgICAgICAgICBpZiAob2RhdGFSZXF1ZXN0Py5xdWVyeT8ucHJvcGVydGllcykge1xuICAgICAgICAgICAgICAgIGlmIChvZGF0YVJlcXVlc3QucXVlcnkucHJvcGVydGllc1snRHJhZnRBZG1pbmlzdHJhdGl2ZURhdGEnXSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IChkYXRhIGFzIGFueVtdKS5tYXAoKGVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVsZW1lbnQuRHJhZnRBZG1pbmlzdHJhdGl2ZURhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5EcmFmdEFkbWluaXN0cmF0aXZlRGF0YSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50O1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YSAhPSBudWxsICYmIGRhdGEuY29uc3RydWN0b3IubmFtZSA9PT0gJ09iamVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZGF0YS5EcmFmdEFkbWluaXN0cmF0aXZlRGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuRHJhZnRBZG1pbmlzdHJhdGl2ZURhdGEgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG9kYXRhUmVxdWVzdD8ucXVlcnk/LnByb3BlcnRpZXMgJiYgT2JqZWN0LmtleXMob2RhdGFSZXF1ZXN0Py5xdWVyeT8ucHJvcGVydGllcykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHF1ZXJ5UHJvcHNLZXlzID0gT2JqZWN0LmtleXMob2RhdGFSZXF1ZXN0LnF1ZXJ5LnByb3BlcnRpZXMpO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgY29tcGFyZUJ5S2V5ID0gKGVsZW1lbnQ6IHsgW3g6IHN0cmluZ106IGFueSB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsZW1LZXlzID0gT2JqZWN0LmtleXMoZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpZmZlcmVuY2VLZXlzID0gZWxlbUtleXMuZmlsdGVyKCh4KSA9PiAhcXVlcnlQcm9wc0tleXMuaW5jbHVkZXMoeCkpO1xuICAgICAgICAgICAgICAgICAgICBkaWZmZXJlbmNlS2V5cy5mb3JFYWNoKChrKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZWxlbWVudFtrXTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvZGF0YVJlcXVlc3QucXVlcnkuZXhwYW5kKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBhbmRLZXlzID0gT2JqZWN0LmtleXMob2RhdGFSZXF1ZXN0LnF1ZXJ5LmV4cGFuZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBleHBhbmRLZXlzLmZvckVhY2goKGV4cGFuZEtleSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4cGFuZEVsZW0gPSBlbGVtZW50W2V4cGFuZEtleV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV4cGFuZEVsZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9kYXRhUmVxdWVzdC5xdWVyeS5leHBhbmRbZXhwYW5kS2V5XS5zZWxlY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4cGFuZFNlbGVjdEtleXMgPSBPYmplY3Qua2V5cyhvZGF0YVJlcXVlc3QucXVlcnkuZXhwYW5kW2V4cGFuZEtleV0uc2VsZWN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGV4cGFuZEVsZW0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhwYW5kRWxlbS5mb3JFYWNoKGZ1bmN0aW9uKGV4cGFuZEl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwYW5kRWxlbUtleXMgPSBPYmplY3Qua2V5cyhleHBhbmRJdGVtKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaWZmZXJlbmNlS2V5cyA9IGV4cGFuZEVsZW1LZXlzLmZpbHRlcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh4KSA9PiAhZXhwYW5kU2VsZWN0S2V5cy5pbmNsdWRlcyh4KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWZmZXJlbmNlS2V5cy5mb3JFYWNoKChrKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZXhwYW5kSXRlbVtrXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4cGFuZEVsZW1LZXlzID0gT2JqZWN0LmtleXMoZXhwYW5kRWxlbSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaWZmZXJlbmNlS2V5cyA9IGV4cGFuZEVsZW1LZXlzLmZpbHRlcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHgpID0+ICFleHBhbmRTZWxlY3RLZXlzLmluY2x1ZGVzKHgpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWZmZXJlbmNlS2V5cy5mb3JFYWNoKChrKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBleHBhbmRFbGVtW2tdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudDtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IChkYXRhIGFzIGFueVtdKS5tYXAoKGVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjb21wYXJlQnlLZXkoZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YSAhPSBudWxsICYmIGRhdGEuY29uc3RydWN0b3IubmFtZSA9PT0gJ09iamVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGNvbXBhcmVCeUtleShkYXRhKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBvZGF0YVJlcXVlc3QuZGF0YUxlbmd0aCA9IChBcnJheS5pc0FycmF5KGRhdGEpICYmIGRhdGEubGVuZ3RoKSB8fCAxO1xuXG4gICAgICAgICAgICAvLyBBcHBseSAkc2tpcCAvICR0b3BcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpICYmIG9kYXRhUmVxdWVzdC5xdWVyeS5zdGFydEluZGV4ICE9PSB1bmRlZmluZWQgJiYgb2RhdGFSZXF1ZXN0LnF1ZXJ5Lm1heEVsZW1lbnRzKSB7XG4gICAgICAgICAgICAgICAgZGF0YSA9IChkYXRhIGFzIGFueVtdKS5zbGljZShcbiAgICAgICAgICAgICAgICAgICAgb2RhdGFSZXF1ZXN0LnF1ZXJ5LnN0YXJ0SW5kZXgsXG4gICAgICAgICAgICAgICAgICAgIG9kYXRhUmVxdWVzdC5xdWVyeS5zdGFydEluZGV4ICsgb2RhdGFSZXF1ZXN0LnF1ZXJ5Lm1heEVsZW1lbnRzXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRoaXMubWV0YWRhdGEuZ2V0VmVyc2lvbigpID09PSAnMi4wJykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVucmljaEVsZW1lbnQgPSAoZW50aXR5U2V0OiBFbnRpdHlTZXQsIGRhdGFMaW5lLCBvcmlnaW5hbERhdGFMaW5lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleVZhbHVlczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgZW50aXR5U2V0LmVudGl0eVR5cGUua2V5cy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleVZhbHVlcy5wdXNoKGAke2tleS5uYW1lfT0nJHtkYXRhTGluZVtrZXkubmFtZV0gfHwgb3JpZ2luYWxEYXRhTGluZVtrZXkubmFtZV19J2ApO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXJpID0gYCR7b2RhdGFSZXF1ZXN0LmJhc2VVcmx9LyR7ZW50aXR5U2V0Lm5hbWV9KCR7a2V5VmFsdWVzLmpvaW4oJywnKX0pYDtcbiAgICAgICAgICAgICAgICAgICAgZGF0YUxpbmVbJ19fbWV0YWRhdGEnXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiB1cmksXG4gICAgICAgICAgICAgICAgICAgICAgICB1cmk6IHVyaSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGVudGl0eVNldC5lbnRpdHlUeXBlTmFtZVxuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGVudGl0eVNldC5lbnRpdHlUeXBlLm5hdmlnYXRpb25Qcm9wZXJ0aWVzLmZvckVhY2goKG5hdlByb3ApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vZXNsaW50LWRpc2FibGUtbmV4dC1saW5lXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YUxpbmUuaGFzT3duUHJvcGVydHkobmF2UHJvcC5uYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHlTZXQubmF2aWdhdGlvblByb3BlcnR5QmluZGluZ1tuYXZQcm9wLm5hbWVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuYXZQcm9wLmlzQ29sbGVjdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YUxpbmVbbmF2UHJvcC5uYW1lXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzOiBkYXRhTGluZVtuYXZQcm9wLm5hbWVdLm1hcCgoZWxlbWVudCwgaWR4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbnJpY2hFbGVtZW50KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5U2V0Lm5hdmlnYXRpb25Qcm9wZXJ0eUJpbmRpbmdbbmF2UHJvcC5uYW1lXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbERhdGFMaW5lW25hdlByb3AubmFtZV1baWR4XVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGFMaW5lW25hdlByb3AubmFtZV0gIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFMaW5lW25hdlByb3AubmFtZV0gPSBlbnJpY2hFbGVtZW50KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eVNldC5uYXZpZ2F0aW9uUHJvcGVydHlCaW5kaW5nW25hdlByb3AubmFtZV0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YUxpbmVbbmF2UHJvcC5uYW1lXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbERhdGFMaW5lW25hdlByb3AubmFtZV1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YUxpbmU7XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIC8vIEVucmljaCBkYXRhIHdpdGggX19tZXRhZGF0YSBmb3IgdjJcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgICAgICAgICAgICAgICAgICBkYXRhID0gKGRhdGEgYXMgYW55W10pLm1hcCgoZWxlbWVudCwgaWR4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW5yaWNoRWxlbWVudChjdXJyZW50RW50aXR5U2V0LCBlbGVtZW50LCBvcmlnaW5hbERhdGFbaWR4XSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YSAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGEgPSBlbnJpY2hFbGVtZW50KGN1cnJlbnRFbnRpdHlTZXQsIGRhdGEsIG9yaWdpbmFsRGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoaXNDb3VudCkge1xuICAgICAgICAgICAgICAgIGRhdGEgPSBvZGF0YVJlcXVlc3QuZGF0YUxlbmd0aDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyB1cGRhdGVEYXRhKG9kYXRhUmVxdWVzdDogT0RhdGFSZXF1ZXN0LCBwYXRjaERhdGE6IGFueSkge1xuICAgICAgICBjb25zdCBlbnRpdHlTZXROYW1lID0gb2RhdGFSZXF1ZXN0LnF1ZXJ5LnF1ZXJ5UGF0aFswXS5wYXRoO1xuICAgICAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0TW9ja0VudGl0eVNldChlbnRpdHlTZXROYW1lKSkucGVyZm9ybVBBVENIKFxuICAgICAgICAgICAgb2RhdGFSZXF1ZXN0LnF1ZXJ5LnF1ZXJ5UGF0aFswXS5rZXlzLFxuICAgICAgICAgICAgcGF0Y2hEYXRhLFxuICAgICAgICAgICAgb2RhdGFSZXF1ZXN0LnRlbmFudElkXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGNyZWF0ZURhdGEob2RhdGFSZXF1ZXN0OiBPRGF0YVJlcXVlc3QsIHBvc3REYXRhOiBhbnkpIHtcbiAgICAgICAgY29uc3QgZW50aXR5U2V0TmFtZSA9IG9kYXRhUmVxdWVzdC5xdWVyeS5xdWVyeVBhdGhbMF0ucGF0aDtcbiAgICAgICAgY29uc3QgbmF2UHJvcGVydHlOYW1lID1cbiAgICAgICAgICAgIG9kYXRhUmVxdWVzdC5xdWVyeS5xdWVyeVBhdGgubGVuZ3RoID4gMSA/IG9kYXRhUmVxdWVzdC5xdWVyeS5xdWVyeVBhdGhbMV0ucGF0aCA6IHVuZGVmaW5lZDtcbiAgICAgICAgY29uc3QgZW50aXR5U2V0ID0gdGhpcy5tZXRhZGF0YS5nZXRFbnRpdHlTZXQoZW50aXR5U2V0TmFtZSk7XG4gICAgICAgIGlmIChuYXZQcm9wZXJ0eU5hbWUpIHtcbiAgICAgICAgICAgIC8vIENyZWF0aW5nIGEgc3ViIG9iamVjdFxuICAgICAgICAgICAgY29uc3QgZW50aXR5VHlwZSA9IGVudGl0eVNldC5lbnRpdHlUeXBlO1xuICAgICAgICAgICAgY29uc3QgbmF2UHJvcERldGFpbCA9IGVudGl0eVR5cGUubmF2aWdhdGlvblByb3BlcnRpZXMuZmluZChcbiAgICAgICAgICAgICAgICAobmF2UHJvcCkgPT4gbmF2UHJvcC5uYW1lID09PSBuYXZQcm9wZXJ0eU5hbWVcbiAgICAgICAgICAgICkgYXMgYW55O1xuICAgICAgICAgICAgY29uc3QgbmF2UHJvcEVudGl0eVR5cGUgPSAobmF2UHJvcERldGFpbCBhcyBhbnkpLnRhcmdldFR5cGU7XG4gICAgICAgICAgICBjb25zdCBkYXRhID0gKGF3YWl0IHRoaXMuZ2V0TW9ja0VudGl0eVNldChlbnRpdHlTZXROYW1lKSkucGVyZm9ybUdFVChcbiAgICAgICAgICAgICAgICBvZGF0YVJlcXVlc3QucXVlcnkucXVlcnlQYXRoWzBdLmtleXMsXG4gICAgICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICAgICAgb2RhdGFSZXF1ZXN0LnRlbmFudElkXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgaWYgKCFkYXRhW25hdlByb3BlcnR5TmFtZV0pIHtcbiAgICAgICAgICAgICAgICBkYXRhW25hdlByb3BlcnR5TmFtZV0gPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHByb3ZpZGVkS2V5cyA9IHt9O1xuICAgICAgICAgICAgbmF2UHJvcEVudGl0eVR5cGUua2V5cy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocG9zdERhdGFba2V5Lm5hbWVdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvdmlkZWRLZXlzW2tleS5uYW1lXSA9IHBvc3REYXRhW2tleS5uYW1lXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRLZXlzID0gdGhpcy5nZXROYXZpZ2F0aW9uUHJvcGVydHlLZXlzKFxuICAgICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgICAgbmF2UHJvcERldGFpbCxcbiAgICAgICAgICAgICAgICBlbnRpdHlTZXQuZW50aXR5VHlwZSxcbiAgICAgICAgICAgICAgICBwcm92aWRlZEtleXMsXG4gICAgICAgICAgICAgICAgdHJ1ZVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGlmICghbmF2UHJvcERldGFpbC5jb250YWluc1RhcmdldCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldEVudGl0eVNldCA9IGVudGl0eVNldC5uYXZpZ2F0aW9uUHJvcGVydHlCaW5kaW5nW25hdlByb3BlcnR5TmFtZV07XG4gICAgICAgICAgICAgICAgKG9kYXRhUmVxdWVzdCBhcyBPRGF0YVY0UmVxdWVzdCkuY29udGV4dCA9IGAuLi8kbWV0YWRhdGEjJHt0YXJnZXRFbnRpdHlTZXQubmFtZX0vJGVudGl0eWA7XG4gICAgICAgICAgICAgICAgKG9kYXRhUmVxdWVzdCBhcyBPRGF0YVY0UmVxdWVzdCkubG9jYXRpb24gPSBgJHt0YXJnZXRFbnRpdHlTZXQubmFtZX0oJHtPYmplY3Qua2V5cyhjdXJyZW50S2V5cylcbiAgICAgICAgICAgICAgICAgICAgLm1hcCgoa2V5KSA9PiBgJHtrZXl9PScke2N1cnJlbnRLZXlzW2tleV19J2ApXG4gICAgICAgICAgICAgICAgICAgIC5qb2luKCcsJyl9KWA7XG4gICAgICAgICAgICAgICAgKGF3YWl0IHRoaXMuZ2V0TW9ja0VudGl0eVNldCh0YXJnZXRFbnRpdHlTZXQubmFtZSkpLnBlcmZvcm1QT1NUKFxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50S2V5cyxcbiAgICAgICAgICAgICAgICAgICAgcG9zdERhdGEsXG4gICAgICAgICAgICAgICAgICAgIG9kYXRhUmVxdWVzdC50ZW5hbnRJZFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRhdGFbbmF2UHJvcGVydHlOYW1lXS5wdXNoKHBvc3REYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwb3N0RGF0YTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIENyZWF0aW5nIGEgbWFpbiBvYmplY3RcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRLZXlzID0ge307XG4gICAgICAgICAgICBlbnRpdHlTZXQuZW50aXR5VHlwZS5rZXlzLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChwb3N0RGF0YVtrZXkubmFtZV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50S2V5c1trZXkubmFtZV0gPSBwb3N0RGF0YVtrZXkubmFtZV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAoYXdhaXQgdGhpcy5nZXRNb2NrRW50aXR5U2V0KGVudGl0eVNldC5uYW1lKSkucGVyZm9ybVBPU1QoY3VycmVudEtleXMsIHBvc3REYXRhLCBvZGF0YVJlcXVlc3QudGVuYW50SWQpO1xuICAgICAgICAgICAgKG9kYXRhUmVxdWVzdCBhcyBPRGF0YVY0UmVxdWVzdCkuY29udGV4dCA9IGAuLi8kbWV0YWRhdGEjJHtlbnRpdHlTZXQubmFtZX0vJGVudGl0eWA7XG4gICAgICAgICAgICAob2RhdGFSZXF1ZXN0IGFzIE9EYXRhVjRSZXF1ZXN0KS5sb2NhdGlvbiA9IGAke2VudGl0eVNldC5uYW1lfSgke09iamVjdC5rZXlzKGN1cnJlbnRLZXlzKVxuICAgICAgICAgICAgICAgIC5tYXAoKGtleSkgPT4gYCR7a2V5fT0nJHtjdXJyZW50S2V5c1trZXldfSdgKVxuICAgICAgICAgICAgICAgIC5qb2luKCcsJyl9KWA7XG4gICAgICAgICAgICByZXR1cm4gcG9zdERhdGE7XG4gICAgICAgICAgICAvLyB0aGlzLmdldE1vY2tFbnRpdHlTZXQoZW50aXR5U2V0TmFtZSkucGVyZm9ybVBPU1QocG9zdERhdGEsIHJlcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZGVsZXRlRGF0YShvZGF0YVJlcXVlc3Q6IE9EYXRhUmVxdWVzdCkge1xuICAgICAgICBjb25zdCBlbnRpdHlTZXROYW1lID0gb2RhdGFSZXF1ZXN0LnF1ZXJ5LnF1ZXJ5UGF0aFswXS5wYXRoO1xuICAgICAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0TW9ja0VudGl0eVNldChlbnRpdHlTZXROYW1lKSkucGVyZm9ybURFTEVURShcbiAgICAgICAgICAgIG9kYXRhUmVxdWVzdC5xdWVyeS5xdWVyeVBhdGhbMF0ua2V5cyxcbiAgICAgICAgICAgIG9kYXRhUmVxdWVzdC50ZW5hbnRJZFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHB1YmxpYyByZXNldFN0aWNreVNlc3Npb25UaW1lb3V0KHJlczogYW55LCB0ZW5hbnRJZDogc3RyaW5nKSB7XG4gICAgICAgIHJlcy5oZWFkZXIoJ29kYXRhLXZlcnNpb24nLCAnNC4wJyk7XG4gICAgICAgIGxldCBVVUlEID0gJyc7XG4gICAgICAgIGxldCB0aW1lb3V0VGltZSA9IDIwO1xuICAgICAgICB0aGlzLnN0aWNreUVudGl0eVNldHMuZm9yRWFjaCgoZW50aXR5U2V0KSA9PiB7XG4gICAgICAgICAgICBVVUlEID0gZW50aXR5U2V0LnJlc2V0U2Vzc2lvblRpbWVvdXQodGVuYW50SWQpO1xuICAgICAgICAgICAgdGltZW91dFRpbWUgPSBlbnRpdHlTZXQuc2Vzc2lvblRpbWVvdXRUaW1lO1xuICAgICAgICB9KTtcbiAgICAgICAgcmVzLmhlYWRlcignc2FwLWNvbnRleHRpZCcsIFVVSUQpO1xuICAgICAgICByZXMuaGVhZGVyKCdzYXAtaHR0cC1zZXNzaW9uLXRpbWVvdXQnLCB0aW1lb3V0VGltZS50b1N0cmluZygpKTtcbiAgICAgICAgcmVzLnN0YXR1cygyMDApO1xuICAgICAgICByZXMuZW5kKCk7XG4gICAgfVxufVxuIl19