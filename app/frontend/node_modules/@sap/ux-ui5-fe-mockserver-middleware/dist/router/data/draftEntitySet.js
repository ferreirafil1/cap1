"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DraftMockEntitySet = void 0;
var entitySet_1 = require("./entitySet");
var id_1 = require("./id");
function _getDateTimeOffset(isV4) {
    var date = new Date();
    date.setFullYear(2000 + Math.floor(Math.random() * 22));
    date.setDate(Math.floor(Math.random() * 30));
    date.setMonth(Math.floor(Math.random() * 12));
    date.setMilliseconds(0);
    return isV4 ? date.toISOString() : '/Date(' + date.getTime() + '+0000)/';
}
var DraftMockEntitySet = /** @class */ (function (_super) {
    __extends(DraftMockEntitySet, _super);
    function DraftMockEntitySet(rootFolder, entitySetDefinition, dataAccess, generateMockData) {
        return _super.call(this, rootFolder, entitySetDefinition, dataAccess, generateMockData, true, true) || this;
    }
    DraftMockEntitySet.prototype.checkSpecificProperties = function (filterExpression, mockData, allData, forceToLower) {
        if (forceToLower === void 0) { forceToLower = false; }
        if (filterExpression.prop === 'DraftAdministrativeData/InProcessByUser') {
            return false;
        }
        else if (filterExpression.prop === 'SiblingEntity/IsActiveEntity' && filterExpression.eqValue === 'null') {
            // Ensure that there is not sibling entity which is inactive
            var keys_1 = {};
            this.entityTypeDefinition.keys.forEach(function (keyDef) {
                if (keyDef.name !== 'IsActiveEntity') {
                    keys_1[keyDef.name] = mockData[keyDef.name];
                }
                else {
                    keys_1[keyDef.name] = false;
                }
            });
            return !allData.hasEntry(keys_1);
        }
        else {
            return true;
        }
    };
    DraftMockEntitySet.prototype.checkKeyValue = function (mockData, keyValues, keyName, property) {
        if (keyName === 'IsActiveEntity') {
            // Make sure we check a boolean value
            var booleanKeyValue = keyValues[keyName];
            if (typeof booleanKeyValue === 'string') {
                booleanKeyValue = booleanKeyValue === 'true';
            }
            return mockData[keyName] === booleanKeyValue;
        }
        return _super.prototype.checkKeyValue.call(this, mockData, keyValues, keyName, property);
    };
    DraftMockEntitySet.prototype.createInactiveVersion = function (keyValues, tenantId) {
        var currentMockData = this.getMockData(tenantId);
        var dataToDuplicate = this.performGET(keyValues, true, tenantId, true);
        dataToDuplicate.forEach(function (data) {
            data.HasDraftEntity = true;
            var duplicate = Object.assign({}, data);
            duplicate.IsActiveEntity = false;
            duplicate.HasActiveEntity = true;
            currentMockData.addEntry(duplicate);
        });
    };
    DraftMockEntitySet.prototype.activateInactiveVersion = function (keyValues, tenantId) {
        var _this = this;
        var currentMockData = this.getMockData(tenantId);
        var dataToDuplicate = this.performGET(keyValues, true, tenantId, true);
        dataToDuplicate.forEach(function (draftData) {
            var activateKeyValues = _this.getKeys(draftData);
            activateKeyValues.IsActiveEntity = true;
            var activeDraft = Object.assign({}, draftData);
            activeDraft.IsActiveEntity = true;
            activeDraft.HasDraftEntity = false;
            if (!currentMockData.hasEntry(activateKeyValues)) {
                currentMockData.addEntry(activeDraft);
            }
            else {
                currentMockData.updateEntry(activateKeyValues, activeDraft);
            }
        });
    };
    DraftMockEntitySet.prototype.draftDiscard = function (keyValues, draftData, tenantId) {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function () {
            var _loop_1, this_1, _c, _d, _i, navPropName, deleteKeyValues, activeData;
            return __generator(this, function (_e) {
                switch (_e.label) {
                    case 0:
                        _super.prototype.performDELETE.call(this, keyValues, tenantId);
                        _loop_1 = function (navPropName) {
                            var navPropDetail, subKeys, navPropEntity;
                            return __generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        if (!((_b = (_a = this_1.entitySetDefinition.navigationPropertyBinding[navPropName].annotations) === null || _a === void 0 ? void 0 : _a.Common) === null || _b === void 0 ? void 0 : _b.DraftNode)) return [3 /*break*/, 2];
                                        navPropDetail = this_1.entityTypeDefinition.navigationProperties.find(function (navProp) { return navProp.name === navPropName; });
                                        subKeys = this_1.dataAccess.getNavigationPropertyKeys(draftData, navPropDetail, this_1.entitySetDefinition.entityType, {});
                                        return [4 /*yield*/, this_1.dataAccess.getMockEntitySet(this_1.entitySetDefinition.navigationPropertyBinding[navPropName].name)];
                                    case 1:
                                        navPropEntity = (_a.sent());
                                        if (navPropEntity && navPropEntity.discardInactiveVersion) {
                                            navPropEntity.discardInactiveVersion(subKeys, tenantId);
                                        }
                                        _a.label = 2;
                                    case 2: return [2 /*return*/];
                                }
                            });
                        };
                        this_1 = this;
                        _c = [];
                        for (_d in this.entitySetDefinition.navigationPropertyBinding)
                            _c.push(_d);
                        _i = 0;
                        _e.label = 1;
                    case 1:
                        if (!(_i < _c.length)) return [3 /*break*/, 4];
                        navPropName = _c[_i];
                        return [5 /*yield**/, _loop_1(navPropName)];
                    case 2:
                        _e.sent();
                        _e.label = 3;
                    case 3:
                        _i++;
                        return [3 /*break*/, 1];
                    case 4:
                        deleteKeyValues = Object.assign({}, keyValues);
                        deleteKeyValues.IsActiveEntity = true;
                        activeData = this.performGET(deleteKeyValues, false, tenantId, true);
                        if (activeData) {
                            activeData.HasDraftEntity = false;
                        }
                        return [2 /*return*/, activeData];
                }
            });
        });
    };
    DraftMockEntitySet.prototype.discardInactiveVersion = function (keyValues, tenantId) {
        var _this = this;
        var dataToDiscard = this.performGET(keyValues, true, tenantId);
        dataToDiscard.forEach(function (data) {
            var keys = _this.getKeys(data);
            _this.performDELETE(keys, tenantId);
            var deleteKeyValues = Object.assign({}, keys);
            deleteKeyValues.IsActiveEntity = true;
            var activeData = _this.performGET(deleteKeyValues, false, tenantId, true);
            if (activeData) {
                activeData.HasDraftEntity = false;
            }
        });
    };
    DraftMockEntitySet.prototype.executeAction = function (actionDefinition, actionData, odataRequest, keys) {
        var _a, _b, _c, _d;
        return __awaiter(this, void 0, void 0, function () {
            var currentMockData, responseObject, _e, data, duplicate, currentDate, _loop_2, this_2, _f, _g, _i, navPropName, inactiveKeys, data, activeData, draftData, keyValues, activeDraft, _loop_3, this_3, _h, _j, _k, navPropName;
            return __generator(this, function (_l) {
                switch (_l.label) {
                    case 0:
                        currentMockData = this.getMockData(odataRequest.tenantId);
                        actionData = currentMockData.onBeforeAction(actionDefinition, actionData, keys);
                        _e = actionDefinition.fullyQualifiedName;
                        switch (_e) {
                            case this.entitySetDefinition.annotations.Common.DraftRoot.EditAction + "(" + this.entitySetDefinition.entityTypeName + ")": return [3 /*break*/, 1];
                            case this.entitySetDefinition.annotations.Common.DraftRoot.EditAction + "()": return [3 /*break*/, 1];
                            case this.entitySetDefinition.annotations.Common.DraftRoot.PreparationAction + "(" + this.entitySetDefinition.entityTypeName + ")": return [3 /*break*/, 6];
                            case this.entitySetDefinition.annotations.Common.DraftRoot.PreparationAction + "()": return [3 /*break*/, 6];
                            case this.entitySetDefinition.annotations.Common.DraftRoot.DiscardAction + "(" + this.entitySetDefinition.entityTypeName + ")": return [3 /*break*/, 7];
                            case this.entitySetDefinition.annotations.Common.DraftRoot.DiscardAction + "()": return [3 /*break*/, 7];
                            case this.entitySetDefinition.annotations.Common.DraftRoot.ActivationAction + "(" + this.entitySetDefinition.entityTypeName + ")": return [3 /*break*/, 9];
                            case this.entitySetDefinition.annotations.Common.DraftRoot.ActivationAction + "()": return [3 /*break*/, 9];
                        }
                        return [3 /*break*/, 15];
                    case 1:
                        data = this.performGET(keys, false, odataRequest.tenantId, true);
                        data.HasDraftEntity = true;
                        duplicate = Object.assign({}, data);
                        duplicate.IsActiveEntity = false;
                        duplicate.HasActiveEntity = true;
                        currentDate = _getDateTimeOffset(this.isV4());
                        duplicate.DraftAdministrativeData = {
                            DraftUUID: id_1.uuidv4(),
                            CreationDateTime: currentDate,
                            CreatedByUser: 'nobody',
                            DraftIsCreatedByMe: true,
                            LastChangeDateTime: currentDate,
                            LastChangedByUser: 'nobody',
                            InProcessByUser: 'nobody',
                            DraftIsProcessedByMe: true
                        };
                        currentMockData.addEntry(duplicate);
                        _loop_2 = function (navPropName) {
                            var navPropDetail, subKeys, navPropEntity;
                            return __generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        if (!((_b = (_a = this_2.entitySetDefinition.navigationPropertyBinding[navPropName].annotations) === null || _a === void 0 ? void 0 : _a.Common) === null || _b === void 0 ? void 0 : _b.DraftNode)) return [3 /*break*/, 2];
                                        navPropDetail = this_2.entityTypeDefinition.navigationProperties.find(function (navProp) { return navProp.name === navPropName; });
                                        subKeys = this_2.dataAccess.getNavigationPropertyKeys(data, navPropDetail, this_2.entitySetDefinition.entityType, {});
                                        return [4 /*yield*/, this_2.dataAccess.getMockEntitySet(this_2.entitySetDefinition.navigationPropertyBinding[navPropName].name)];
                                    case 1:
                                        navPropEntity = (_a.sent());
                                        if (navPropEntity && navPropEntity.createInactiveVersion) {
                                            navPropEntity.createInactiveVersion(subKeys, odataRequest.tenantId);
                                        }
                                        _a.label = 2;
                                    case 2: return [2 /*return*/];
                                }
                            });
                        };
                        this_2 = this;
                        _f = [];
                        for (_g in this.entitySetDefinition.navigationPropertyBinding)
                            _f.push(_g);
                        _i = 0;
                        _l.label = 2;
                    case 2:
                        if (!(_i < _f.length)) return [3 /*break*/, 5];
                        navPropName = _f[_i];
                        return [5 /*yield**/, _loop_2(navPropName)];
                    case 3:
                        _l.sent();
                        _l.label = 4;
                    case 4:
                        _i++;
                        return [3 /*break*/, 2];
                    case 5:
                        // responseObject = duplicate;
                        odataRequest.query.queryPath.pop();
                        inactiveKeys = Object.assign({}, keys, { IsActiveEntity: false });
                        odataRequest.query.queryPath[odataRequest.query.queryPath.length - 1].keys = inactiveKeys;
                        responseObject = this.dataAccess.getData(odataRequest);
                        return [3 /*break*/, 15];
                    case 6:
                        // Prepare
                        responseObject = this.performGET(keys, false, odataRequest.tenantId);
                        return [3 /*break*/, 15];
                    case 7:
                        data = this.performGET(keys, false, odataRequest.tenantId);
                        return [4 /*yield*/, this.draftDiscard(keys, data, odataRequest.tenantId)];
                    case 8:
                        activeData = _l.sent();
                        responseObject = activeData;
                        return [3 /*break*/, 15];
                    case 9:
                        draftData = this.performGET(keys, false, odataRequest.tenantId);
                        keyValues = Object.assign({}, keys);
                        keyValues.IsActiveEntity = true;
                        activeDraft = Object.assign({}, draftData);
                        activeDraft.IsActiveEntity = true;
                        activeDraft.DraftAdministrativeData = null;
                        activeDraft.HasDraftEntity = false;
                        if (currentMockData.hasEntry(keyValues)) {
                            currentMockData.updateEntry(keyValues, activeDraft);
                        }
                        else {
                            currentMockData.addEntry(activeDraft);
                        }
                        _loop_3 = function (navPropName) {
                            var navPropDetail, subKeys, navPropEntity;
                            return __generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        if (!((_d = (_c = this_3.entitySetDefinition.navigationPropertyBinding[navPropName].annotations) === null || _c === void 0 ? void 0 : _c.Common) === null || _d === void 0 ? void 0 : _d.DraftNode)) return [3 /*break*/, 2];
                                        navPropDetail = this_3.entityTypeDefinition.navigationProperties.find(function (navProp) { return navProp.name === navPropName; });
                                        subKeys = this_3.dataAccess.getNavigationPropertyKeys(draftData, navPropDetail, this_3.entitySetDefinition.entityType, {});
                                        return [4 /*yield*/, this_3.dataAccess.getMockEntitySet(this_3.entitySetDefinition.navigationPropertyBinding[navPropName].name)];
                                    case 1:
                                        navPropEntity = (_a.sent());
                                        if (navPropEntity && navPropEntity.activateInactiveVersion) {
                                            navPropEntity.activateInactiveVersion(subKeys, odataRequest.tenantId);
                                        }
                                        _a.label = 2;
                                    case 2: return [2 /*return*/];
                                }
                            });
                        };
                        this_3 = this;
                        _h = [];
                        for (_j in this.entitySetDefinition.navigationPropertyBinding)
                            _h.push(_j);
                        _k = 0;
                        _l.label = 10;
                    case 10:
                        if (!(_k < _h.length)) return [3 /*break*/, 13];
                        navPropName = _h[_k];
                        return [5 /*yield**/, _loop_3(navPropName)];
                    case 11:
                        _l.sent();
                        _l.label = 12;
                    case 12:
                        _k++;
                        return [3 /*break*/, 10];
                    case 13: return [4 /*yield*/, this.draftDiscard(keys, draftData, odataRequest.tenantId)];
                    case 14:
                        _l.sent();
                        responseObject = activeDraft;
                        return [3 /*break*/, 15];
                    case 15:
                        responseObject = currentMockData.onAfterAction(actionDefinition, actionData, keys, responseObject);
                        return [2 /*return*/, responseObject];
                }
            });
        });
    };
    DraftMockEntitySet.prototype.performPOST = function (keyValues, postData, tenantId) {
        // Validate potentially missing keys
        if (!Object.hasOwnProperty.call(postData, 'IsActiveEntity')) {
            postData.IsActiveEntity = false;
        }
        if (!Object.hasOwnProperty.call(postData, 'HasActiveEntity')) {
            postData.HasActiveEntity = false;
        }
        return _super.prototype.performPOST.call(this, keyValues, postData, tenantId);
    };
    DraftMockEntitySet.prototype.performDELETE = function (keyValues, tenantId) {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function () {
            var draftData;
            return __generator(this, function (_c) {
                switch (_c.label) {
                    case 0:
                        draftData = this.performGET(keyValues, false, tenantId);
                        if (!(((_b = (_a = this.entitySetDefinition.annotations) === null || _a === void 0 ? void 0 : _a.Common) === null || _b === void 0 ? void 0 : _b.DraftRoot) && draftData && !draftData.IsActiveEntity)) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.draftDiscard(keyValues, draftData, tenantId)];
                    case 1:
                        _c.sent();
                        return [3 /*break*/, 3];
                    case 2: return [2 /*return*/, _super.prototype.performDELETE.call(this, keyValues, tenantId)];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    return DraftMockEntitySet;
}(entitySet_1.MockDataEntitySet));
exports.DraftMockEntitySet = DraftMockEntitySet;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhZnRFbnRpdHlTZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcm91dGVyL2RhdGEvZHJhZnRFbnRpdHlTZXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHlDQUFnRDtBQUloRCwyQkFBOEI7QUFxQjlCLFNBQVMsa0JBQWtCLENBQUMsSUFBYTtJQUNyQyxJQUFNLElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0lBQ3hCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDeEQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzdDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM5QyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3hCLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsU0FBUyxDQUFDO0FBQzdFLENBQUM7QUFFRDtJQUF3QyxzQ0FBaUI7SUFDckQsNEJBQ0ksVUFBa0IsRUFDbEIsbUJBQTJDLEVBQzNDLFVBQStCLEVBQy9CLGdCQUF5QjtlQUV6QixrQkFBTSxVQUFVLEVBQUUsbUJBQW1CLEVBQUUsVUFBVSxFQUFFLGdCQUFnQixFQUFFLElBQUksRUFBRSxJQUFJLENBQUM7SUFDcEYsQ0FBQztJQUVTLG9EQUF1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O1xuaW1wb3J0IHsgT0RhdGFSZXF1ZXN0IH0gZnJvbSAnLi4vcmVxdWVzdC9vZGF0YVJlcXVlc3QnO1xuaW1wb3J0IHsgQWN0aW9uLCBFbnRpdHlTZXQsIEVudGl0eVR5cGUsIFByb3BlcnR5LCBOYXZpZ2F0aW9uUHJvcGVydHkgfSBmcm9tICdAc2FwLXV4L2Fubm90YXRpb24tY29udmVydGVyJztcbmltcG9ydCB7IEZpbGVCYXNlZE1vY2tEYXRhLCBLZXlEZWZpbml0aW9ucyB9IGZyb20gJy4vZmlsZUJhc2VkTW9ja0RhdGEnO1xuaW1wb3J0IHsgdXVpZHY0IH0gZnJvbSAnLi9pZCc7XG5pbXBvcnQgeyBEYXRhQWNjZXNzSW50ZXJmYWNlIH0gZnJvbSAnLi9jb21tb24nO1xuXG50eXBlIERyYWZ0RWxlbWVudCA9IHtcbiAgICBJc0FjdGl2ZUVudGl0eTogYm9vbGVhbjtcbiAgICBIYXNEcmFmdEVudGl0eTogYm9vbGVhbjtcbiAgICBIYXNBY3RpdmVFbnRpdHk6IGJvb2xlYW47XG4gICAgRHJhZnRBZG1pbmlzdHJhdGl2ZURhdGE6IERyYWZ0QWRtaW5pc3RyYXRpdmVEYXRhO1xufTtcblxudHlwZSBEcmFmdEFkbWluaXN0cmF0aXZlRGF0YSA9IHtcbiAgICBEcmFmdFVVSUQ6IHN0cmluZztcbiAgICBDcmVhdGlvbkRhdGVUaW1lOiBzdHJpbmc7XG4gICAgQ3JlYXRlZEJ5VXNlcjogc3RyaW5nO1xuICAgIERyYWZ0SXNDcmVhdGVkQnlNZTogYm9vbGVhbjtcbiAgICBMYXN0Q2hhbmdlRGF0ZVRpbWU6IHN0cmluZztcbiAgICBMYXN0Q2hhbmdlZEJ5VXNlcjogc3RyaW5nO1xuICAgIEluUHJvY2Vzc0J5VXNlcjogc3RyaW5nO1xuICAgIERyYWZ0SXNQcm9jZXNzZWRCeU1lOiBib29sZWFuO1xufTtcblxuZnVuY3Rpb24gX2dldERhdGVUaW1lT2Zmc2V0KGlzVjQ6IGJvb2xlYW4pIHtcbiAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoKTtcbiAgICBkYXRlLnNldEZ1bGxZZWFyKDIwMDAgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAyMikpO1xuICAgIGRhdGUuc2V0RGF0ZShNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAzMCkpO1xuICAgIGRhdGUuc2V0TW9udGgoTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMTIpKTtcbiAgICBkYXRlLnNldE1pbGxpc2Vjb25kcygwKTtcbiAgICByZXR1cm4gaXNWNCA/IGRhdGUudG9JU09TdHJpbmcoKSA6ICcvRGF0ZSgnICsgZGF0ZS5nZXRUaW1lKCkgKyAnKzAwMDApLyc7XG59XG5cbmV4cG9ydCBjbGFzcyBEcmFmdE1vY2tFbnRpdHlTZXQgZXh0ZW5kcyBNb2NrRGF0YUVudGl0eVNldCB7XG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHJvb3RGb2xkZXI6IHN0cmluZyxcbiAgICAgICAgZW50aXR5U2V0RGVmaW5pdGlvbjogRW50aXR5U2V0IHwgRW50aXR5VHlwZSxcbiAgICAgICAgZGF0YUFjY2VzczogRGF0YUFjY2Vzc0ludGVyZmFjZSxcbiAgICAgICAgZ2VuZXJhdGVNb2NrRGF0YTogYm9vbGVhblxuICAgICkge1xuICAgICAgICBzdXBlcihyb290Rm9sZGVyLCBlbnRpdHlTZXREZWZpbml0aW9uLCBkYXRhQWNjZXNzLCBnZW5lcmF0ZU1vY2tEYXRhLCB0cnVlLCB0cnVlKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgY2hlY2tTcGVjaWZpY1Byb3BlcnRpZXMoXG4gICAgICAgIGZpbHRlckV4cHJlc3Npb246IGFueSxcbiAgICAgICAgbW9ja0RhdGE6IGFueSxcbiAgICAgICAgYWxsRGF0YTogRmlsZUJhc2VkTW9ja0RhdGEsXG4gICAgICAgIGZvcmNlVG9Mb3dlciA9IGZhbHNlXG4gICAgKTogYm9vbGVhbiB7XG4gICAgICAgIGlmIChmaWx0ZXJFeHByZXNzaW9uLnByb3AgPT09ICdEcmFmdEFkbWluaXN0cmF0aXZlRGF0YS9JblByb2Nlc3NCeVVzZXInKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyRXhwcmVzc2lvbi5wcm9wID09PSAnU2libGluZ0VudGl0eS9Jc0FjdGl2ZUVudGl0eScgJiYgZmlsdGVyRXhwcmVzc2lvbi5lcVZhbHVlID09PSAnbnVsbCcpIHtcbiAgICAgICAgICAgIC8vIEVuc3VyZSB0aGF0IHRoZXJlIGlzIG5vdCBzaWJsaW5nIGVudGl0eSB3aGljaCBpcyBpbmFjdGl2ZVxuICAgICAgICAgICAgY29uc3Qga2V5cyA9IHt9O1xuICAgICAgICAgICAgdGhpcy5lbnRpdHlUeXBlRGVmaW5pdGlvbi5rZXlzLmZvckVhY2goKGtleURlZikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChrZXlEZWYubmFtZSAhPT0gJ0lzQWN0aXZlRW50aXR5Jykge1xuICAgICAgICAgICAgICAgICAgICBrZXlzW2tleURlZi5uYW1lXSA9IG1vY2tEYXRhW2tleURlZi5uYW1lXTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBrZXlzW2tleURlZi5uYW1lXSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuICFhbGxEYXRhLmhhc0VudHJ5KGtleXMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgY2hlY2tLZXlWYWx1ZShtb2NrRGF0YTogb2JqZWN0LCBrZXlWYWx1ZXM6IG9iamVjdCwga2V5TmFtZTogc3RyaW5nLCBwcm9wZXJ0eT86IFByb3BlcnR5KTogYm9vbGVhbiB7XG4gICAgICAgIGlmIChrZXlOYW1lID09PSAnSXNBY3RpdmVFbnRpdHknKSB7XG4gICAgICAgICAgICAvLyBNYWtlIHN1cmUgd2UgY2hlY2sgYSBib29sZWFuIHZhbHVlXG4gICAgICAgICAgICBsZXQgYm9vbGVhbktleVZhbHVlID0ga2V5VmFsdWVzW2tleU5hbWVdO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBib29sZWFuS2V5VmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgYm9vbGVhbktleVZhbHVlID0gYm9vbGVhbktleVZhbHVlID09PSAndHJ1ZSc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbW9ja0RhdGFba2V5TmFtZV0gPT09IGJvb2xlYW5LZXlWYWx1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3VwZXIuY2hlY2tLZXlWYWx1ZShtb2NrRGF0YSwga2V5VmFsdWVzLCBrZXlOYW1lLCBwcm9wZXJ0eSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNyZWF0ZUluYWN0aXZlVmVyc2lvbihrZXlWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4sIHRlbmFudElkOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgY3VycmVudE1vY2tEYXRhID0gdGhpcy5nZXRNb2NrRGF0YSh0ZW5hbnRJZCk7XG4gICAgICAgIGNvbnN0IGRhdGFUb0R1cGxpY2F0ZSA9IHRoaXMucGVyZm9ybUdFVChrZXlWYWx1ZXMsIHRydWUsIHRlbmFudElkLCB0cnVlKTtcbiAgICAgICAgZGF0YVRvRHVwbGljYXRlLmZvckVhY2goKGRhdGEpID0+IHtcbiAgICAgICAgICAgIGRhdGEuSGFzRHJhZnRFbnRpdHkgPSB0cnVlO1xuICAgICAgICAgICAgY29uc3QgZHVwbGljYXRlOiBEcmFmdEVsZW1lbnQgPSBPYmplY3QuYXNzaWduKHt9LCBkYXRhKSBhcyBEcmFmdEVsZW1lbnQ7XG4gICAgICAgICAgICBkdXBsaWNhdGUuSXNBY3RpdmVFbnRpdHkgPSBmYWxzZTtcbiAgICAgICAgICAgIGR1cGxpY2F0ZS5IYXNBY3RpdmVFbnRpdHkgPSB0cnVlO1xuXG4gICAgICAgICAgICBjdXJyZW50TW9ja0RhdGEuYWRkRW50cnkoZHVwbGljYXRlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFjdGl2YXRlSW5hY3RpdmVWZXJzaW9uKGtleVZhbHVlczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiwgdGVuYW50SWQ6IHN0cmluZykge1xuICAgICAgICBjb25zdCBjdXJyZW50TW9ja0RhdGEgPSB0aGlzLmdldE1vY2tEYXRhKHRlbmFudElkKTtcbiAgICAgICAgY29uc3QgZGF0YVRvRHVwbGljYXRlID0gdGhpcy5wZXJmb3JtR0VUKGtleVZhbHVlcywgdHJ1ZSwgdGVuYW50SWQsIHRydWUpO1xuICAgICAgICBkYXRhVG9EdXBsaWNhdGUuZm9yRWFjaCgoZHJhZnREYXRhKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBhY3RpdmF0ZUtleVZhbHVlcyA9IHRoaXMuZ2V0S2V5cyhkcmFmdERhdGEpO1xuICAgICAgICAgICAgYWN0aXZhdGVLZXlWYWx1ZXMuSXNBY3RpdmVFbnRpdHkgPSB0cnVlO1xuICAgICAgICAgICAgY29uc3QgYWN0aXZlRHJhZnQ6IERyYWZ0RWxlbWVudCA9IE9iamVjdC5hc3NpZ24oe30sIGRyYWZ0RGF0YSkgYXMgRHJhZnRFbGVtZW50O1xuICAgICAgICAgICAgYWN0aXZlRHJhZnQuSXNBY3RpdmVFbnRpdHkgPSB0cnVlO1xuICAgICAgICAgICAgYWN0aXZlRHJhZnQuSGFzRHJhZnRFbnRpdHkgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmICghY3VycmVudE1vY2tEYXRhLmhhc0VudHJ5KGFjdGl2YXRlS2V5VmFsdWVzKSkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRNb2NrRGF0YS5hZGRFbnRyeShhY3RpdmVEcmFmdCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRNb2NrRGF0YS51cGRhdGVFbnRyeShhY3RpdmF0ZUtleVZhbHVlcywgYWN0aXZlRHJhZnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZHJhZnREaXNjYXJkKGtleVZhbHVlczogUmVjb3JkPHN0cmluZywgYW55PiwgZHJhZnREYXRhOiBvYmplY3QsIHRlbmFudElkOiBzdHJpbmcpIHtcbiAgICAgICAgc3VwZXIucGVyZm9ybURFTEVURShrZXlWYWx1ZXMsIHRlbmFudElkKTtcbiAgICAgICAgZm9yIChjb25zdCBuYXZQcm9wTmFtZSBpbiB0aGlzLmVudGl0eVNldERlZmluaXRpb24ubmF2aWdhdGlvblByb3BlcnR5QmluZGluZykge1xuICAgICAgICAgICAgaWYgKHRoaXMuZW50aXR5U2V0RGVmaW5pdGlvbi5uYXZpZ2F0aW9uUHJvcGVydHlCaW5kaW5nW25hdlByb3BOYW1lXS5hbm5vdGF0aW9ucz8uQ29tbW9uPy5EcmFmdE5vZGUpIHtcbiAgICAgICAgICAgICAgICAvLyBGb3IgYWxsIHRoZSBkcmFmdCBub2RlIGRhdGEgZHVwbGljYXRlIHRoZW1cbiAgICAgICAgICAgICAgICBjb25zdCBuYXZQcm9wRGV0YWlsID0gdGhpcy5lbnRpdHlUeXBlRGVmaW5pdGlvbi5uYXZpZ2F0aW9uUHJvcGVydGllcy5maW5kKFxuICAgICAgICAgICAgICAgICAgICAobmF2UHJvcCkgPT4gbmF2UHJvcC5uYW1lID09PSBuYXZQcm9wTmFtZVxuICAgICAgICAgICAgICAgICkgYXMgTmF2aWdhdGlvblByb3BlcnR5O1xuICAgICAgICAgICAgICAgIGNvbnN0IHN1YktleXMgPSB0aGlzLmRhdGFBY2Nlc3MuZ2V0TmF2aWdhdGlvblByb3BlcnR5S2V5cyhcbiAgICAgICAgICAgICAgICAgICAgZHJhZnREYXRhLFxuICAgICAgICAgICAgICAgICAgICBuYXZQcm9wRGV0YWlsLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVudGl0eVNldERlZmluaXRpb24uZW50aXR5VHlwZSxcbiAgICAgICAgICAgICAgICAgICAge31cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGNvbnN0IG5hdlByb3BFbnRpdHkgPSAoYXdhaXQgdGhpcy5kYXRhQWNjZXNzLmdldE1vY2tFbnRpdHlTZXQoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5U2V0RGVmaW5pdGlvbi5uYXZpZ2F0aW9uUHJvcGVydHlCaW5kaW5nW25hdlByb3BOYW1lXS5uYW1lXG4gICAgICAgICAgICAgICAgKSkgYXMgRHJhZnRNb2NrRW50aXR5U2V0O1xuICAgICAgICAgICAgICAgIGlmIChuYXZQcm9wRW50aXR5ICYmIG5hdlByb3BFbnRpdHkuZGlzY2FyZEluYWN0aXZlVmVyc2lvbikge1xuICAgICAgICAgICAgICAgICAgICBuYXZQcm9wRW50aXR5LmRpc2NhcmRJbmFjdGl2ZVZlcnNpb24oc3ViS2V5cywgdGVuYW50SWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zdCBkZWxldGVLZXlWYWx1ZXMgPSBPYmplY3QuYXNzaWduKHt9LCBrZXlWYWx1ZXMpO1xuICAgICAgICBkZWxldGVLZXlWYWx1ZXMuSXNBY3RpdmVFbnRpdHkgPSB0cnVlO1xuICAgICAgICBjb25zdCBhY3RpdmVEYXRhID0gdGhpcy5wZXJmb3JtR0VUKGRlbGV0ZUtleVZhbHVlcywgZmFsc2UsIHRlbmFudElkLCB0cnVlKSBhcyBEcmFmdEVsZW1lbnQ7XG4gICAgICAgIGlmIChhY3RpdmVEYXRhKSB7XG4gICAgICAgICAgICBhY3RpdmVEYXRhLkhhc0RyYWZ0RW50aXR5ID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjdGl2ZURhdGE7XG4gICAgfVxuXG4gICAgcHVibGljIGRpc2NhcmRJbmFjdGl2ZVZlcnNpb24oa2V5VmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LCB0ZW5hbnRJZDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGRhdGFUb0Rpc2NhcmQgPSB0aGlzLnBlcmZvcm1HRVQoa2V5VmFsdWVzLCB0cnVlLCB0ZW5hbnRJZCk7XG4gICAgICAgIGRhdGFUb0Rpc2NhcmQuZm9yRWFjaCgoZGF0YSkgPT4ge1xuICAgICAgICAgICAgY29uc3Qga2V5cyA9IHRoaXMuZ2V0S2V5cyhkYXRhKTtcbiAgICAgICAgICAgIHRoaXMucGVyZm9ybURFTEVURShrZXlzLCB0ZW5hbnRJZCk7XG4gICAgICAgICAgICBjb25zdCBkZWxldGVLZXlWYWx1ZXMgPSBPYmplY3QuYXNzaWduKHt9LCBrZXlzKTtcbiAgICAgICAgICAgIGRlbGV0ZUtleVZhbHVlcy5Jc0FjdGl2ZUVudGl0eSA9IHRydWU7XG4gICAgICAgICAgICBjb25zdCBhY3RpdmVEYXRhID0gdGhpcy5wZXJmb3JtR0VUKGRlbGV0ZUtleVZhbHVlcywgZmFsc2UsIHRlbmFudElkLCB0cnVlKSBhcyBEcmFmdEVsZW1lbnQ7XG4gICAgICAgICAgICBpZiAoYWN0aXZlRGF0YSkge1xuICAgICAgICAgICAgICAgIGFjdGl2ZURhdGEuSGFzRHJhZnRFbnRpdHkgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVBY3Rpb24oXG4gICAgICAgIGFjdGlvbkRlZmluaXRpb246IEFjdGlvbixcbiAgICAgICAgYWN0aW9uRGF0YTogb2JqZWN0LFxuICAgICAgICBvZGF0YVJlcXVlc3Q6IE9EYXRhUmVxdWVzdCxcbiAgICAgICAga2V5czogUmVjb3JkPHN0cmluZywgYW55PlxuICAgICk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRNb2NrRGF0YSA9IHRoaXMuZ2V0TW9ja0RhdGEob2RhdGFSZXF1ZXN0LnRlbmFudElkKTtcbiAgICAgICAgYWN0aW9uRGF0YSA9IGN1cnJlbnRNb2NrRGF0YS5vbkJlZm9yZUFjdGlvbihhY3Rpb25EZWZpbml0aW9uLCBhY3Rpb25EYXRhLCBrZXlzKTtcbiAgICAgICAgbGV0IHJlc3BvbnNlT2JqZWN0O1xuICAgICAgICBzd2l0Y2ggKGFjdGlvbkRlZmluaXRpb24uZnVsbHlRdWFsaWZpZWROYW1lKSB7XG4gICAgICAgICAgICAvLyBEcmFmdCBFZGl0IEFjdGlvblxuICAgICAgICAgICAgY2FzZSBgJHt0aGlzLmVudGl0eVNldERlZmluaXRpb24uYW5ub3RhdGlvbnMuQ29tbW9uLkRyYWZ0Um9vdC5FZGl0QWN0aW9ufSgke3RoaXMuZW50aXR5U2V0RGVmaW5pdGlvbi5lbnRpdHlUeXBlTmFtZX0pYDpcbiAgICAgICAgICAgIGNhc2UgYCR7dGhpcy5lbnRpdHlTZXREZWZpbml0aW9uLmFubm90YXRpb25zLkNvbW1vbi5EcmFmdFJvb3QuRWRpdEFjdGlvbn0oKWA6IHtcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gdGhpcy5wZXJmb3JtR0VUKGtleXMsIGZhbHNlLCBvZGF0YVJlcXVlc3QudGVuYW50SWQsIHRydWUpIGFzIERyYWZ0RWxlbWVudDtcblxuICAgICAgICAgICAgICAgIGRhdGEuSGFzRHJhZnRFbnRpdHkgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGNvbnN0IGR1cGxpY2F0ZTogRHJhZnRFbGVtZW50ID0gT2JqZWN0LmFzc2lnbih7fSwgZGF0YSkgYXMgRHJhZnRFbGVtZW50O1xuICAgICAgICAgICAgICAgIGR1cGxpY2F0ZS5Jc0FjdGl2ZUVudGl0eSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGR1cGxpY2F0ZS5IYXNBY3RpdmVFbnRpdHkgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnREYXRlID0gX2dldERhdGVUaW1lT2Zmc2V0KHRoaXMuaXNWNCgpKTtcbiAgICAgICAgICAgICAgICBkdXBsaWNhdGUuRHJhZnRBZG1pbmlzdHJhdGl2ZURhdGEgPSB7XG4gICAgICAgICAgICAgICAgICAgIERyYWZ0VVVJRDogdXVpZHY0KCksXG4gICAgICAgICAgICAgICAgICAgIENyZWF0aW9uRGF0ZVRpbWU6IGN1cnJlbnREYXRlLFxuICAgICAgICAgICAgICAgICAgICBDcmVhdGVkQnlVc2VyOiAnbm9ib2R5JyxcbiAgICAgICAgICAgICAgICAgICAgRHJhZnRJc0NyZWF0ZWRCeU1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBMYXN0Q2hhbmdlRGF0ZVRpbWU6IGN1cnJlbnREYXRlLFxuICAgICAgICAgICAgICAgICAgICBMYXN0Q2hhbmdlZEJ5VXNlcjogJ25vYm9keScsXG4gICAgICAgICAgICAgICAgICAgIEluUHJvY2Vzc0J5VXNlcjogJ25vYm9keScsXG4gICAgICAgICAgICAgICAgICAgIERyYWZ0SXNQcm9jZXNzZWRCeU1lOiB0cnVlXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBjdXJyZW50TW9ja0RhdGEuYWRkRW50cnkoZHVwbGljYXRlKTtcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IG5hdlByb3BOYW1lIGluIHRoaXMuZW50aXR5U2V0RGVmaW5pdGlvbi5uYXZpZ2F0aW9uUHJvcGVydHlCaW5kaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5U2V0RGVmaW5pdGlvbi5uYXZpZ2F0aW9uUHJvcGVydHlCaW5kaW5nW25hdlByb3BOYW1lXS5hbm5vdGF0aW9ucz8uQ29tbW9uPy5EcmFmdE5vZGVcbiAgICAgICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3IgYWxsIHRoZSBkcmFmdCBub2RlIGRhdGEgZHVwbGljYXRlIHRoZW1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hdlByb3BEZXRhaWwgPSB0aGlzLmVudGl0eVR5cGVEZWZpbml0aW9uLm5hdmlnYXRpb25Qcm9wZXJ0aWVzLmZpbmQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKG5hdlByb3ApID0+IG5hdlByb3AubmFtZSA9PT0gbmF2UHJvcE5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgICkgYXMgTmF2aWdhdGlvblByb3BlcnR5O1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ViS2V5cyA9IHRoaXMuZGF0YUFjY2Vzcy5nZXROYXZpZ2F0aW9uUHJvcGVydHlLZXlzKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmF2UHJvcERldGFpbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVudGl0eVNldERlZmluaXRpb24uZW50aXR5VHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7fVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hdlByb3BFbnRpdHkgPSAoYXdhaXQgdGhpcy5kYXRhQWNjZXNzLmdldE1vY2tFbnRpdHlTZXQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdHlTZXREZWZpbml0aW9uLm5hdmlnYXRpb25Qcm9wZXJ0eUJpbmRpbmdbbmF2UHJvcE5hbWVdLm5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgICkpIGFzIERyYWZ0TW9ja0VudGl0eVNldDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuYXZQcm9wRW50aXR5ICYmIG5hdlByb3BFbnRpdHkuY3JlYXRlSW5hY3RpdmVWZXJzaW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmF2UHJvcEVudGl0eS5jcmVhdGVJbmFjdGl2ZVZlcnNpb24oc3ViS2V5cywgb2RhdGFSZXF1ZXN0LnRlbmFudElkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyByZXNwb25zZU9iamVjdCA9IGR1cGxpY2F0ZTtcbiAgICAgICAgICAgICAgICBvZGF0YVJlcXVlc3QucXVlcnkucXVlcnlQYXRoLnBvcCgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGluYWN0aXZlS2V5cyA9IE9iamVjdC5hc3NpZ24oe30sIGtleXMsIHsgSXNBY3RpdmVFbnRpdHk6IGZhbHNlIH0pO1xuICAgICAgICAgICAgICAgIG9kYXRhUmVxdWVzdC5xdWVyeS5xdWVyeVBhdGhbb2RhdGFSZXF1ZXN0LnF1ZXJ5LnF1ZXJ5UGF0aC5sZW5ndGggLSAxXS5rZXlzID0gaW5hY3RpdmVLZXlzO1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0ID0gdGhpcy5kYXRhQWNjZXNzLmdldERhdGEob2RhdGFSZXF1ZXN0KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhc2UgYCR7dGhpcy5lbnRpdHlTZXREZWZpbml0aW9uLmFubm90YXRpb25zLkNvbW1vbi5EcmFmdFJvb3QuUHJlcGFyYXRpb25BY3Rpb259KCR7dGhpcy5lbnRpdHlTZXREZWZpbml0aW9uLmVudGl0eVR5cGVOYW1lfSlgOlxuICAgICAgICAgICAgY2FzZSBgJHt0aGlzLmVudGl0eVNldERlZmluaXRpb24uYW5ub3RhdGlvbnMuQ29tbW9uLkRyYWZ0Um9vdC5QcmVwYXJhdGlvbkFjdGlvbn0oKWA6XG4gICAgICAgICAgICAgICAgLy8gUHJlcGFyZVxuICAgICAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0ID0gdGhpcy5wZXJmb3JtR0VUKGtleXMsIGZhbHNlLCBvZGF0YVJlcXVlc3QudGVuYW50SWQpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlIGAke3RoaXMuZW50aXR5U2V0RGVmaW5pdGlvbi5hbm5vdGF0aW9ucy5Db21tb24uRHJhZnRSb290LkRpc2NhcmRBY3Rpb259KCR7dGhpcy5lbnRpdHlTZXREZWZpbml0aW9uLmVudGl0eVR5cGVOYW1lfSlgOlxuICAgICAgICAgICAgY2FzZSBgJHt0aGlzLmVudGl0eVNldERlZmluaXRpb24uYW5ub3RhdGlvbnMuQ29tbW9uLkRyYWZ0Um9vdC5EaXNjYXJkQWN0aW9ufSgpYDoge1xuICAgICAgICAgICAgICAgIC8vIERpc2NhcmRcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gdGhpcy5wZXJmb3JtR0VUKGtleXMsIGZhbHNlLCBvZGF0YVJlcXVlc3QudGVuYW50SWQpIGFzIERyYWZ0RWxlbWVudDtcbiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmVEYXRhID0gYXdhaXQgdGhpcy5kcmFmdERpc2NhcmQoa2V5cywgZGF0YSwgb2RhdGFSZXF1ZXN0LnRlbmFudElkKTtcbiAgICAgICAgICAgICAgICByZXNwb25zZU9iamVjdCA9IGFjdGl2ZURhdGE7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNhc2UgYCR7dGhpcy5lbnRpdHlTZXREZWZpbml0aW9uLmFubm90YXRpb25zLkNvbW1vbi5EcmFmdFJvb3QuQWN0aXZhdGlvbkFjdGlvbn0oJHt0aGlzLmVudGl0eVNldERlZmluaXRpb24uZW50aXR5VHlwZU5hbWV9KWA6XG4gICAgICAgICAgICBjYXNlIGAke3RoaXMuZW50aXR5U2V0RGVmaW5pdGlvbi5hbm5vdGF0aW9ucy5Db21tb24uRHJhZnRSb290LkFjdGl2YXRpb25BY3Rpb259KClgOiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZHJhZnREYXRhID0gdGhpcy5wZXJmb3JtR0VUKGtleXMsIGZhbHNlLCBvZGF0YVJlcXVlc3QudGVuYW50SWQpO1xuXG4gICAgICAgICAgICAgICAgY29uc3Qga2V5VmFsdWVzID0gT2JqZWN0LmFzc2lnbih7fSwga2V5cyk7XG4gICAgICAgICAgICAgICAga2V5VmFsdWVzLklzQWN0aXZlRW50aXR5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmVEcmFmdDogRHJhZnRFbGVtZW50ID0gT2JqZWN0LmFzc2lnbih7fSwgZHJhZnREYXRhKSBhcyBEcmFmdEVsZW1lbnQ7XG4gICAgICAgICAgICAgICAgYWN0aXZlRHJhZnQuSXNBY3RpdmVFbnRpdHkgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGFjdGl2ZURyYWZ0LkRyYWZ0QWRtaW5pc3RyYXRpdmVEYXRhID0gbnVsbDtcbiAgICAgICAgICAgICAgICBhY3RpdmVEcmFmdC5IYXNEcmFmdEVudGl0eSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChjdXJyZW50TW9ja0RhdGEuaGFzRW50cnkoa2V5VmFsdWVzKSkge1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50TW9ja0RhdGEudXBkYXRlRW50cnkoa2V5VmFsdWVzLCBhY3RpdmVEcmFmdCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudE1vY2tEYXRhLmFkZEVudHJ5KGFjdGl2ZURyYWZ0KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IG5hdlByb3BOYW1lIGluIHRoaXMuZW50aXR5U2V0RGVmaW5pdGlvbi5uYXZpZ2F0aW9uUHJvcGVydHlCaW5kaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5U2V0RGVmaW5pdGlvbi5uYXZpZ2F0aW9uUHJvcGVydHlCaW5kaW5nW25hdlByb3BOYW1lXS5hbm5vdGF0aW9ucz8uQ29tbW9uPy5EcmFmdE5vZGVcbiAgICAgICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3IgYWxsIHRoZSBkcmFmdCBub2RlIGRhdGEgZHVwbGljYXRlIHRoZW1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hdlByb3BEZXRhaWwgPSB0aGlzLmVudGl0eVR5cGVEZWZpbml0aW9uLm5hdmlnYXRpb25Qcm9wZXJ0aWVzLmZpbmQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKG5hdlByb3ApID0+IG5hdlByb3AubmFtZSA9PT0gbmF2UHJvcE5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgICkgYXMgTmF2aWdhdGlvblByb3BlcnR5O1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ViS2V5cyA9IHRoaXMuZGF0YUFjY2Vzcy5nZXROYXZpZ2F0aW9uUHJvcGVydHlLZXlzKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRyYWZ0RGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYXZQcm9wRGV0YWlsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5U2V0RGVmaW5pdGlvbi5lbnRpdHlUeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHt9XG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmF2UHJvcEVudGl0eSA9IChhd2FpdCB0aGlzLmRhdGFBY2Nlc3MuZ2V0TW9ja0VudGl0eVNldChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVudGl0eVNldERlZmluaXRpb24ubmF2aWdhdGlvblByb3BlcnR5QmluZGluZ1tuYXZQcm9wTmFtZV0ubmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgKSkgYXMgRHJhZnRNb2NrRW50aXR5U2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hdlByb3BFbnRpdHkgJiYgbmF2UHJvcEVudGl0eS5hY3RpdmF0ZUluYWN0aXZlVmVyc2lvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hdlByb3BFbnRpdHkuYWN0aXZhdGVJbmFjdGl2ZVZlcnNpb24oc3ViS2V5cywgb2RhdGFSZXF1ZXN0LnRlbmFudElkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmRyYWZ0RGlzY2FyZChrZXlzLCBkcmFmdERhdGEsIG9kYXRhUmVxdWVzdC50ZW5hbnRJZCk7XG4gICAgICAgICAgICAgICAgcmVzcG9uc2VPYmplY3QgPSBhY3RpdmVEcmFmdDtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXNwb25zZU9iamVjdCA9IGN1cnJlbnRNb2NrRGF0YS5vbkFmdGVyQWN0aW9uKGFjdGlvbkRlZmluaXRpb24sIGFjdGlvbkRhdGEsIGtleXMsIHJlc3BvbnNlT2JqZWN0KTtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlT2JqZWN0O1xuICAgIH1cblxuICAgIHB1YmxpYyBwZXJmb3JtUE9TVChrZXlWYWx1ZXM6IEtleURlZmluaXRpb25zLCBwb3N0RGF0YTogYW55LCB0ZW5hbnRJZDogc3RyaW5nKTogYW55IHtcbiAgICAgICAgLy8gVmFsaWRhdGUgcG90ZW50aWFsbHkgbWlzc2luZyBrZXlzXG4gICAgICAgIGlmICghT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwocG9zdERhdGEsICdJc0FjdGl2ZUVudGl0eScpKSB7XG4gICAgICAgICAgICBwb3N0RGF0YS5Jc0FjdGl2ZUVudGl0eSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwocG9zdERhdGEsICdIYXNBY3RpdmVFbnRpdHknKSkge1xuICAgICAgICAgICAgcG9zdERhdGEuSGFzQWN0aXZlRW50aXR5ID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN1cGVyLnBlcmZvcm1QT1NUKGtleVZhbHVlcywgcG9zdERhdGEsIHRlbmFudElkKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgcGVyZm9ybURFTEVURShrZXlWYWx1ZXM6IEtleURlZmluaXRpb25zLCB0ZW5hbnRJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGRyYWZ0RGF0YSA9IHRoaXMucGVyZm9ybUdFVChrZXlWYWx1ZXMsIGZhbHNlLCB0ZW5hbnRJZCk7XG4gICAgICAgIGlmICh0aGlzLmVudGl0eVNldERlZmluaXRpb24uYW5ub3RhdGlvbnM/LkNvbW1vbj8uRHJhZnRSb290ICYmIGRyYWZ0RGF0YSAmJiAhZHJhZnREYXRhLklzQWN0aXZlRW50aXR5KSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmRyYWZ0RGlzY2FyZChrZXlWYWx1ZXMsIGRyYWZ0RGF0YSwgdGVuYW50SWQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHN1cGVyLnBlcmZvcm1ERUxFVEUoa2V5VmFsdWVzLCB0ZW5hbnRJZCk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=