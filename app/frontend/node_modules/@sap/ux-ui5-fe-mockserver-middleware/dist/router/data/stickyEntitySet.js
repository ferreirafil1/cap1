"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.StickyMockEntitySet = void 0;
var entitySet_1 = require("./entitySet");
var lodash_clonedeep_1 = __importDefault(require("lodash.clonedeep"));
var id_1 = require("./id");
var StickyMockEntitySet = /** @class */ (function (_super) {
    __extends(StickyMockEntitySet, _super);
    function StickyMockEntitySet(rootFolder, entitySetDefinition, dataAccess, generateMockData) {
        var _this = _super.call(this, rootFolder, entitySetDefinition, dataAccess, generateMockData) || this;
        _this._currentSessionObject = {};
        _this.sessionTimeoutTime = 120;
        return _this;
    }
    StickyMockEntitySet.prototype.getSessionObject = function (tenantId) {
        return this._currentSessionObject[tenantId];
    };
    StickyMockEntitySet.prototype.setSessionObject = function (tenantId, objectData) {
        this._currentSessionObject[tenantId] = objectData;
    };
    StickyMockEntitySet.prototype.resetSessionTimeout = function (tenantId) {
        var _this = this;
        clearTimeout(this.sessionTimeoutRef);
        this.sessionTimeoutRef = setTimeout(function () {
            _this.currentUUID = null;
            _this.setSessionObject(tenantId, null);
        }, this.sessionTimeoutTime * 1000);
        return this.currentUUID;
    };
    StickyMockEntitySet.prototype.performPATCH = function (keyValues, patchData, tenantId) {
        keyValues = this.prepareKeys(keyValues);
        var data = this.performGET(keyValues, false, tenantId);
        var currentMockData = this.getMockData(tenantId);
        var updatedData = Object.assign(data, patchData);
        currentMockData.onBeforeUpdateEntry(keyValues, updatedData);
        if (updatedData.__transient) {
            this.setSessionObject(tenantId, updatedData);
        }
        else {
            currentMockData.updateEntry(keyValues, updatedData);
        }
        currentMockData.onAfterUpdateEntry(keyValues, updatedData);
        return updatedData;
    };
    StickyMockEntitySet.prototype.executeAction = function (actionDefinition, actionData, odataRequest, keys) {
        return __awaiter(this, void 0, void 0, function () {
            var currentMockData, responseObject, data, duplicate, newObject_1, nonNullableProperties, uuid, newData;
            return __generator(this, function (_a) {
                currentMockData = this.getMockData(odataRequest.tenantId);
                keys = this.prepareKeys(keys);
                actionData = currentMockData.onBeforeAction(actionDefinition, actionData, keys);
                switch (actionDefinition.fullyQualifiedName) {
                    // Draft Edit Action
                    case this.entitySetDefinition.annotations.Session.StickySessionSupported.EditAction + "(" + actionDefinition.sourceType + ")": {
                        data = this.performGET(keys, false, odataRequest.tenantId);
                        duplicate = Object.assign({}, data);
                        this.setSessionObject(odataRequest.tenantId, duplicate);
                        duplicate.__transient = true;
                        duplicate.__keys = keys;
                        responseObject = duplicate;
                        break;
                    }
                    case this.entitySetDefinition.annotations.Session.StickySessionSupported.NewAction + "(" + actionDefinition.sourceType + ")": {
                        newObject_1 = Object.assign({}, actionData);
                        nonNullableProperties = actionDefinition.returnEntityType.entityProperties.filter(function (prop) { return prop.nullable === false; });
                        nonNullableProperties.forEach(function (nonNullableProperty) {
                            if (newObject_1[nonNullableProperty.name] === undefined) {
                                if (Object.prototype.hasOwnProperty.call(nonNullableProperty, 'defaultValue')) {
                                    newObject_1[nonNullableProperty.name] = nonNullableProperty.defaultValue;
                                }
                                else {
                                    switch (nonNullableProperty.type) {
                                        case 'Edm.String':
                                            newObject_1[nonNullableProperty.name] = '';
                                            break;
                                        case 'Edm.Guid':
                                            newObject_1[nonNullableProperty.name] = '';
                                            break;
                                    }
                                }
                            }
                        });
                        this.setSessionObject(odataRequest.tenantId, newObject_1);
                        newObject_1.__transient = true;
                        odataRequest.context = "../$metadata#" + this.entitySetDefinition.name + "()/$entity";
                        uuid = id_1.generateId(16);
                        this.currentUUID = uuid;
                        odataRequest.setResponseHeader('sap-contextid', 'SID:ANON:localMock' + uuid);
                        odataRequest.setResponseHeader('sap-http-session-timeout', this.sessionTimeoutTime);
                        this.resetSessionTimeout(odataRequest.tenantId);
                        responseObject = newObject_1;
                        break;
                    }
                    case this.entitySetDefinition.annotations.Session.StickySessionSupported.DiscardAction + "(" + actionDefinition.sourceType + ")":
                        // Discard
                        this.setSessionObject(odataRequest.tenantId, null);
                        responseObject = null;
                        break;
                    case this.entitySetDefinition.annotations.Session.StickySessionSupported.SaveAction + "(" + actionDefinition.sourceType + ")": {
                        newData = this.getSessionObject(odataRequest.tenantId);
                        if (newData.__keys) {
                            // Key needs to be filled now
                            currentMockData.updateEntry(newData.__keys, newData);
                        }
                        else {
                            this.performPOST({}, newData, odataRequest.tenantId);
                        }
                        this.setSessionObject(odataRequest.tenantId, null);
                        responseObject = newData;
                        break;
                    }
                }
                responseObject = currentMockData.onAfterAction(actionDefinition, actionData, keys, responseObject);
                return [2 /*return*/, responseObject];
            });
        });
    };
    StickyMockEntitySet.prototype.performGET = function (keyValues, asArray, tenantId, dontClone) {
        if (dontClone === void 0) { dontClone = false; }
        var currentSessionObject = this.getSessionObject(tenantId);
        if (currentSessionObject && keyValues && Object.keys(keyValues).length) {
            if ((Object.prototype.hasOwnProperty.call(keyValues, "''") && keyValues["''"] === undefined) ||
                this.checkKeys(keyValues, currentSessionObject, this.entityTypeDefinition.keys)) {
                // odataRequest.setResponseHeader('sap-contextid', this.currentUUID);
                // odataRequest.setResponseHeader('sap-http-session-timeout', this.sessionTimeoutTime.toString());
                this.resetSessionTimeout(tenantId);
                return lodash_clonedeep_1.default(currentSessionObject);
            }
        }
        return _super.prototype.performGET.call(this, keyValues, asArray, tenantId);
    };
    return StickyMockEntitySet;
}(entitySet_1.MockDataEntitySet));
exports.StickyMockEntitySet = StickyMockEntitySet;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RpY2t5RW50aXR5U2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3JvdXRlci9kYXRhL3N0aWNreUVudGl0eVNldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEseUNBQWdEO0FBSWhELHNFQUF5QztBQUN6QywyQkFBa0M7QUFJbEM7SUFBeUMsdUNBQWlCO0lBTXRELDZCQUNJLFVBQWtCLEVBQ2xCLG1CQUEyQyxFQUMzQyxVQUErQixFQUMvQixnQkFBeUI7UUFKN0IsWUFNSSxrQkFBTSxVQUFVLEVBQUUsbUJBQW1CLEVBQUUsVUFBVSxFQUFFLGdCQUFnQixDQUFDLFNBQ3ZFO1FBWk8sMkJBQXFCLEdBQUcsRUFBRSxDQUFDO1FBRzVCLHdCQUFrQixHQUFHLEdBQUcsQ0FBQzs7SUFTaEMsQ0FBQztJQUVPLDhDQUFnQixHQUF4QixVQUF5QixRQUFnQjtRQUNyQyxPQUFPLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRU8sOENBQWdCLEdBQXhCLFVBQXlCLFFBQWdCLEVBQUUsVUFBa0I7UUFDekQsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFFBQVEsQ0FBQyxHQUFHLFVBQVUsQ0FBQztJQUN0RCxDQUFDO0lBRU0saURBQW1CLEdBQTFCLFVBQTJCLFFBQWdCO1FBQTNDLGlCQU9DO1FBTkcsWUFBWSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxVQUFVLENBQUM7WUFDaEMsS0FBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7WUFDeEIsS0FBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMxQyxDQUFDLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ25DLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUM1QixDQUFDO0lBRU0sMENBQVksR0FBbkIsVUFBb0IsU0FBeUIsRUFBRSxTQUFpQixFQUFFLFFBQWdCO1FBQzlFLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3hDLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN6RCxJQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ25ELElBQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ25ELGVBQWUsQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDNUQsSUFBSSxXQUFXLENBQUMsV0FBVyxFQUFFO1lBQ3pCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDLENBQUM7U0FDaEQ7YUFBTTtZQUNILGVBQWUsQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1NBQ3ZEO1FBRUQsZUFBZSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUUzRCxPQUFPLFdBQVcsQ0FBQztJQUN2QixDQUFDO0lBRVksMkNBQWEsR0FBMUIsVUFDSSxnQkFBd0IsRUFDeEIsVUFBa0IsRUFDbEIsWUFBMEIsRUFDMUIsSUFBeUI7Ozs7Z0JBRW5CLGVBQWUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDaEUsSUFBSSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzlCLFVBQVUsR0FBRyxlQUFlLENBQUMsY0FBYyxDQUFDLGdCQUFnQixFQUFFLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFFaEYsUUFBUSxnQkFBZ0IsQ0FBQyxrQkFBa0IsRUFBRTtvQkFDekMsb0JBQW9CO29CQUNwQixLQUFRLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLHNCQUFzQixDQUFDLFVBQVUsU0FBSSxnQkFBZ0IsQ0FBQyxVQUFVLE1BQUcsQ0FBQyxDQUFDO3dCQUNoSCxJQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQzt3QkFDM0QsU0FBUyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO3dCQUMxQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQzt3QkFDeEQsU0FBUyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7d0JBQzdCLFNBQVMsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO3dCQUN4QixjQUFjLEdBQUcsU0FBUyxDQUFDO3dCQUMzQixNQUFNO3FCQUNUO29CQUVELEtBQVEsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsc0JBQXNCLENBQUMsU0FBUyxTQUFJLGdCQUFnQixDQUFDLFVBQVUsTUFBRyxDQUFDLENBQUM7d0JBRS9HLGNBQWlCLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFVBQVUsQ0FBQyxDQUFDO3dCQUMvQyxxQkFBcUIsR0FBRyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQ25GLFVBQUMsSUFBSSxJQUFLLE9BQUEsSUFBSSxDQUFDLFFBQVEsS0FBSyxLQUFLLEVBQXZCLENBQXVCLENBQ3BDLENBQUM7d0JBQ0YscUJBQXFCLENBQUMsT0FBTyxDQUFDLFVBQUMsbUJBQW1COzRCQUM5QyxJQUFJLFdBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxTQUFTLEVBQUU7Z0NBQ25ELElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLGNBQWMsQ0FBQyxFQUFFO29DQUMzRSxXQUFTLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEdBQUcsbUJBQW1CLENBQUMsWUFBWSxDQUFDO2lDQUMxRTtxQ0FBTTtvQ0FDSCxRQUFRLG1CQUFtQixDQUFDLElBQUksRUFBRTt3Q0FDOUIsS0FBSyxZQUFZOzRDQUNiLFdBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7NENBQ3pDLE1BQU07d0NBQ1YsS0FBSyxVQUFVOzRDQUNYLFdBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7NENBQ3pDLE1BQU07cUNBQ2I7aUNBQ0o7NkJBQ0o7d0JBQ0wsQ0FBQyxDQUFDLENBQUM7d0JBRUgsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsV0FBUyxDQUFDLENBQUM7d0JBQ3hELFdBQVMsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO3dCQUM1QixZQUErQixDQUFDLE9BQU8sR0FBRyxrQkFBZ0IsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksZUFBWSxDQUFDO3dCQUMvRixJQUFJLEdBQUcsZUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO3dCQUM1QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQzt3QkFDeEIsWUFBWSxDQUFDLGlCQUFpQixDQUFDLGVBQWUsRUFBRSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsQ0FBQzt3QkFDN0UsWUFBWSxDQUFDLGlCQUFpQixDQUFDLDBCQUEwQixFQUFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO3dCQUNwRixJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO3dCQUNoRCxjQUFjLEdBQUcsV0FBUyxDQUFDO3dCQUMzQixNQUFNO3FCQUNUO29CQUVELEtBQVEsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsc0JBQXNCLENBQUMsYUFBYSxTQUFJLGdCQUFnQixDQUFDLFVBQVUsTUFBRzt3QkFDdkgsVUFBVTt3QkFDVixJQUFJLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQzt3QkFDbkQsY0FBYyxHQUFHLElBQUksQ0FBQzt3QkFDdEIsTUFBTTtvQkFFVixLQUFRLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLHNCQUFzQixDQUFDLFVBQVUsU0FBSSxnQkFBZ0IsQ0FBQyxVQUFVLE1BQUcsQ0FBQyxDQUFDO3dCQUNoSCxPQUFPLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQzt3QkFDN0QsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFOzRCQUNoQiw2QkFBNkI7NEJBQzdCLGVBQWUsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQzt5QkFDeEQ7NkJBQU07NEJBQ0gsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQzt5QkFDeEQ7d0JBRUQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7d0JBRW5ELGNBQWMsR0FBRyxPQUFPLENBQUM7d0JBQ3pCLE1BQU07cUJBQ1Q7aUJBQ0o7Z0JBQ0QsY0FBYyxHQUFHLGVBQWUsQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxjQUFjLENBQUMsQ0FBQztnQkFDbkcsc0JBQU8sY0FBYyxFQUFDOzs7S0FDekI7SUFFTSx3Q0FBVSxHQUFqQixVQUFrQixTQUF5QixFQUFFLE9BQWdCLEVBQUUsUUFBZ0IsRUFBRSxTQUFpQjtRQUFqQiwwQkFBQSxFQUFBLGlCQUFpQjtRQUM5RixJQUFNLG9CQUFvQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM3RCxJQUFJLG9CQUFvQixJQUFJLFNBQVMsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sRUFBRTtZQUNwRSxJQUNJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssU0FBUyxDQUFDO2dCQUN4RixJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxvQkFBb0IsRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLEVBQ2pGO2dCQUNFLHFFQUFxRTtnQkFDckUsa0dBQWtHO2dCQUNsRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ25DLE9BQU8sMEJBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO2FBQzFDO1NBQ0o7UUFDRCxPQUFPLGlCQUFNLFVBQVUsWUFBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFDTCwwQkFBQztBQUFELENBQUMsQUFsSkQsQ0FBeUMsNkJBQWlCLEdBa0p6RDtBQWxKWSxrREFBbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb2NrRGF0YUVudGl0eVNldCB9IGZyb20gJy4vZW50aXR5U2V0JztcbmltcG9ydCB7IE9EYXRhUmVxdWVzdCB9IGZyb20gJy4uL3JlcXVlc3Qvb2RhdGFSZXF1ZXN0JztcbmltcG9ydCB7IEVudGl0eVR5cGUsIEVudGl0eVNldCwgQWN0aW9uIH0gZnJvbSAnQHNhcC11eC9hbm5vdGF0aW9uLWNvbnZlcnRlcic7XG5pbXBvcnQgeyBPRGF0YVY0UmVxdWVzdCB9IGZyb20gJy4uL3JlcXVlc3Qvb2RhdGFWNFJlcXVlc3QnO1xuaW1wb3J0IGNsb25lRGVlcCBmcm9tICdsb2Rhc2guY2xvbmVkZWVwJztcbmltcG9ydCB7IGdlbmVyYXRlSWQgfSBmcm9tICcuL2lkJztcbmltcG9ydCB7IEtleURlZmluaXRpb25zIH0gZnJvbSAnLi9maWxlQmFzZWRNb2NrRGF0YSc7XG5pbXBvcnQgeyBEYXRhQWNjZXNzSW50ZXJmYWNlIH0gZnJvbSAnLi9jb21tb24nO1xuXG5leHBvcnQgY2xhc3MgU3RpY2t5TW9ja0VudGl0eVNldCBleHRlbmRzIE1vY2tEYXRhRW50aXR5U2V0IHtcbiAgICBwcml2YXRlIF9jdXJyZW50U2Vzc2lvbk9iamVjdCA9IHt9O1xuICAgIGN1cnJlbnRVVUlEO1xuICAgIHNlc3Npb25UaW1lb3V0UmVmO1xuICAgIHB1YmxpYyBzZXNzaW9uVGltZW91dFRpbWUgPSAxMjA7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcm9vdEZvbGRlcjogc3RyaW5nLFxuICAgICAgICBlbnRpdHlTZXREZWZpbml0aW9uOiBFbnRpdHlTZXQgfCBFbnRpdHlUeXBlLFxuICAgICAgICBkYXRhQWNjZXNzOiBEYXRhQWNjZXNzSW50ZXJmYWNlLFxuICAgICAgICBnZW5lcmF0ZU1vY2tEYXRhOiBib29sZWFuXG4gICAgKSB7XG4gICAgICAgIHN1cGVyKHJvb3RGb2xkZXIsIGVudGl0eVNldERlZmluaXRpb24sIGRhdGFBY2Nlc3MsIGdlbmVyYXRlTW9ja0RhdGEpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0U2Vzc2lvbk9iamVjdCh0ZW5hbnRJZDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jdXJyZW50U2Vzc2lvbk9iamVjdFt0ZW5hbnRJZF07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRTZXNzaW9uT2JqZWN0KHRlbmFudElkOiBzdHJpbmcsIG9iamVjdERhdGE6IG9iamVjdCkge1xuICAgICAgICB0aGlzLl9jdXJyZW50U2Vzc2lvbk9iamVjdFt0ZW5hbnRJZF0gPSBvYmplY3REYXRhO1xuICAgIH1cblxuICAgIHB1YmxpYyByZXNldFNlc3Npb25UaW1lb3V0KHRlbmFudElkOiBzdHJpbmcpOiBhbnkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5zZXNzaW9uVGltZW91dFJlZik7XG4gICAgICAgIHRoaXMuc2Vzc2lvblRpbWVvdXRSZWYgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFVVSUQgPSBudWxsO1xuICAgICAgICAgICAgdGhpcy5zZXRTZXNzaW9uT2JqZWN0KHRlbmFudElkLCBudWxsKTtcbiAgICAgICAgfSwgdGhpcy5zZXNzaW9uVGltZW91dFRpbWUgKiAxMDAwKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFVVSUQ7XG4gICAgfVxuXG4gICAgcHVibGljIHBlcmZvcm1QQVRDSChrZXlWYWx1ZXM6IEtleURlZmluaXRpb25zLCBwYXRjaERhdGE6IG9iamVjdCwgdGVuYW50SWQ6IHN0cmluZyk6IGFueSB7XG4gICAgICAgIGtleVZhbHVlcyA9IHRoaXMucHJlcGFyZUtleXMoa2V5VmFsdWVzKTtcbiAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMucGVyZm9ybUdFVChrZXlWYWx1ZXMsIGZhbHNlLCB0ZW5hbnRJZCk7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRNb2NrRGF0YSA9IHRoaXMuZ2V0TW9ja0RhdGEodGVuYW50SWQpO1xuICAgICAgICBjb25zdCB1cGRhdGVkRGF0YSA9IE9iamVjdC5hc3NpZ24oZGF0YSwgcGF0Y2hEYXRhKTtcbiAgICAgICAgY3VycmVudE1vY2tEYXRhLm9uQmVmb3JlVXBkYXRlRW50cnkoa2V5VmFsdWVzLCB1cGRhdGVkRGF0YSk7XG4gICAgICAgIGlmICh1cGRhdGVkRGF0YS5fX3RyYW5zaWVudCkge1xuICAgICAgICAgICAgdGhpcy5zZXRTZXNzaW9uT2JqZWN0KHRlbmFudElkLCB1cGRhdGVkRGF0YSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjdXJyZW50TW9ja0RhdGEudXBkYXRlRW50cnkoa2V5VmFsdWVzLCB1cGRhdGVkRGF0YSk7XG4gICAgICAgIH1cblxuICAgICAgICBjdXJyZW50TW9ja0RhdGEub25BZnRlclVwZGF0ZUVudHJ5KGtleVZhbHVlcywgdXBkYXRlZERhdGEpO1xuXG4gICAgICAgIHJldHVybiB1cGRhdGVkRGF0YTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZXhlY3V0ZUFjdGlvbihcbiAgICAgICAgYWN0aW9uRGVmaW5pdGlvbjogQWN0aW9uLFxuICAgICAgICBhY3Rpb25EYXRhOiBvYmplY3QsXG4gICAgICAgIG9kYXRhUmVxdWVzdDogT0RhdGFSZXF1ZXN0LFxuICAgICAgICBrZXlzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+XG4gICAgKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgY3VycmVudE1vY2tEYXRhID0gdGhpcy5nZXRNb2NrRGF0YShvZGF0YVJlcXVlc3QudGVuYW50SWQpO1xuICAgICAgICBrZXlzID0gdGhpcy5wcmVwYXJlS2V5cyhrZXlzKTtcbiAgICAgICAgYWN0aW9uRGF0YSA9IGN1cnJlbnRNb2NrRGF0YS5vbkJlZm9yZUFjdGlvbihhY3Rpb25EZWZpbml0aW9uLCBhY3Rpb25EYXRhLCBrZXlzKTtcbiAgICAgICAgbGV0IHJlc3BvbnNlT2JqZWN0O1xuICAgICAgICBzd2l0Y2ggKGFjdGlvbkRlZmluaXRpb24uZnVsbHlRdWFsaWZpZWROYW1lKSB7XG4gICAgICAgICAgICAvLyBEcmFmdCBFZGl0IEFjdGlvblxuICAgICAgICAgICAgY2FzZSBgJHt0aGlzLmVudGl0eVNldERlZmluaXRpb24uYW5ub3RhdGlvbnMuU2Vzc2lvbi5TdGlja3lTZXNzaW9uU3VwcG9ydGVkLkVkaXRBY3Rpb259KCR7YWN0aW9uRGVmaW5pdGlvbi5zb3VyY2VUeXBlfSlgOiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMucGVyZm9ybUdFVChrZXlzLCBmYWxzZSwgb2RhdGFSZXF1ZXN0LnRlbmFudElkKTtcbiAgICAgICAgICAgICAgICBjb25zdCBkdXBsaWNhdGUgPSBPYmplY3QuYXNzaWduKHt9LCBkYXRhKTtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFNlc3Npb25PYmplY3Qob2RhdGFSZXF1ZXN0LnRlbmFudElkLCBkdXBsaWNhdGUpO1xuICAgICAgICAgICAgICAgIGR1cGxpY2F0ZS5fX3RyYW5zaWVudCA9IHRydWU7XG4gICAgICAgICAgICAgICAgZHVwbGljYXRlLl9fa2V5cyA9IGtleXM7XG4gICAgICAgICAgICAgICAgcmVzcG9uc2VPYmplY3QgPSBkdXBsaWNhdGU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNhc2UgYCR7dGhpcy5lbnRpdHlTZXREZWZpbml0aW9uLmFubm90YXRpb25zLlNlc3Npb24uU3RpY2t5U2Vzc2lvblN1cHBvcnRlZC5OZXdBY3Rpb259KCR7YWN0aW9uRGVmaW5pdGlvbi5zb3VyY2VUeXBlfSlgOiB7XG4gICAgICAgICAgICAgICAgLy8gTmV3XG4gICAgICAgICAgICAgICAgY29uc3QgbmV3T2JqZWN0OiBhbnkgPSBPYmplY3QuYXNzaWduKHt9LCBhY3Rpb25EYXRhKTtcbiAgICAgICAgICAgICAgICBjb25zdCBub25OdWxsYWJsZVByb3BlcnRpZXMgPSBhY3Rpb25EZWZpbml0aW9uLnJldHVybkVudGl0eVR5cGUuZW50aXR5UHJvcGVydGllcy5maWx0ZXIoXG4gICAgICAgICAgICAgICAgICAgIChwcm9wKSA9PiBwcm9wLm51bGxhYmxlID09PSBmYWxzZVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgbm9uTnVsbGFibGVQcm9wZXJ0aWVzLmZvckVhY2goKG5vbk51bGxhYmxlUHJvcGVydHkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5ld09iamVjdFtub25OdWxsYWJsZVByb3BlcnR5Lm5hbWVdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobm9uTnVsbGFibGVQcm9wZXJ0eSwgJ2RlZmF1bHRWYWx1ZScpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3T2JqZWN0W25vbk51bGxhYmxlUHJvcGVydHkubmFtZV0gPSBub25OdWxsYWJsZVByb3BlcnR5LmRlZmF1bHRWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChub25OdWxsYWJsZVByb3BlcnR5LnR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnRWRtLlN0cmluZyc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdPYmplY3Rbbm9uTnVsbGFibGVQcm9wZXJ0eS5uYW1lXSA9ICcnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ0VkbS5HdWlkJzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld09iamVjdFtub25OdWxsYWJsZVByb3BlcnR5Lm5hbWVdID0gJyc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHRoaXMuc2V0U2Vzc2lvbk9iamVjdChvZGF0YVJlcXVlc3QudGVuYW50SWQsIG5ld09iamVjdCk7XG4gICAgICAgICAgICAgICAgbmV3T2JqZWN0Ll9fdHJhbnNpZW50ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAob2RhdGFSZXF1ZXN0IGFzIE9EYXRhVjRSZXF1ZXN0KS5jb250ZXh0ID0gYC4uLyRtZXRhZGF0YSMke3RoaXMuZW50aXR5U2V0RGVmaW5pdGlvbi5uYW1lfSgpLyRlbnRpdHlgO1xuICAgICAgICAgICAgICAgIGNvbnN0IHV1aWQgPSBnZW5lcmF0ZUlkKDE2KTtcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRVVUlEID0gdXVpZDtcbiAgICAgICAgICAgICAgICBvZGF0YVJlcXVlc3Quc2V0UmVzcG9uc2VIZWFkZXIoJ3NhcC1jb250ZXh0aWQnLCAnU0lEOkFOT046bG9jYWxNb2NrJyArIHV1aWQpO1xuICAgICAgICAgICAgICAgIG9kYXRhUmVxdWVzdC5zZXRSZXNwb25zZUhlYWRlcignc2FwLWh0dHAtc2Vzc2lvbi10aW1lb3V0JywgdGhpcy5zZXNzaW9uVGltZW91dFRpbWUpO1xuICAgICAgICAgICAgICAgIHRoaXMucmVzZXRTZXNzaW9uVGltZW91dChvZGF0YVJlcXVlc3QudGVuYW50SWQpO1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0ID0gbmV3T2JqZWN0O1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjYXNlIGAke3RoaXMuZW50aXR5U2V0RGVmaW5pdGlvbi5hbm5vdGF0aW9ucy5TZXNzaW9uLlN0aWNreVNlc3Npb25TdXBwb3J0ZWQuRGlzY2FyZEFjdGlvbn0oJHthY3Rpb25EZWZpbml0aW9uLnNvdXJjZVR5cGV9KWA6XG4gICAgICAgICAgICAgICAgLy8gRGlzY2FyZFxuICAgICAgICAgICAgICAgIHRoaXMuc2V0U2Vzc2lvbk9iamVjdChvZGF0YVJlcXVlc3QudGVuYW50SWQsIG51bGwpO1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSBgJHt0aGlzLmVudGl0eVNldERlZmluaXRpb24uYW5ub3RhdGlvbnMuU2Vzc2lvbi5TdGlja3lTZXNzaW9uU3VwcG9ydGVkLlNhdmVBY3Rpb259KCR7YWN0aW9uRGVmaW5pdGlvbi5zb3VyY2VUeXBlfSlgOiB7XG4gICAgICAgICAgICAgICAgY29uc3QgbmV3RGF0YSA9IHRoaXMuZ2V0U2Vzc2lvbk9iamVjdChvZGF0YVJlcXVlc3QudGVuYW50SWQpO1xuICAgICAgICAgICAgICAgIGlmIChuZXdEYXRhLl9fa2V5cykge1xuICAgICAgICAgICAgICAgICAgICAvLyBLZXkgbmVlZHMgdG8gYmUgZmlsbGVkIG5vd1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50TW9ja0RhdGEudXBkYXRlRW50cnkobmV3RGF0YS5fX2tleXMsIG5ld0RhdGEpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGVyZm9ybVBPU1Qoe30sIG5ld0RhdGEsIG9kYXRhUmVxdWVzdC50ZW5hbnRJZCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTZXNzaW9uT2JqZWN0KG9kYXRhUmVxdWVzdC50ZW5hbnRJZCwgbnVsbCk7XG5cbiAgICAgICAgICAgICAgICByZXNwb25zZU9iamVjdCA9IG5ld0RhdGE7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmVzcG9uc2VPYmplY3QgPSBjdXJyZW50TW9ja0RhdGEub25BZnRlckFjdGlvbihhY3Rpb25EZWZpbml0aW9uLCBhY3Rpb25EYXRhLCBrZXlzLCByZXNwb25zZU9iamVjdCk7XG4gICAgICAgIHJldHVybiByZXNwb25zZU9iamVjdDtcbiAgICB9XG5cbiAgICBwdWJsaWMgcGVyZm9ybUdFVChrZXlWYWx1ZXM6IEtleURlZmluaXRpb25zLCBhc0FycmF5OiBib29sZWFuLCB0ZW5hbnRJZDogc3RyaW5nLCBkb250Q2xvbmUgPSBmYWxzZSk6IGFueSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRTZXNzaW9uT2JqZWN0ID0gdGhpcy5nZXRTZXNzaW9uT2JqZWN0KHRlbmFudElkKTtcbiAgICAgICAgaWYgKGN1cnJlbnRTZXNzaW9uT2JqZWN0ICYmIGtleVZhbHVlcyAmJiBPYmplY3Qua2V5cyhrZXlWYWx1ZXMpLmxlbmd0aCkge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoa2V5VmFsdWVzLCBcIicnXCIpICYmIGtleVZhbHVlc1tcIicnXCJdID09PSB1bmRlZmluZWQpIHx8XG4gICAgICAgICAgICAgICAgdGhpcy5jaGVja0tleXMoa2V5VmFsdWVzLCBjdXJyZW50U2Vzc2lvbk9iamVjdCwgdGhpcy5lbnRpdHlUeXBlRGVmaW5pdGlvbi5rZXlzKVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgLy8gb2RhdGFSZXF1ZXN0LnNldFJlc3BvbnNlSGVhZGVyKCdzYXAtY29udGV4dGlkJywgdGhpcy5jdXJyZW50VVVJRCk7XG4gICAgICAgICAgICAgICAgLy8gb2RhdGFSZXF1ZXN0LnNldFJlc3BvbnNlSGVhZGVyKCdzYXAtaHR0cC1zZXNzaW9uLXRpbWVvdXQnLCB0aGlzLnNlc3Npb25UaW1lb3V0VGltZS50b1N0cmluZygpKTtcbiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0U2Vzc2lvblRpbWVvdXQodGVuYW50SWQpO1xuICAgICAgICAgICAgICAgIHJldHVybiBjbG9uZURlZXAoY3VycmVudFNlc3Npb25PYmplY3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdXBlci5wZXJmb3JtR0VUKGtleVZhbHVlcywgYXNBcnJheSwgdGVuYW50SWQpO1xuICAgIH1cbn1cbiJdfQ==