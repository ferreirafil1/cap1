"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ODataV4Request = void 0;
var odataRequest_1 = require("./odataRequest");
var simpleHttpResponse_1 = require("../batch/http/simpleHttpResponse");
var query_string_1 = require("query-string");
var balanced_match_1 = __importDefault(require("balanced-match"));
var ODataV4Request = /** @class */ (function (_super) {
    __extends(ODataV4Request, _super);
    function ODataV4Request(baseUrl, url, metadata) {
        var _this = _super.call(this, baseUrl, url, metadata) || this;
        _this.context = url.split('?')[0];
        return _this;
    }
    ODataV4Request.prototype.countCharInString = function (testStr, char) {
        var charCount = 0;
        for (var i = 0; i < testStr.length; i++) {
            if (testStr[i] === char) {
                charCount++;
            }
        }
        return charCount;
    };
    /**
     * Comma separate list of properties that can contain sub-requests are split into an array.
     * @param propertiesQuery OData properties request
     */
    ODataV4Request.prototype.splitProperties = function (propertiesQuery) {
        var properties = [];
        var property = '', nestingDepth = 0;
        for (var _i = 0, propertiesQuery_1 = propertiesQuery; _i < propertiesQuery_1.length; _i++) {
            var char = propertiesQuery_1[_i];
            if (char === ',' && nestingDepth === 0) {
                // top-level delimiter - end of property
                if (property.length > 0)
                    properties.push(property);
                property = '';
            }
            else {
                property += char;
                if (char === '(')
                    nestingDepth++;
                if (char === ')')
                    nestingDepth--;
            }
        }
        if (nestingDepth === 0) {
            if (property.length > 0)
                properties.push(property);
        }
        else {
            throw "Invalid properties: " + propertiesQuery;
        }
        return properties;
    };
    ODataV4Request.prototype.parseExpand = function (expandParameters) {
        var _this = this;
        var props = this.splitProperties(expandParameters);
        return props.reduce(function (reducer, property) {
            var match = property.match(/([^(]*)(\((.+)\))?/);
            var name = match[1];
            var parameters = match[3];
            var parameterSplit = parameters === null || parameters === void 0 ? void 0 : parameters.split(';');
            var queryPart = {};
            var previousParamData = '';
            parameterSplit === null || parameterSplit === void 0 ? void 0 : parameterSplit.forEach(function (paramData) {
                if (previousParamData.length > 0) {
                    previousParamData += ';';
                }
                previousParamData += paramData;
                if (previousParamData.indexOf('(') !== -1) {
                    // In case we have an opening parenthesis we may not be balanced
                    var isBalanced = balanced_match_1.default('(', ')', previousParamData);
                    if (isBalanced) {
                        queryPart = Object.assign(queryPart, query_string_1.parse(previousParamData));
                        previousParamData = '';
                    }
                }
                else {
                    queryPart = Object.assign(queryPart, query_string_1.parse(paramData));
                    previousParamData = '';
                }
            });
            var expand = queryPart['$expand']
                ? _this.parseExpand(queryPart['$expand'])
                : { expand: {}, properties: {} };
            var select = queryPart['$select'] ? queryPart['$select'].split(',') : [];
            var selectProperties = {};
            select.forEach(function (propName) {
                selectProperties[propName] = true;
            });
            Object.keys(expand.properties).forEach(function (expandName) {
                selectProperties[expandName] = true;
            });
            reducer.expand[name] = {
                expand: expand.expand,
                select: selectProperties
            };
            reducer.properties[name] = true;
            return reducer;
        }, { expand: {}, properties: {} });
    };
    ODataV4Request.prototype.enrichElement = function (entity, element) {
        // nothing to do in v4
    };
    ODataV4Request.prototype.createResponse = function (data, bCreated, key) {
        if (bCreated === void 0) { bCreated = false; }
        if (key === void 0) { key = undefined; }
        var response = new simpleHttpResponse_1.SimpleResponse();
        if (data !== null) {
            response.write(this.toJSON(data));
            response.status(bCreated ? 204 : 200);
        }
        else {
            response.status(404);
        }
        response.setHeader('content-type', 'application/json;odata.metadata=minimal;IEEE754Compatible=true');
        response.setHeader('odata-version', '4.0');
        if (bCreated) {
            response.setHeader('location', this.location);
        }
        return response;
    };
    ODataV4Request.prototype.toJSON = function (data) {
        /*
        $select=ID,IsActiveEntity,category_ID,currency_code,identifier,price,rating,stock,thumbnailImage,title
        $expand=DraftAdministrativeData,category($select=ID,name),supplier($select=ID,city,name,phone,postCode,street)

        */
        // Header sap-contextid: SID:ANON:ldcicf6_CF6_00:PfxM66KUqPqnTLsyxAgp1J2aQJHbISjdfAQTi6e_-ATT
        // TODO: generate context based on this.uri
        //'@odata.context': `$metadata#${this.uri.entitySet}(${this.uri.query['$select']},${this.uri.query['$expand']})`
        var outContext = this.context;
        var dataLength = this.dataLength;
        if (outContext.indexOf('$metadata') === -1) {
            outContext = "$metadata#" + this.context;
        }
        if (Array.isArray(data)) {
            var result = {
                '@odata.context': "" + outContext,
                '@odata.count': dataLength,
                value: data
            };
            return JSON.stringify(result);
        }
        else {
            var result = {
                '@odata.context': "" + outContext,
                '@odata.metadataEtag': 'W/"2DWIhBAR9jvPhquo53N+7tW+t3A5axeT11Xw3lkjcRY="'
            };
            return JSON.stringify(Object.assign(result, data));
        }
    };
    return ODataV4Request;
}(odataRequest_1.ODataRequest));
exports.ODataV4Request = ODataV4Request;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2RhdGFWNFJlcXVlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcm91dGVyL3JlcXVlc3Qvb2RhdGFWNFJlcXVlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLCtDQUF5RDtBQUN6RCx1RUFBa0U7QUFFbEUsNkNBQXFDO0FBQ3JDLGtFQUFzQztBQUV0QztJQUFvQyxrQ0FBWTtJQUk1Qyx3QkFBbUIsT0FBZSxFQUFFLEdBQVcsRUFBRSxRQUF1QjtRQUF4RSxZQUNJLGtCQUFNLE9BQU8sRUFBRSxHQUFHLEVBQUUsUUFBUSxDQUFDLFNBRWhDO1FBREcsS0FBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDOztJQUNyQyxDQUFDO0lBRUQsMENBQWlCLEdBQWpCLFVBQWtCLE9BQWUsRUFBRSxJQUFZO1FBQzNDLElBQUksU0FBUyxHQUFHLENBQUMsQ0FBQztRQUNsQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNyQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLEVBQUU7Z0JBQ3JCLFNBQVMsRUFBRSxDQUFDO2FBQ2Y7U0FDSjtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ3JCLENBQUM7SUFDRDs7O09BR0c7SUFDTyx3Q0FBZSxHQUF6QixVQUEwQixlQUF1QjtRQUM3QyxJQUFNLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDdEIsSUFBSSxRQUFRLEdBQUcsRUFBRSxFQUNiLFlBQVksR0FBRyxDQUFDLENBQUM7UUFFckIsS0FBbUIsVUFBZSxFQUFmLG1DQUFlLEVBQWYsNkJBQWUsRUFBZixJQUFlLEVBQUU7WUFBL0IsSUFBTSxJQUFJLHdCQUFBO1lBQ1gsSUFBSSxJQUFJLEtBQUssR0FBRyxJQUFJLFlBQVks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QUMsQ0FBQyxDQUFDO1NBQ3REO0lBQ0wsQ0FBQztJQUNMLHFCQUFDO0FBQUQsQ0FBQyxBQWpKRCxDQUFvQywyQkFBWSxHQWlKL0M7QUFqSlksd0NBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPRGF0YVJlcXVlc3QsIERhdGFRdWVyeSB9IGZyb20gJy4vb2RhdGFSZXF1ZXN0JztcbmltcG9ydCB7IFNpbXBsZVJlc3BvbnNlIH0gZnJvbSAnLi4vYmF0Y2gvaHR0cC9zaW1wbGVIdHRwUmVzcG9uc2UnO1xuaW1wb3J0IHsgT0RhdGFNZXRhZGF0YSB9IGZyb20gJy4uL2RhdGEvbWV0YWRhdGEnO1xuaW1wb3J0IHsgcGFyc2UgfSBmcm9tICdxdWVyeS1zdHJpbmcnO1xuaW1wb3J0IGJhbGFuY2VkIGZyb20gJ2JhbGFuY2VkLW1hdGNoJztcblxuZXhwb3J0IGNsYXNzIE9EYXRhVjRSZXF1ZXN0IGV4dGVuZHMgT0RhdGFSZXF1ZXN0IHtcbiAgICBwdWJsaWMgY29udGV4dDogc3RyaW5nO1xuICAgIHB1YmxpYyBkYXRhTGVuZ3RoOiBudW1iZXI7XG4gICAgcHVibGljIGxvY2F0aW9uOiBzdHJpbmc7XG4gICAgcHVibGljIGNvbnN0cnVjdG9yKGJhc2VVcmw6IHN0cmluZywgdXJsOiBzdHJpbmcsIG1ldGFkYXRhOiBPRGF0YU1ldGFkYXRhKSB7XG4gICAgICAgIHN1cGVyKGJhc2VVcmwsIHVybCwgbWV0YWRhdGEpO1xuICAgICAgICB0aGlzLmNvbnRleHQgPSB1cmwuc3BsaXQoJz8nKVswXTtcbiAgICB9XG5cbiAgICBjb3VudENoYXJJblN0cmluZyh0ZXN0U3RyOiBzdHJpbmcsIGNoYXI6IHN0cmluZykge1xuICAgICAgICBsZXQgY2hhckNvdW50ID0gMDtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0ZXN0U3RyLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBpZiAodGVzdFN0cltpXSA9PT0gY2hhcikge1xuICAgICAgICAgICAgICAgIGNoYXJDb3VudCsrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjaGFyQ291bnQ7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIENvbW1hIHNlcGFyYXRlIGxpc3Qgb2YgcHJvcGVydGllcyB0aGF0IGNhbiBjb250YWluIHN1Yi1yZXF1ZXN0cyBhcmUgc3BsaXQgaW50byBhbiBhcnJheS5cbiAgICAgKiBAcGFyYW0gcHJvcGVydGllc1F1ZXJ5IE9EYXRhIHByb3BlcnRpZXMgcmVxdWVzdFxuICAgICAqL1xuICAgIHByb3RlY3RlZCBzcGxpdFByb3BlcnRpZXMocHJvcGVydGllc1F1ZXJ5OiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSBbXTtcbiAgICAgICAgbGV0IHByb3BlcnR5ID0gJycsXG4gICAgICAgICAgICBuZXN0aW5nRGVwdGggPSAwO1xuXG4gICAgICAgIGZvciAoY29uc3QgY2hhciBvZiBwcm9wZXJ0aWVzUXVlcnkpIHtcbiAgICAgICAgICAgIGlmIChjaGFyID09PSAnLCcgJiYgbmVzdGluZ0RlcHRoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgLy8gdG9wLWxldmVsIGRlbGltaXRlciAtIGVuZCBvZiBwcm9wZXJ0eVxuICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eS5sZW5ndGggPiAwKSBwcm9wZXJ0aWVzLnB1c2gocHJvcGVydHkpO1xuICAgICAgICAgICAgICAgIHByb3BlcnR5ID0gJyc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHByb3BlcnR5ICs9IGNoYXI7XG4gICAgICAgICAgICAgICAgaWYgKGNoYXIgPT09ICcoJykgbmVzdGluZ0RlcHRoKys7XG4gICAgICAgICAgICAgICAgaWYgKGNoYXIgPT09ICcpJykgbmVzdGluZ0RlcHRoLS07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5lc3RpbmdEZXB0aCA9PT0gMCkge1xuICAgICAgICAgICAgaWYgKHByb3BlcnR5Lmxlbmd0aCA+IDApIHByb3BlcnRpZXMucHVzaChwcm9wZXJ0eSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBgSW52YWxpZCBwcm9wZXJ0aWVzOiAke3Byb3BlcnRpZXNRdWVyeX1gO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwcm9wZXJ0aWVzO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBwYXJzZUV4cGFuZChleHBhbmRQYXJhbWV0ZXJzOiBzdHJpbmcpOiBQYXJ0aWFsPERhdGFRdWVyeT4ge1xuICAgICAgICBjb25zdCBwcm9wcyA9IHRoaXMuc3BsaXRQcm9wZXJ0aWVzKGV4cGFuZFBhcmFtZXRlcnMpO1xuICAgICAgICByZXR1cm4gcHJvcHMucmVkdWNlKFxuICAgICAgICAgICAgKHJlZHVjZXIsIHByb3BlcnR5KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSBwcm9wZXJ0eS5tYXRjaCgvKFteKF0qKShcXCgoLispXFwpKT8vKTtcbiAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbWF0Y2hbMV07XG4gICAgICAgICAgICAgICAgY29uc3QgcGFyYW1ldGVycyA9IG1hdGNoWzNdO1xuICAgICAgICAgICAgICAgIGNvbnN0IHBhcmFtZXRlclNwbGl0ID0gcGFyYW1ldGVycz8uc3BsaXQoJzsnKTtcbiAgICAgICAgICAgICAgICBsZXQgcXVlcnlQYXJ0ID0ge307XG4gICAgICAgICAgICAgICAgbGV0IHByZXZpb3VzUGFyYW1EYXRhID0gJyc7XG4gICAgICAgICAgICAgICAgcGFyYW1ldGVyU3BsaXQ/LmZvckVhY2goKHBhcmFtRGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNQYXJhbURhdGEubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNQYXJhbURhdGEgKz0gJzsnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHByZXZpb3VzUGFyYW1EYXRhICs9IHBhcmFtRGF0YTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzUGFyYW1EYXRhLmluZGV4T2YoJygnKSAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluIGNhc2Ugd2UgaGF2ZSBhbiBvcGVuaW5nIHBhcmVudGhlc2lzIHdlIG1heSBub3QgYmUgYmFsYW5jZWRcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzQmFsYW5jZWQgPSBiYWxhbmNlZCgnKCcsICcpJywgcHJldmlvdXNQYXJhbURhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQmFsYW5jZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVyeVBhcnQgPSBPYmplY3QuYXNzaWduKHF1ZXJ5UGFydCwgcGFyc2UocHJldmlvdXNQYXJhbURhdGEpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1BhcmFtRGF0YSA9ICcnO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnlQYXJ0ID0gT2JqZWN0LmFzc2lnbihxdWVyeVBhcnQsIHBhcnNlKHBhcmFtRGF0YSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNQYXJhbURhdGEgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGNvbnN0IGV4cGFuZCA9IHF1ZXJ5UGFydFsnJGV4cGFuZCddXG4gICAgICAgICAgICAgICAgICAgID8gdGhpcy5wYXJzZUV4cGFuZChxdWVyeVBhcnRbJyRleHBhbmQnXSlcbiAgICAgICAgICAgICAgICAgICAgOiB7IGV4cGFuZDoge30sIHByb3BlcnRpZXM6IHt9IH07XG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ID0gcXVlcnlQYXJ0Wyckc2VsZWN0J10gPyBxdWVyeVBhcnRbJyRzZWxlY3QnXS5zcGxpdCgnLCcpIDogW107XG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0UHJvcGVydGllcyA9IHt9O1xuICAgICAgICAgICAgICAgIHNlbGVjdC5mb3JFYWNoKChwcm9wTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzZWxlY3RQcm9wZXJ0aWVzW3Byb3BOYW1lXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXMoZXhwYW5kLnByb3BlcnRpZXMpLmZvckVhY2goKGV4cGFuZE5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0UHJvcGVydGllc1tleHBhbmROYW1lXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICByZWR1Y2VyLmV4cGFuZFtuYW1lXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgZXhwYW5kOiBleHBhbmQuZXhwYW5kLFxuICAgICAgICAgICAgICAgICAgICBzZWxlY3Q6IHNlbGVjdFByb3BlcnRpZXNcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHJlZHVjZXIucHJvcGVydGllc1tuYW1lXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlZHVjZXI7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgeyBleHBhbmQ6IHt9LCBwcm9wZXJ0aWVzOiB7fSB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGVucmljaEVsZW1lbnQoZW50aXR5OiBzdHJpbmcsIGVsZW1lbnQ6IG9iamVjdCk6IHZvaWQge1xuICAgICAgICAvLyBub3RoaW5nIHRvIGRvIGluIHY0XG4gICAgfVxuXG4gICAgcHVibGljIGNyZWF0ZVJlc3BvbnNlKGRhdGE6IGFueSwgYkNyZWF0ZWQgPSBmYWxzZSwga2V5OiBzdHJpbmcgPSB1bmRlZmluZWQpOiBTaW1wbGVSZXNwb25zZSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gbmV3IFNpbXBsZVJlc3BvbnNlKCk7XG4gICAgICAgIGlmIChkYXRhICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXNwb25zZS53cml0ZSh0aGlzLnRvSlNPTihkYXRhKSk7XG4gICAgICAgICAgICByZXNwb25zZS5zdGF0dXMoYkNyZWF0ZWQgPyAyMDQgOiAyMDApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzKDQwNCk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzcG9uc2Uuc2V0SGVhZGVyKCdjb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24vanNvbjtvZGF0YS5tZXRhZGF0YT1taW5pbWFsO0lFRUU3NTRDb21wYXRpYmxlPXRydWUnKTtcbiAgICAgICAgcmVzcG9uc2Uuc2V0SGVhZGVyKCdvZGF0YS12ZXJzaW9uJywgJzQuMCcpO1xuICAgICAgICBpZiAoYkNyZWF0ZWQpIHtcbiAgICAgICAgICAgIHJlc3BvbnNlLnNldEhlYWRlcignbG9jYXRpb24nLCB0aGlzLmxvY2F0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHRvSlNPTihkYXRhOiBvYmplY3QgfCBvYmplY3RbXSk6IHN0cmluZyB7XG4gICAgICAgIC8qXG4gICAgICAgICRzZWxlY3Q9SUQsSXNBY3RpdmVFbnRpdHksY2F0ZWdvcnlfSUQsY3VycmVuY3lfY29kZSxpZGVudGlmaWVyLHByaWNlLHJhdGluZyxzdG9jayx0aHVtYm5haWxJbWFnZSx0aXRsZVxuICAgICAgICAkZXhwYW5kPURyYWZ0QWRtaW5pc3RyYXRpdmVEYXRhLGNhdGVnb3J5KCRzZWxlY3Q9SUQsbmFtZSksc3VwcGxpZXIoJHNlbGVjdD1JRCxjaXR5LG5hbWUscGhvbmUscG9zdENvZGUsc3RyZWV0KVxuXG4gICAgICAgICovXG4gICAgICAgIC8vIEhlYWRlciBzYXAtY29udGV4dGlkOiBTSUQ6QU5PTjpsZGNpY2Y2X0NGNl8wMDpQZnhNNjZLVXFQcW5UTHN5eEFncDFKMmFRSkhiSVNqZGZBUVRpNmVfLUFUVFxuICAgICAgICAvLyBUT0RPOiBnZW5lcmF0ZSBjb250ZXh0IGJhc2VkIG9uIHRoaXMudXJpXG4gICAgICAgIC8vJ0BvZGF0YS5jb250ZXh0JzogYCRtZXRhZGF0YSMke3RoaXMudXJpLmVudGl0eVNldH0oJHt0aGlzLnVyaS5xdWVyeVsnJHNlbGVjdCddfSwke3RoaXMudXJpLnF1ZXJ5WyckZXhwYW5kJ119KWBcbiAgICAgICAgbGV0IG91dENvbnRleHQgPSB0aGlzLmNvbnRleHQ7XG4gICAgICAgIGNvbnN0IGRhdGFMZW5ndGggPSB0aGlzLmRhdGFMZW5ndGg7XG4gICAgICAgIGlmIChvdXRDb250ZXh0LmluZGV4T2YoJyRtZXRhZGF0YScpID09PSAtMSkge1xuICAgICAgICAgICAgb3V0Q29udGV4dCA9IGAkbWV0YWRhdGEjJHt0aGlzLmNvbnRleHR9YDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICAgICAgICAgICdAb2RhdGEuY29udGV4dCc6IGAke291dENvbnRleHR9YCxcbiAgICAgICAgICAgICAgICAnQG9kYXRhLmNvdW50JzogZGF0YUxlbmd0aCxcbiAgICAgICAgICAgICAgICB2YWx1ZTogZGF0YVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShyZXN1bHQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICAgICAgICAgICdAb2RhdGEuY29udGV4dCc6IGAke291dENvbnRleHR9YCxcbiAgICAgICAgICAgICAgICAnQG9kYXRhLm1ldGFkYXRhRXRhZyc6ICdXL1wiMkRXSWhCQVI5anZQaHF1bzUzTis3dFcrdDNBNWF4ZVQxMVh3M2xramNSWT1cIidcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoT2JqZWN0LmFzc2lnbihyZXN1bHQsIGRhdGEpKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==