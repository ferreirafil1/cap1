"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ODataRequest = void 0;
var querystring_1 = require("querystring");
var simpleHttpResponse_1 = require("../batch/http/simpleHttpResponse");
/**
 * Abstract class representing an OData request
 */
var ODataRequest = /** @class */ (function () {
    function ODataRequest(baseUrl, url, metadata) {
        this.headers = {};
        this.metadata = metadata;
        var _a = url.split('?'), path = _a[0], params = _a[1];
        this.baseUrl = baseUrl;
        this.query = this.parseUrl(path, params ? querystring_1.parse(params) : {});
        this.tenantId = this.baseUrl.indexOf('/tenant-') === 0 ? this.baseUrl.split('/')[1] : 'tenant-default';
    }
    ODataRequest.prototype.setResponseHeader = function (headerName, headerValue) {
        this.headers[headerName] = headerValue;
    };
    ODataRequest.prototype.applyResponseHeaders = function (res) {
        for (var headerName in this.headers) {
            res.setHeader(headerName, this.headers[headerName]);
        }
        this.headers = {};
    };
    ODataRequest.prototype.parsePath = function (path) {
        var pathSplit = path.split('/');
        return pathSplit.reduce(function (pathArr, pathPart) {
            var keysStart = pathPart.indexOf('(');
            var keysEnd = pathPart.indexOf(')');
            var entity;
            var keys;
            if (keysStart > -1) {
                entity = pathPart.substring(0, keysStart) + pathPart.substring(keysEnd + 1);
                var keysList = pathPart.substring(keysStart + 1, keysEnd).split(',');
                keys = {};
                keysList.forEach(function (keyValue) {
                    var _a = keyValue.split('='), key = _a[0], value = _a[1];
                    if (value) {
                        keys[key] = value.replace(/^'|'$/g, '');
                    }
                    else {
                        keys[key] = undefined;
                    }
                });
            }
            else {
                entity = pathPart;
            }
            pathArr.push({ path: entity, keys: keys });
            return pathArr;
        }, []);
    };
    /**
     * Version specific parsing of the input url
     * @param path: url path
     * @param params: query parameters as object
     */
    ODataRequest.prototype.parseUrl = function (path, params) {
        var query = { properties: {} };
        query.queryPath = this.parsePath(path);
        query.rawParams = params;
        query.searchQuery = params['$search'];
        if (params['$select']) {
            var props = params['$select'].split(',');
            props.forEach(function (property) {
                query.properties[property.split('/')[0]] = true;
            });
        }
        else if (params['$expand']) {
            // If we have no select but an expand we may want to pull in content from the entity as well
            var entitySet = this.metadata.getEntitySet(query.queryPath[0].path);
            if (entitySet) {
                var properties = entitySet.entityType.entityProperties;
                properties.forEach(function (property) {
                    query.properties[property.name] = true;
                });
            }
        }
        if (params['$expand']) {
            var expandParameters = this.parseExpand(params['$expand']);
            query.expand = expandParameters.expand;
            query.properties = Object.assign(query.properties, expandParameters.properties || {});
        }
        if (params['$apply']) {
            var applyParameters = this.parseApply(params['$apply']);
            query.aggregateDefinition = applyParameters;
        }
        if (params['$filter']) {
            var filterParams = decodeURIComponent(params['$filter']);
            var thisFilters = this.parseFilter(filterParams);
            query.filter = thisFilters;
        }
        query.startIndex = params['$skip'] ? parseInt(params['$skip']) : 0;
        query.maxElements = params['$top'] ? parseInt(params['$top']) : Number.POSITIVE_INFINITY;
        query.format = 'json';
        return query;
    };
    ODataRequest.prototype.parseFilter = function (filterParams) {
        var filterSplit = filterParams.split(' ');
        filterSplit = filterSplit.reduce(function (outSplit, currentValue) {
            if (currentValue.indexOf('tolower') === 0) {
                outSplit.push(currentValue);
            }
            else if (currentValue.indexOf('(') !== -1) {
                var parentSplit = currentValue.split('(');
                parentSplit.forEach(function (subValue) {
                    if (subValue.length === 0) {
                        outSplit.push('(');
                    }
                    else {
                        outSplit.push(subValue);
                    }
                });
            }
            else if (currentValue.indexOf(')') !== -1) {
                var parentSplit = currentValue.split(')');
                parentSplit.forEach(function (subValue) {
                    if (subValue.length === 0) {
                        outSplit.push(')');
                    }
                    else {
                        outSplit.push(subValue);
                    }
                });
            }
            else {
                outSplit.push(currentValue);
            }
            return outSplit;
        }, []);
        var char = filterSplit[0];
        var filterIdx = 0;
        var filters = [];
        var childStack = [];
        var thisFilters = filters;
        filters.operator = 'AND';
        while (filterIdx < filterSplit.length) {
            if (char[0] === '(') {
                var childFilters = [];
                childStack.push(thisFilters);
                thisFilters = childFilters;
                filterIdx++;
                char = filterSplit[filterIdx];
            }
            else if (char[char.length - 1] === ')' && char.indexOf('tolower') !== 0) {
                var parentFilter = childStack.pop();
                parentFilter.push(thisFilters);
                thisFilters = parentFilter;
                filterIdx++;
                char = filterSplit[filterIdx];
            }
            else if (char === 'and') {
                filterIdx++;
                thisFilters.operator = 'AND';
                char = filterSplit[filterIdx];
            }
            else if (char === 'or') {
                var currentFilters = thisFilters;
                thisFilters = [currentFilters];
                thisFilters.operator = 'OR';
                filterIdx++;
                char = filterSplit[filterIdx];
            }
            else {
                var filterProperty = char;
                var filterOperator = filterSplit[++filterIdx];
                var eqValue = filterSplit[++filterIdx];
                thisFilters.push({
                    prop: filterProperty,
                    operator: filterOperator,
                    eqValue: eqValue
                });
                char = filterSplit[++filterIdx];
            }
        }
        return thisFilters;
    };
    ODataRequest.prototype.parseApply = function (applyParameters) {
        var filterRegEx = /^filter\(([^)]+)\)\/(.*)$/;
        var filterMatches = applyParameters.match(filterRegEx);
        var groupByText = applyParameters;
        var filterParams;
        if (filterMatches) {
            var filterExpr = filterMatches[1];
            filterParams = this.parseFilter(filterExpr);
            groupByText = filterMatches[2];
        }
        var groupByRegEx = /^groupby\(\(([^)]+)\),([^)]+\))\)$/;
        var groupByMatches = groupByText.match(groupByRegEx);
        if (groupByMatches) {
            return {
                filter: filterParams,
                groupBy: groupByMatches[1].split(','),
                aggregates: this.parseAggregateDefinition(groupByMatches[2])
            };
        }
    };
    ODataRequest.prototype.parseAggregateDefinition = function (aggregationDefinition) {
        var aggregateRegEx = /^aggregate\(([^)]+)\)$/;
        var aggregateMatches = aggregationDefinition.match(aggregateRegEx);
        if (aggregateMatches) {
            return aggregateMatches[1].split(',').map(function (aggregateMatch) {
                var _a = aggregateMatch.split(' '), property = _a[0], withOp = _a[1], operator = _a[2], asStr = _a[3], targetName = _a[4];
                return {
                    name: targetName || property,
                    operator: operator,
                    sourceProperty: property
                };
            });
        }
    };
    ODataRequest.prototype.enrichElement = function (entity, element) {
        // method can be overwritten by enhancing classes
    };
    // /**
    //  * Select only the properties that the client requested
    //  * @param element element to be modified
    //  */
    // protected selectProperties(element: object, properties: object): void {
    //     if (properties) {
    //         for (const property in element) {
    //             if (!properties[property]) {
    //                 delete element[property];
    //             }
    //         }
    //     }
    // }
    //
    // protected expandProperties(element: object, expand: object): void {
    //     if (expand) {
    //         for (const property in expand) {
    //             const target = this.metadata.getTarget(this.query.entitySet, property);
    //             if (target) {
    //                 const data = this.dataAccess.read(target);
    //
    //                 let keys;
    //                 const keyMap = this.metadata.getTargetPropertyMap(this.query.entitySet, property);
    //                 if (keyMap) {
    //                     keys = {};
    //                     for (const key in keyMap) {
    //                         if (element[key] !== undefined) {
    //                             keys[keyMap[key]] = element[key];
    //                         }
    //                     }
    //                 } else {
    //                     if (this.query.keys) {
    //                         keys = this.query.keys;
    //                     } else {
    //                         keys = {};
    //                         const keyIds = this.metadata.getKeys(this.query.entitySet);
    //                         keyIds.forEach((key) => {
    //                             keys[key] = element[key];
    //                         });
    //                     }
    //                 }
    //
    //                 const subElements = this.selectElements(data, keys);
    //                 for (const subElement of subElements) {
    //                     this.enrichElement(target, subElement);
    //                 }
    //                 element[property] = subElements.length === 1 ? subElements[0] : subElements;
    //             } else {
    //                 element[property] = null;
    //             }
    //         }
    //     }
    // }
    // protected selectElements(elements: object[], keys: object): object[] {
    //     if (!keys) {
    //         return elements;
    //     }
    //     const selected = elements.filter((element: object) => {
    //         for (const key in keys) {
    //             if (!!element[key] && element[key] + '' !== keys[key] + '') {
    //                 return false;
    //             }
    //         }
    //         return true;
    //     });
    //     return selected;
    // }
    ODataRequest.prototype.createErrorResponse = function (errorInformation) {
        var response = new simpleHttpResponse_1.SimpleResponse();
        if (errorInformation.isCustomError) {
            if (errorInformation.messageData) {
                if (errorInformation.isSAPMessage) {
                    response.setHeader('odata-version', '4.0');
                    response.setHeader('content-type', 'application/json;odata.metadata=minimal;IEEE754Compatible=true');
                    response.setHeader('sap-messages', JSON.stringify(errorInformation.messageData));
                }
                else {
                    response.write(JSON.stringify(errorInformation.messageData));
                }
            }
            else {
                response.write(errorInformation.messageData);
            }
            response.status(errorInformation.statusCode);
        }
        else {
            response.write(errorInformation.message);
            response.status(500);
        }
        return response;
    };
    ODataRequest.prototype.createResponse = function (data, bCreated, key) {
        if (bCreated === void 0) { bCreated = false; }
        if (key === void 0) { key = undefined; }
        var response = new simpleHttpResponse_1.SimpleResponse();
        if (data !== null) {
            response.write(this.toJSON(data));
            response.status(200);
        }
        else {
            response.status(204);
        }
        return response;
    };
    return ODataRequest;
}());
exports.ODataRequest = ODataRequest;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2RhdGFSZXF1ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3JvdXRlci9yZXF1ZXN0L29kYXRhUmVxdWVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQ0FBb0M7QUFFcEMsdUVBQWtFO0FBeUNsRTs7R0FFRztBQUNIO0lBUUksc0JBQW1CLE9BQWUsRUFBRSxHQUFXLEVBQUUsUUFBdUI7UUFGOUQsWUFBTyxHQUFRLEVBQUUsQ0FBQztRQUd4QixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUNuQixJQUFBLEtBQWlCLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQTlCLElBQUksUUFBQSxFQUFFLE1BQU0sUUFBa0IsQ0FBQztRQUN0QyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsbUJBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQztJQUMzRyxDQUFDO0lBRU0sd0NBQWlCLEdBQXhCLFVBQXlCLFVBQWtCLEVBQUUsV0FBZ0I7UUFDekQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxXQUFXLENBQUM7SUFDM0MsQ0FBQztJQUVNLDJDQUFvQixHQUEzQixVQUE0QixHQUFhO1FBQ3JDLEtBQUssSUFBTSxVQUFVLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNuQyxHQUFHLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7U0FDdkQ7UUFDRCxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztJQUN0QixDQUFDO0lBRU8sZ0NBQVMsR0FBakIsVUFBa0IsSUFBWTtRQUMxQixJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2xDLE9BQU8sU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFDLE9BQU8sRUFBRSxRQUFRO1lBQ3RDLElBQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDeEMsSUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0QyxJQUFJLE1BQU0sQ0FBQztZQUNYLElBQUksSUFBSSxDQUFDO1lBQ1QsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDLEVBQUU7Z0JBQ2hCLE1BQU0sR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDNUUsSUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEdBQUcsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDdkUsSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFDVixRQUFRLENBQUMsT0FBTyxDQUFDLFVBQUMsUUFBUTtvQkFDaEIsSUFBQSxLQUFlLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQWpDLEdBQUcsUUFBQSxFQUFFLEtBQUssUUFBdUIsQ0FBQztvQkFDekMsSUFBSSxLQUFLLEVBQUU7d0JBQ1AsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO3FCQUMzQzt5QkFBTTt3QkFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsU0FBUyxDQUFDO3FCQUN6QjtnQkFDTCxDQUFDLENBQUMsQ0FBQzthQUNOO2lCQUFNO2dCQUNILE1BQU0sR0FBRyxRQUFRLENBQUM7YUFDckI7WUFDRCxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUMzQyxPQUFPLE9BQU8sQ0FBQztRQUNuQixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDWCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNPLCtCQUFRLEdBQWxCLFVBQW1CLElBQVksRUFBRSxNQUFjO1FBQzNDLElBQU0sS0FBSyxHQUF1QixFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsQ0FBQztRQUNyRCxLQUFLLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkMsS0FBSyxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUM7UUFDekIsS0FBSyxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFdEMsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDbkIsSUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMzQyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQUMsUUFBUTtnQkFDbkIsS0FBSyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQ3BELENBQUMsQ0FBQyxDQUFDO1NBQ047YUFBTSxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUMxQiw0RkFBNEY7WUFDNUYsSUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN0RSxJQUFJLFNBQVMsRUFBRTtnQkFDWCxJQUFNLFVBQVUsR0FBRyxTQUFTLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDO2dCQUN6RCxVQUFVLENBQUMsT0FBTyxDQUFDLFVBQUMsUUFBUTtvQkFDeEIsS0FBSyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO2dCQUMzQyxDQUFDLENBQUMsQ0FBQzthQUNOO1NBQ0o7UUFFRCxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUNuQixJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDN0QsS0FBSyxDQUFDLE1BQU0sR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUM7WUFDdkMsS0FBSyxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1NBQ3pGO1FBRUQsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDbEIsSUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUMxRCxLQUFLLENBQUMsbUJBQW1CLEdBQUcsZUFBZSxDQUFDO1NBQy9DO1FBRUQsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDbkIsSUFBTSxZQUFZLEdBQUcsa0JBQWtCLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDM0QsSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNuRCxLQUFLLENBQUMsTUFBTSxHQUFHLFdBQVcsQ0FBQztTQUM5QjtRQUVELEtBQUssQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNuRSxLQUFLLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUM7UUFFekYsS0FBSyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDdEIsT0FBTyxLQUFrQixDQUFDO0lBQzlCLENBQUM7SUFFUyxrQ0FBVyxHQUFyQixVQUFzQixZQUFvQjtRQUN0QyxJQUFJLFdBQVcsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzFDLFdBQVcsR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDLFVBQUMsUUFBUSxFQUFFLFlBQVk7WUFDcEQsSUFBSSxZQUFZLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDdkMsUUFBUSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUMvQjtpQkFBTSxJQUFJLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7Z0JBQ3pDLElBQU0sV0FBVyxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzVDLFdBQVcsQ0FBQyxPQUFPLENBQUMsVUFBQyxRQUFRO29CQUN6QixJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO3dCQUN2QixRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO3FCQUN0Qjt5QkFBTTt3QkFDSCxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO3FCQUMzQjtnQkFDTCxDQUFDLENBQUMsQ0FBQzthQUNOO2lCQUFNLElBQUksWUFBWSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtnQkFDekMsSUFBTSxXQUFXLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDNUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxVQUFDLFFBQVE7b0JBQ3pCLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7d0JBQ3ZCLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7cUJBQ3RCO3lCQUFNO3dCQUNILFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7cUJBQzNCO2dCQUNMLENBQUMsQ0FBQyxDQUFDO2FBQ047aUJBQU07Z0JBQ0gsUUFBUSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUMvQjtZQUNELE9BQU8sUUFBUSxDQUFDO1FBQ3BCLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNQLElBQUksSUFBSSxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxQixJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7UUFDbEIsSUFBTSxPQUFPLEdBQVEsRUFBRSxDQUFDO1FBQ3hCLElBQU0sVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUN0QixJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUM7UUFFMUIsT0FBTyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7UUFDekIsT0FBTyxTQUFTLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBRTtZQUNuQyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLEVBQUU7Z0JBQ2pCLElBQU0sWUFBWSxHQUFHLEVBQUUsQ0FBQztnQkFDeEIsVUFBVSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDN0IsV0FBVyxHQUFHLFlBQVksQ0FBQztnQkFDM0IsU0FBUyxFQUFFLENBQUM7Z0JBQ1osSUFBSSxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQzthQUNqQztpQkFBTSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDdkUsSUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDO2dCQUN0QyxZQUFZLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUMvQixXQUFXLEdBQUcsWUFBWSxDQUFDO2dCQUMzQixTQUFTLEVBQUUsQ0FBQztnQkFDWixJQUFJLEdBQUcsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQ2pDO2lCQUFNLElBQUksSUFBSSxLQUFLLEtBQUssRUFBRTtnQkFDdkIsU0FBUyxFQUFFLENBQUM7Z0JBQ1osV0FBVyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7Z0JBQzdCLElBQUksR0FBRyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDakM7aUJBQU0sSUFBSSxJQUFJLEtBQUssSUFBSSxFQUFFO2dCQUN0QixJQUFNLGNBQWMsR0FBRyxXQUFXLENBQUM7Z0JBQ25DLFdBQVcsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO2dCQUMvQixXQUFXLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztnQkFDNUIsU0FBUyxFQUFFLENBQUM7Z0JBQ1osSUFBSSxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQzthQUNqQztpQkFBTTtnQkFDSCxJQUFNLGNBQWMsR0FBRyxJQUFJLENBQUM7Z0JBQzVCLElBQU0sY0FBYyxHQUFHLFdBQVcsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUNoRCxJQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQztnQkFDekMsV0FBVyxDQUFDLElBQUksQ0FBQztvQkFDYixJQUFJLEVBQUUsY0FBYztvQkFDcEIsUUFBUSxFQUFFLGNBQWM7b0JBQ3hCLE9BQU8sRUFBRSxPQUFPO2lCQUNuQixDQUFDLENBQUM7Z0JBQ0gsSUFBSSxHQUFHLFdBQVcsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2FBQ25DO1NBQ0o7UUFDRCxPQUFPLFdBQVcsQ0FBQztJQUN2QixDQUFDO0lBSVMsaUNBQVUsR0FBcEIsVUFBcUIsZUFBdUI7UUFDeEMsSUFBTSxXQUFXLEdBQUcsMkJBQTJCLENBQUM7UUFDaEQsSUFBTSxhQUFhLEdBQUcsZUFBZSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN6RCxJQUFJLFdBQVcsR0FBRyxlQUFlLENBQUM7UUFDbEMsSUFBSSxZQUFZLENBQUM7UUFDakIsSUFBSSxhQUFhLEVBQUU7WUFDZixJQUFNLFVBQVUsR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEMsWUFBWSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDNUMsV0FBVyxHQUFHLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNsQztRQUNELElBQU0sWUFBWSxHQUFHLG9DQUFvQyxDQUFDO1FBQzFELElBQU0sY0FBYyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDdkQsSUFBSSxjQUFjLEVBQUU7WUFDaEIsT0FBTztnQkFDSCxNQUFNLEVBQUUsWUFBWTtnQkFDcEIsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO2dCQUNyQyxVQUFVLEVBQUUsSUFBSSxDQUFDLHdCQUF3QixDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUMvRCxDQUFDO1NBQ0w7SUFDTCxDQUFDO0lBRVMsK0NBQXdCLEdBQWxDLFVBQW1DLHFCQUE2QjtRQUM1RCxJQUFNLGNBQWMsR0FBRyx3QkFBd0IsQ0FBQztRQUNoRCxJQUFNLGdCQUFnQixHQUFHLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNyRSxJQUFJLGdCQUFnQixFQUFFO1lBQ2xCLE9BQU8sZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFDLGNBQWM7Z0JBQy9DLElBQUEsS0FBa0QsY0FBYyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBMUUsUUFBUSxRQUFBLEVBQUUsTUFBTSxRQUFBLEVBQUUsUUFBUSxRQUFBLEVBQUUsS0FBSyxRQUFBLEVBQUUsVUFBVSxRQUE2QixDQUFDO2dCQUNsRixPQUFPO29CQUNILElBQUksRUFBRSxVQUFVLElBQUksUUFBUTtvQkFDNUIsUUFBUSxVQUFBO29CQUNSLGNBQWMsRUFBRSxRQUFRO2lCQUMzQixDQUFDO1lBQ04sQ0FBQyxDQUFDLENBQUM7U0FDTjtJQUNMLENBQUM7SUFJUyxvQ0FBYSxHQUF2QixVQUF3QixNQUFjLEVBQUUsT0FBZTtRQUNuRCxpREFBaUQ7SUFDckQsQ0FBQztJQUVELE1BQU07SUFDTiwwREFBMEQ7SUFDMUQsMkNBQTJDO0lBQzNDLE1BQU07SUFDTiwwRUFBMEU7SUFDMUUsd0JBQXdCO0lBQ3hCLDRDQUE0QztJQUM1QywyQ0FBMkM7SUFDM0MsNENBQTRDO0lBQzVDLGdCQUFnQjtJQUNoQixZQUFZO0lBQ1osUUFBUTtJQUNSLElBQUk7SUFDSixFQUFFO0lBQ0Ysc0VBQXNFO0lBQ3RFLG9CQUFvQjtJQUNwQiwyQ0FBMkM7SUFDM0Msc0ZBQXNGO0lBQ3RGLDRCQUE0QjtJQUM1Qiw2REFBNkQ7SUFDN0QsRUFBRTtJQUNGLDRCQUE0QjtJQUM1QixxR0FBcUc7SUFDckcsZ0NBQWdDO0lBQ2hDLGlDQUFpQztJQUNqQyxrREFBa0Q7SUFDbEQsNERBQTREO0lBQzVELGdFQUFnRTtJQUNoRSw0QkFBNEI7SUFDNUIsd0JBQXdCO0lBQ3hCLDJCQUEyQjtJQUMzQiw2Q0FBNkM7SUFDN0Msa0RBQWtEO0lBQ2xELCtCQUErQjtJQUMvQixxQ0FBcUM7SUFDckMsc0ZBQXNGO0lBQ3RGLG9EQUFvRDtJQUNwRCx3REFBd0Q7SUFDeEQsOEJBQThCO0lBQzlCLHdCQUF3QjtJQUN4QixvQkFBb0I7SUFDcEIsRUFBRTtJQUNGLHVFQUF1RTtJQUN2RSwwREFBMEQ7SUFDMUQsOERBQThEO0lBQzlELG9CQUFvQjtJQUNwQiwrRkFBK0Y7SUFDL0YsdUJBQXVCO0lBQ3ZCLDRDQUE0QztJQUM1QyxnQkFBZ0I7SUFDaEIsWUFBWTtJQUNaLFFBQVE7SUFDUixJQUFJO0lBRUoseUVBQXlFO0lBQ3pFLG1CQUFtQjtJQUNuQiwyQkFBMkI7SUFDM0IsUUFBUTtJQUNSLDhEQUE4RDtJQUM5RCxvQ0FBb0M7SUFDcEMsNEVBQTRFO0lBQzVFLGdDQUFnQztJQUNoQyxnQkFBZ0I7SUFDaEIsWUFBWTtJQUNaLHVCQUF1QjtJQUN2QixVQUFVO0lBQ1YsdUJBQXVCO0lBQ3ZCLElBQUk7SUFFRywwQ0FBbUIsR0FBMUIsVUFBMkIsZ0JBQWdDO1FBQ3ZELElBQU0sUUFBUSxHQUFHLElBQUksbUNBQWMsRUFBRSxDQUFDO1FBQ3RDLElBQUksZ0JBQWdCLENBQUMsYUFBYSxFQUFFO1lBQ2hDLElBQUksZ0JBQWdCLENBQUMsV0FBVyxFQUFFO2dCQUM5QixJQUFJLGdCQUFnQixDQUFDLFlBQVksRUFBRTtvQkFDL0IsUUFBUSxDQUFDLFNBQVMsQ0FBQyxlQUFlLEVBQUUsS0FBSyxDQUFDLENBQUM7b0JBQzNDLFFBQVEsQ0FBQyxTQUFTLENBQ2QsY0FBYyxFQUNkLGdFQUFnRSxDQUNuRSxDQUFDO29CQUNGLFFBQVEsQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztpQkFDcEY7cUJBQU07b0JBQ0gsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7aUJBQ2hFO2FBQ0o7aUJBQU07Z0JBQ0gsUUFBUSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUNoRDtZQUNELFFBQVEsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDaEQ7YUFBTTtZQUNILFFBQVEsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDekMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN4QjtRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7SUFDTSxxQ0FBYyxHQUFyQixVQUFzQixJQUFTLEVBQUUsUUFBZ0IsRUFBRSxHQUF1QjtRQUF6Qyx5QkFBQSxFQUFBLGdCQUFnQjtRQUFFLG9CQUFBLEVBQUEsZUFBdUI7UUFDdEUsSUFBTSxRQUFRLEdBQUcsSUFBSSxtQ0FBYyxFQUFFLENBQUM7UUFDdEMsSUFBSSxJQUFJLEtBQUssSUFBSSxFQUFFO1lBQ2YsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDbEMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN4QjthQUFNO1lBQ0gsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN4QjtRQUVELE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7SUErQkwsbUJBQUM7QUFBRCxDQUFDLEFBcFdELElBb1dDO0FBcFdxQixvQ0FBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHBhcnNlIH0gZnJvbSAncXVlcnlzdHJpbmcnO1xuaW1wb3J0IHsgT0RhdGFNZXRhZGF0YSB9IGZyb20gJy4uL2RhdGEvbWV0YWRhdGEnO1xuaW1wb3J0IHsgU2ltcGxlUmVzcG9uc2UgfSBmcm9tICcuLi9iYXRjaC9odHRwL3NpbXBsZUh0dHBSZXNwb25zZSc7XG5pbXBvcnQgeyBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgRXhlY3V0aW9uRXJyb3IsIE9EYXRhUmVxdWVzdEludGVyZmFjZSB9IGZyb20gJy4uL2RhdGEvY29tbW9uJztcblxuZXhwb3J0IGludGVyZmFjZSBEYXRhUXVlcnkge1xuICAgIGxpc3Q6IGJvb2xlYW47XG4gICAgcXVlcnlQYXRoOiBRdWVyeVBhdGhbXTtcbiAgICByYXdQYXJhbXM6IG9iamVjdDtcbiAgICBwcm9wZXJ0aWVzOiBvYmplY3Q7XG4gICAgc2VhcmNoUXVlcnk6IHN0cmluZztcbiAgICBleHBhbmQ6IG9iamVjdDtcbiAgICBmb3JtYXQ6IHN0cmluZztcbiAgICBhZ2dyZWdhdGVEZWZpbml0aW9uOiBBZ2dyZWdhdGVEZWZpbml0aW9uO1xuICAgIGZpbHRlcjogYW55O1xuICAgIHN0YXJ0SW5kZXg/OiBudW1iZXI7XG4gICAgbWF4RWxlbWVudHM/OiBudW1iZXI7XG59XG5cbnR5cGUgQWdncmVnYXRlRGVmaW5pdGlvbiA9IHtcbiAgICBmaWx0ZXI6IGFueTtcbiAgICBncm91cEJ5OiBzdHJpbmdbXTtcbiAgICBhZ2dyZWdhdGVzOiBBZ2dyZWdhdGVQcm9wZXJ0eVtdO1xufTtcblxudHlwZSBBZ2dyZWdhdGVQcm9wZXJ0eSA9IHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgb3BlcmF0b3I6IHN0cmluZztcbiAgICBzb3VyY2VQcm9wZXJ0eTogc3RyaW5nO1xufTtcblxuZXhwb3J0IHR5cGUgUXVlcnlQYXRoID0ge1xuICAgIHBhdGg6IHN0cmluZztcbiAgICBrZXlzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xufTtcblxuZXhwb3J0IHR5cGUgRXJyb3JJbmZvcm1hdGlvbiA9IHtcbiAgICBzdGF0dXNDb2RlOiBudW1iZXI7XG4gICAgbWVzc2FnZT86IHN0cmluZztcbiAgICBkYXRhPzogb2JqZWN0O1xufTtcblxuLyoqXG4gKiBBYnN0cmFjdCBjbGFzcyByZXByZXNlbnRpbmcgYW4gT0RhdGEgcmVxdWVzdFxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgT0RhdGFSZXF1ZXN0IGltcGxlbWVudHMgT0RhdGFSZXF1ZXN0SW50ZXJmYWNlIHtcbiAgICBwdWJsaWMgcXVlcnk6IERhdGFRdWVyeTtcbiAgICBwdWJsaWMgcmVhZG9ubHkgYmFzZVVybDogc3RyaW5nO1xuICAgIHB1YmxpYyByZWFkb25seSB0ZW5hbnRJZDogc3RyaW5nO1xuICAgIHB1YmxpYyBkYXRhTGVuZ3RoOiBudW1iZXI7XG4gICAgcHJvdGVjdGVkIG1ldGFkYXRhOiBPRGF0YU1ldGFkYXRhO1xuICAgIHByb3RlY3RlZCBoZWFkZXJzOiBhbnkgPSB7fTtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcihiYXNlVXJsOiBzdHJpbmcsIHVybDogc3RyaW5nLCBtZXRhZGF0YTogT0RhdGFNZXRhZGF0YSkge1xuICAgICAgICB0aGlzLm1ldGFkYXRhID0gbWV0YWRhdGE7XG4gICAgICAgIGNvbnN0IFtwYXRoLCBwYXJhbXNdID0gdXJsLnNwbGl0KCc/Jyk7XG4gICAgICAgIHRoaXMuYmFzZVVybCA9IGJhc2VVcmw7XG4gICAgICAgIHRoaXMucXVlcnkgPSB0aGlzLnBhcnNlVXJsKHBhdGgsIHBhcmFtcyA/IHBhcnNlKHBhcmFtcykgOiB7fSk7XG4gICAgICAgIHRoaXMudGVuYW50SWQgPSB0aGlzLmJhc2VVcmwuaW5kZXhPZignL3RlbmFudC0nKSA9PT0gMCA/IHRoaXMuYmFzZVVybC5zcGxpdCgnLycpWzFdIDogJ3RlbmFudC1kZWZhdWx0JztcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0UmVzcG9uc2VIZWFkZXIoaGVhZGVyTmFtZTogc3RyaW5nLCBoZWFkZXJWYWx1ZTogYW55KSB7XG4gICAgICAgIHRoaXMuaGVhZGVyc1toZWFkZXJOYW1lXSA9IGhlYWRlclZhbHVlO1xuICAgIH1cblxuICAgIHB1YmxpYyBhcHBseVJlc3BvbnNlSGVhZGVycyhyZXM6IFJlc3BvbnNlKSB7XG4gICAgICAgIGZvciAoY29uc3QgaGVhZGVyTmFtZSBpbiB0aGlzLmhlYWRlcnMpIHtcbiAgICAgICAgICAgIHJlcy5zZXRIZWFkZXIoaGVhZGVyTmFtZSwgdGhpcy5oZWFkZXJzW2hlYWRlck5hbWVdKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmhlYWRlcnMgPSB7fTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBhcnNlUGF0aChwYXRoOiBzdHJpbmcpOiBRdWVyeVBhdGhbXSB7XG4gICAgICAgIGNvbnN0IHBhdGhTcGxpdCA9IHBhdGguc3BsaXQoJy8nKTtcbiAgICAgICAgcmV0dXJuIHBhdGhTcGxpdC5yZWR1Y2UoKHBhdGhBcnIsIHBhdGhQYXJ0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBrZXlzU3RhcnQgPSBwYXRoUGFydC5pbmRleE9mKCcoJyk7XG4gICAgICAgICAgICBjb25zdCBrZXlzRW5kID0gcGF0aFBhcnQuaW5kZXhPZignKScpO1xuICAgICAgICAgICAgbGV0IGVudGl0eTtcbiAgICAgICAgICAgIGxldCBrZXlzO1xuICAgICAgICAgICAgaWYgKGtleXNTdGFydCA+IC0xKSB7XG4gICAgICAgICAgICAgICAgZW50aXR5ID0gcGF0aFBhcnQuc3Vic3RyaW5nKDAsIGtleXNTdGFydCkgKyBwYXRoUGFydC5zdWJzdHJpbmcoa2V5c0VuZCArIDEpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGtleXNMaXN0ID0gcGF0aFBhcnQuc3Vic3RyaW5nKGtleXNTdGFydCArIDEsIGtleXNFbmQpLnNwbGl0KCcsJyk7XG4gICAgICAgICAgICAgICAga2V5cyA9IHt9O1xuICAgICAgICAgICAgICAgIGtleXNMaXN0LmZvckVhY2goKGtleVZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IFtrZXksIHZhbHVlXSA9IGtleVZhbHVlLnNwbGl0KCc9Jyk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAga2V5c1trZXldID0gdmFsdWUucmVwbGFjZSgvXid8JyQvZywgJycpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAga2V5c1trZXldID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGVudGl0eSA9IHBhdGhQYXJ0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGF0aEFyci5wdXNoKHsgcGF0aDogZW50aXR5LCBrZXlzOiBrZXlzIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHBhdGhBcnI7XG4gICAgICAgIH0sIFtdKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBWZXJzaW9uIHNwZWNpZmljIHBhcnNpbmcgb2YgdGhlIGlucHV0IHVybFxuICAgICAqIEBwYXJhbSBwYXRoOiB1cmwgcGF0aFxuICAgICAqIEBwYXJhbSBwYXJhbXM6IHF1ZXJ5IHBhcmFtZXRlcnMgYXMgb2JqZWN0XG4gICAgICovXG4gICAgcHJvdGVjdGVkIHBhcnNlVXJsKHBhdGg6IHN0cmluZywgcGFyYW1zOiBvYmplY3QpOiBEYXRhUXVlcnkge1xuICAgICAgICBjb25zdCBxdWVyeTogUGFydGlhbDxEYXRhUXVlcnk+ID0geyBwcm9wZXJ0aWVzOiB7fSB9O1xuICAgICAgICBxdWVyeS5xdWVyeVBhdGggPSB0aGlzLnBhcnNlUGF0aChwYXRoKTtcbiAgICAgICAgcXVlcnkucmF3UGFyYW1zID0gcGFyYW1zO1xuICAgICAgICBxdWVyeS5zZWFyY2hRdWVyeSA9IHBhcmFtc1snJHNlYXJjaCddO1xuXG4gICAgICAgIGlmIChwYXJhbXNbJyRzZWxlY3QnXSkge1xuICAgICAgICAgICAgY29uc3QgcHJvcHMgPSBwYXJhbXNbJyRzZWxlY3QnXS5zcGxpdCgnLCcpO1xuICAgICAgICAgICAgcHJvcHMuZm9yRWFjaCgocHJvcGVydHkpID0+IHtcbiAgICAgICAgICAgICAgICBxdWVyeS5wcm9wZXJ0aWVzW3Byb3BlcnR5LnNwbGl0KCcvJylbMF1dID0gdHJ1ZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2UgaWYgKHBhcmFtc1snJGV4cGFuZCddKSB7XG4gICAgICAgICAgICAvLyBJZiB3ZSBoYXZlIG5vIHNlbGVjdCBidXQgYW4gZXhwYW5kIHdlIG1heSB3YW50IHRvIHB1bGwgaW4gY29udGVudCBmcm9tIHRoZSBlbnRpdHkgYXMgd2VsbFxuICAgICAgICAgICAgY29uc3QgZW50aXR5U2V0ID0gdGhpcy5tZXRhZGF0YS5nZXRFbnRpdHlTZXQocXVlcnkucXVlcnlQYXRoWzBdLnBhdGgpO1xuICAgICAgICAgICAgaWYgKGVudGl0eVNldCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSBlbnRpdHlTZXQuZW50aXR5VHlwZS5lbnRpdHlQcm9wZXJ0aWVzO1xuICAgICAgICAgICAgICAgIHByb3BlcnRpZXMuZm9yRWFjaCgocHJvcGVydHkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnkucHJvcGVydGllc1twcm9wZXJ0eS5uYW1lXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGFyYW1zWyckZXhwYW5kJ10pIHtcbiAgICAgICAgICAgIGNvbnN0IGV4cGFuZFBhcmFtZXRlcnMgPSB0aGlzLnBhcnNlRXhwYW5kKHBhcmFtc1snJGV4cGFuZCddKTtcbiAgICAgICAgICAgIHF1ZXJ5LmV4cGFuZCA9IGV4cGFuZFBhcmFtZXRlcnMuZXhwYW5kO1xuICAgICAgICAgICAgcXVlcnkucHJvcGVydGllcyA9IE9iamVjdC5hc3NpZ24ocXVlcnkucHJvcGVydGllcywgZXhwYW5kUGFyYW1ldGVycy5wcm9wZXJ0aWVzIHx8IHt9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwYXJhbXNbJyRhcHBseSddKSB7XG4gICAgICAgICAgICBjb25zdCBhcHBseVBhcmFtZXRlcnMgPSB0aGlzLnBhcnNlQXBwbHkocGFyYW1zWyckYXBwbHknXSk7XG4gICAgICAgICAgICBxdWVyeS5hZ2dyZWdhdGVEZWZpbml0aW9uID0gYXBwbHlQYXJhbWV0ZXJzO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBhcmFtc1snJGZpbHRlciddKSB7XG4gICAgICAgICAgICBjb25zdCBmaWx0ZXJQYXJhbXMgPSBkZWNvZGVVUklDb21wb25lbnQocGFyYW1zWyckZmlsdGVyJ10pO1xuICAgICAgICAgICAgY29uc3QgdGhpc0ZpbHRlcnMgPSB0aGlzLnBhcnNlRmlsdGVyKGZpbHRlclBhcmFtcyk7XG4gICAgICAgICAgICBxdWVyeS5maWx0ZXIgPSB0aGlzRmlsdGVycztcbiAgICAgICAgfVxuXG4gICAgICAgIHF1ZXJ5LnN0YXJ0SW5kZXggPSBwYXJhbXNbJyRza2lwJ10gPyBwYXJzZUludChwYXJhbXNbJyRza2lwJ10pIDogMDtcbiAgICAgICAgcXVlcnkubWF4RWxlbWVudHMgPSBwYXJhbXNbJyR0b3AnXSA/IHBhcnNlSW50KHBhcmFtc1snJHRvcCddKSA6IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTtcblxuICAgICAgICBxdWVyeS5mb3JtYXQgPSAnanNvbic7XG4gICAgICAgIHJldHVybiBxdWVyeSBhcyBEYXRhUXVlcnk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHBhcnNlRmlsdGVyKGZpbHRlclBhcmFtczogc3RyaW5nKSB7XG4gICAgICAgIGxldCBmaWx0ZXJTcGxpdCA9IGZpbHRlclBhcmFtcy5zcGxpdCgnICcpO1xuICAgICAgICBmaWx0ZXJTcGxpdCA9IGZpbHRlclNwbGl0LnJlZHVjZSgob3V0U3BsaXQsIGN1cnJlbnRWYWx1ZSkgPT4ge1xuICAgICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZS5pbmRleE9mKCd0b2xvd2VyJykgPT09IDApIHtcbiAgICAgICAgICAgICAgICBvdXRTcGxpdC5wdXNoKGN1cnJlbnRWYWx1ZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRWYWx1ZS5pbmRleE9mKCcoJykgIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFyZW50U3BsaXQgPSBjdXJyZW50VmFsdWUuc3BsaXQoJygnKTtcbiAgICAgICAgICAgICAgICBwYXJlbnRTcGxpdC5mb3JFYWNoKChzdWJWYWx1ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3ViVmFsdWUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvdXRTcGxpdC5wdXNoKCcoJyk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvdXRTcGxpdC5wdXNoKHN1YlZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50VmFsdWUuaW5kZXhPZignKScpICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudFNwbGl0ID0gY3VycmVudFZhbHVlLnNwbGl0KCcpJyk7XG4gICAgICAgICAgICAgICAgcGFyZW50U3BsaXQuZm9yRWFjaCgoc3ViVmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN1YlZhbHVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3V0U3BsaXQucHVzaCgnKScpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3V0U3BsaXQucHVzaChzdWJWYWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb3V0U3BsaXQucHVzaChjdXJyZW50VmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG91dFNwbGl0O1xuICAgICAgICB9LCBbXSk7XG4gICAgICAgIGxldCBjaGFyID0gZmlsdGVyU3BsaXRbMF07XG4gICAgICAgIGxldCBmaWx0ZXJJZHggPSAwO1xuICAgICAgICBjb25zdCBmaWx0ZXJzOiBhbnkgPSBbXTtcbiAgICAgICAgY29uc3QgY2hpbGRTdGFjayA9IFtdO1xuICAgICAgICBsZXQgdGhpc0ZpbHRlcnMgPSBmaWx0ZXJzO1xuXG4gICAgICAgIGZpbHRlcnMub3BlcmF0b3IgPSAnQU5EJztcbiAgICAgICAgd2hpbGUgKGZpbHRlcklkeCA8IGZpbHRlclNwbGl0Lmxlbmd0aCkge1xuICAgICAgICAgICAgaWYgKGNoYXJbMF0gPT09ICcoJykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkRmlsdGVycyA9IFtdO1xuICAgICAgICAgICAgICAgIGNoaWxkU3RhY2sucHVzaCh0aGlzRmlsdGVycyk7XG4gICAgICAgICAgICAgICAgdGhpc0ZpbHRlcnMgPSBjaGlsZEZpbHRlcnM7XG4gICAgICAgICAgICAgICAgZmlsdGVySWR4Kys7XG4gICAgICAgICAgICAgICAgY2hhciA9IGZpbHRlclNwbGl0W2ZpbHRlcklkeF07XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNoYXJbY2hhci5sZW5ndGggLSAxXSA9PT0gJyknICYmIGNoYXIuaW5kZXhPZigndG9sb3dlcicpICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFyZW50RmlsdGVyID0gY2hpbGRTdGFjay5wb3AoKTtcbiAgICAgICAgICAgICAgICBwYXJlbnRGaWx0ZXIucHVzaCh0aGlzRmlsdGVycyk7XG4gICAgICAgICAgICAgICAgdGhpc0ZpbHRlcnMgPSBwYXJlbnRGaWx0ZXI7XG4gICAgICAgICAgICAgICAgZmlsdGVySWR4Kys7XG4gICAgICAgICAgICAgICAgY2hhciA9IGZpbHRlclNwbGl0W2ZpbHRlcklkeF07XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICdhbmQnKSB7XG4gICAgICAgICAgICAgICAgZmlsdGVySWR4Kys7XG4gICAgICAgICAgICAgICAgdGhpc0ZpbHRlcnMub3BlcmF0b3IgPSAnQU5EJztcbiAgICAgICAgICAgICAgICBjaGFyID0gZmlsdGVyU3BsaXRbZmlsdGVySWR4XTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gJ29yJykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRGaWx0ZXJzID0gdGhpc0ZpbHRlcnM7XG4gICAgICAgICAgICAgICAgdGhpc0ZpbHRlcnMgPSBbY3VycmVudEZpbHRlcnNdO1xuICAgICAgICAgICAgICAgIHRoaXNGaWx0ZXJzLm9wZXJhdG9yID0gJ09SJztcbiAgICAgICAgICAgICAgICBmaWx0ZXJJZHgrKztcbiAgICAgICAgICAgICAgICBjaGFyID0gZmlsdGVyU3BsaXRbZmlsdGVySWR4XTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyUHJvcGVydHkgPSBjaGFyO1xuICAgICAgICAgICAgICAgIGNvbnN0IGZpbHRlck9wZXJhdG9yID0gZmlsdGVyU3BsaXRbKytmaWx0ZXJJZHhdO1xuICAgICAgICAgICAgICAgIGNvbnN0IGVxVmFsdWUgPSBmaWx0ZXJTcGxpdFsrK2ZpbHRlcklkeF07XG4gICAgICAgICAgICAgICAgdGhpc0ZpbHRlcnMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIHByb3A6IGZpbHRlclByb3BlcnR5LFxuICAgICAgICAgICAgICAgICAgICBvcGVyYXRvcjogZmlsdGVyT3BlcmF0b3IsXG4gICAgICAgICAgICAgICAgICAgIGVxVmFsdWU6IGVxVmFsdWVcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjaGFyID0gZmlsdGVyU3BsaXRbKytmaWx0ZXJJZHhdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzRmlsdGVycztcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgcGFyc2VFeHBhbmQoZXhwYW5kUGFyYW1ldGVyczogc3RyaW5nKTogUGFydGlhbDxEYXRhUXVlcnk+O1xuXG4gICAgcHJvdGVjdGVkIHBhcnNlQXBwbHkoYXBwbHlQYXJhbWV0ZXJzOiBzdHJpbmcpOiBBZ2dyZWdhdGVEZWZpbml0aW9uIHtcbiAgICAgICAgY29uc3QgZmlsdGVyUmVnRXggPSAvXmZpbHRlclxcKChbXildKylcXClcXC8oLiopJC87XG4gICAgICAgIGNvbnN0IGZpbHRlck1hdGNoZXMgPSBhcHBseVBhcmFtZXRlcnMubWF0Y2goZmlsdGVyUmVnRXgpO1xuICAgICAgICBsZXQgZ3JvdXBCeVRleHQgPSBhcHBseVBhcmFtZXRlcnM7XG4gICAgICAgIGxldCBmaWx0ZXJQYXJhbXM7XG4gICAgICAgIGlmIChmaWx0ZXJNYXRjaGVzKSB7XG4gICAgICAgICAgICBjb25zdCBmaWx0ZXJFeHByID0gZmlsdGVyTWF0Y2hlc1sxXTtcbiAgICAgICAgICAgIGZpbHRlclBhcmFtcyA9IHRoaXMucGFyc2VGaWx0ZXIoZmlsdGVyRXhwcik7XG4gICAgICAgICAgICBncm91cEJ5VGV4dCA9IGZpbHRlck1hdGNoZXNbMl07XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZ3JvdXBCeVJlZ0V4ID0gL15ncm91cGJ5XFwoXFwoKFteKV0rKVxcKSwoW14pXStcXCkpXFwpJC87XG4gICAgICAgIGNvbnN0IGdyb3VwQnlNYXRjaGVzID0gZ3JvdXBCeVRleHQubWF0Y2goZ3JvdXBCeVJlZ0V4KTtcbiAgICAgICAgaWYgKGdyb3VwQnlNYXRjaGVzKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGZpbHRlcjogZmlsdGVyUGFyYW1zLFxuICAgICAgICAgICAgICAgIGdyb3VwQnk6IGdyb3VwQnlNYXRjaGVzWzFdLnNwbGl0KCcsJyksXG4gICAgICAgICAgICAgICAgYWdncmVnYXRlczogdGhpcy5wYXJzZUFnZ3JlZ2F0ZURlZmluaXRpb24oZ3JvdXBCeU1hdGNoZXNbMl0pXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHBhcnNlQWdncmVnYXRlRGVmaW5pdGlvbihhZ2dyZWdhdGlvbkRlZmluaXRpb246IHN0cmluZyk6IEFnZ3JlZ2F0ZVByb3BlcnR5W10ge1xuICAgICAgICBjb25zdCBhZ2dyZWdhdGVSZWdFeCA9IC9eYWdncmVnYXRlXFwoKFteKV0rKVxcKSQvO1xuICAgICAgICBjb25zdCBhZ2dyZWdhdGVNYXRjaGVzID0gYWdncmVnYXRpb25EZWZpbml0aW9uLm1hdGNoKGFnZ3JlZ2F0ZVJlZ0V4KTtcbiAgICAgICAgaWYgKGFnZ3JlZ2F0ZU1hdGNoZXMpIHtcbiAgICAgICAgICAgIHJldHVybiBhZ2dyZWdhdGVNYXRjaGVzWzFdLnNwbGl0KCcsJykubWFwKChhZ2dyZWdhdGVNYXRjaCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IFtwcm9wZXJ0eSwgd2l0aE9wLCBvcGVyYXRvciwgYXNTdHIsIHRhcmdldE5hbWVdID0gYWdncmVnYXRlTWF0Y2guc3BsaXQoJyAnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiB0YXJnZXROYW1lIHx8IHByb3BlcnR5LFxuICAgICAgICAgICAgICAgICAgICBvcGVyYXRvcixcbiAgICAgICAgICAgICAgICAgICAgc291cmNlUHJvcGVydHk6IHByb3BlcnR5XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IHRvSlNPTihkYXRhOiBvYmplY3QgfCBvYmplY3RbXSk6IHN0cmluZztcblxuICAgIHByb3RlY3RlZCBlbnJpY2hFbGVtZW50KGVudGl0eTogc3RyaW5nLCBlbGVtZW50OiBvYmplY3QpOiB2b2lkIHtcbiAgICAgICAgLy8gbWV0aG9kIGNhbiBiZSBvdmVyd3JpdHRlbiBieSBlbmhhbmNpbmcgY2xhc3Nlc1xuICAgIH1cblxuICAgIC8vIC8qKlxuICAgIC8vICAqIFNlbGVjdCBvbmx5IHRoZSBwcm9wZXJ0aWVzIHRoYXQgdGhlIGNsaWVudCByZXF1ZXN0ZWRcbiAgICAvLyAgKiBAcGFyYW0gZWxlbWVudCBlbGVtZW50IHRvIGJlIG1vZGlmaWVkXG4gICAgLy8gICovXG4gICAgLy8gcHJvdGVjdGVkIHNlbGVjdFByb3BlcnRpZXMoZWxlbWVudDogb2JqZWN0LCBwcm9wZXJ0aWVzOiBvYmplY3QpOiB2b2lkIHtcbiAgICAvLyAgICAgaWYgKHByb3BlcnRpZXMpIHtcbiAgICAvLyAgICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgaW4gZWxlbWVudCkge1xuICAgIC8vICAgICAgICAgICAgIGlmICghcHJvcGVydGllc1twcm9wZXJ0eV0pIHtcbiAgICAvLyAgICAgICAgICAgICAgICAgZGVsZXRlIGVsZW1lbnRbcHJvcGVydHldO1xuICAgIC8vICAgICAgICAgICAgIH1cbiAgICAvLyAgICAgICAgIH1cbiAgICAvLyAgICAgfVxuICAgIC8vIH1cbiAgICAvL1xuICAgIC8vIHByb3RlY3RlZCBleHBhbmRQcm9wZXJ0aWVzKGVsZW1lbnQ6IG9iamVjdCwgZXhwYW5kOiBvYmplY3QpOiB2b2lkIHtcbiAgICAvLyAgICAgaWYgKGV4cGFuZCkge1xuICAgIC8vICAgICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBleHBhbmQpIHtcbiAgICAvLyAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLm1ldGFkYXRhLmdldFRhcmdldCh0aGlzLnF1ZXJ5LmVudGl0eVNldCwgcHJvcGVydHkpO1xuICAgIC8vICAgICAgICAgICAgIGlmICh0YXJnZXQpIHtcbiAgICAvLyAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YUFjY2Vzcy5yZWFkKHRhcmdldCk7XG4gICAgLy9cbiAgICAvLyAgICAgICAgICAgICAgICAgbGV0IGtleXM7XG4gICAgLy8gICAgICAgICAgICAgICAgIGNvbnN0IGtleU1hcCA9IHRoaXMubWV0YWRhdGEuZ2V0VGFyZ2V0UHJvcGVydHlNYXAodGhpcy5xdWVyeS5lbnRpdHlTZXQsIHByb3BlcnR5KTtcbiAgICAvLyAgICAgICAgICAgICAgICAgaWYgKGtleU1hcCkge1xuICAgIC8vICAgICAgICAgICAgICAgICAgICAga2V5cyA9IHt9O1xuICAgIC8vICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4ga2V5TWFwKSB7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW1lbnRba2V5XSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleXNba2V5TWFwW2tleV1dID0gZWxlbWVudFtrZXldO1xuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAvLyAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAvLyAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnF1ZXJ5LmtleXMpIHtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICBrZXlzID0gdGhpcy5xdWVyeS5rZXlzO1xuICAgIC8vICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICBrZXlzID0ge307XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5SWRzID0gdGhpcy5tZXRhZGF0YS5nZXRLZXlzKHRoaXMucXVlcnkuZW50aXR5U2V0KTtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICBrZXlJZHMuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleXNba2V5XSA9IGVsZW1lbnRba2V5XTtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAvLyAgICAgICAgICAgICAgICAgfVxuICAgIC8vXG4gICAgLy8gICAgICAgICAgICAgICAgIGNvbnN0IHN1YkVsZW1lbnRzID0gdGhpcy5zZWxlY3RFbGVtZW50cyhkYXRhLCBrZXlzKTtcbiAgICAvLyAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBzdWJFbGVtZW50IG9mIHN1YkVsZW1lbnRzKSB7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICB0aGlzLmVucmljaEVsZW1lbnQodGFyZ2V0LCBzdWJFbGVtZW50KTtcbiAgICAvLyAgICAgICAgICAgICAgICAgfVxuICAgIC8vICAgICAgICAgICAgICAgICBlbGVtZW50W3Byb3BlcnR5XSA9IHN1YkVsZW1lbnRzLmxlbmd0aCA9PT0gMSA/IHN1YkVsZW1lbnRzWzBdIDogc3ViRWxlbWVudHM7XG4gICAgLy8gICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAvLyAgICAgICAgICAgICAgICAgZWxlbWVudFtwcm9wZXJ0eV0gPSBudWxsO1xuICAgIC8vICAgICAgICAgICAgIH1cbiAgICAvLyAgICAgICAgIH1cbiAgICAvLyAgICAgfVxuICAgIC8vIH1cblxuICAgIC8vIHByb3RlY3RlZCBzZWxlY3RFbGVtZW50cyhlbGVtZW50czogb2JqZWN0W10sIGtleXM6IG9iamVjdCk6IG9iamVjdFtdIHtcbiAgICAvLyAgICAgaWYgKCFrZXlzKSB7XG4gICAgLy8gICAgICAgICByZXR1cm4gZWxlbWVudHM7XG4gICAgLy8gICAgIH1cbiAgICAvLyAgICAgY29uc3Qgc2VsZWN0ZWQgPSBlbGVtZW50cy5maWx0ZXIoKGVsZW1lbnQ6IG9iamVjdCkgPT4ge1xuICAgIC8vICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4ga2V5cykge1xuICAgIC8vICAgICAgICAgICAgIGlmICghIWVsZW1lbnRba2V5XSAmJiBlbGVtZW50W2tleV0gKyAnJyAhPT0ga2V5c1trZXldICsgJycpIHtcbiAgICAvLyAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIC8vICAgICAgICAgICAgIH1cbiAgICAvLyAgICAgICAgIH1cbiAgICAvLyAgICAgICAgIHJldHVybiB0cnVlO1xuICAgIC8vICAgICB9KTtcbiAgICAvLyAgICAgcmV0dXJuIHNlbGVjdGVkO1xuICAgIC8vIH1cblxuICAgIHB1YmxpYyBjcmVhdGVFcnJvclJlc3BvbnNlKGVycm9ySW5mb3JtYXRpb246IEV4ZWN1dGlvbkVycm9yKTogU2ltcGxlUmVzcG9uc2Uge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IG5ldyBTaW1wbGVSZXNwb25zZSgpO1xuICAgICAgICBpZiAoZXJyb3JJbmZvcm1hdGlvbi5pc0N1c3RvbUVycm9yKSB7XG4gICAgICAgICAgICBpZiAoZXJyb3JJbmZvcm1hdGlvbi5tZXNzYWdlRGF0YSkge1xuICAgICAgICAgICAgICAgIGlmIChlcnJvckluZm9ybWF0aW9uLmlzU0FQTWVzc2FnZSkge1xuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5zZXRIZWFkZXIoJ29kYXRhLXZlcnNpb24nLCAnNC4wJyk7XG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnNldEhlYWRlcihcbiAgICAgICAgICAgICAgICAgICAgICAgICdjb250ZW50LXR5cGUnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2FwcGxpY2F0aW9uL2pzb247b2RhdGEubWV0YWRhdGE9bWluaW1hbDtJRUVFNzU0Q29tcGF0aWJsZT10cnVlJ1xuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5zZXRIZWFkZXIoJ3NhcC1tZXNzYWdlcycsIEpTT04uc3RyaW5naWZ5KGVycm9ySW5mb3JtYXRpb24ubWVzc2FnZURhdGEpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS53cml0ZShKU09OLnN0cmluZ2lmeShlcnJvckluZm9ybWF0aW9uLm1lc3NhZ2VEYXRhKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXNwb25zZS53cml0ZShlcnJvckluZm9ybWF0aW9uLm1lc3NhZ2VEYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cyhlcnJvckluZm9ybWF0aW9uLnN0YXR1c0NvZGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzcG9uc2Uud3JpdGUoZXJyb3JJbmZvcm1hdGlvbi5tZXNzYWdlKTtcbiAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cyg1MDApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9XG4gICAgcHVibGljIGNyZWF0ZVJlc3BvbnNlKGRhdGE6IGFueSwgYkNyZWF0ZWQgPSBmYWxzZSwga2V5OiBzdHJpbmcgPSB1bmRlZmluZWQpOiBTaW1wbGVSZXNwb25zZSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gbmV3IFNpbXBsZVJlc3BvbnNlKCk7XG4gICAgICAgIGlmIChkYXRhICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXNwb25zZS53cml0ZSh0aGlzLnRvSlNPTihkYXRhKSk7XG4gICAgICAgICAgICByZXNwb25zZS5zdGF0dXMoMjAwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cygyMDQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgIH1cblxuICAgIC8vIHByb3RlY3RlZCBnZXRFbGVtZW50KCk6IG9iamVjdCB7XG4gICAgLy8gICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGFBY2Nlc3MucmVhZCh0aGlzLnF1ZXJ5LmVudGl0eVNldCk7XG4gICAgLy8gICAgIGNvbnN0IGVsZW1lbnRzID0gdGhpcy5zZWxlY3RFbGVtZW50cyhkYXRhLCB0aGlzLnF1ZXJ5LmtleXMpO1xuICAgIC8vICAgICBpZiAoZWxlbWVudHMgJiYgZWxlbWVudHMubGVuZ3RoID4gMCkge1xuICAgIC8vICAgICAgICAgY29uc3QgZWxlbWVudCA9IGVsZW1lbnRzWzBdO1xuICAgIC8vICAgICAgICAgdGhpcy5leHBhbmRQcm9wZXJ0aWVzKGVsZW1lbnQsIHRoaXMucXVlcnkuZXhwYW5kKTtcbiAgICAvLyAgICAgICAgIHRoaXMuc2VsZWN0UHJvcGVydGllcyhlbGVtZW50LCB0aGlzLnF1ZXJ5LnByb3BlcnRpZXMpO1xuICAgIC8vICAgICAgICAgdGhpcy5lbnJpY2hFbGVtZW50KHRoaXMucXVlcnkuZW50aXR5U2V0LCBlbGVtZW50KTtcbiAgICAvLyAgICAgICAgIHJldHVybiBlbGVtZW50O1xuICAgIC8vICAgICB9IGVsc2Uge1xuICAgIC8vICAgICAgICAgcmV0dXJuIHt9O1xuICAgIC8vICAgICB9XG4gICAgLy8gfVxuICAgIC8vXG4gICAgLy8gcHJvdGVjdGVkIGxpc3RFbGVtZW50cygpOiBvYmplY3Qge1xuICAgIC8vICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhQWNjZXNzLnJlYWQodGhpcy5xdWVyeS5lbnRpdHlTZXQpO1xuICAgIC8vICAgICBjb25zdCBmaXJzdCA9IHRoaXMucXVlcnkuc3RhcnRJbmRleCB8fCAwO1xuICAgIC8vICAgICBjb25zdCBsYXN0ID0gTWF0aC5taW4odGhpcy5xdWVyeS5zdGFydEluZGV4ICsgdGhpcy5xdWVyeS5tYXhFbGVtZW50cywgZGF0YS5sZW5ndGgpO1xuICAgIC8vXG4gICAgLy8gICAgIGNvbnN0IGVsZW1lbnRzID0gW107XG4gICAgLy8gICAgIGZvciAobGV0IGluZGV4ID0gZmlyc3Q7IGluZGV4IDwgbGFzdDsgaW5kZXgrKykge1xuICAgIC8vICAgICAgICAgY29uc3QgZWxlbWVudCA9IGRhdGFbaW5kZXhdO1xuICAgIC8vICAgICAgICAgdGhpcy5leHBhbmRQcm9wZXJ0aWVzKGVsZW1lbnQsIHRoaXMucXVlcnkuZXhwYW5kKTtcbiAgICAvLyAgICAgICAgIHRoaXMuc2VsZWN0UHJvcGVydGllcyhlbGVtZW50LCB0aGlzLnF1ZXJ5LnByb3BlcnRpZXMpO1xuICAgIC8vICAgICAgICAgdGhpcy5lbnJpY2hFbGVtZW50KHRoaXMucXVlcnkuZW50aXR5U2V0LCBlbGVtZW50KTtcbiAgICAvLyAgICAgICAgIGVsZW1lbnRzLnB1c2goZWxlbWVudCk7XG4gICAgLy8gICAgIH1cbiAgICAvLyAgICAgcmV0dXJuIGVsZW1lbnRzO1xuICAgIC8vIH1cbn1cbiJdfQ==